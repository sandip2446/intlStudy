<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Edu Nepal | Leading Study Abroad Consultants</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Google Fonts - Inter for professional look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- CSS RESET & VARIABLES --- */
        :root {
            /* Primary Colors - WCAG AAA Compliant */
            --primary: #003366; /* Deep Navy - Better contrast */
            --primary-dark: #001f3f;
            --primary-light: #1a5f7a;
            --primary-lighter: #2d7a9f;
            
            /* Accent Colors - WCAG AAA Compliant */
            --accent: #d4af37; /* Professional Gold - Better contrast */
            --accent-dark: #b8941f;
            --accent-light: #e8c547;
            
            /* Neutral Colors */
            --light: #f8f9fa;
            --light-gray: #e9ecef;
            --white: #ffffff;
            --off-white: #fafbfc;
            
            /* Text Colors - WCAG AAA Compliant (7:1 contrast ratio) */
            --text-dark: #1a1a1a; /* High contrast for readability */
            --text-medium: #4a4a4a;
            --text-light: #6c757d;
            --text-lighter: #8e9aaf;
            
            /* Border & Divider */
            --border: #dee2e6;
            --border-light: #e9ecef;
            --border-dark: #adb5bd;
            
            /* Status Colors - WCAG AAA Compliant */
            --success: #0d6efd; /* Changed to blue for better contrast */
            --success-dark: #0a58ca;
            --success-light: #3d8bfd;
            --danger: #dc3545;
            --danger-dark: #bb2d3b;
            --warning: #ffc107;
            --warning-dark: #ffb300;
            --info: #0dcaf0;
            
            /* Shadows - Professional depth */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
            
            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 50px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * { 
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.7;
            margin: 0; 
            padding: 0; 
            background-color: var(--white); 
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--primary); 
            font-weight: 700; 
            margin-top: 0;
            margin-bottom: 1rem;
            line-height: 1.3;
            letter-spacing: -0.02em;
        }
        
        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 800;
            line-height: 1.2;
        }
        
        h2 {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 700;
        }
        
        h3 {
            font-size: clamp(1.5rem, 3vw, 2rem);
            font-weight: 600;
        }
        
        h4 {
            font-size: clamp(1.25rem, 2.5vw, 1.5rem);
            font-weight: 600;
        }
        
        p { 
            color: var(--text-medium);
            margin-bottom: 1rem;
            font-size: 1rem;
            line-height: 1.7;
        }
        
        a { 
            text-decoration: none; 
            color: var(--primary);
            transition: color var(--transition-fast);
        }
        
        a:hover, a:focus {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        /* Focus styles for accessibility */
        *:focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Skip to main content link for screen readers */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: var(--white);
            padding: 8px 16px;
            z-index: 10000;
            text-decoration: none;
        }
        
        .skip-link:focus {
            top: 0;
        }

        /* --- NAVIGATION --- */
        header { 
            background-color: var(--white); 
            min-height: 80px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 5%;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.98);
        }

        .logo { 
            font-size: 1.5rem; 
            font-weight: 800; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            letter-spacing: -0.02em;
            transition: transform var(--transition-fast);
        }
        
        .logo:hover {
            transform: scale(1.02);
        }
        
        .logo i { 
            color: var(--accent);
            font-size: 1.75rem;
        }
        
        nav { 
            display: flex; 
            gap: 2rem; 
            align-items: center;
            flex-wrap: wrap;
        }
        
        nav button { 
            background: transparent; 
            border: none; 
            color: var(--text-dark); 
            font-size: 0.95rem; 
            font-weight: 500;
            cursor: pointer; 
            transition: all var(--transition-base);
            padding: 10px 0;
            position: relative;
            font-family: inherit;
        }
        
        nav button:hover, 
        nav button:focus,
        nav button.active { 
            color: var(--primary);
            font-weight: 600;
        }
        
        nav button.active::after {
            content: ''; 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 3px; 
            background: var(--accent);
            border-radius: 2px 2px 0 0;
        }

        .nav-cta {
            background-color: var(--primary) !important;
            color: var(--white) !important;
            padding: 12px 28px !important;
            border-radius: var(--radius-full);
            transition: all var(--transition-base) !important;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }
        
        .nav-cta:hover,
        .nav-cta:focus { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md);
            background-color: var(--primary-dark) !important;
        }
        
        .nav-cta::after { 
            display: none; 
        }

        .logout-btn { 
            background-color: var(--danger) !important; 
            color: var(--white) !important;
            padding: 10px 24px !important;
            border-radius: var(--radius-md);
            font-weight: 600;
            transition: all var(--transition-base);
        }
        
        .logout-btn:hover,
        .logout-btn:focus {
            background-color: var(--danger-dark) !important;
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        /* --- LAYOUT UTILITIES --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .section { display: none; padding: 60px 0; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            nav { display: none; /* In a real app, adding a hamburger menu would be next */ }
            .hero h1 { font-size: 2.5rem !important; }
            .hero p { font-size: 1rem !important; }
            .hero-stats { flex-direction: column; gap: 30px !important; }
            .section-title { font-size: 2rem !important; }
            .marketing-section { padding: 50px 0 !important; }
            .dest-highlights { flex-direction: column; gap: 10px !important; }
            .dest-detail-header { height: 200px !important; }
            table { font-size: 0.9rem; }
            table th, table td { padding: 10px !important; }
            #admin-contacts-view > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
            #admin-contacts-view > div[style*="grid-template-columns"] > div:last-child { display: none; }
        }

        /* --- HERO SECTION --- */
        .hero {
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.95) 0%, rgba(26, 95, 122, 0.9) 100%), 
                        url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--white);
            padding: 120px 0;
            text-align: center;
            position: relative;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.85) 0%, rgba(26, 95, 122, 0.75) 100%);
            z-index: 0;
        }
        
        .hero > .container {
            position: relative;
            z-index: 1;
        }
        
        .hero h1 { 
            color: var(--white); 
            font-size: clamp(2.5rem, 6vw, 4rem);
            margin-bottom: 1.5rem; 
            line-height: 1.2;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-weight: 800;
        }
        
        .hero p { 
            color: rgba(255, 255, 255, 0.95); 
            font-size: clamp(1.1rem, 2vw, 1.35rem);
            max-width: 750px; 
            margin: 0 auto 2.5rem auto;
            line-height: 1.7;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }
        
        .hero-stats {
            display: flex; 
            justify-content: center; 
            gap: 3rem; 
            margin-top: 4rem; 
            padding-top: 3rem; 
            border-top: 2px solid rgba(255, 255, 255, 0.25);
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            min-width: 150px;
        }
        
        .stat-item h3 { 
            color: var(--accent); 
            font-size: clamp(2rem, 4vw, 3rem); 
            margin-bottom: 0.5rem;
            font-weight: 800;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .stat-item p { 
            color: rgba(255, 255, 255, 0.95); 
            font-size: 0.95rem; 
            text-transform: uppercase; 
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        /* --- CARDS & SERVICES --- */
        .service-card {
            background: var(--white); 
            padding: 2.5rem; 
            border-radius: var(--radius-lg); 
            border: 2px solid var(--border-light); 
            transition: all var(--transition-base);
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-sm);
        }
        
        .service-card:hover,
        .service-card:focus-within { 
            transform: translateY(-8px); 
            box-shadow: var(--shadow-lg); 
            border-color: var(--accent);
        }
        
        .service-icon { 
            font-size: 3rem; 
            color: var(--primary); 
            margin-bottom: 1.5rem;
            transition: transform var(--transition-base);
        }
        
        .service-card:hover .service-icon {
            transform: scale(1.1);
        }

        .dest-card {
            height: 280px; 
            border-radius: var(--radius-lg); 
            overflow: hidden; 
            position: relative; 
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }
        
        .dest-card:hover,
        .dest-card:focus {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }
        
        .dest-card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform var(--transition-slow);
        }
        
        .dest-card:hover img { 
            transform: scale(1.15); 
        }
        
        .dest-overlay {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.4) 60%, transparent 100%);
            padding: 2rem 1.5rem 1.5rem; 
            color: var(--white);
        }
        
        .dest-overlay h3 {
            color: var(--white);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .dest-overlay p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            margin: 0;
        }

        /* --- MARKETING SECTIONS --- */
        .marketing-section {
            padding: 5rem 0;
        }
        
        .marketing-section.alt-bg {
            background-color: var(--off-white);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(0, 51, 102, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 50%);
        }
        
        .section-title {
            text-align: center;
            font-size: clamp(2rem, 4vw, 2.75rem);
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .section-subtitle {
            text-align: center;
            font-size: clamp(1rem, 2vw, 1.15rem);
            color: var(--text-medium);
            max-width: 750px;
            margin: 0 auto 3.5rem;
            line-height: 1.7;
        }
        .feature-card {
            background: var(--white);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border: 2px solid var(--border-light);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .feature-card:hover,
        .feature-card:focus-within {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
        }
        
        .feature-icon {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            transition: transform var(--transition-base);
        }
        
        .feature-card:hover .feature-icon {
            transform: scale(1.1) rotate(5deg);
        }
        .testimonial-card {
            background: var(--white);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--accent);
            transition: all var(--transition-base);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .testimonial-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
        }
        
        .testimonial-text {
            font-style: italic;
            color: var(--text-medium);
            margin-bottom: 1.5rem;
            line-height: 1.8;
            font-size: 1.05rem;
        }
        .testimonial-author {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .testimonial-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .why-us-item {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: start;
        }
        .why-us-icon {
            font-size: 2rem;
            color: var(--accent);
            min-width: 50px;
        }
        .dest-detail-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: 0.3s;
            margin-bottom: 30px;
        }
        .dest-detail-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .dest-detail-header {
            height: 250px;
            position: relative;
            overflow: hidden;
        }
        .dest-detail-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .dest-detail-content {
            padding: 30px;
        }
        .dest-highlights {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .dest-highlight {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
        }
        .dest-highlight i {
            color: var(--accent);
        }

        /* --- BUTTONS & FORMS --- */
        .btn {
            display: inline-block; 
            padding: 14px 32px; 
            background-color: var(--primary); 
            color: var(--white); 
            border: 2px solid transparent; 
            border-radius: var(--radius-md); 
            font-weight: 600; 
            font-size: 1rem;
            cursor: pointer; 
            transition: all var(--transition-base);
            font-family: inherit;
            text-align: center;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
        }
        
        .btn:hover,
        .btn:focus { 
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-accent { 
            background-color: var(--accent); 
            color: var(--primary-dark);
            font-weight: 700;
        }
        
        .btn-accent:hover,
        .btn-accent:focus { 
            background-color: var(--accent-dark);
            color: var(--primary-dark);
        }
        
        .btn-outline { 
            background: transparent; 
            border: 2px solid var(--white); 
            color: var(--white);
            box-shadow: none;
        }
        
        .btn-outline:hover,
        .btn-outline:focus { 
            background: var(--white); 
            color: var(--primary);
            border-color: var(--white);
        }
        
        .btn-success { 
            background-color: var(--success);
        }
        
        .btn-success:hover,
        .btn-success:focus { 
            background-color: var(--success-dark);
        }
        
        .btn-danger { 
            background-color: var(--danger);
        }
        
        .btn-danger:hover,
        .btn-danger:focus {
            background-color: var(--danger-dark);
        }
        
        .btn-sm { 
            padding: 8px 16px; 
            font-size: 0.875rem;
        }

        input, select, textarea {
            width: 100%; 
            padding: 14px 16px; 
            margin-bottom: 1rem; 
            border: 2px solid var(--border); 
            border-radius: var(--radius-md); 
            font-family: inherit; 
            font-size: 1rem;
            background: var(--white);
            color: var(--text-dark);
            transition: all var(--transition-fast);
        }
        
        input:focus,
        select:focus,
        textarea:focus { 
            border-color: var(--primary); 
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        
        input::placeholder,
        textarea::placeholder {
            color: var(--text-lighter);
            opacity: 1;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        /* --- DASHBOARDS --- */
        .dashboard-layout { display: grid; grid-template-columns: 280px 1fr; min-height: 80vh; }
        .dash-sidebar { background: var(--primary); color: white; padding: 30px 20px; }
        .dash-main { padding: 40px; background: var(--light); }
        
        .dash-menu-item {
            display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; color: rgba(255,255,255,0.7); border-radius: 6px; margin-bottom: 5px; cursor: pointer;
        }
        .dash-menu-item:hover, .dash-menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .dash-menu-item i { width: 25px; }
        .nav-badge-simple {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .dash-card { 
            background: var(--white); 
            padding: 2rem; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); 
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
            transition: all var(--transition-base);
        }
        
        .dash-card:hover {
            box-shadow: var(--shadow-md);
        }

        /* --- CHAT UI --- */
        .chat-wrapper { display: flex; flex-direction: column; height: 500px; border: 1px solid var(--border); background: white; border-radius: 8px; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: #f8f9fa; }
        .chat-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #fff; }
        .message { max-width: 70%; padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; }
        .msg-in { background-color: #f0f2f5; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-out { background-color: var(--primary-light); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        /* --- DEMO MODE BADGE --- */
        .demo-badge { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: var(--primary); padding: 8px 15px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 999; display: none; }
        .error-message { color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none; }

        /* --- NEW FEATURES STYLES --- */
        /* Notification Center */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            transition: 0.2s;
        }
        .notification-bell:hover { background: rgba(0,43,91,0.1); }
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .notification-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 1001;
            display: none;
            overflow: hidden;
        }
        .notification-panel.active { display: block; }
        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary);
            color: white;
        }
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: 0.2s;
        }
        .notification-item:hover { background: #f8f9fa; }
        .notification-item.unread { background: #e3f2fd; }
        .notification-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
        }
        .notification-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
        }

        /* Status Tracker */
        .status-tracker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 30px 0;
        }
        .status-tracker::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        .status-step {
            flex: 1;
            position: relative;
            z-index: 1;
            text-align: center;
        }
        .status-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: 0.3s;
        }
        .status-step.active .status-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .status-step.completed .status-circle {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        .status-step.completed .status-circle::after {
            content: 'âœ“';
        }
        .status-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }
        .status-step.active .status-label { color: var(--primary); font-weight: 600; }

        /* Test Score Card */
        .test-score-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: 0.2s;
        }
        .test-score-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .test-score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .score-expiry {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .score-expiry.valid { background: #d1e7dd; color: #0f5132; }
        .score-expiry.expiring { background: #fff3cd; color: #856404; }
        .score-expiry.expired { background: #f8d7da; color: #842029; }

        /* Document Checklist */
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: 0.2s;
        }
        .checklist-item:hover { background: #f8f9fa; }
        .checklist-item.completed {
            background: #f0f9ff;
            opacity: 0.8;
        }
        .checklist-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        .checklist-progress {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 15px;
        }
        .checklist-progress-bar {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        /* Task Card */
        .task-card {
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .task-card.priority-high { border-left-color: var(--danger); }
        .task-card.priority-medium { border-left-color: var(--warning); }
        .task-card.priority-low { border-left-color: var(--success); }
        .task-card.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        .task-due-date {
            font-size: 0.8rem;
            color: #999;
        }
        .task-due-date.overdue { color: var(--danger); font-weight: 600; }

        /* Notes Section */
        .notes-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .note-item {
            background: #f8f9fa;
            border-left: 3px solid var(--primary);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .note-date {
            font-size: 0.75rem;
            color: #999;
        }
        .note-tags {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .note-tag {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        /* Appointment Card */
        .appointment-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .appointment-time {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        .appointment-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 8px;
        }
        .appointment-status.scheduled { background: #cfe2ff; color: #084298; }
        .appointment-status.completed { background: #d1e7dd; color: #0f5132; }
        .appointment-status.cancelled { background: #f8d7da; color: #842029; }

        /* Payment Card */
        .payment-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .payment-amount {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        .payment-status.paid { color: var(--success); }
        .payment-status.pending { color: var(--warning); }
        .payment-status.overdue { color: var(--danger); }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 25px;
        }
        .timeline-dot {
            position: absolute;
            left: -25px;
            top: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e0e0e0;
        }
        .timeline-item.completed .timeline-dot {
            background: var(--success);
            border-color: var(--success);
        }
        .timeline-item.active .timeline-dot {
            background: var(--primary);
            border-color: var(--primary);
        }
        .timeline-content {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        .modal-close:hover { color: var(--danger); }

        /* Search & Filter */
        .search-filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .filter-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        /* Email Template */
        .email-template-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        .email-template-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        /* Report Card */
        .report-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .report-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .report-metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .report-metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }
        .report-metric-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* --- TAGS FOR SELECTED UNIVERSITIES --- */
        .uni-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e3f2fd;
            color: #0d47a1;
            padding: 5px 12px;
            border-radius: 20px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .uni-tag i { margin-left: 8px; cursor: pointer; color: #d32f2f; }
        .uni-tag i:hover { color: #b71c1c; }

        /* --- PREVIEW STYLES --- */
        .preview-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .preview-label { font-weight: 600; color: var(--text-light); font-size: 0.9rem; }
        .preview-value { color: var(--primary); font-size: 1rem; font-weight: 500; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .status-draft { background-color: #f0f0f0; color: #666; }
        .status-submitted { background-color: #d1e7dd; color: #0f5132; }

        /* --- COUNSELOR SPECIFIC --- */
        .coun-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .coun-tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 2px solid transparent; }
        .coun-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .coun-tab:hover { background-color: #f9f9f9; }
        
        .student-item { 
            padding: 16px; 
            border-bottom: 1px solid #e5e7eb; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.2s;
            border-radius: 8px;
            margin: 4px;
        }
        .student-item:hover { 
            background-color: #f0f8ff; 
            transform: translateX(2px);
        }
        .student-item.active { 
            background-color: #e0e7ff; 
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .student-item-checkbox { display: flex; align-items: center; gap: 12px; flex: 1; }
        .student-item-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        .student-item-checkbox label { cursor: pointer; flex: 1; margin: 0; }
        .student-item-checkbox .student-info { flex: 1; }
        .student-item-checkbox .student-name { font-weight: 600; color: var(--primary); margin-bottom: 3px; }
        .student-item-checkbox .student-details { font-size: 0.85rem; color: #666; }
        
        .coun-action-btn { background: none; border: none; cursor: pointer; color: #999; padding: 5px; transition:0.2s; }
        .coun-action-btn:hover { color: var(--primary); }
        .coun-action-btn.delete:hover { color: var(--danger); }

        /* --- WORKSPACE DESIGN --- */
        .workspace-layout { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
        .workspace-sidebar { 
            background: linear-gradient(180deg, #1e3a5f 0%, #2c5282 100%); 
            color: white; 
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .workspace-main { 
            padding: 0; 
            background: #f5f7fa; 
            overflow-y: auto;
        }

        .workspace-brand {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        .workspace-logo {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .workspace-nav {
            padding: 0 15px;
        }
        .workspace-nav-item {
            display: block;
            padding: 14px 15px;
            color: rgba(255,255,255,0.8);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .workspace-nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .workspace-nav-item.active {
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: 600;
        }
        .nav-item-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .nav-item-main {
            display: flex;
            align-items: center;
        }
        .workspace-nav-item i {
            width: 24px;
            margin-right: 12px;
        }
        .nav-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            align-self: flex-start;
            margin-left: 36px;
        }

        .workspace-header {
            background: white;
            padding: 30px 40px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workspace-stats {
            display: flex;
            gap: 20px;
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            min-width: 140px;
        }
        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .stat-info {
            flex: 1;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .workspace-content {
            padding: 30px 40px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        .workspace-panel-left, .workspace-panel-right {
            min-width: 0;
        }

        .workspace-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .workspace-card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }
        .workspace-card-body {
            padding: 0;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        .workspace-list {
            padding: 8px;
        }

        .workspace-empty-state {
            background: white;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
            color: #9ca3af;
        }
        .workspace-empty-state h3 {
            margin: 0 0 10px 0;
            color: #1a1a1a;
            font-size: 1.3rem;
        }
        .workspace-empty-state p {
            color: #6b7280;
            margin: 8px 0;
            line-height: 1.6;
        }
        .empty-state-hint {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 15px;
        }

        .workspace-student-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .student-header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .student-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        .student-header-info h2 {
            color: white;
        }
        .student-header-info p {
            color: rgba(255,255,255,0.9);
        }
        .student-header-meta {
            text-align: right;
        }
        .status-badge-modern {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 8px;
        }
        .badge-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }
        .last-updated {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            margin: 0;
        }

        .workspace-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: #fafbfc;
            padding: 0 24px;
        }
        .workspace-tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
            top: 2px;
        }
        .workspace-tab:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .workspace-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        .tab-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 4px;
        }

        .workspace-tab-content {
            padding: 30px;
        }
        .profile-section {
            margin-bottom: 30px;
        }
        .section-title {
            color: #1a1a1a;
            margin: 0 0 12px 0;
            font-size: 1.2rem;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title i {
            color: var(--primary);
        }
        .section-description {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .profile-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .info-field {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .info-field:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        .info-label {
            font-size: 0.8rem;
            color: #6b7280;
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .info-label i {
            margin-right: 6px;
            color: #9ca3af;
        }
        .info-value {
            margin: 0;
            font-weight: 500;
            color: #1a1a1a;
            font-size: 0.95rem;
        }
        .highlight-field {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #bfdbfe;
        }
        .highlight-value {
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }
        .highlight-value-accent {
            color: var(--accent);
            font-weight: 600;
            font-size: 1.1rem;
        }
        .milestone-field {
            background: #fff7ed;
            border-color: #fed7aa;
        }
        .milestone-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .milestone-select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        .milestone-btn {
            padding: 10px 16px;
            border-radius: 6px;
        }
        .current-milestone {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6b7280;
        }
        .unis-list {
            margin-top: 8px;
        }
        .empty-text {
            color: #9ca3af;
            font-style: italic;
        }

        .docs-list {
            margin-top: 20px;
        }
        .empty-docs {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        .empty-docs i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        .empty-docs p {
            font-style: italic;
        }

        .workspace-chat {
            height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .workspace-chat-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .chat-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .chat-header-info {
            flex: 1;
        }
        .chat-header-info strong {
            display: block;
            color: white;
            margin-bottom: 4px;
        }
        .chat-status {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.9);
        }
        .chat-status i {
            font-size: 0.5rem;
            color: #10b981;
            margin-right: 4px;
        }
        .workspace-chat-body {
            background: #f9fafb;
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        .workspace-chat-footer {
            background: white;
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .chat-input {
            flex: 1;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            border-radius: 24px;
            padding: 12px 20px;
            font-size: 0.95rem;
            outline: none;
        }
        .chat-input:focus {
            border-color: var(--primary);
            background: white;
        }
        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chat-send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .workspace-btn {
            border-radius: 6px;
            font-weight: 500;
        }

        /* --- WIZARD STEPS --- */
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; max-width: 600px; margin-left: auto; margin-right: auto; }
        .step-indicator::before { content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 2px; background: #eee; z-index: 0; }
        .step { position: relative; z-index: 1; background: white; padding: 0 10px; text-align: center; width: 33%; }
        .step-circle { width: 32px; height: 32px; background: #eee; color: #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-weight: bold; transition: 0.3s; border: 2px solid white; }
        .step.active .step-circle { background: var(--primary); color: white; border-color: var(--accent); }
        .step.completed .step-circle { background: var(--success); color: white; }
        .step-label { font-size: 0.8rem; color: #666; font-weight: 500; }
        .step.active .step-label { color: var(--primary); font-weight: 700; }

        .wizard-content { display: none; animation: fadeIn 0.4s; }
        .wizard-content.active { display: block; }

        /* --- GREEN LIGHT INDICATOR --- */
        .doc-status-light { width: 12px; height: 12px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 10px; vertical-align: middle; transition: 0.3s; }
        .doc-uploaded .doc-status-light { background: var(--success); box-shadow: 0 0 8px var(--success); transform: scale(1.2); }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 { margin: 0; color: var(--primary); }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { color: var(--danger); }
        .modal-student-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-student-item:hover {
            background: #f8f9fa;
            border-color: var(--primary);
        }
        .modal-student-item .student-info {
            flex: 1;
        }
        .modal-student-item .student-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        .modal-student-item .student-details {
            font-size: 0.85rem;
            color: #666;
        }

        /* === NEW FEATURES STYLES === */
        
        /* Eligibility Checker */
        .eligibility-checker {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 12px;
            padding: 40px;
            color: white;
            margin: 40px 0;
        }
        .eligibility-form {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-top: 20px;
        }
        .eligibility-form input,
        .eligibility-form select {
            background: white;
            color: var(--text-dark);
        }
        .eligibility-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        .eligibility-result.success {
            background: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid var(--success);
        }
        .eligibility-result.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning);
        }
        .eligibility-result.info {
            background: #cfe2ff;
            color: #084298;
            border-left: 4px solid var(--primary);
        }

        /* Cost Calculator */
        .cost-calculator {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin: 40px 0;
        }
        .calc-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .calc-result {
            background: var(--light);
            padding: 25px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--accent);
        }
        .calc-total {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        .calc-breakdown {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .calc-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: var(--text-light);
        }

        /* FAQ Accordion */
        .faq-container {
            margin: 40px 0;
        }
        .faq-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: 0.3s;
        }
        .faq-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .faq-question {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--primary);
            transition: 0.2s;
        }
        .faq-question:hover {
            background: var(--light);
        }
        .faq-question i {
            transition: transform 0.3s;
            color: var(--accent);
        }
        .faq-item.active .faq-question i {
            transform: rotate(180deg);
        }
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 20px;
        }
        .faq-item.active .faq-answer {
            max-height: 500px;
            padding: 0 20px 20px 20px;
        }
        .faq-answer-content {
            color: var(--text-light);
            line-height: 1.8;
        }

        /* Blog Hero Section */
        .blog-hero-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 5rem 0;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }
        
        .blog-hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .blog-hero-section .container {
            position: relative;
            z-index: 1;
        }
        
        .blog-hero-icon {
            font-size: 3.5rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .blog-hero-title {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: -0.02em;
            color: white;
        }
        
        .blog-hero-subtitle {
            opacity: 0.95;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
            color: rgba(255,255,255,0.95);
        }

        /* Blog/Resources Preview */
        .blog-preview {
            margin: 40px 0;
        }
        .blog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .blog-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: 0.3s;
            cursor: pointer;
        }
        .blog-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .blog-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .blog-card-content {
            padding: 20px;
        }
        .blog-card-tag {
            display: inline-block;
            background: var(--accent);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .blog-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .blog-card-excerpt {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .blog-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Application Deadline Countdown */
        .deadline-countdown {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border-radius: 12px;
            padding: 30px;
            color: white;
            margin: 40px 0;
            text-align: center;
        }
        .deadline-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px;
            display: inline-block;
            min-width: 120px;
        }
        .deadline-item h3 {
            color: var(--primary);
            font-size: 2rem;
            margin: 0;
        }
        .deadline-item p {
            color: var(--text-light);
            margin: 5px 0 0 0;
            font-size: 0.9rem;
        }
        .deadline-university {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .deadline-date {
            color: var(--danger);
            font-weight: 600;
        }


        /* Document Checklist Generator */
        .checklist-generator {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin: 40px 0;
        }
        .checklist-selector {
            margin-bottom: 25px;
        }
        .checklist-items-container {
            margin-top: 20px;
        }
        .checklist-generator-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: 0.2s;
        }
        .checklist-generator-item:hover {
            background: var(--light);
            border-color: var(--primary);
        }
        .checklist-generator-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        .checklist-generator-item.completed {
            background: #d1e7dd;
            opacity: 0.8;
        }
        .checklist-generator-item.completed label {
            text-decoration: line-through;
            color: var(--text-light);
        }
        .checklist-print-btn {
            margin-top: 20px;
        }

        /* Blog Detail Page Styles */
        .blog-detail-article {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 0;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .blog-detail-header {
            padding: 3rem 3rem 2rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .blog-detail-meta {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .blog-detail-category {
            background: var(--accent);
            color: var(--primary-dark);
            padding: 6px 16px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .blog-detail-date,
        .blog-detail-read-time {
            color: var(--text-light);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .blog-detail-date i,
        .blog-detail-read-time i {
            color: var(--primary);
        }
        
        .blog-detail-title {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            color: var(--primary);
            margin: 0 0 1rem 0;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }
        
        .blog-detail-excerpt {
            font-size: 1.25rem;
            color: var(--text-medium);
            line-height: 1.7;
            margin: 0;
            font-weight: 400;
        }
        
        .blog-detail-image {
            width: 100%;
            max-height: 500px;
            overflow: hidden;
            margin: 0;
        }
        
        .blog-detail-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .blog-detail-content {
            padding: 3rem;
            font-size: 1.1rem;
            line-height: 1.9;
            color: var(--text-dark);
        }
        
        .blog-detail-content h2 {
            font-size: 2rem;
            color: var(--primary);
            margin: 2.5rem 0 1rem;
            font-weight: 700;
        }
        
        .blog-detail-content h3 {
            font-size: 1.5rem;
            color: var(--primary);
            margin: 2rem 0 0.75rem;
            font-weight: 600;
        }
        
        .blog-detail-content p {
            margin-bottom: 1.5rem;
            color: var(--text-dark);
            font-size: 1.1rem;
            line-height: 1.9;
        }
        
        .blog-detail-content ul,
        .blog-detail-content ol {
            margin: 1.5rem 0;
            padding-left: 2rem;
            color: var(--text-dark);
        }
        
        .blog-detail-content li {
            margin-bottom: 0.75rem;
            line-height: 1.8;
        }
        
        .blog-detail-content a {
            color: var(--primary);
            text-decoration: underline;
            font-weight: 600;
        }
        
        .blog-detail-content a:hover {
            color: var(--primary-dark);
        }
        
        .blog-detail-content blockquote {
            border-left: 4px solid var(--accent);
            padding-left: 1.5rem;
            margin: 2rem 0;
            font-style: italic;
            color: var(--text-medium);
            background: var(--off-white);
            padding: 1.5rem;
            border-radius: var(--radius-md);
        }
        
        .blog-detail-content img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-md);
            margin: 2rem 0;
        }
        
        .blog-detail-content code {
            background: var(--light);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--primary);
        }
        
        .blog-detail-content pre {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        
        .blog-detail-footer {
            padding: 0 3rem 3rem;
        }

        @media (max-width: 768px) {
            .calc-input-group {
                grid-template-columns: 1fr;
            }
            .deadline-item {
                min-width: 100px;
                margin: 10px 5px;
            }
            .chat-window {
                width: 100%;
                height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }
            .blog-grid {
                grid-template-columns: 1fr;
            }
            .blog-card-image-wrapper {
                height: 180px;
            }
            .blog-hero-section {
                padding: 3rem 0;
            }
            .blog-hero-icon {
                font-size: 2.5rem;
            }
            .blog-hero-title {
                font-size: 2rem;
            }
            .blog-hero-subtitle {
                font-size: 1rem;
            }
            .blog-detail-header {
                padding: 2rem 1.5rem 1.5rem;
            }
            .blog-detail-content {
                padding: 2rem 1.5rem;
                font-size: 1rem;
            }
            .blog-detail-footer {
                padding: 0 1.5rem 2rem;
            }
            .blog-detail-title {
                font-size: 1.75rem;
            }
            .blog-detail-excerpt {
                font-size: 1.1rem;
            }
        }

        /* --- ACCESSIBILITY IMPROVEMENTS --- */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border: #000000;
                --text-light: #000000;
            }
        }
        
        /* Print styles */
        @media print {
            header, nav, .blog-detail-footer button, .btn {
                display: none !important;
            }
            .blog-detail-article {
                box-shadow: none !important;
                border: none !important;
            }
            .blog-detail-header, .blog-detail-content, .blog-detail-footer {
                padding: 1rem !important;
            }
            .blog-detail-image img {
                max-height: 400px !important;
            }
            body {
                background: white !important;
            }
            .section {
                padding: 0 !important;
            }
        }
        
        /* Share Modal Styles */
        .share-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .share-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .share-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .share-modal-header h3 {
            margin: 0;
            color: var(--primary);
        }
        
        .share-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .share-modal-close:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        .share-modal-body {
            padding: 1.5rem;
        }
        
        .share-modal-body p {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }
        
        .share-social-links {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .share-social-links .btn {
            flex: 1;
            min-width: 100px;
        }
        
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10001;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            max-width: 300px;
        }
        
        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast-success {
            background: var(--success);
        }
        
        .toast-error {
            background: var(--danger);
        }
        
        .toast-info {
            background: var(--primary);
        }

    </style>
</head>
<body>
    <!-- Skip to main content link for screen readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- SAFETY SCRIPT -->
    <script>
        function scriptError() {
            alert("âš ï¸ SCRIPT ERROR: The application logic failed to load.\nPlease use 'Live Server' in VS Code.");
        }
        window.router = scriptError;
        window.handleLogin = scriptError;
        window.handleSignup = scriptError;
        window.handleLogout = scriptError;
        window.startDemoMode = scriptError;
        window.handleUpload = scriptError;
        window.sendMessage = scriptError;
        window.selectStudent = scriptError;
        window.handleAddUniversity = scriptError;
        window.saveApplication = scriptError;
        window.editApplication = scriptError;
        window.submitApplication = scriptError;
        window.renderStudentList = scriptError;
        window.switchCounselorTab = scriptError;
        window.addStudent = scriptError;
        window.deleteStudent = scriptError;
        window.archiveStudent = scriptError;
        window.updateProfile = scriptError;
        window.goToStep = scriptError;
    </script>

    <!-- NAVIGATION -->
    <header>
        <div class="logo">
            <i class="fas fa-graduation-cap"></i> GLOBAL EDU NEPAL
        </div>
        <nav id="public-nav">
            <button onclick="router('home')" class="active">Home</button>
            <button onclick="router('services')">Services</button>
            <button onclick="router('destinations')">Destinations</button>
            <button onclick="router('blogs')">Blog</button>
            <button onclick="router('contact')">Contact</button>
            <button onclick="router('auth', 'student')" class="nav-cta">Login</button>
        </nav>
        <nav id="private-nav" style="display: none;">
            <div class="notification-bell" onclick="toggleNotificationPanel()" style="position: relative;">
                <i class="fas fa-bell" style="font-size: 1.2rem; color: var(--primary);"></i>
                <span class="notification-badge" id="notification-count" style="display: none;">0</span>
            </div>
            <span id="user-display" style="font-weight: 600; color: var(--primary);"></span>
            <button onclick="handleLogout()" class="logout-btn">Logout</button>
        </nav>
        
        <!-- Notification Panel -->
        <div id="notification-panel" class="notification-panel">
            <div class="notification-header">
                <h4 style="margin: 0; color: white;"><i class="fas fa-bell"></i> Notifications</h4>
                <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: white; cursor: pointer; font-size: 0.85rem;">Mark all read</button>
            </div>
            <div id="notification-list" class="notification-list">
                <div style="padding: 40px; text-align: center; color: #999;">
                    <i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>No notifications</p>
                </div>
            </div>
        </div>
    </header>

    <!-- DEMO BADGE -->
    <div id="demo-badge" class="demo-badge"><i class="fas fa-flask"></i> Demo Mode Active</div>

    <!-- ADD STUDENT MODAL -->
    <div id="add-student-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Select Student to Add</h3>
                <button class="modal-close" onclick="closeAddStudentModal()">&times;</button>
            </div>
            <div id="available-students-list">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Loading available students...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- === HOME PAGE === -->
    <main id="main-content">
    <div id="page-home" class="section active">
        <div class="hero">
            <div class="container">
                <h1>Turn Your Dream of Studying<br>Abroad Into Reality</h1>
                <p>We provide expert guidance for students in Nepal looking to study in Canada, USA, UK, and Australia. Your future begins with the right counseling.</p>
                <div>
                    <button class="btn btn-accent" onclick="router('auth', 'student')">Apply Now</button>
                    <button class="btn btn-outline" onclick="router('services')">Our Services</button>
                </div>

                <div class="hero-stats">
                    <div class="stat-item">
                        <h3>10k+</h3>
                        <p>Students Placed</p>
                    </div>
                    <div class="stat-item">
                        <h3>98%</h3>
                        <p>Visa Success Rate</p>
                    </div>
                    <div class="stat-item">
                        <h3>500+</h3>
                        <p>Partner Universities</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Application Deadline Countdown -->
        <div class="container">
            <div class="deadline-countdown">
                <h2 style="color: white; margin-bottom: 20px;"><i class="fas fa-clock"></i> Upcoming Application Deadlines</h2>
                <div id="deadline-countdown-container">
                    <div class="deadline-item">
                        <div class="deadline-university">University of Toronto</div>
                        <div class="deadline-date">Jan 15, 2025</div>
                        <div id="deadline-1" style="margin-top: 10px;"></div>
                    </div>
                    <div class="deadline-item">
                        <div class="deadline-university">University of Melbourne</div>
                        <div class="deadline-date">Feb 1, 2025</div>
                        <div id="deadline-2" style="margin-top: 10px;"></div>
                    </div>
                    <div class="deadline-item">
                        <div class="deadline-university">Imperial College London</div>
                        <div class="deadline-date">Jan 31, 2025</div>
                        <div id="deadline-3" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <button class="btn btn-accent" onclick="router('destinations')" style="margin-top: 20px;">View All Universities</button>
            </div>
        </div>

        <!-- Popular Destinations Section -->
        <div class="container marketing-section">
            <h2 class="section-title">Popular Destinations</h2>
            <p class="section-subtitle">Explore world-class education opportunities in top study destinations</p>
            <div class="grid-4">
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1517935706615-2717063c2225?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="Canada">
                    <div class="dest-overlay"><h3>Canada</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">Top Quality Education</p></div>
                </div>
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="UK">
                    <div class="dest-overlay"><h3>United Kingdom</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">Prestigious Universities</p></div>
                </div>
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1525026198548-4baa812f1183?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="USA">
                    <div class="dest-overlay"><h3>United States</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">World's Best Programs</p></div>
                </div>
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1506973035872-a4ec16b8e8d9?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="Australia">
                    <div class="dest-overlay"><h3>Australia</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">Vibrant Student Life</p></div>
                </div>
            </div>
        </div>

        <!-- Why Choose Us Section -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Why Choose Global Edu Nepal?</h2>
            <p class="section-subtitle">We are committed to making your study abroad journey smooth and successful</p>
            <div class="grid-3">
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-user-graduate"></i></div>
                    <div>
                        <h3 style="margin-top:0;">Expert Counselors</h3>
                        <p>Our experienced team provides personalized guidance tailored to your academic goals and career aspirations.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-check-circle"></i></div>
                    <div>
                        <h3 style="margin-top:0;">98% Visa Success Rate</h3>
                        <p>We have a proven track record of helping students secure visas with comprehensive documentation support.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-handshake"></i></div>
                    <div>
                        <h3 style="margin-top:0;">500+ Partner Universities</h3>
                        <p>Extensive network of accredited institutions across Canada, USA, UK, and Australia.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div>
                        <h3 style="margin-top:0;">Transparent Pricing</h3>
                        <p>No hidden fees. Clear, upfront pricing with flexible payment options for all our services.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-headset"></i></div>
                    <div>
                        <h3 style="margin-top:0;">24/7 Support</h3>
                        <p>Round-the-clock assistance for all your queries, from application to post-arrival support.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-book-reader"></i></div>
                    <div>
                        <h3 style="margin-top:0;">Test Preparation</h3>
                        <p>Comprehensive IELTS, PTE, and TOEFL training to help you achieve your target scores.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Our Services Preview -->
        <div class="container marketing-section">
            <h2 class="section-title">Our Services</h2>
            <p class="section-subtitle">End-to-end support for your complete study abroad journey</p>
            <div class="grid-3">
                <div class="feature-card">
                    <i class="fas fa-university feature-icon"></i>
                    <h3>University Selection</h3>
                    <p>Expert guidance to choose the right university and program that matches your career goals and budget.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-file-alt feature-icon"></i>
                    <h3>Application Support</h3>
                    <p>Complete assistance with application forms, essays, recommendation letters, and all required documentation.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-passport feature-icon"></i>
                    <h3>Visa Processing</h3>
                    <p>Professional visa guidance including document preparation, interview coaching, and financial statement support.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-book-open feature-icon"></i>
                    <h3>Test Preparation</h3>
                    <p>Structured classes for IELTS, PTE, TOEFL, and GRE/GMAT with practice tests and personalized feedback.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-plane feature-icon"></i>
                    <h3>Pre-Departure Briefing</h3>
                    <p>Essential information about your destination country, accommodation, banking, and student life preparation.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-heart feature-icon"></i>
                    <h3>Post-Arrival Support</h3>
                    <p>Continued assistance after you arrive, helping you settle in and navigate your new academic environment.</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-accent" onclick="router('services')">View All Services</button>
            </div>
        </div>

        <!-- Blog Section -->
        <div class="container marketing-section">
            <div class="text-center mb-5">
                <h2 class="section-title mb-3">Latest Blog Posts</h2>
                <p class="section-subtitle text-muted">Stay informed with our latest articles, guides, and study abroad insights</p>
            </div>
            <div id="home-blogs-container" class="row g-4">
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading blog posts...</p>
                </div>
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-accent btn-lg" onclick="router('blogs')">
                    <i class="fas fa-arrow-right me-2"></i>View All Blog Posts
                </button>
            </div>
        </div>

        <!-- Testimonials Section -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Success Stories</h2>
            <p class="section-subtitle">Hear from students who achieved their dreams with our help</p>
            <div class="grid-3">
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "Global Edu Nepal made my dream of studying in Canada come true. Their counselors were patient, professional, and guided me through every step. I'm now pursuing my Master's at University of Toronto!"
                    </div>
                    <div class="testimonial-author">
                        <div class="testimonial-avatar">SP</div>
                        <div>
                            <strong>Sarita Pandey</strong><br>
                            <small style="color: var(--text-light);">University of Toronto, Canada</small>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "The visa process seemed overwhelming, but the team at Global Edu Nepal handled everything perfectly. Their attention to detail and expertise resulted in a successful visa approval. Highly recommended!"
                    </div>
                    <div class="testimonial-author">
                        <div class="testimonial-avatar">RK</div>
                        <div>
                            <strong>Rajesh Kumar</strong><br>
                            <small style="color: var(--text-light);">University of Melbourne, Australia</small>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "From test preparation to university selection and visa processing, Global Edu Nepal provided comprehensive support. I'm grateful for their dedication in helping me secure admission to a top UK university."
                    </div>
                    <div class="testimonial-author">
                        <div class="testimonial-avatar">PM</div>
                        <div>
                            <strong>Priya Maharjan</strong><br>
                            <small style="color: var(--text-light);">University of Manchester, UK</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQ Accordion Section -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <p class="section-subtitle">Get answers to common questions about studying abroad</p>
            <div class="faq-container">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>What documents do I need to apply for a student visa?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            You'll typically need: valid passport, acceptance letter from university, proof of financial support, IELTS/TOEFL scores, academic transcripts, medical examination report, and a statement of purpose. Requirements may vary by country.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>How long does the visa processing take?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Processing times vary by country: Canada (4-8 weeks), UK (3-6 weeks), USA (2-4 months), Australia (4-8 weeks). We recommend applying at least 3-4 months before your program start date.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>What is the minimum IELTS score required?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Minimum IELTS scores vary by country and program: Canada (6.0-7.0), UK (6.0-7.5), USA (6.5-7.5), Australia (6.0-7.0). Some universities may accept PTE or TOEFL as alternatives.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Can I work while studying abroad?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Yes, most countries allow international students to work part-time (typically 20 hours/week during studies, full-time during breaks). Canada, UK, USA, and Australia all have work permit options for students.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>What are the total costs including tuition and living expenses?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Total costs vary by country: Canada (CAD $25,000-$50,000/year), UK (Â£22,000-$50,000/year), USA ($32,000-$80,000/year), Australia (AUD $35,000-$65,000/year). Use our cost calculator above for accurate estimates.
                        </div>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Do you help with scholarship applications?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Yes! We help identify scholarship opportunities, prepare scholarship applications, and provide guidance on eligibility requirements. Many universities offer merit-based and need-based scholarships for international students.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CTA Section -->
        <div class="container marketing-section" style="text-align: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; padding: 60px 40px; color: white;">
            <h2 style="color: white; font-size: 2.5rem; margin-bottom: 20px;">Ready to Start Your Journey?</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 1.2rem; max-width: 600px; margin: 0 auto 40px;">
                Join thousands of successful students who have achieved their study abroad dreams with Global Edu Nepal
            </p>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Apply Now</button>
                <button class="btn btn-outline" onclick="router('contact')" style="font-size: 1.1rem; padding: 16px 40px;">Contact Us</button>
            </div>
        </div>
    </div>
    </main>

    <!-- === DESTINATIONS PAGE === -->
    <div id="page-destinations" class="section">
        <div class="container" style="padding-top: 60px;">
            <div style="text-align: center; margin-bottom: 60px;">
                <h1 class="section-title">Study Destinations</h1>
                <p class="section-subtitle">Discover world-class education opportunities in top study destinations around the globe</p>
            </div>

            <!-- Canada -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1517935706615-2717063c2225?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Canada">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> Canada</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        Canada is one of the most popular study destinations for international students, offering high-quality education, 
                        multicultural environment, and excellent post-graduation opportunities. With world-renowned universities and 
                        a welcoming atmosphere, Canada provides an ideal setting for academic and personal growth.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> University of Toronto, McGill University, UBC</div>
                        <div class="dest-highlight"><i class="fas fa-dollar-sign"></i> <strong>Tuition:</strong> CAD $15,000 - $35,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> CAD $10,000 - $15,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> Up to 3 years post-graduation</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English & French</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>IELTS:</strong> 6.0 - 7.0 required</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in Canada?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>High-quality education recognized worldwide</li>
                            <li>Safe and multicultural society</li>
                            <li>Post-graduation work permit (PGWP) opportunities</li>
                            <li>Pathway to permanent residency</li>
                            <li>Affordable tuition fees compared to other countries</li>
                            <li>Beautiful landscapes and high quality of life</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for Canada</button>
                    </div>
                </div>
            </div>

            <!-- United Kingdom -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="United Kingdom">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> United Kingdom</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        The UK is home to some of the world's oldest and most prestigious universities. With a rich academic heritage, 
                        innovative research opportunities, and shorter degree programs, the UK offers an excellent education system 
                        that is respected globally. Students benefit from world-class facilities and a vibrant cultural experience.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> Oxford, Cambridge, Imperial College, LSE</div>
                        <div class="dest-highlight"><i class="fas fa-pound-sign"></i> <strong>Tuition:</strong> Â£12,000 - Â£35,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> Â£10,000 - Â£15,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> 2 years post-graduation (Graduate Route)</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>IELTS:</strong> 6.0 - 7.5 required</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in the UK?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>World-renowned universities with excellent reputation</li>
                            <li>Shorter degree programs (3 years for Bachelor's, 1 year for Master's)</li>
                            <li>Rich cultural heritage and diverse student community</li>
                            <li>Strong research opportunities and industry connections</li>
                            <li>Graduate Route visa allows 2 years of work after graduation</li>
                            <li>Gateway to Europe and global career opportunities</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for UK</button>
                    </div>
                </div>
            </div>

            <!-- United States -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1525026198548-4baa812f1183?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="United States">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> United States</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        The United States boasts the largest number of top-ranked universities in the world. With cutting-edge research facilities, 
                        flexible curriculum, and diverse academic programs, the US offers unparalleled educational opportunities. 
                        Students can choose from thousands of institutions and programs tailored to their interests.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> MIT, Harvard, Stanford, UC Berkeley</div>
                        <div class="dest-highlight"><i class="fas fa-dollar-sign"></i> <strong>Tuition:</strong> $20,000 - $60,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> $12,000 - $20,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> OPT (12-36 months post-graduation)</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>TOEFL/IELTS:</strong> 80-100 (TOEFL) / 6.5-7.5 (IELTS)</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in the USA?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>World's best universities and research facilities</li>
                            <li>Flexible education system with diverse course options</li>
                            <li>Strong industry connections and internship opportunities</li>
                            <li>Optional Practical Training (OPT) for work experience</li>
                            <li>Innovation and entrepreneurship culture</li>
                            <li>Global recognition of US degrees</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for USA</button>
                    </div>
                </div>
            </div>

            <!-- Australia -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1506973035872-a4ec16b8e8d9?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Australia">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> Australia</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        Australia offers a perfect blend of high-quality education, stunning natural beauty, and a relaxed lifestyle. 
                        With world-class universities, excellent student support services, and a strong focus on research and innovation, 
                        Australia provides an ideal environment for international students to thrive academically and personally.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> ANU, University of Melbourne, University of Sydney</div>
                        <div class="dest-highlight"><i class="fas fa-dollar-sign"></i> <strong>Tuition:</strong> AUD $20,000 - $45,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> AUD $15,000 - $20,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> 2-4 years post-graduation</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>IELTS:</strong> 6.0 - 7.0 required</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in Australia?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>World-class education system with excellent student support</li>
                            <li>Beautiful landscapes and high quality of life</li>
                            <li>Post-study work rights (2-4 years depending on degree)</li>
                            <li>Strong pathway to permanent residency</li>
                            <li>Multicultural society with welcoming environment</li>
                            <li>Excellent research opportunities and modern facilities</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for Australia</button>
                    </div>
                </div>
            </div>

            <!-- Comparison Table -->
            <div class="dash-card" style="margin-top: 60px;">
                <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">Quick Comparison</h2>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--primary); color: white;">
                                <th style="padding: 15px; text-align: left;">Country</th>
                                <th style="padding: 15px; text-align: left;">Avg. Tuition/Year</th>
                                <th style="padding: 15px; text-align: left;">Living Cost/Year</th>
                                <th style="padding: 15px; text-align: left;">Work Permit</th>
                                <th style="padding: 15px; text-align: left;">IELTS Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">Canada</td>
                                <td style="padding: 15px;">CAD $15,000 - $35,000</td>
                                <td style="padding: 15px;">CAD $10,000 - $15,000</td>
                                <td style="padding: 15px;">Up to 3 years</td>
                                <td style="padding: 15px;">6.0 - 7.0</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">United Kingdom</td>
                                <td style="padding: 15px;">Â£12,000 - Â£35,000</td>
                                <td style="padding: 15px;">Â£10,000 - Â£15,000</td>
                                <td style="padding: 15px;">2 years</td>
                                <td style="padding: 15px;">6.0 - 7.5</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">United States</td>
                                <td style="padding: 15px;">$20,000 - $60,000</td>
                                <td style="padding: 15px;">$12,000 - $20,000</td>
                                <td style="padding: 15px;">12-36 months (OPT)</td>
                                <td style="padding: 15px;">6.5 - 7.5</td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">Australia</td>
                                <td style="padding: 15px;">AUD $20,000 - $45,000</td>
                                <td style="padding: 15px;">AUD $15,000 - $20,000</td>
                                <td style="padding: 15px;">2-4 years</td>
                                <td style="padding: 15px;">6.0 - 7.0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cost Calculator -->
            <div class="container marketing-section">
                <h2 class="section-title">Calculate Your Study Costs</h2>
                <p class="section-subtitle">Estimate your total expenses for studying in your chosen destination</p>
                <div class="cost-calculator">
                    <div class="calc-input-group">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Destination Country</label>
                            <select id="calc-country-dest" onchange="updateCostCalculatorDest()" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                                <option value="">Select Country</option>
                                <option value="canada">Canada</option>
                                <option value="uk">United Kingdom</option>
                                <option value="usa">United States</option>
                                <option value="australia">Australia</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Program Duration (years)</label>
                            <input type="number" id="calc-duration-dest" onchange="updateCostCalculatorDest()" placeholder="e.g., 2" min="1" max="5" value="2" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                        </div>
                    </div>
                    <div class="calc-input-group">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Annual Tuition Fee</label>
                            <input type="number" id="calc-tuition-dest" onchange="updateCostCalculatorDest()" placeholder="Enter tuition fee" min="0" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Monthly Living Expenses</label>
                            <input type="number" id="calc-living-dest" onchange="updateCostCalculatorDest()" placeholder="Enter monthly living cost" min="0" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                        </div>
                    </div>
                    <div id="calc-result-dest" class="calc-result" style="display: none;">
                        <h3 style="margin-top: 0; color: var(--primary);">Estimated Total Cost</h3>
                        <div class="calc-total" id="calc-total-dest">$0</div>
                        <div class="calc-breakdown">
                            <div class="calc-breakdown-item">
                                <span>Total Tuition Fees:</span>
                                <strong id="calc-tuition-total-dest">$0</strong>
                            </div>
                            <div class="calc-breakdown-item">
                                <span>Total Living Expenses:</span>
                                <strong id="calc-living-total-dest">$0</strong>
                            </div>
                            <div class="calc-breakdown-item" style="border-top: 2px solid var(--border); padding-top: 10px; margin-top: 10px; font-size: 1.1rem;">
                                <span><strong>Grand Total:</strong></span>
                                <strong id="calc-grand-total-dest" style="color: var(--primary);">$0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA Section -->
            <div style="text-align: center; margin-top: 60px; padding: 50px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; color: white;">
                <h2 style="color: white; margin-bottom: 20px;">Ready to Choose Your Destination?</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; max-width: 600px; margin: 0 auto 30px;">
                    Our expert counselors will help you select the perfect destination and university based on your goals, budget, and preferences.
                </p>
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Start Your Application</button>
            </div>
        </div>
    </div>

    <!-- === SERVICES PAGE === -->
    <div id="page-services" class="section" style="padding-top: 0;">
        <!-- Hero Section -->
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 100px 0; text-align: center;">
            <div class="container">
                <h1 style="color: white; font-size: 3.5rem; margin-bottom: 20px;">Our Comprehensive Services</h1>
                <p style="color: rgba(255,255,255,0.9); font-size: 1.3rem; max-width: 800px; margin: 0 auto 40px;">
                    From university selection to post-arrival support, we guide you through every step of your study abroad journey
                </p>
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Get Started Today</button>
            </div>
        </div>

        <!-- Main Services -->
        <div class="container marketing-section">
            <h2 class="section-title">What We Offer</h2>
            <p class="section-subtitle">Comprehensive support services designed to maximize your success</p>
            
            <div class="grid-3">
                <div class="feature-card" style="border-top: 4px solid var(--primary);">
                    <i class="fas fa-university feature-icon" style="color: var(--primary);"></i>
                    <h3>University Selection & Admission</h3>
                    <p style="margin-bottom: 20px;">Expert guidance to choose the perfect university and program that aligns with your career aspirations and financial capacity.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Personalized university matching</li>
                        <li>Program and course recommendations</li>
                        <li>Scholarship opportunities research</li>
                        <li>Application deadline management</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid var(--accent);">
                    <i class="fas fa-file-alt feature-icon" style="color: var(--accent);"></i>
                    <h3>Application Support</h3>
                    <p style="margin-bottom: 20px;">Complete assistance with all application requirements to ensure your submission stands out.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Application form completion</li>
                        <li>Statement of Purpose (SOP) writing</li>
                        <li>Recommendation letter guidance</li>
                        <li>Document verification & compilation</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid var(--success);">
                    <i class="fas fa-passport feature-icon" style="color: var(--success);"></i>
                    <h3>Visa Processing & Guidance</h3>
                    <p style="margin-bottom: 20px;">Professional visa assistance with a 98% success rate to help you secure your study visa.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Visa document preparation</li>
                        <li>Financial statement support</li>
                        <li>Interview coaching & preparation</li>
                        <li>Application submission & tracking</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid #007bff;">
                    <i class="fas fa-book-open feature-icon" style="color: #007bff;"></i>
                    <h3>Test Preparation</h3>
                    <p style="margin-bottom: 20px;">Comprehensive test preparation courses to help you achieve your target scores for IELTS, PTE, TOEFL, and more.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>IELTS/PTE/TOEFL training</li>
                        <li>GRE/GMAT preparation</li>
                        <li>Mock tests & practice sessions</li>
                        <li>Personalized feedback & improvement</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid #ff6b6b;">
                    <i class="fas fa-plane feature-icon" style="color: #ff6b6b;"></i>
                    <h3>Pre-Departure Briefing</h3>
                    <p style="margin-bottom: 20px;">Essential information and guidance to prepare you for life in your new country.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Country & culture orientation</li>
                        <li>Accommodation assistance</li>
                        <li>Banking & finance setup</li>
                        <li>Travel & packing guidance</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid #9b59b6;">
                    <i class="fas fa-heart feature-icon" style="color: #9b59b6;"></i>
                    <h3>Post-Arrival Support</h3>
                    <p style="margin-bottom: 20px;">Continued assistance after you arrive to help you settle in smoothly.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Airport pickup coordination</li>
                        <li>Accommodation assistance</li>
                        <li>Student life guidance</li>
                        <li>Ongoing counseling support</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Process Timeline -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Our Process</h2>
            <p class="section-subtitle">A simple, step-by-step journey to your dream university</p>
            
            <div style="max-width: 900px; margin: 0 auto; position: relative;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-top: 50px;">
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(0,43,91,0.3);">1</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Consultation</h3>
                        <p style="color: var(--text-light);">Free initial consultation to understand your goals, preferences, and budget.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: var(--accent); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(249,217,35,0.3);">2</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">University Selection</h3>
                        <p style="color: var(--text-light);">We help you choose the best universities and programs matching your profile.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: var(--success); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(25,135,84,0.3);">3</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Application</h3>
                        <p style="color: var(--text-light);">Complete application support with document preparation and submission.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(0,123,255,0.3);">4</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Visa Processing</h3>
                        <p style="color: var(--text-light);">Expert visa guidance and documentation to secure your study visa.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: #9b59b6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(155,89,182,0.3);">5</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Pre-Departure</h3>
                        <p style="color: var(--text-light);">Comprehensive briefing and preparation for your new journey abroad.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Why Choose Our Services -->
        <div class="container marketing-section">
            <h2 class="section-title">Why Choose Our Services?</h2>
            <div class="grid-2" style="gap: 40px; align-items: center;">
                <div>
                    <div class="why-us-item" style="margin-bottom: 30px;">
                        <div class="why-us-icon"><i class="fas fa-check-circle"></i></div>
                        <div>
                            <h3 style="margin-top: 0;">98% Visa Success Rate</h3>
                            <p>Our proven track record speaks for itself. We have successfully helped thousands of students secure their study visas.</p>
                        </div>
                    </div>
                    <div class="why-us-item" style="margin-bottom: 30px;">
                        <div class="why-us-icon"><i class="fas fa-users"></i></div>
                        <div>
                            <h3 style="margin-top: 0;">Expert Counselors</h3>
                            <p>Our team of experienced counselors provides personalized guidance tailored to your unique situation and goals.</p>
                        </div>
                    </div>
                    <div class="why-us-item" style="margin-bottom: 30px;">
                        <div class="why-us-icon"><i class="fas fa-clock"></i></div>
                        <div>
                            <h3 style="margin-top: 0;">24/7 Support</h3>
                            <p>Round-the-clock assistance ensures you never feel alone in your journey. We're here whenever you need us.</p>
                        </div>
                    </div>
                </div>
                <div>
                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; padding: 50px; color: white; text-align: center;">
                        <h2 style="color: white; margin-bottom: 30px;">10,000+</h2>
                        <p style="font-size: 1.2rem; margin-bottom: 40px; color: rgba(255,255,255,0.9);">Students Successfully Placed</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px;">
                            <div>
                                <h3 style="color: var(--accent); font-size: 2.5rem; margin: 0;">500+</h3>
                                <p style="margin: 5px 0 0 0;">Partner Universities</p>
                            </div>
                            <div>
                                <h3 style="color: var(--accent); font-size: 2.5rem; margin: 0;">15+</h3>
                                <p style="margin: 5px 0 0 0;">Years Experience</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Packages -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Service Packages</h2>
            <p class="section-subtitle">Choose the package that best fits your needs</p>
            
            <div class="grid-3" style="margin-top: 50px;">
                <div class="dash-card" style="text-align: center; border: 2px solid var(--border); transition: 0.3s;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Basic Package</h3>
                    <div style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 20px 0;">Free</div>
                    <ul style="text-align: left; list-style: none; padding: 0; margin: 30px 0;">
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Initial Consultation</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> University Information</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Basic Guidance</li>
                    </ul>
                    <button class="btn" style="width: 100%;" onclick="router('contact')">Get Started</button>
                </div>

                <div class="dash-card" style="text-align: center; border: 2px solid var(--accent); transform: scale(1.05); box-shadow: 0 10px 30px rgba(249,217,35,0.2); position: relative;">
                    <div style="position: absolute; top: -15px; right: 20px; background: var(--accent); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">MOST POPULAR</div>
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Complete Package</h3>
                    <div style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 20px 0;">Custom Price</div>
                    <ul style="text-align: left; list-style: none; padding: 0; margin: 30px 0;">
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Everything in Basic</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> University Application</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Visa Processing</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Test Preparation</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Pre & Post Arrival Support</li>
                    </ul>
                    <button class="btn btn-accent" style="width: 100%;" onclick="router('contact')">Contact Us</button>
                </div>

                <div class="dash-card" style="text-align: center; border: 2px solid var(--border); transition: 0.3s;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Premium Package</h3>
                    <div style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 20px 0;">Custom Price</div>
                    <ul style="text-align: left; list-style: none; padding: 0; margin: 30px 0;">
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Everything in Complete</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Priority Support</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Scholarship Assistance</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Extended Post-Arrival Support</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Career Counseling</li>
                    </ul>
                    <button class="btn" style="width: 100%;" onclick="router('contact')">Contact Us</button>
                </div>
            </div>
        </div>

        <!-- FAQ Section -->
        <div class="container marketing-section">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <p class="section-subtitle">Get answers to common questions about our services</p>
            
            <div style="max-width: 800px; margin: 50px auto 0;">
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> How long does the application process take?</h3>
                    <p style="color: var(--text-light); margin: 0;">The timeline varies by country and university, but typically ranges from 3-6 months from application to visa approval. We'll provide you with a detailed timeline during your consultation.</p>
                </div>
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> What documents do I need to get started?</h3>
                    <p style="color: var(--text-light); margin: 0;">Basic documents include academic transcripts, passport, English test scores (if available), and financial documents. We'll provide a complete checklist during your initial consultation.</p>
                </div>
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> Do you help with scholarships?</h3>
                    <p style="color: var(--text-light); margin: 0;">Yes! We help identify scholarship opportunities and assist with scholarship applications. Our Premium package includes dedicated scholarship assistance.</p>
                </div>
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> What if my visa gets rejected?</h3>
                    <p style="color: var(--text-light); margin: 0;">While we maintain a 98% success rate, if a visa is rejected, we provide free reapplication support and help address the reasons for rejection to improve your chances.</p>
                </div>
            </div>
        </div>

        <!-- Document Checklist Generator -->
        <div class="container marketing-section">
            <h2 class="section-title">Document Checklist Generator</h2>
            <p class="section-subtitle">Get a personalized checklist of documents needed for your application</p>
            <div class="checklist-generator">
                <div class="checklist-selector">
                    <div class="grid-2" style="gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Select Country</label>
                            <select id="checklist-country-services" onchange="generateChecklistServices()" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                                <option value="">Select Country</option>
                                <option value="canada">Canada</option>
                                <option value="uk">United Kingdom</option>
                                <option value="usa">United States</option>
                                <option value="australia">Australia</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Program Level</label>
                            <select id="checklist-level-services" onchange="generateChecklistServices()" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px;">
                                <option value="">Select Level</option>
                                <option value="bachelor">Bachelor's Degree</option>
                                <option value="master">Master's Degree</option>
                                <option value="phd">PhD/Doctorate</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="checklist-items-container-services" class="checklist-items-container">
                    <p style="text-align: center; color: var(--text-light); padding: 40px;">Select a country and program level to generate your personalized checklist</p>
                </div>
                <button class="btn btn-accent checklist-print-btn" onclick="printChecklistServices()" style="display: none; width: 100%;" id="print-checklist-btn-services"><i class="fas fa-print"></i> Print Checklist</button>
            </div>
        </div>

        <!-- CTA Section -->
        <div class="container marketing-section" style="text-align: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; padding: 60px 40px; color: white;">
            <h2 style="color: white; font-size: 2.5rem; margin-bottom: 20px;">Ready to Start Your Journey?</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 1.2rem; max-width: 600px; margin: 0 auto 40px;">
                Book a free consultation today and take the first step towards your dream education abroad
            </p>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Apply Now</button>
                <button class="btn btn-outline" onclick="router('contact')" style="font-size: 1.1rem; padding: 16px 40px;">Contact Us</button>
            </div>
        </div>
    </div>

    <!-- === BLOG PAGE === -->
    <div id="page-blogs" class="section">
        <!-- Hero Section -->
        <div class="blog-hero-section">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 col-xl-8 mx-auto text-center">
                        <div class="mb-4">
                            <i class="fas fa-blog blog-hero-icon"></i>
                        </div>
                        <h1 class="display-3 fw-bold mb-4 blog-hero-title">Our Blog</h1>
                        <p class="lead fs-4 mb-0 blog-hero-subtitle">Stay informed with our latest articles, guides, and study abroad insights</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="container py-4">
            <!-- Blog Filter -->
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-body p-4">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label for="blog-page-search" class="form-label fw-semibold text-muted small mb-2">Search Blog Posts</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="blog-page-search" class="form-control border-start-0" 
                                       placeholder="Search by title, content, or category..." 
                                       onkeyup="filterBlogPage(this.value)">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="blog-page-category" class="form-label fw-semibold text-muted small mb-2">Filter by Category</label>
                            <select id="blog-page-category" class="form-select form-select-lg" onchange="filterBlogPageByCategory(this.value)">
                                <option value="all">All Categories</option>
                                <option value="Study Guide">Study Guide</option>
                                <option value="Visa Tips">Visa Tips</option>
                                <option value="Scholarships">Scholarships</option>
                                <option value="University Info">University Info</option>
                                <option value="Student Life">Student Life</option>
                                <option value="Success Stories">Success Stories</option>
                                <option value="News">News</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blog List -->
            <div id="blog-page-list" class="row g-4">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading blog posts...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- === BLOG DETAIL PAGE === -->
    <div id="page-blog-detail" class="section">
        <div class="container" style="padding-top: 40px; max-width: 900px;">
            <button class="btn" onclick="router('blogs')" style="margin-bottom: 30px; background: var(--light); color: var(--primary);">
                <i class="fas fa-arrow-left"></i> Back to Blog
            </button>
            
            <div id="blog-detail-container">
                <div style="text-align: center; padding: 60px; color: var(--text-light);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Loading blog post...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- === CONTACT PAGE === -->
    <div id="page-contact" class="section">
        <div class="container">
            <div class="grid-2">
                <div>
                    <h1>Get in Touch</h1>
                    <p style="margin-bottom: 30px;">Visit our office in Kathmandu or send us a message.</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-map-marker-alt"></i> Head Office</h3>
                        <p>Putalisadak, Kathmandu, Nepal</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-phone"></i> Phone</h3>
                        <p>+977 1 4444444</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-envelope"></i> Email</h3>
                        <p>info@globaledunepal.com</p>
                    </div>
                </div>
                
                <div class="dash-card">
                    <h3>Send Message</h3>
                    <form id="contact-form" onsubmit="handleContactSubmit(event); return false;">
                        <input type="text" id="contact-name" placeholder="Full Name" required>
                        <input type="email" id="contact-email" placeholder="Email Address" required>
                        <textarea rows="4" id="contact-message" placeholder="How can we help?" required></textarea>
                        <button type="submit" class="btn" style="width: 100%;">Submit Inquiry</button>
                        <p id="contact-form-status" style="margin-top: 10px; display: none;"></p>
                    </form>
                </div>
            </div>

            <!-- FAQ Section -->
            <div class="container marketing-section" style="margin-top: 60px;">
                <h2 class="section-title">Frequently Asked Questions</h2>
                <p class="section-subtitle">Find quick answers to common questions</p>
                <div class="faq-container">
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>What are your office hours?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                Our office is open Monday to Saturday from 9:00 AM to 6:00 PM. We also offer online consultations that can be scheduled outside these hours.
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>How do I schedule a consultation?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                You can schedule a consultation by calling us, sending an email, filling out the contact form above, or using our online booking system. We'll confirm your appointment within 24 hours.
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Is the initial consultation free?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                Yes, we offer a free initial consultation to discuss your study abroad goals, eligibility, and answer any questions you may have about the process.
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>What information should I bring to the consultation?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                Please bring your academic transcripts, passport, English test scores (if available), and any questions you have. Don't worry if you don't have everything - we can start with what you have.
                            </div>
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Do you provide services in Nepali language?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                Yes, our counselors are fluent in both English and Nepali. We can provide consultations and support in your preferred language.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === AUTHENTICATION === -->
    <div id="page-auth" class="section">
        <div class="container" style="display: flex; justify-content: center;">
            <div class="dash-card" style="width: 100%; max-width: 450px; text-align: center; padding: 40px;">
                <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;">
                    <i class="fas fa-user-circle"></i>
                </div>
                <h2 id="auth-title">Login</h2>
                <p id="auth-subtitle">Welcome back</p>
                
                <div style="margin-top: 30px;">
                    <input type="email" id="auth-email" placeholder="Email Address">
                    <input type="password" id="auth-pass" placeholder="Password">
                    <p id="auth-error-msg" class="error-message"></p>
                    
                    <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="handleLogin()">Sign In</button>
                    <button class="btn btn-outline" style="width: 100%; color: var(--text-light); border-color: var(--border);" onclick="toggleSignupMode()" id="signup-toggle-btn">Create Account</button>
                    <button class="btn btn-success" style="width: 100%; margin-top: 10px; display: none;" id="signup-submit-btn" onclick="handleSignup()">Create Account</button>
                </div>

                <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                    <p style="font-size: 0.8rem; margin-bottom: 10px;">Preview Mode:</p>
                    <button class="btn btn-accent" style="width: 100%; margin-bottom: 15px;" onclick="startDemoMode()">
                        <i class="fas fa-flask"></i> Try Demo Mode (Skip Login)
                    </button>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 0.85rem;">
                        <p style="margin: 0 0 10px 0; font-weight: 600; color: #333;"><i class="fas fa-info-circle"></i> How to Login:</p>
                        <ul style="margin: 0; padding-left: 20px; color: #666;">
                            <li><strong>Students:</strong> Click "Create Account" â†’ Sign up</li>
                            <li><strong>Counselors:</strong> Click "Create Account" â†’ Sign up</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; color: #999; font-size: 0.8rem;">After signup, you'll be automatically logged in and routed to your portal.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === STUDENT DASHBOARD === -->
    <div id="page-student-dash" class="section" style="padding: 0;">
        <div class="dashboard-layout">
            <div class="dash-sidebar">
                <div style="margin-bottom: 40px;">
                    <h3 style="color: white;">Student Portal</h3>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">Manage your application</p>
                </div>
                <a class="dash-menu-item active" onclick="router('student')"><i class="fas fa-home"></i> Dashboard</a>
                <a class="dash-menu-item" id="student-side-app-link" onclick="router('student-apps')"><i class="fas fa-file-alt"></i> Application Form</a>
            </div>

            <div class="dash-main">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2 style="margin: 0 0 5px 0;">Welcome Back!</h2>
                        <p style="margin: 0; color: #666; font-size: 0.95rem;" id="student-welcome-email">Student</p>
                    </div>
                    <span class="status-badge status-submitted" id="dash-status-badge" style="display: none;"><i class="fas fa-check-circle"></i> Application Submitted</span>
                </div>
                
                <!-- Quick Stats -->
                <div class="grid-3" style="margin-bottom: 30px;">
                    <div class="dash-card" style="text-align:center; cursor: pointer; transition: 0.2s;" onclick="openStatusTrackerModal()" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                        <i class="fas fa-route" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                        <h3 style="margin-bottom:0; font-size: 1.1rem;">Application Status</h3>
                        <p style="margin-top:5px; font-size:0.85rem; color: #666;">View Progress</p>
                    </div>
                    <div class="dash-card" style="text-align:center; cursor: pointer; transition: 0.2s;" onclick="openDocumentChecklistModal()" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                        <i class="fas fa-check-square" style="font-size:2rem; color:var(--accent); margin-bottom:10px;"></i>
                        <h3 style="margin-bottom:0; font-size: 1.1rem;" id="dash-checklist-count">0/8</h3>
                        <p style="margin-top:5px; font-size:0.85rem; color: #666;">Documents</p>
                    </div>
                    <div class="dash-card" style="text-align:center; cursor: pointer; transition: 0.2s;" onclick="openPaymentsModal()" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                        <i class="fas fa-money-bill-wave" style="font-size:2rem; color:var(--success); margin-bottom:10px;"></i>
                        <h3 style="margin-bottom:0; font-size: 1.1rem;" id="dash-payment-status">$0</h3>
                        <p style="margin-top:5px; font-size:0.85rem; color: #666;">Payments</p>
                    </div>
                </div>

                <!-- Main Action Buttons -->
                <div class="grid-2" style="gap: 20px; margin-bottom: 30px;">
                    <div class="dash-card" style="padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white;" onclick="openChatModal()" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,43,91,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.9;"></i>
                        <h3 style="color: white; margin-bottom: 10px;">Chat with Counselor</h3>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">Get instant help and support</p>
                    </div>
                    <div class="dash-card" style="padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: linear-gradient(135deg, var(--accent) 0%, #e6c81b 100%); color: var(--primary);" onclick="openTestScoresModal()" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(249,217,35,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                        <i class="fas fa-certificate" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Test Scores</h3>
                        <p style="color: var(--primary); font-size: 0.9rem; margin: 0; opacity: 0.8;">Manage your test results</p>
                    </div>
                </div>

                <!-- Secondary Actions -->
                <div class="grid-4" style="gap: 15px; margin-bottom: 30px;">
                    <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="openStatusTrackerModal()" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                        <i class="fas fa-route" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                        <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Status Tracker</p>
                    </div>
                    <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="openDocumentChecklistModal()" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                        <i class="fas fa-file-check" style="font-size: 2rem; color: var(--accent); margin-bottom: 10px;"></i>
                        <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Documents</p>
                    </div>
                    <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="openPaymentsModal()" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                        <i class="fas fa-credit-card" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                        <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Payments</p>
                    </div>
                    <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="router('student-apps')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                        <i class="fas fa-edit" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                        <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Edit Profile</p>
                    </div>
                </div>

                <!-- Profile Summary (Compact) -->
                <div id="dash-profile-view" class="dash-card" style="display:none; margin-bottom: 25px; border-left: 5px solid var(--accent);">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <h3 style="margin-bottom: 5px; color: var(--primary);"><i class="fas fa-id-card-alt"></i> My Profile</h3>
                            <p style="margin:0; font-size:1rem; font-weight:600; color:var(--text-dark);" id="dash-full-name">Student Name</p>
                        </div>
                    </div>
                    <div class="grid-2" style="gap: 20px; margin-top: 15px;">
                        <div>
                            <p style="margin:5px 0; font-size: 0.9rem;"><strong>Target:</strong> <span id="dash-target"></span></p>
                            <p style="margin:5px 0; font-size: 0.9rem;"><strong>Intake:</strong> <span id="dash-intake-val"></span></p>
                        </div>
                        <div>
                            <p style="margin:5px 0; font-size: 0.9rem;"><strong>Phone:</strong> <span id="dash-phone"></span></p>
                            <p style="margin:5px 0; font-size: 0.9rem;"><strong>Address:</strong> <span id="dash-address"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === STUDENT APPLICATION FORM PAGE === -->
    <div id="page-student-apps" class="section" style="padding: 0;">
        <div class="dashboard-layout">
            <div class="dash-sidebar">
                <div style="margin-bottom: 40px;">
                    <h3 style="color: white;">Student Portal</h3>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">Manage your application</p>
                </div>
                <a class="dash-menu-item" onclick="router('student')"><i class="fas fa-home"></i> Dashboard</a>
                <a class="dash-menu-item active" onclick="router('student-apps')"><i class="fas fa-file-alt"></i> My Profile</a>
            </div>

            <div class="dash-main">
                <h2 style="margin-bottom: 30px;" id="app-page-title">Application Wizard</h2>
                
                <!-- WIZARD STEP INDICATOR -->
                <div id="wizard-steps" class="step-indicator">
                    <div class="step active" id="step-ind-1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Basic Info</div>
                    </div>
                    <div class="step" id="step-ind-2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Destination</div>
                    </div>
                    <div class="step" id="step-ind-3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Documents</div>
                    </div>
                </div>

                <div class="container" style="max-width: 800px; padding: 0;">
                    
                    <!-- Application Form View (Wizard) -->
                    <div id="app-form-view" class="dash-card">
                        
                        <!-- STEP 1 -->
                        <div id="wizard-step-1" class="wizard-content active">
                            <h3><i class="fas fa-user-edit"></i> Basic Information</h3>
                            <div style="margin-top: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <input type="text" placeholder="First Name" id="app-fname">
                                    <input type="text" placeholder="Last Name" id="app-lname">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <input type="date" placeholder="Date of Birth" id="app-dob">
                                    <select id="app-gender">
                                        <option value="" disabled selected>Gender</option>
                                        <option>Male</option>
                                        <option>Female</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <input type="text" placeholder="Citizenship" id="app-citizen">
                                <input type="text" placeholder="Phone Number" id="app-phone">
                                <input type="text" placeholder="Current Address" id="app-address">
                                
                                <div style="text-align: right; margin-top: 20px;">
                                    <button class="btn" onclick="goToStep(2)">Next: Study Preferences <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 2 -->
                        <div id="wizard-step-2" class="wizard-content">
                            <h3><i class="fas fa-globe"></i> Study Destination</h3>
                            <div style="margin-top: 20px;">
                                <label style="font-size: 0.9rem; font-weight: 600;">1. Select Target Country</label>
                                <select id="app-country" onchange="updateLocations()">
                                    <option value="" disabled selected>Choose Country...</option>
                                    <option value="Canada">Canada</option>
                                    <option value="USA">USA</option>
                                    <option value="Australia">Australia</option>
                                    <option value="UK">UK</option>
                                </select>

                                <label style="font-size: 0.9rem; font-weight: 600;">2. Select Location (State/Province)</label>
                                <select id="app-state" disabled onchange="updateUniversities()">
                                    <option value="" disabled selected>Select Country First</option>
                                </select>

                                <label style="font-size: 0.9rem; font-weight: 600;">3. Select University/College</label>
                                <select id="app-university" disabled onchange="handleAddUniversity()">
                                    <option value="" disabled selected>Select Location First</option>
                                </select>

                                <!-- SELECTED LIST -->
                                <div id="selected-universities-list" style="margin-top: 10px; min-height: 20px;"></div>

                                <label style="font-size: 0.9rem; font-weight: 600; margin-top: 15px; display: block;">4. Preferred Intake</label>
                                <select id="app-intake">
                                    <option value="" disabled selected>Select Intake Season</option>
                                    <option>Fall (Sept) 2025</option>
                                    <option>Winter (Jan) 2026</option>
                                    <option>Summer (May) 2026</option>
                                </select>

                                <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                                    <button class="btn btn-outline" style="color: var(--text-dark); border-color: #ddd;" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i> Back</button>
                                    <button class="btn" onclick="goToStep(3)">Next: Documents <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 3 -->
                        <div id="wizard-step-3" class="wizard-content">
                            <h3><i class="fas fa-cloud-upload-alt"></i> Upload Documents</h3>
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">Upload required documents for IRCC compliance. Ensure scans are clear.</p>
                            
                            <!-- Document Upload Grid -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; margin-bottom: 15px; font-weight: 600; font-size: 0.9rem; color: var(--text-dark); padding-bottom: 10px; border-bottom: 2px solid #ddd;">
                                    <div>Document Type</div>
                                    <div>Choose File(s)</div>
                                    <div style="text-align: center;">Action</div>
                                </div>
                                
                                <!-- Passport Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Passport (Front & Back)</div>
                                    <div>
                                        <input type="file" id="file-passport" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('passport', 'Passport')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- Transcript Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Academic Transcripts</div>
                                    <div>
                                        <input type="file" id="file-transcript" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('transcript', 'Transcript')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- IELTS/PTE Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">IELTS/PTE Score Card</div>
                                    <div>
                                        <input type="file" id="file-ielts" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('ielts', 'IELTS/PTE')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- Financial Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Financial Documents</div>
                                    <div>
                                        <input type="file" id="file-financial" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('financial', 'Financial')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- SOP Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Statement of Purpose</div>
                                    <div>
                                        <input type="file" id="file-sop" class="doc-file-input" multiple accept=".pdf,.doc,.docx" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('sop', 'SOP')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- Other Documents Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0;">
                                    <div style="font-weight: 500;">Other Documents</div>
                                    <div>
                                        <input type="file" id="file-other" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('other', 'Other')">Upload</button>
                                    </div>
                                </div>
                            </div>

                            <div id="stu-file-list" style="margin-bottom: 30px;">
                                <h4 style="font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">Uploaded Files</h4>
                                <div class="no-docs" style="color: #999; font-style: italic; font-size: 0.9rem;">No documents uploaded yet.</div>
                            </div>

                            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                                <button class="btn btn-outline" style="color: var(--text-dark); border-color: #ddd;" onclick="goToStep(2)"><i class="fas fa-arrow-left"></i> Back</button>
                                
                                <button id="btn-app-save" class="btn" onclick="saveApplication()">Preview Application</button>
                                <button id="btn-app-update" class="btn btn-success" style="display:none;" onclick="updateProfile()">Update Profile</button>
                            </div>
                        </div>

                    </div>

                    <!-- Preview View -->
                    <div id="app-preview-view" class="dash-card" style="display: none;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                            <h3>Application Review</h3>
                            <span id="preview-status-badge" class="status-badge status-draft">Draft</span>
                        </div>
                        <div id="preview-content"></div>
                        <div style="margin-top:20px; display:flex; gap:15px;">
                            <button class="btn btn-secondary" onclick="editApplication()"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-success" onclick="submitApplication()"><i class="fas fa-paper-plane"></i> Submit Application</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === COUNSELOR PORTAL === -->
    <div id="page-counselor-dash" class="section" style="padding: 0;">
        <div class="dashboard-layout" style="grid-template-columns: 1fr;">
            <div class="dash-main" style="width: 100%; max-width: 1400px; margin: 0 auto;">
                <!-- Main Dashboard View (when no student selected) -->
                <div id="coun-dashboard-view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <div>
                            <h2 style="margin: 0 0 5px 0;">Counselor Dashboard</h2>
                            <p style="margin: 0; color: #666; font-size: 0.95rem;">Manage your students and track their progress</p>
                        </div>
                        <button class="btn btn-primary" onclick="addStudent()"><i class="fas fa-plus"></i> Add Student</button>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="grid-4" style="margin-bottom: 30px;">
                        <div class="dash-card" style="text-align:center; border-left: 4px solid var(--primary);">
                            <i class="fas fa-users" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.5rem;" id="coun-stat-active">0</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">Active Students</p>
                        </div>
                        <div class="dash-card" style="text-align:center; border-left: 4px solid var(--accent);">
                            <i class="fas fa-tasks" style="font-size:2rem; color:var(--accent); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.5rem;" id="coun-stat-tasks">0</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">Pending Tasks</p>
                        </div>
                        <div class="dash-card" style="text-align:center; border-left: 4px solid var(--success);">
                            <i class="fas fa-calendar-check" style="font-size:2rem; color:var(--success); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.5rem;" id="coun-stat-appointments">0</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">Upcoming Appointments</p>
                        </div>
                        <div class="dash-card" style="text-align:center; border-left: 4px solid var(--danger);">
                            <i class="fas fa-exclamation-circle" style="font-size:2rem; color:var(--danger); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.5rem;" id="coun-stat-alerts">0</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">Alerts</p>
                        </div>
                    </div>

                    <!-- Student List -->
                    <div class="dash-card" style="padding: 0; overflow: hidden;">
                        <div style="padding: 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <h3 id="coun-list-header" style="margin:0;">My Students</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-sm" onclick="renderStudentList('active')" id="btn-filter-active">Active</button>
                                <button class="btn btn-sm" onclick="renderStudentList('inactive')" id="btn-filter-inactive">Inactive</button>
                                <button class="btn btn-sm" onclick="renderAvailableStudents()" id="btn-filter-available">Available</button>
                            </div>
                        </div>
                        <div id="coun-student-list" style="max-height: 500px; overflow-y: auto; padding: 10px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Student Detail View (when student is selected) -->
                <div id="coun-interaction" style="display: none;">
                    <!-- Back Button -->
                    <button class="btn btn-sm" onclick="clearStudentSelection()" style="margin-bottom: 20px;">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                    
                    <!-- Student Header Card -->
                    <div class="dash-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h2 id="coun-header-name" style="color: white; margin-bottom: 8px; font-size: 1.5rem;">
                                    <i class="fas fa-user-graduate" style="margin-right: 10px;"></i>Student Name
                                </h2>
                                <p id="coun-header-status" style="font-size: 0.95rem; color: rgba(255,255,255,0.9); margin: 0;">
                                    <i class="fas fa-envelope" style="margin-right: 5px;"></i>Email: N/A
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: inline-block; margin-bottom: 5px;">
                                    <span id="cp-status-badge" style="font-size: 0.85rem; font-weight: 600;">Active</span>
                                </div>
                                <p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">
                                    <i class="fas fa-calendar"></i> <span id="cp-last-updated">Recently Active</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats for Selected Student -->
                    <div class="grid-4" style="margin-bottom: 30px;">
                        <div class="dash-card" style="text-align:center; cursor: pointer; transition: 0.2s;" onclick="switchCounselorTab('docs')" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                            <i class="fas fa-file-alt" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.1rem;" id="cp-docs-count-dash">0</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">Documents</p>
                        </div>
                        <div class="dash-card" style="text-align:center; cursor: pointer; transition: 0.2s;" onclick="switchCounselorTab('tasks')" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                            <i class="fas fa-tasks" style="font-size:2rem; color:var(--accent); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.1rem;" id="cp-tasks-count-dash">0</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">Tasks</p>
                        </div>
                        <div class="dash-card" style="text-align:center; cursor: pointer; transition: 0.2s;" onclick="switchCounselorTab('appointments')" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                            <i class="fas fa-calendar-check" style="font-size:2rem; color:var(--success); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.1rem;" id="cp-appointments-count-dash">0</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">Appointments</p>
                        </div>
                        <div class="dash-card" style="text-align:center; cursor: pointer; transition: 0.2s;" onclick="switchCounselorTab('notes')" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                            <i class="fas fa-sticky-note" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                            <h3 style="margin-bottom:0; font-size: 1.1rem;">Notes</h3>
                            <p style="margin-top:5px; font-size:0.85rem; color: #666;">View All</p>
                        </div>
                    </div>

                    <!-- Main Action Buttons -->
                    <div class="grid-2" style="gap: 20px; margin-bottom: 30px;">
                        <div class="dash-card" style="padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white;" onclick="openTaskModal()" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,43,91,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                            <i class="fas fa-tasks" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.9;"></i>
                            <h3 style="color: white; margin-bottom: 10px;">Create Task</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">Assign tasks and track progress</p>
                        </div>
                        <div class="dash-card" style="padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; background: linear-gradient(135deg, var(--accent) 0%, #e6c81b 100%); color: var(--primary);" onclick="openAppointmentModal()" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(249,217,35,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                            <i class="fas fa-calendar-plus" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3 style="color: var(--primary); margin-bottom: 10px;">Schedule Appointment</h3>
                            <p style="color: var(--primary); font-size: 0.9rem; margin: 0; opacity: 0.8;">Book a meeting with student</p>
                        </div>
                    </div>

                    <!-- Secondary Actions -->
                    <div class="grid-4" style="gap: 15px; margin-bottom: 30px;">
                        <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="openNoteModal()" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                            <i class="fas fa-sticky-note" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                            <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Add Note</p>
                        </div>
                        <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="switchCounselorTab('chat')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                            <i class="fas fa-comments" style="font-size: 2rem; color: var(--accent); margin-bottom: 10px;"></i>
                            <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Chat</p>
                        </div>
                        <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="switchCounselorTab('timeline')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                            <i class="fas fa-history" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                            <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Timeline</p>
                        </div>
                        <div class="dash-card" style="padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;" onclick="switchCounselorTab('profile')" onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e5e5e5'; this.style.transform='translateY(0)'">
                            <i class="fas fa-user-circle" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                            <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">Profile</p>
                        </div>
                    </div>
                                
                    <!-- Tabs (Hidden by default, shown when clicking specific actions) -->
                    <div class="dash-card" style="padding: 0; display: none;" id="coun-tabs-container">
                        <div class="coun-tabs" style="border-bottom: 2px solid #eee;">
                            <div class="coun-tab active" onclick="switchCounselorTab('profile')">
                                <i class="fas fa-user-circle"></i> Profile
                            </div>
                            <div class="coun-tab" onclick="switchCounselorTab('docs')">
                                <i class="fas fa-file-alt"></i> Documents
                                <span id="cp-docs-count" style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                            </div>
                            <div class="coun-tab" onclick="switchCounselorTab('tasks')">
                                <i class="fas fa-tasks"></i> Tasks
                                <span id="cp-tasks-count" style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                            </div>
                            <div class="coun-tab" onclick="switchCounselorTab('notes')">
                                <i class="fas fa-sticky-note"></i> Notes
                            </div>
                            <div class="coun-tab" onclick="switchCounselorTab('timeline')">
                                <i class="fas fa-history"></i> Timeline
                            </div>
                            <div class="coun-tab" onclick="switchCounselorTab('appointments')">
                                <i class="fas fa-calendar-check"></i> Appointments
                            </div>
                            <div class="coun-tab" onclick="switchCounselorTab('chat')">
                                <i class="fas fa-comments"></i> Chat
                            </div>
                        </div>
                                
                        <!-- Tab Content -->
                        <!-- 1. PROFILE TAB -->
                        <div id="tab-profile" class="coun-content" style="padding: 25px;">
                                    <div style="margin-bottom: 25px;">
                                        <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 8px;">
                                            <i class="fas fa-info-circle"></i> Personal Information
                                        </h4>
                                    <div class="grid-2" style="gap: 20px;">
                                        <div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">Full Name</label>
                                                    <p style="margin: 0; font-weight: 600; color: var(--primary);" id="cp-fullname">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-phone"></i> Phone Number
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-phone">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-map-marker-alt"></i> Address
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-addr">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-birthday-cake"></i> Date of Birth
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-dob">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-venus-mars"></i> Gender
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-gender">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-id-card"></i> Citizenship
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-citizen">N/A</p>
                                                </div>
                                        </div>
                                        <div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-graduation-cap"></i> Education Level
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-edu">N/A</p>
                                        </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-globe"></i> Target Country
                                                    </label>
                                                    <p style="margin: 0; font-weight: 600; color: var(--primary); font-size: 1.1rem;" id="cp-target">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-map-pin"></i> Preferred Location
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-state">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-calendar-alt"></i> Preferred Intake
                                                    </label>
                                                    <p style="margin: 0; font-weight: 600; color: var(--accent);" id="cp-intake">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-university"></i> Selected Universities
                                                    </label>
                                                    <div id="cp-unis" style="margin-top: 8px;">
                                                        <span style="color: #999; font-style: italic;">None selected</span>
                                                    </div>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-file-check"></i> Application Status
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-status">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 8px;">
                                                        <i class="fas fa-flag-checkered"></i> Milestone
                                                    </label>
                                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                                        <select id="cp-milestone-select" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                                            <option value="">No Milestone</option>
                                                            <option value="Joined">Joined</option>
                                                            <option value="IELTS Completed">IELTS Completed</option>
                                                            <option value="Applied for College">Applied for College</option>
                                                            <option value="Offer Letter Approved">Offer Letter Approved</option>
                                                            <option value="Offer Letter Denied">Offer Letter Denied</option>
                                                            <option value="Visa Applied">Visa Applied</option>
                                                            <option value="Visa Approved">Visa Approved</option>
                                                            <option value="Visa Denied">Visa Denied</option>
                                                        </select>
                                                        <button class="btn btn-sm btn-primary" onclick="updateStudentMilestone()" style="padding: 8px 15px;">
                                                            <i class="fas fa-save"></i> Update
                                                        </button>
                                                    </div>
                                                    <div id="cp-current-milestone" style="margin-top: 8px; font-size: 0.85rem; color: #666;"></div>
                                                </div>
                                                    <p style="margin: 0;">
                                                        <span id="cp-app-status" class="status-badge status-draft">Draft</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. DOCUMENTS TAB -->
                                <div id="tab-docs" class="coun-content" style="display: none; padding: 25px;">
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 8px;">
                                            <i class="fas fa-file-upload"></i> Student Documents
                                        </h4>
                                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">All documents uploaded by the student are listed below.</p>
                                    </div>
                                    <div id="cp-docs-list">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                            <p style="font-style: italic;">No documents uploaded.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 3. CHAT TAB -->
                                <!-- TASKS TAB -->
                                <div id="tab-tasks" class="coun-content" style="display: none; padding: 25px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h4 style="color: var(--primary); margin: 0;"><i class="fas fa-tasks"></i> Tasks & Reminders</h4>
                                        <button class="btn btn-sm" onclick="openTaskModal()"><i class="fas fa-plus"></i> Add Task</button>
                                    </div>
                                    <div id="tasks-list">
                                        <p style="color: #999; text-align: center; padding: 20px;">No tasks created yet</p>
                                    </div>
                                </div>

                                <!-- NOTES TAB -->
                                <div id="tab-notes" class="coun-content" style="display: none; padding: 25px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h4 style="color: var(--primary); margin: 0;"><i class="fas fa-sticky-note"></i> Internal Notes</h4>
                                        <button class="btn btn-sm" onclick="openNoteModal()"><i class="fas fa-plus"></i> Add Note</button>
                                    </div>
                                    <div id="notes-list" class="notes-container">
                                        <p style="color: #999; text-align: center; padding: 20px;">No notes added yet</p>
                                    </div>
                                </div>

                                <!-- TIMELINE TAB -->
                                <div id="tab-timeline" class="coun-content" style="display: none; padding: 25px;">
                                    <h4 style="color: var(--primary); margin-bottom: 20px;"><i class="fas fa-history"></i> Student Journey Timeline</h4>
                                    <div id="student-timeline" class="timeline">
                                        <p style="color: #999; text-align: center; padding: 20px;">Timeline will appear here</p>
                                    </div>
                                </div>

                                <!-- APPOINTMENTS TAB -->
                                <div id="tab-appointments" class="coun-content" style="display: none; padding: 25px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                        <h4 style="color: var(--primary); margin: 0;"><i class="fas fa-calendar-check"></i> Appointments</h4>
                                        <button class="btn btn-sm" onclick="openAppointmentModal()"><i class="fas fa-plus"></i> Schedule</button>
                                    </div>
                                    <div id="appointments-list">
                                        <p style="color: #999; text-align: center; padding: 20px;">No appointments scheduled</p>
                                    </div>
                                </div>

                                <div id="tab-chat" class="coun-content" style="display: none; padding: 0;">
                                    <div class="chat-wrapper" style="height: 500px;">
                                        <div class="chat-header" style="background: var(--primary); color: white;">
                                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-user-graduate"></i>
                                            </div>
                                            <div>
                                                <strong style="display: block; color: white;">Chat with <span id="coun-chat-student-name">Student</span></strong>
                                                <span style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                                                    <i class="fas fa-circle" style="font-size: 0.5rem; color: var(--success);"></i> Online
                                                </span>
                                            </div>
                                        </div>
                                        <div id="coun-chat-box" class="chat-body" style="background: #f8f9fa;">
                                            <div class="message msg-in">
                                                <strong>System:</strong> Chat history will appear here. Start a conversation with the student!
                                            </div>
                                        </div>
                                        <div class="chat-footer" style="background: white;">
                                            <input type="text" id="coun-chat-input" placeholder="Type your message..." style="margin: 0; border: 1px solid #ddd; background: #f0f2f5; border-radius: 20px; padding: 10px 15px;" onkeypress="if(event.key === 'Enter') sendMessage('counselor')">
                                            <button class="btn" style="border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center; background: var(--primary);" onclick="sendMessage('counselor')" title="Send message">
                                                <i class="fas fa-paper-plane" style="color: white;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === ADMIN PORTAL === -->
    <div id="page-admin-dash" class="section" style="padding: 0;">
        <div class="dashboard-layout">
            <div class="dash-sidebar">
                <div style="margin-bottom: 40px;">
                    <h3 style="color: white;">Admin Panel</h3>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">Administrator Access</p>
                </div>
                <a class="dash-menu-item" id="back-to-counselor-link" onclick="showAdminView('dashboard')" style="display: none;"><i class="fas fa-arrow-left"></i> Back to Counselor Panel</a>
                <a class="dash-menu-item active" onclick="showAdminView('dashboard')" id="admin-menu-dashboard"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('all')" id="admin-menu-users"><i class="fas fa-users"></i> All Users</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('students')" id="admin-menu-students"><i class="fas fa-user-graduate"></i> Students</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('counselors')" id="admin-menu-counselors"><i class="fas fa-user-tie"></i> Counselors</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('admins')" id="admin-menu-admins"><i class="fas fa-user-shield"></i> Admins</a>
                <a class="dash-menu-item" onclick="showAdminView('analytics')" id="admin-menu-analytics"><i class="fas fa-chart-bar"></i> Analytics</a>
                <a class="dash-menu-item" onclick="showAdminView('activity')" id="admin-menu-activity"><i class="fas fa-history"></i> Activity Logs</a>
                <a class="dash-menu-item" onclick="showAdminView('contacts')" id="admin-menu-contacts"><i class="fas fa-envelope"></i> Contact Messages</a>
                <a class="dash-menu-item" onclick="showAdminView('blogs')" id="admin-menu-blogs"><i class="fas fa-blog"></i> Blog Management</a>
            </div>

            <div class="dash-main">
                <!-- DASHBOARD VIEW -->
                <div id="admin-dashboard-view" style="display: block;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
                        <p style="color: #666;">Overview of system statistics and recent activity</p>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid-4" style="margin-bottom: 30px; gap: 20px;">
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #007bff;">
                            <div style="font-size: 2.5rem; color: #007bff; margin-bottom: 10px;">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-total">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Total Users</p>
                        </div>
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #28a745;">
                            <div style="font-size: 2.5rem; color: #28a745; margin-bottom: 10px;">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-students">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Students</p>
                        </div>
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #ffc107;">
                            <div style="font-size: 2.5rem; color: #ffc107; margin-bottom: 10px;">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-counselors">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Counselors</p>
                        </div>
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #dc3545;">
                            <div style="font-size: 2.5rem; color: #dc3545; margin-bottom: 10px;">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-admins">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Admins</p>
                        </div>
                    </div>

                    <!-- Additional Stats -->
                    <div class="grid-2" style="margin-bottom: 30px; gap: 20px;">
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-chart-pie"></i> User Distribution</h3>
                            <div id="admin-chart-container" style="height: 250px; display: flex; align-items: center; justify-content: center; color: #999;">
                                <div id="admin-pie-chart" style="width: 100%; height: 100%;"></div>
                            </div>
                        </div>
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-calendar-alt"></i> Recent Activity</h3>
                            <div id="admin-recent-activity" style="max-height: 250px; overflow-y: auto;">
                                <div style="text-align: center; padding: 20px; color: #999;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="dash-card">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-bolt"></i> Quick Actions</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="showCreateUserModal()"><i class="fas fa-user-plus"></i> Create User</button>
                            <button class="btn btn-primary" onclick="showAdminView('users')"><i class="fas fa-users"></i> Manage Users</button>
                            <button class="btn btn-info" onclick="exportUsersData()"><i class="fas fa-download"></i> Export Data</button>
                            <button class="btn btn-warning" onclick="showAdminView('analytics')"><i class="fas fa-chart-bar"></i> View Analytics</button>
                        </div>
                    </div>
                </div>

                <!-- USERS MANAGEMENT VIEW -->
                <div id="admin-users-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin-bottom: 10px;">User Management</h2>
                                <p style="color: #666; margin: 0;">Manage user roles, create profiles, and assign counselors to students.</p>
                            </div>
                            <button class="btn btn-success" onclick="showCreateUserModal()"><i class="fas fa-user-plus"></i> Create New User</button>
                        </div>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <input type="text" id="admin-search-users" placeholder="Search by name, email..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onkeyup="filterAdminUsers()">
                            </div>
                            <select id="admin-filter-role" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterAdminUsers()">
                                <option value="all">All Roles</option>
                                <option value="student">Students</option>
                                <option value="counselor">Counselors</option>
                                <option value="admin">Admins</option>
                            </select>
                            <select id="admin-filter-status" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterAdminUsers()">
                                <option value="all">All Status</option>
                                <option value="Draft">Draft</option>
                                <option value="Submitted">Submitted</option>
                                <option value="In Review">In Review</option>
                            </select>
                            <button class="btn btn-outline" onclick="clearAdminFilters()"><i class="fas fa-times"></i> Clear</button>
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="dash-card" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; display: none;" id="admin-bulk-actions">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span id="admin-selected-count" style="font-weight: 600; color: #007bff;">0 users selected</span>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-sm btn-danger" onclick="bulkDeleteUsers()"><i class="fas fa-trash"></i> Delete Selected</button>
                                <button class="btn btn-sm btn-primary" onclick="bulkAssignCounselor()"><i class="fas fa-user-tie"></i> Assign Counselor</button>
                                <button class="btn btn-sm btn-outline" onclick="clearUserSelection()"><i class="fas fa-times"></i> Clear Selection</button>
                            </div>
                        </div>
                    </div>

                    <div class="dash-card" style="padding: 0;">
                        <div style="padding: 20px; background: #fff; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 id="admin-list-header" style="margin:0;">All Users</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" id="admin-select-all" onchange="toggleSelectAllUsers()">
                                        <span style="font-size: 0.9rem;">Select All</span>
                                    </label>
                                </div>
                            </div>
                            <div class="search-filter-bar">
                                <input type="text" id="admin-search-users" class="search-input" placeholder="Search users..." onkeyup="filterAdminUsers()">
                                <select id="admin-filter-role" class="filter-select" onchange="filterAdminUsers()">
                                    <option value="all">All Roles</option>
                                    <option value="student">Students</option>
                                    <option value="counselor">Counselors</option>
                                    <option value="admin">Admins</option>
                                </select>
                                <select id="admin-filter-status" class="filter-select" onchange="filterAdminUsers()">
                                    <option value="all">All Status</option>
                                    <option value="draft">Draft</option>
                                    <option value="submitted">Submitted</option>
                                </select>
                                <button class="btn btn-sm" onclick="clearAdminFilters()" style="padding: 10px 15px;"><i class="fas fa-times"></i> Clear</button>
                            </div>
                        </div>
                        <div id="admin-users-list" style="max-height: 600px; overflow-y: auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ANALYTICS VIEW -->
                <div id="admin-analytics-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> Analytics & Reports</h2>
                        <p style="color: #666;">Detailed insights and statistics</p>
                    </div>

                    <div class="grid-2" style="margin-bottom: 20px; gap: 20px;">
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-user-plus"></i> New Users (Last 30 Days)</h3>
                            <div id="admin-new-users-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #999;">
                                Loading chart...
                            </div>
                        </div>
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-file-alt"></i> Application Status</h3>
                            <div id="admin-status-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #999;">
                                Loading chart...
                            </div>
                        </div>
                    </div>

                    <div class="dash-card">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-table"></i> Detailed Statistics</h3>
                        <div id="admin-detailed-stats" style="overflow-x: auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ACTIVITY LOGS VIEW -->
                <div id="admin-activity-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-history"></i> Activity Logs</h2>
                        <p style="color: #666;">Track system activities and user actions</p>
                    </div>

                    <div class="dash-card" style="padding: 0;">
                        <div style="padding: 20px; background: #fff; border-bottom: 1px solid #eee;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <input type="date" id="activity-date-from" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <input type="date" id="activity-date-to" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <select id="activity-filter-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="all">All Activities</option>
                                    <option value="user_created">User Created</option>
                                    <option value="user_updated">User Updated</option>
                                    <option value="user_deleted">User Deleted</option>
                                    <option value="login">Login</option>
                                </select>
                                <button class="btn btn-primary" onclick="loadActivityLogs()"><i class="fas fa-filter"></i> Filter</button>
                            </div>
                        </div>
                        <div id="admin-activity-logs" style="max-height: 600px; overflow-y: auto; padding: 20px;">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Loading activity logs...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONTACT MESSAGES VIEW -->
                <div id="admin-contacts-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-envelope"></i> Contact Messages</h2>
                        <p style="color: #666;">View and respond to inquiries from the contact page</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 250px);">
                        <!-- Messages List -->
                        <div class="dash-card" style="padding: 0; overflow-y: auto;">
                            <div style="padding: 15px; border-bottom: 1px solid #eee; background: #f8f9fa;">
                                <input type="text" id="contact-search" placeholder="Search messages..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onkeyup="filterContactMessages(this.value)">
                            </div>
                            <div id="contact-messages-list" style="padding: 10px;">
                                <div style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <p>Loading messages...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat View -->
                        <div class="dash-card" style="padding: 0; display: flex; flex-direction: column; height: 100%;">
                            <div id="contact-chat-empty" style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #999;">
                                <i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                                <p style="font-size: 1.1rem;">Select a message to start chatting</p>
                            </div>
                            
                            <div id="contact-chat-view" style="display: none; flex: 1; flex-direction: column; height: 100%;">
                                <!-- Chat Header -->
                                <div style="padding: 20px; border-bottom: 1px solid #eee; background: #f8f9fa;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h3 style="margin: 0; color: var(--primary);" id="contact-chat-name">Contact Name</h3>
                                            <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;" id="contact-chat-email">email@example.com</p>
                                        </div>
                                        <div>
                                            <span class="status-badge" id="contact-chat-status" style="background: #d1e7dd; color: #0f5132;">New</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chat Body -->
                                <div id="contact-chat-body" style="flex: 1; padding: 20px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 15px;">
                                    <!-- Messages will be loaded here -->
                                </div>

                                <!-- Chat Footer -->
                                <div style="padding: 15px; border-top: 1px solid #eee; background: #f8f9fa;">
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="contact-chat-input" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px;" onkeypress="if(event.key === 'Enter') sendContactReply()">
                                        <button class="btn" onclick="sendContactReply()" style="padding: 12px 24px;">
                                            <i class="fas fa-paper-plane"></i> Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BLOG MANAGEMENT VIEW -->
                <div id="admin-blogs-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin-bottom: 10px;"><i class="fas fa-blog"></i> Blog Management</h2>
                                <p style="color: var(--text-light);">Create, edit, and manage blog posts</p>
                            </div>
                            <button class="btn btn-accent" onclick="showCreateBlogModal()">
                                <i class="fas fa-plus"></i> Create New Blog
                            </button>
                        </div>
                    </div>

                    <!-- Blog List -->
                    <div class="dash-card">
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="blog-search" placeholder="Search blogs..." 
                                   style="flex: 1; min-width: 250px; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-md);"
                                   onkeyup="filterBlogs(this.value)">
                            <select id="blog-filter-status" onchange="filterBlogsByStatus(this.value)" 
                                    style="padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-md);">
                                <option value="all">All Status</option>
                                <option value="published">Published</option>
                                <option value="draft">Draft</option>
                            </select>
                        </div>
                        <div id="admin-blogs-list">
                            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Loading blogs...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE/EDIT BLOG MODAL -->
    <div id="blog-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="blog-modal-title"><i class="fas fa-plus"></i> Create New Blog Post</h3>
                <button class="modal-close" onclick="closeBlogModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <form id="blog-form" onsubmit="saveBlog(event); return false;">
                    <input type="hidden" id="blog-id">
                    
                    <div style="margin-bottom: 20px;">
                        <label for="blog-title">Blog Title *</label>
                        <input type="text" id="blog-title" placeholder="Enter blog title" required 
                               style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md);">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="blog-excerpt">Short Description/Excerpt *</label>
                        <textarea id="blog-excerpt" rows="3" placeholder="Brief description of the blog post" required
                                  style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md);"></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="blog-content">Content *</label>
                        <textarea id="blog-content" rows="12" placeholder="Write your blog content here..." required
                                  style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md); font-family: inherit;"></textarea>
                        <small style="color: var(--text-light);">You can use HTML formatting in the content.</small>
                    </div>

                    <div class="grid-2" style="gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label for="blog-category">Category *</label>
                            <select id="blog-category" required
                                    style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md);">
                                <option value="">Select Category</option>
                                <option value="Study Guide">Study Guide</option>
                                <option value="Visa Tips">Visa Tips</option>
                                <option value="Scholarships">Scholarships</option>
                                <option value="University Info">University Info</option>
                                <option value="Student Life">Student Life</option>
                                <option value="Success Stories">Success Stories</option>
                                <option value="News">News</option>
                            </select>
                        </div>
                        <div>
                            <label for="blog-status">Status *</label>
                            <select id="blog-status" required
                                    style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md);">
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="blog-image">Featured Image URL</label>
                        <input type="url" id="blog-image" placeholder="https://example.com/image.jpg"
                               style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md);">
                        <small style="color: var(--text-light);">Optional: Add a featured image URL for the blog post</small>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                        <button type="button" class="btn" onclick="closeBlogModal()" style="background: var(--text-light);">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-accent">
                            <i class="fas fa-save"></i> Save Blog
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CREATE USER MODAL -->
    <div id="create-user-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Create New User</h3>
                <button class="modal-close" onclick="closeCreateUserModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email Address</label>
                    <input type="email" id="create-user-email" placeholder="user@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Password</label>
                    <input type="password" id="create-user-password" placeholder="Minimum 6 characters" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role</label>
                    <select id="create-user-role" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="student">Student</option>
                        <option value="counselor">Counselor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">First Name</label>
                    <input type="text" id="create-user-fname" placeholder="First Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Last Name</label>
                    <input type="text" id="create-user-lname" placeholder="Last Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="createNewUser()"><i class="fas fa-check"></i> Create User</button>
            </div>
        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit User</h3>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="edit-user-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email Address</label>
                    <input type="email" id="edit-user-email" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role</label>
                    <select id="edit-user-role" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="student">Student</option>
                        <option value="counselor">Counselor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">First Name</label>
                    <input type="text" id="edit-user-fname" placeholder="First Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Last Name</label>
                    <input type="text" id="edit-user-lname" placeholder="Last Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div id="edit-student-counselor" style="margin-bottom: 20px; display: none;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Assigned Counselor</label>
                    <select id="edit-user-counselor" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">None (Not Assigned - Counselors will choose)</option>
                    </select>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> Leave as "None" to let counselors choose students from the Available Students list.
                    </p>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveUserChanges()"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- TEST SCORE MODAL -->
    <div id="test-score-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-certificate"></i> Add Test Score</h3>
                <button class="modal-close" onclick="closeTestScoreModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Test Type</label>
                    <select id="test-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="IELTS">IELTS</option>
                        <option value="TOEFL">TOEFL</option>
                        <option value="PTE">PTE</option>
                        <option value="GRE">GRE</option>
                        <option value="GMAT">GMAT</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Score</label>
                    <input type="text" id="test-score" placeholder="e.g., 7.5 or 100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Test Date</label>
                    <input type="date" id="test-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Expiry Date</label>
                    <input type="date" id="test-expiry" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button class="btn" style="width: 100%;" onclick="saveTestScore()"><i class="fas fa-save"></i> Save Score</button>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> Add Payment</h3>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Payment Type</label>
                    <select id="payment-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="Application Fee">Application Fee</option>
                        <option value="Visa Fee">Visa Fee</option>
                        <option value="Service Fee">Service Fee</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Amount</label>
                    <input type="number" id="payment-amount" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Payment Date</label>
                    <input type="date" id="payment-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Status</label>
                    <select id="payment-status" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes</label>
                    <textarea id="payment-notes" rows="3" placeholder="Additional notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <button class="btn" style="width: 100%;" onclick="savePayment()"><i class="fas fa-save"></i> Save Payment</button>
            </div>
        </div>
    </div>

    <!-- TASK MODAL -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-tasks"></i> Add Task</h3>
                <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Task Title</label>
                    <input type="text" id="task-title" placeholder="Enter task title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description</label>
                    <textarea id="task-description" rows="3" placeholder="Task description..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Due Date</label>
                    <input type="date" id="task-due-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Priority</label>
                    <select id="task-priority" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <button class="btn" style="width: 100%;" onclick="saveTask()"><i class="fas fa-save"></i> Save Task</button>
            </div>
        </div>
    </div>

    <!-- NOTE MODAL -->
    <div id="note-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-sticky-note"></i> Add Note</h3>
                <button class="modal-close" onclick="closeNoteModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Note</label>
                    <textarea id="note-content" rows="5" placeholder="Enter your note..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tags (comma separated)</label>
                    <input type="text" id="note-tags" placeholder="e.g., urgent, follow-up, important" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button class="btn" style="width: 100%;" onclick="saveNote()"><i class="fas fa-save"></i> Save Note</button>
            </div>
        </div>
    </div>

    <!-- APPOINTMENT MODAL -->
    <div id="appointment-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-check"></i> Schedule Appointment</h3>
                <button class="modal-close" onclick="closeAppointmentModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date</label>
                    <input type="date" id="appointment-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Time</label>
                    <input type="time" id="appointment-time" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Duration (minutes)</label>
                    <input type="number" id="appointment-duration" value="30" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Meeting Type</label>
                    <select id="appointment-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="in-person">In Person</option>
                        <option value="video">Video Call</option>
                        <option value="phone">Phone Call</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes</label>
                    <textarea id="appointment-notes" rows="3" placeholder="Meeting agenda or notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <button class="btn" style="width: 100%;" onclick="saveAppointment()"><i class="fas fa-save"></i> Schedule Appointment</button>
            </div>
        </div>
    </div>

    <!-- CHAT MODAL -->
    <div id="chat-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="background: var(--primary); color: white;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: white;">Chat with Your Counselor</h3>
                        <span style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                            <i class="fas fa-circle" style="font-size: 0.5rem; color: var(--success);"></i> Online
                        </span>
                    </div>
                </div>
                <button class="modal-close" onclick="closeChatModal()" style="color: white;">&times;</button>
            </div>
            <div id="stu-chat-box-modal" class="chat-body" style="flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa;">
                <div class="message msg-in">
                    <strong>System:</strong> Chat history will appear here. Start a conversation with your counselor!
                </div>
            </div>
            <div class="chat-footer" style="background: white; padding: 15px; border-top: 1px solid #eee;">
                <input type="text" id="stu-chat-input-modal" placeholder="Type your message..." style="flex: 1; margin: 0; border: 1px solid #ddd; background: #f0f2f5; border-radius: 20px; padding: 10px 15px;" onkeypress="if(event.key === 'Enter') sendMessageFromModal('student')">
                <button class="btn" style="border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center; background: var(--primary); margin-left: 10px;" onclick="sendMessageFromModal('student')" title="Send message">
                    <i class="fas fa-paper-plane" style="color: white;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- STATUS TRACKER MODAL -->
    <div id="status-tracker-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-route"></i> Application Status Tracker</h3>
                <button class="modal-close" onclick="closeStatusTrackerModal()">&times;</button>
            </div>
            <div style="padding: 30px;">
                <div id="status-tracker-modal-content" class="status-tracker">
                    <div class="status-step completed">
                        <div class="status-circle">1</div>
                        <div class="status-label">Application<br>Submitted</div>
                    </div>
                    <div class="status-step active">
                        <div class="status-circle">2</div>
                        <div class="status-label">Under<br>Review</div>
                    </div>
                    <div class="status-step">
                        <div class="status-circle">3</div>
                        <div class="status-label">Offer<br>Received</div>
                    </div>
                    <div class="status-step">
                        <div class="status-circle">4</div>
                        <div class="status-label">Visa<br>Processing</div>
                    </div>
                    <div class="status-step">
                        <div class="status-circle">5</div>
                        <div class="status-label">Visa<br>Approved</div>
                    </div>
                </div>
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-top: 0; color: var(--primary);"><i class="fas fa-info-circle"></i> Current Status</h4>
                    <p id="status-tracker-details" style="margin: 0; color: #666;">Your application is currently under review. We'll update you as soon as there are any changes.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- DOCUMENT CHECKLIST MODAL -->
    <div id="document-checklist-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-check-square"></i> Document Checklist</h3>
                <button class="modal-close" onclick="closeDocumentChecklistModal()">&times;</button>
            </div>
            <div style="padding: 30px;">
                <div style="margin-bottom: 25px;">
                    <div class="checklist-progress">
                        <div class="checklist-progress-bar" id="checklist-progress-bar-modal" style="width: 0%;"></div>
                    </div>
                    <p style="text-align: right; margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <span id="checklist-completed-modal">0</span> of <span id="checklist-total-modal">8</span> documents completed
                        <span style="margin-left: 15px; font-weight: 600; color: var(--primary);" id="checklist-percentage-modal">0%</span>
                    </p>
                </div>
                <div id="document-checklist-modal-content" style="margin-top: 20px;">
                    <!-- Populated by JS -->
                </div>
                <div style="margin-top: 25px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
                    <p style="margin: 0; font-size: 0.85rem; color: #0d47a1;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Documents marked with <span style="color: var(--danger);">*</span> are required. Upload them from the Application Form page.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- TEST SCORES MODAL (Enhanced) -->
    <div id="test-scores-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3><i class="fas fa-certificate"></i> Test Scores</h3>
                <div>
                    <button class="btn btn-sm" onclick="openTestScoreModal()" style="margin-right: 10px;"><i class="fas fa-plus"></i> Add Score</button>
                    <button class="modal-close" onclick="closeTestScoresModal()">&times;</button>
                </div>
            </div>
            <div style="padding: 20px; flex: 1; overflow-y: auto;">
                <div id="test-scores-list-modal">
                    <p style="color: #999; text-align: center; padding: 40px;">No test scores added yet. Click "Add Score" to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENTS MODAL (Enhanced) -->
    <div id="payments-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> Payment Tracking</h3>
                <div>
                    <button class="btn btn-sm" onclick="openPaymentModal()" style="margin-right: 10px;"><i class="fas fa-plus"></i> Add Payment</button>
                    <button class="modal-close" onclick="closePaymentsModal()">&times;</button>
                </div>
            </div>
            <div style="padding: 20px; flex: 1; overflow-y: auto;">
                <div id="payments-list-modal">
                    <p style="color: #999; text-align: center; padding: 40px;">No payments recorded yet. Click "Add Payment" to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, increment, limit, onSnapshot, orderBy, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

        console.log('Main script loaded, Firebase imports successful');

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCupkWcEuM27tZojhPahJj3g6LAUSn15gs",
            authDomain: "intedu-2595c.firebaseapp.com",
            projectId: "intedu-2595c",
            storageBucket: "intedu-2595c.firebasestorage.app",
            messagingSenderId: "713959040536",
            appId: "1:713959040536:web:3b0d9d34696aeee049c56d"
        };

        let app, auth, db, storage, isDemoMode = false;
        let currentApplication = { status: 'Draft' };
        
        // --- COUNSELOR DATA (Loaded from Database) ---
        let counselorStudents = []; // All students loaded from Firebase
        let currentStudentId = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            console.log("Firebase initialized");
        } catch(e) { console.warn("Firebase Init Error", e); }

        // Seed admin user in Firebase
        window.seedAdminUser = async function() {
            if (!auth || !db) {
                console.warn("Firebase not initialized, cannot seed admin user");
                return;
            }

            const ADMIN_EMAIL = 'admin@gmail.com';
            const ADMIN_PASSWORD = 'admin123';

            try {
                // Sign out any existing user first
                const currentUser = auth.currentUser;
                if(currentUser) {
                    await signOut(auth);
                }

                // Try to sign in first to check if user exists
                let userCredential;
                try {
                    userCredential = await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                    console.log("Admin user already exists in Firebase Auth");
                } catch(signInError) {
                    // If user doesn't exist, create it
                    if(signInError.code === 'auth/user-not-found') {
                        console.log("Creating admin user in Firebase Auth...");
                        userCredential = await createUserWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                        console.log("Admin user created successfully in Firebase Auth");
                    } else {
                        console.warn("Error checking admin user:", signInError);
                        return;
                    }
                }

                const user = userCredential.user;

                // Ensure admin user document exists in Firestore
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(!userDoc.exists()) {
                    console.log("Creating admin user document in Firestore...");
                    await setDoc(doc(db, "users", user.uid), {
                        email: ADMIN_EMAIL,
                        role: 'admin',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    console.log("Admin user document created in Firestore");
                } else {
                    const userData = userDoc.data();
                    if(userData.role !== 'admin') {
                        console.log("Updating user role to admin in Firestore...");
                        await updateDoc(doc(db, "users", user.uid), {
                            role: 'admin',
                            updatedAt: new Date().toISOString()
                        });
                        console.log("Admin role updated in Firestore");
                    } else {
                        console.log("Admin user document already exists with correct role");
                    }
                }

                // Sign out after seeding (user will sign in when they login)
                await signOut(auth);
                console.log("Admin user seeded successfully");
            } catch(err) {
                console.error("Error seeding admin user:", err);
            }
        };

        // Auto-seed admin user when Firebase is ready
        if(auth && db) {
            // Wait a bit for Firebase to be fully ready
            setTimeout(() => {
                seedAdminUser();
            }, 1000);
        }

        window.currentRole = '';

        // --- UNIVERSITY DATA ---
        const universityData = {
            "Canada": {
                "Ontario": [
                    "University of Toronto",
                    "University of Waterloo",
                    "McMaster University",
                    "Western University",
                    "Queen's University",
                    "University of Ottawa",
                    "York University",
                    "Ryerson University",
                    "University of Guelph",
                    "Carleton University",
                    "Seneca College",
                    "Humber College",
                    "George Brown College",
                    "Centennial College",
                    "Sheridan College",
                    "Fanshawe College",
                    "Conestoga College",
                    "Algonquin College"
                ],
                "British Columbia": [
                    "University of British Columbia (UBC)",
                    "Simon Fraser University (SFU)",
                    "University of Victoria",
                    "British Columbia Institute of Technology (BCIT)",
                    "Capilano University",
                    "Kwantlen Polytechnic University",
                    "Langara College",
                    "Douglas College",
                    "Vancouver Community College",
                    "Camosun College"
                ],
                "Alberta": [
                    "University of Alberta",
                    "University of Calgary",
                    "Mount Royal University",
                    "MacEwan University",
                    "SAIT Polytechnic",
                    "NAIT (Northern Alberta Institute of Technology)",
                    "Bow Valley College",
                    "Lethbridge College"
                ],
                "Quebec": [
                    "McGill University",
                    "UniversitÃ© de MontrÃ©al",
                    "Concordia University",
                    "UniversitÃ© Laval",
                    "HEC MontrÃ©al",
                    "Ã‰cole Polytechnique de MontrÃ©al",
                    "Dawson College",
                    "Vanier College",
                    "John Abbott College",
                    "CÃ©gep de Maisonneuve"
                ],
                "Manitoba": [
                    "University of Manitoba",
                    "University of Winnipeg",
                    "Red River College",
                    "Assiniboine Community College",
                    "Manitoba Institute of Trades and Technology"
                ],
                "Saskatchewan": [
                    "University of Saskatchewan",
                    "University of Regina",
                    "Saskatchewan Polytechnic",
                    "Cumberland College"
                ],
                "Nova Scotia": [
                    "Dalhousie University",
                    "Saint Mary's University",
                    "Acadia University",
                    "Nova Scotia Community College (NSCC)",
                    "Mount Saint Vincent University"
                ],
                "New Brunswick": [
                    "University of New Brunswick",
                    "Mount Allison University",
                    "St. Thomas University",
                    "New Brunswick Community College"
                ],
                "Newfoundland and Labrador": [
                    "Memorial University of Newfoundland",
                    "College of the North Atlantic"
                ],
                "Prince Edward Island": [
                    "University of Prince Edward Island",
                    "Holland College"
                ]
            },
            "USA": {
                "California": [
                    "Stanford University",
                    "University of California, Berkeley (UC Berkeley)",
                    "University of California, Los Angeles (UCLA)",
                    "University of Southern California (USC)",
                    "California Institute of Technology (Caltech)",
                    "University of California, San Diego (UCSD)",
                    "University of California, Davis (UC Davis)",
                    "University of California, Irvine (UCI)",
                    "University of California, Santa Barbara (UCSB)",
                    "San Francisco State University",
                    "California State University, Long Beach",
                    "California State University, Fullerton",
                    "San Jose State University",
                    "Santa Monica College",
                    "De Anza College",
                    "Pasadena City College"
                ],
                "New York": [
                    "Columbia University",
                    "New York University (NYU)",
                    "Cornell University",
                    "University of Rochester",
                    "Syracuse University",
                    "Fordham University",
                    "Stony Brook University",
                    "City University of New York (CUNY)",
                    "State University of New York (SUNY)",
                    "Rensselaer Polytechnic Institute",
                    "Rochester Institute of Technology",
                    "Baruch College",
                    "Hunter College",
                    "Queens College"
                ],
                "Massachusetts": [
                    "Harvard University",
                    "Massachusetts Institute of Technology (MIT)",
                    "Boston University",
                    "Northeastern University",
                    "Boston College",
                    "Tufts University",
                    "University of Massachusetts Amherst",
                    "Brandeis University",
                    "Worcester Polytechnic Institute",
                    "Bunker Hill Community College"
                ],
                "Texas": [
                    "University of Texas at Austin",
                    "Texas A&M University",
                    "Rice University",
                    "University of Houston",
                    "Texas Tech University",
                    "Baylor University",
                    "Southern Methodist University",
                    "Austin Community College",
                    "Houston Community College"
                ],
                "Illinois": [
                    "University of Chicago",
                    "Northwestern University",
                    "University of Illinois at Urbana-Champaign",
                    "Illinois Institute of Technology",
                    "DePaul University",
                    "Loyola University Chicago",
                    "City Colleges of Chicago"
                ],
                "Florida": [
                    "University of Florida",
                    "Florida State University",
                    "University of Miami",
                    "University of Central Florida",
                    "Florida International University",
                    "Miami Dade College",
                    "Valencia College"
                ],
                "Pennsylvania": [
                    "University of Pennsylvania",
                    "Carnegie Mellon University",
                    "Penn State University",
                    "Temple University",
                    "Drexel University",
                    "University of Pittsburgh",
                    "Community College of Philadelphia"
                ],
                "Michigan": [
                    "University of Michigan",
                    "Michigan State University",
                    "Wayne State University",
                    "Oakland University",
                    "Washtenaw Community College"
                ],
                "Washington": [
                    "University of Washington",
                    "Washington State University",
                    "Seattle University",
                    "Bellevue College",
                    "Shoreline Community College"
                ],
                "Arizona": [
                    "Arizona State University",
                    "University of Arizona",
                    "Northern Arizona University",
                    "Maricopa Community Colleges"
                ],
                "Georgia": [
                    "Georgia Institute of Technology",
                    "Emory University",
                    "University of Georgia",
                    "Georgia State University",
                    "Georgia Perimeter College"
                ],
                "North Carolina": [
                    "Duke University",
                    "University of North Carolina at Chapel Hill",
                    "North Carolina State University",
                    "Wake Forest University"
                ]
            },
            "Australia": {
                "New South Wales": [
                    "University of Sydney",
                    "University of New South Wales (UNSW)",
                    "Macquarie University",
                    "University of Technology Sydney (UTS)",
                    "Western Sydney University",
                    "University of Wollongong",
                    "Australian Catholic University",
                    "TAFE NSW",
                    "Sydney Institute of Technology",
                    "Navitas English"
                ],
                "Victoria": [
                    "University of Melbourne",
                    "Monash University",
                    "RMIT University",
                    "Deakin University",
                    "La Trobe University",
                    "Swinburne University of Technology",
                    "Victoria University",
                    "TAFE Victoria",
                    "Holmesglen Institute",
                    "Box Hill Institute"
                ],
                "Queensland": [
                    "University of Queensland (UQ)",
                    "Queensland University of Technology (QUT)",
                    "Griffith University",
                    "James Cook University",
                    "Bond University",
                    "TAFE Queensland",
                    "Southbank Institute of Technology"
                ],
                "Western Australia": [
                    "University of Western Australia (UWA)",
                    "Curtin University",
                    "Murdoch University",
                    "Edith Cowan University",
                    "TAFE Western Australia"
                ],
                "South Australia": [
                    "University of Adelaide",
                    "Flinders University",
                    "University of South Australia",
                    "TAFE South Australia"
                ],
                "Tasmania": [
                    "University of Tasmania",
                    "TAFE Tasmania"
                ],
                "Australian Capital Territory": [
                    "Australian National University (ANU)",
                    "University of Canberra",
                    "Canberra Institute of Technology"
                ],
                "Northern Territory": [
                    "Charles Darwin University",
                    "Batchelor Institute of Indigenous Tertiary Education"
                ]
            },
            "UK": {
                "England - London": [
                    "Imperial College London",
                    "University College London (UCL)",
                    "King's College London",
                    "London School of Economics (LSE)",
                    "Queen Mary University of London",
                    "City, University of London",
                    "Birkbeck, University of London",
                    "Goldsmiths, University of London",
                    "Royal Holloway, University of London",
                    "Brunel University London",
                    "University of Westminster",
                    "London Metropolitan University",
                    "Middlesex University",
                    "University of East London"
                ],
                "England - Oxford": [
                    "University of Oxford",
                    "Oxford Brookes University"
                ],
                "England - Cambridge": [
                    "University of Cambridge",
                    "Anglia Ruskin University"
                ],
                "England - Manchester": [
                    "University of Manchester",
                    "Manchester Metropolitan University"
                ],
                "England - Birmingham": [
                    "University of Birmingham",
                    "Aston University",
                    "Birmingham City University"
                ],
                "England - Leeds": [
                    "University of Leeds",
                    "Leeds Beckett University"
                ],
                "England - Liverpool": [
                    "University of Liverpool",
                    "Liverpool John Moores University"
                ],
                "England - Bristol": [
                    "University of Bristol",
                    "University of the West of England"
                ],
                "England - Newcastle": [
                    "Newcastle University",
                    "Northumbria University"
                ],
                "England - Sheffield": [
                    "University of Sheffield",
                    "Sheffield Hallam University"
                ],
                "England - Nottingham": [
                    "University of Nottingham",
                    "Nottingham Trent University"
                ],
                "England - York": [
                    "University of York",
                    "York St John University"
                ],
                "England - Durham": [
                    "Durham University",
                    "Teesside University"
                ],
                "England - Southampton": [
                    "University of Southampton",
                    "Southampton Solent University"
                ],
                "England - Warwick": [
                    "University of Warwick",
                    "Coventry University"
                ],
                "Scotland": [
                    "University of Edinburgh",
                    "University of Glasgow",
                    "University of St Andrews",
                    "University of Aberdeen",
                    "Heriot-Watt University",
                    "University of Strathclyde",
                    "Edinburgh Napier University",
                    "Glasgow Caledonian University",
                    "Robert Gordon University",
                    "Abertay University"
                ],
                "Wales": [
                    "Cardiff University",
                    "Swansea University",
                    "Bangor University",
                    "Aberystwyth University",
                    "University of South Wales"
                ],
                "Northern Ireland": [
                    "Queen's University Belfast",
                    "Ulster University"
                ]
            }
        };

        // --- HELPERS ---
        function showAuthError(msg) {
            const errBox = document.getElementById('auth-error-msg');
            if(msg && msg.trim()) {
                errBox.innerText = msg;
                errBox.style.display = 'block';
            } else {
                errBox.innerText = '';
                errBox.style.display = 'none';
            }
        }

        // --- WIZARD LOGIC (FIXED) ---
        let currentStep = 1;
        window.goToStep = async function(n) {
            try {
            // Validate step 1 if moving forward
            if(n === 2 && currentStep === 1) {
                    const fname = document.getElementById('app-fname');
                    const lname = document.getElementById('app-lname');
                    const phone = document.getElementById('app-phone');
                    if(!fname || !lname || !phone) {
                        console.error('Form fields not found');
                        return;
                    }
                    if(!fname.value || !lname.value || !phone.value) {
                        showWarning("Please fill in First Name, Last Name and Phone Number.");
                        return;
                    }
                }
                
                // Save current step data before moving (both forward and backward)
                await saveFormDataIncrementally();
                
                // Switch tabs - remove inline display styles and use CSS classes
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = ''; // Remove inline display style to let CSS handle it
                });
                const targetStep = document.getElementById('wizard-step-' + n);
                if(!targetStep) {
                    console.error('Step element not found: wizard-step-' + n);
                    return;
                }
                targetStep.classList.add('active');
                targetStep.style.display = ''; // Ensure no inline style blocks CSS
            
            // Update Indicators
            document.querySelectorAll('.step').forEach((el, index) => {
                const stepNum = index + 1;
                el.classList.remove('active', 'completed');
                if(stepNum < n) el.classList.add('completed');
                if(stepNum === n) el.classList.add('active');
            });
            currentStep = n;
                
                // If moving to step 2, restore country selection and update locations
                if(n === 2 && currentApplication.country) {
                    const countrySel = document.getElementById('app-country');
                    const stateSel = document.getElementById('app-state');
                    if(countrySel && currentApplication.country) {
                        countrySel.value = currentApplication.country;
                        updateLocations();
                        // Restore state selection if available
                        if(currentApplication.state && stateSel) {
                            setTimeout(() => {
                                stateSel.value = currentApplication.state;
                                updateUniversities();
                            }, 100);
                        }
                    }
                }
            } catch(error) {
                console.error('Error in goToStep:', error);
                showError('An error occurred. Please try again.');
            }
        };

        // --- STUDENT FORM LOGIC ---
        window.updateLocations = function() {
            const country = document.getElementById('app-country').value;
            const stateSel = document.getElementById('app-state');
            const uniSel = document.getElementById('app-university');
            
            stateSel.innerHTML = '<option value="" disabled selected>Choose Location...</option>';
            uniSel.innerHTML = '<option value="" disabled selected>Select Location First</option>';
            uniSel.disabled = true;

            if (universityData[country]) {
                stateSel.disabled = false;
                Object.keys(universityData[country]).forEach(state => {
                    stateSel.innerHTML += `<option value="${state}">${state}</option>`;
                });
            }
        };

        window.updateUniversities = function() {
            const country = document.getElementById('app-country').value;
            const state = document.getElementById('app-state').value;
            const uniSel = document.getElementById('app-university');

            uniSel.innerHTML = '<option value="" disabled selected>Choose University...</option>';
            if (universityData[country] && universityData[country][state]) {
                uniSel.disabled = false;
                universityData[country][state].forEach(uni => uniSel.innerHTML += `<option value="${uni}">${uni}</option>`);
            }
        };

        let selectedUnis = [];
        window.handleAddUniversity = function() {
            const uniSel = document.getElementById('app-university');
            const uni = uniSel.value;
            if (!uni || selectedUnis.includes(uni)) return;
            selectedUnis.push(uni);
            updateSelectedList();
            uniSel.value = "";
        };

        window.removeUni = function(uni) {
            selectedUnis = selectedUnis.filter(u => u !== uni);
            updateSelectedList();
        };

        function updateSelectedList() {
            const list = document.getElementById('selected-universities-list');
            list.innerHTML = selectedUnis.map(u => 
                `<span class="uni-tag">${u} <i class="fas fa-times" onclick="removeUni('${u}')"></i></span>`
            ).join('');
            document.getElementById('dash-colleges-count').innerText = selectedUnis.length;
        }

        // Function to collect current form data
        function collectFormData() {
            // Convert uploadedFiles object to array format for database storage
            let docsArray = [];
            Object.keys(uploadedFiles).forEach(docType => {
                uploadedFiles[docType].forEach(file => {
                    // Include all file metadata fields, especially for chunked files
                    const fileDoc = {
                        id: file.id || `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        type: docType,
                        name: file.name,
                        size: file.size,
                        fileType: file.type || null,
                        uploadedAt: file.uploadedAt || new Date().toISOString(),
                        downloadURL: file.downloadURL || null, // Include Firebase Storage download URL
                        storagePath: file.storagePath || null, // Include storage path for reference
                        // Chunked file fields
                        isChunked: file.isChunked || false,
                        chunkCount: file.chunkCount || null,
                        chunkedFileId: file.chunkedFileId || null
                    };
                    docsArray.push(fileDoc);
                });
            });
            
            return {
                fname: document.getElementById('app-fname')?.value || '',
                lname: document.getElementById('app-lname')?.value || '',
                dob: document.getElementById('app-dob')?.value || '',
                gender: document.getElementById('app-gender')?.value || '',
                citizen: document.getElementById('app-citizen')?.value || '',
                phone: document.getElementById('app-phone')?.value || '',
                address: document.getElementById('app-address')?.value || '',
                country: document.getElementById('app-country')?.value || '',
                state: document.getElementById('app-state')?.value || '',
                intake: document.getElementById('app-intake')?.value || '',
                universities: selectedUnis,
                docs: docsArray, // Include documents in form data
                lastStep: currentStep, // Track which step they were on
                status: currentApplication.status || 'Draft',
                updatedAt: new Date().toISOString()
            };
        }

        // Function to save data incrementally
        async function saveFormDataIncrementally() {
            const formData = collectFormData();
            currentApplication = { ...currentApplication, ...formData };
            
            // SAVE TO FIRESTORE
            if(auth && auth.currentUser && !isDemoMode) {
                try {
                    await setDoc(doc(db, "users", auth.currentUser.uid), currentApplication, { merge: true });
                    console.log('Form data saved successfully');
                } catch(e) { 
                    console.error("Save error", e); 
                }
            } else if(isDemoMode) {
                localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                console.log('Form data saved to localStorage (demo mode)');
            }
        }

        // Function to load and populate form data
        function loadFormData() {
            if(!currentApplication || Object.keys(currentApplication).length === 0) return;
            
            // Step 1 fields - check if elements exist before setting values
            const fnameEl = document.getElementById('app-fname');
            const lnameEl = document.getElementById('app-lname');
            const dobEl = document.getElementById('app-dob');
            const genderEl = document.getElementById('app-gender');
            const citizenEl = document.getElementById('app-citizen');
            const phoneEl = document.getElementById('app-phone');
            const addressEl = document.getElementById('app-address');
            
            if(fnameEl && currentApplication.fname) fnameEl.value = currentApplication.fname;
            if(lnameEl && currentApplication.lname) lnameEl.value = currentApplication.lname;
            if(dobEl && currentApplication.dob) dobEl.value = currentApplication.dob;
            if(genderEl && currentApplication.gender) genderEl.value = currentApplication.gender;
            if(citizenEl && currentApplication.citizen) citizenEl.value = currentApplication.citizen;
            if(phoneEl && currentApplication.phone) phoneEl.value = currentApplication.phone;
            if(addressEl && currentApplication.address) addressEl.value = currentApplication.address;
            
            // Step 2 fields
            const countryEl = document.getElementById('app-country');
            const stateEl = document.getElementById('app-state');
            const intakeEl = document.getElementById('app-intake');
            
            if(countryEl && currentApplication.country) {
                countryEl.value = currentApplication.country;
                updateLocations();
                // Wait a bit for the state dropdown to populate, then restore state
                if(stateEl && currentApplication.state) {
                    setTimeout(() => {
                        if(document.getElementById('app-state')) {
                            document.getElementById('app-state').value = currentApplication.state;
                            updateUniversities();
                            // Wait a bit more for universities to populate
                            setTimeout(() => {
                                if(currentApplication.universities && currentApplication.universities.length > 0) {
                                    selectedUnis = [...currentApplication.universities];
                                    updateSelectedList();
                                }
                            }, 100);
                        }
                    }, 100);
                } else if(currentApplication.universities && currentApplication.universities.length > 0) {
                    // If no state but universities exist, restore them
                    selectedUnis = [...currentApplication.universities];
                    updateSelectedList();
                }
            }
            if(intakeEl && currentApplication.intake) intakeEl.value = currentApplication.intake;
            
            // Restore universities array (fallback if country wasn't set)
            if(currentApplication.universities && currentApplication.universities.length > 0 && selectedUnis.length === 0) {
                selectedUnis = [...currentApplication.universities];
                updateSelectedList();
            }
            
            // Restore uploaded documents - only if not already loaded to prevent duplicates
            if(currentApplication.docs && currentApplication.docs.length > 0) {
                const list = document.getElementById('stu-file-list');
                if(list) {
                    // Check if documents are already loaded by checking if list has file divs
                    const existingFileDivs = list.querySelectorAll('div[id^="file-"]');
                    if(existingFileDivs.length === 0) {
                        // Only restore if list is empty (not already loaded)
                        uploadedFiles = {};
                        uploadedFilesCounter = 0;
                        
                        const noDocsDiv = list.querySelector('.no-docs');
                        if(noDocsDiv) {
                            noDocsDiv.remove();
                        }
                        
                        currentApplication.docs.forEach((docItem) => {
                            const docType = docItem.type;
                            if(!uploadedFiles[docType]) {
                                uploadedFiles[docType] = [];
                            }
                            
                            // Use the original file ID from the database, or generate a new one if missing
                            const fileId = docItem.id || `file-${uploadedFilesCounter++}`;
                            
                            // Restore all file metadata including chunked file info
                            const fileMetadata = {
                                id: fileId,
                                name: docItem.name,
                                size: docItem.size || 0,
                                type: docItem.fileType || 'application/pdf',
                                uploadedAt: docItem.uploadedAt || new Date().toISOString(),
                                downloadURL: docItem.downloadURL || null, // Restore Firebase Storage URL
                                storagePath: docItem.storagePath || null,
                                // Chunked file metadata
                                isChunked: docItem.isChunked || false,
                                chunkCount: docItem.chunkCount || null,
                                chunkedFileId: docItem.chunkedFileId || null
                            };
                            
                            uploadedFiles[docType].push(fileMetadata);
                            
                            // Display in the uploaded files list
                            const fileDiv = document.createElement('div');
                            fileDiv.id = fileId;
                            fileDiv.style.cssText = 'padding:10px; background:#fff; border:1px solid #eee; margin-top:5px; border-radius:4px; font-size:0.9rem; display:flex; align-items:center; justify-content:space-between;';
                            
                            // Format file size display
                            let fileSize = '';
                            if (docItem.size) {
                                if (docItem.size > 1024 * 1024) {
                                    fileSize = `(${(docItem.size / (1024 * 1024)).toFixed(2)} MB)`;
                                } else {
                                    fileSize = `(${(docItem.size / 1024).toFixed(2)} KB)`;
                                }
                            }
                            
                            const safeFileName = docItem.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            fileDiv.innerHTML = `
                                <div style="display:flex; align-items:center; flex:1;">
                                    <span class="doc-status-light doc-uploaded"></span>
                                    <strong style="margin-left:10px;">${docType}:</strong>
                                    <a href="#" onclick="downloadStudentDocument('${fileId}', '${docType}', '${safeFileName}'); return false;" style="margin-left:5px; color:var(--primary); text-decoration:none; cursor:pointer; font-weight:500; border-bottom:1px dotted var(--primary);" title="Click to download ${docItem.name}">
                                        ${docItem.name}
                                    </a>
                                    ${fileSize ? `<span style="margin-left:10px; color:#999; font-size:0.85rem;">${fileSize}</span>` : ''}
                                </div>
                                <button onclick="removeUploadedFileById('${fileId}', '${docType}')" style="background:none; border:none; color:#dc3545; cursor:pointer; padding:5px; margin-left:10px;" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            list.appendChild(fileDiv);
                        });
                    }
                }
            }
            
            // Restore wizard step if not submitted
            if(currentApplication.status !== 'Submitted' && currentApplication.lastStep) {
                const stepToShow = currentApplication.lastStep;
                currentStep = stepToShow;
                
                // Update wizard display - remove inline styles and use CSS classes
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = ''; // Remove inline display style
                });
                const targetStep = document.getElementById('wizard-step-' + stepToShow);
                if(targetStep) {
                    targetStep.classList.add('active');
                    targetStep.style.display = ''; // Ensure no inline style blocks CSS
                }
                
                // Update step indicators
                document.querySelectorAll('.step').forEach((el, index) => {
                    const stepNum = index + 1;
                    el.classList.remove('active', 'completed');
                    if(stepNum < stepToShow) el.classList.add('completed');
                    if(stepNum === stepToShow) el.classList.add('active');
                });
            }
        }

        window.saveApplication = async function() {
            // Collect all form data
            const formData = collectFormData();
            currentApplication = { ...currentApplication, ...formData };
            
            // SAVE TO FIRESTORE
            if(auth && auth.currentUser && !isDemoMode) {
                try {
                    await setDoc(doc(db, "users", auth.currentUser.uid), currentApplication, { merge: true });
                } catch(e) { console.error("Save error", e); }
            } else if(isDemoMode) {
                localStorage.setItem('demoApp', JSON.stringify(currentApplication));
            }
            
            const previewHTML = `
                <div class="preview-group"><div class="preview-label">Full Name</div><div class="preview-value">${currentApplication.fname} ${currentApplication.lname}</div></div>
                <div class="preview-group"><div class="preview-label">Contact</div><div class="preview-value">${currentApplication.phone}</div></div>
                <div class="preview-group"><div class="preview-label">Target</div><div class="preview-value">${currentApplication.country}</div></div>
                <div class="preview-group"><div class="preview-label">Intake</div><div class="preview-value">${currentApplication.intake}</div></div>
                <div class="preview-group"><div class="preview-label">Universities</div><div class="preview-value">${currentApplication.universities.join(', ') || 'None'}</div></div>
            `;
            document.getElementById('preview-content').innerHTML = previewHTML;
            document.getElementById('app-form-view').style.display = 'none';
            document.getElementById('wizard-steps').style.display = 'none'; // Hide steps in preview
            document.getElementById('app-preview-view').style.display = 'block';
            document.getElementById('dash-countries-count').innerText = currentApplication.country ? "1" : "0";
        };

        window.editApplication = function() {
            document.getElementById('app-form-view').style.display = 'block';
            document.getElementById('wizard-steps').style.display = 'flex';
            document.getElementById('app-preview-view').style.display = 'none';
        };

        window.submitApplication = async function() {
            if(confirm("Submit Application?")) {
                currentApplication.status = 'Submitted';
                
                // SAVE TO FIRESTORE
                if(auth && auth.currentUser && !isDemoMode) {
                    try {
                        await setDoc(doc(db, "users", auth.currentUser.uid), { status: 'Submitted' }, { merge: true });
                    } catch(e) { console.error("Submit error", e); }
                } else if(isDemoMode) {
                    localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                }

                showSuccess("Submitted! Your Profile is now created.");
                window.router('student');
            }
        };

        window.updateProfile = async function() {
            // Collect all form data
            const formData = collectFormData();
            currentApplication = { ...currentApplication, ...formData };
            
            // SAVE TO FIRESTORE
            if(auth && auth.currentUser && !isDemoMode) {
                try {
                    await setDoc(doc(db, "users", auth.currentUser.uid), currentApplication, { merge: true });
                } catch(e) { console.error("Update error", e); }
            } else if(isDemoMode) {
                localStorage.setItem('demoApp', JSON.stringify(currentApplication));
            }
            
            showSuccess("Profile Updated Successfully!");
            updateDashboardUI(); // Refresh dash widgets
        };

        function updateDashboardUI() {
            const isSubmitted = currentApplication.status === 'Submitted';
            
            if (isSubmitted) {
                // Show Profile Widget on Dashboard
                document.getElementById('dash-profile-view').style.display = 'block';
                document.getElementById('dash-full-name').innerText = currentApplication.fname + ' ' + currentApplication.lname;
                document.getElementById('dash-phone').innerText = currentApplication.phone;
                document.getElementById('dash-address').innerText = currentApplication.address;
                document.getElementById('dash-target').innerText = currentApplication.country;
                document.getElementById('dash-intake-val').innerText = currentApplication.intake;
                
                // Update Application Page UI to "Profile Mode"
                document.getElementById('student-side-app-link').innerHTML = '<i class="fas fa-user-circle"></i> My Profile';
                document.getElementById('app-page-title').innerText = 'My Student Profile';
                
                // Switch buttons: Hide Save, Show Update
                document.getElementById('btn-app-save').style.display = 'none';
                document.getElementById('btn-app-update').style.display = 'block';
                
                // Ensure form is visible and step 3 (docs) is active, hide wizard nav
                document.getElementById('wizard-steps').style.display = 'none'; // Hide numbers
                document.getElementById('app-form-view').style.display = 'block';
                document.getElementById('app-preview-view').style.display = 'none';
                
                // Show all sections at once for profile editing instead of wizard
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.style.display = 'block';
                    el.classList.add('active'); // Ensure visiblity
                });
                
                // Hide navigation buttons within wizard (Next/Back)
                document.querySelectorAll('.wizard-content .btn, .wizard-content .btn-outline').forEach(btn => {
                    if(btn.innerHTML.includes('Next') || btn.innerHTML.includes('Back')) {
                        btn.style.display = 'none';
                    }
                });

            } else {
                // Revert to "Application" Mode
                document.getElementById('dash-profile-view').style.display = 'none';
                document.getElementById('student-side-app-link').innerHTML = '<i class="fas fa-file-alt"></i> Application Form';
                document.getElementById('app-page-title').innerText = 'Application Wizard';
                document.getElementById('btn-app-save').style.display = 'block';
                document.getElementById('btn-app-update').style.display = 'none';
                document.getElementById('wizard-steps').style.display = 'flex';
                
                // Reset wizard visibility - use CSS classes instead of inline styles
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.style.display = ''; // Remove inline display style
                    el.classList.remove('active');
                });
                const step1 = document.getElementById('wizard-step-1');
                if(step1) {
                    step1.classList.add('active');
                    step1.style.display = ''; // Ensure no inline style blocks CSS
                }
                
                // Restore buttons
                document.querySelectorAll('.wizard-content button').forEach(btn => btn.style.display = 'inline-block');
            }
        }

        // --- COUNSELOR LOGIC ---
        window.renderStudentList = async function(filter = 'active') {
            // Show dashboard view, hide student detail view
            const dashboardView = document.getElementById('coun-dashboard-view');
            const interactionView = document.getElementById('coun-interaction');
            if(dashboardView) dashboardView.style.display = 'block';
            if(interactionView) interactionView.style.display = 'none';
            
            // Update filter buttons
            const btnActive = document.getElementById('btn-filter-active');
            const btnInactive = document.getElementById('btn-filter-inactive');
            const btnAvailable = document.getElementById('btn-filter-available');
            if(btnActive) btnActive.classList.toggle('btn-primary', filter === 'active');
            if(btnInactive) btnInactive.classList.toggle('btn-primary', filter === 'inactive');
            if(btnAvailable) btnAvailable.classList.toggle('btn-primary', filter === 'available');
            
            const list = document.getElementById('coun-student-list');
            const header = document.getElementById('coun-list-header');
            
            if(!list) {
                console.error('Counselor student list element not found');
                return;
            }
            
            // Update header
            if(header) {
                if(filter === 'active') header.innerText = 'Active Students';
                else if(filter === 'inactive') header.innerText = 'Inactive Students';
                else if(filter === 'archived') header.innerText = 'Archived Students';
                else header.innerText = 'My Students';
            }
            
            list.innerHTML = "<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-spinner fa-spin'></i> Loading students from database...</div>";
            
            let allStudents = [];
            
            // Check if Firebase is initialized
            if(!db) {
                console.error('Firebase database not initialized');
                list.innerHTML = "<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Database not initialized. Please refresh the page.</div>";
                return;
            }
            
            // Load students from Firebase database
            try {
                console.log('Fetching students from Firebase...');
                const usersSnapshot = await getDocs(collection(db, "users"));
                console.log(`Found ${usersSnapshot.size} documents in users collection`);
                
                usersSnapshot.forEach((doc) => {
                    try {
                        const userData = doc.data();
                        if(!userData) {
                            console.warn(`Document ${doc.id} has no data`);
                            return;
                        }
                        
                        // Include all students who have created profiles
                        // Check for any student data (fname, email, or status)
                        if(userData.fname || userData.email || userData.status) {
                            const studentData = {
                                id: doc.id,
                                name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                email: userData.email || 'noemail@example.com',
                                fname: userData.fname || '',
                                lname: userData.lname || '',
                                target: userData.country || 'Not specified',
                                phone: userData.phone || '',
                                address: userData.address || '',
                                dob: userData.dob || '',
                                gender: userData.gender || '',
                                citizen: userData.citizen || '',
                                state: userData.state || '',
                                intake: userData.intake || '',
                                universities: Array.isArray(userData.universities) ? userData.universities : [],
                                docs: Array.isArray(userData.docs) ? userData.docs : [],
                                counselorId: userData.counselorId || null,
                                status: userData.status === 'Submitted' ? 'active' : (userData.status === 'Draft' ? 'draft' : (userData.status || 'active')),
                                isActive: userData.isActive !== undefined ? userData.isActive : true, // Default to active
                                milestone: userData.milestone || null, // Student milestone
                                updatedAt: userData.updatedAt || null
                            };
                            
                            allStudents.push(studentData);
                        }
                    } catch(docError) {
                        console.error(`Error processing document ${doc.id}:`, docError);
                    }
                });
                
                console.log(`Processed ${allStudents.length} students`);
            } catch(e) {
                console.error("Error loading students from Firebase:", e);
                console.error("Error details:", {
                    message: e.message,
                    code: e.code,
                    stack: e.stack
                });
                
                let errorMessage = "Error loading students. ";
                if(e.code === 'permission-denied') {
                    errorMessage += "Permission denied. Please check Firebase security rules.";
                } else if(e.code === 'unavailable') {
                    errorMessage += "Database unavailable. Please check your internet connection.";
                } else {
                    errorMessage += `Error: ${e.message || 'Unknown error'}. Please try again.`;
                }
                
                list.innerHTML = `<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> ${errorMessage}<br><small style='color:#999; margin-top:10px; display:block;'>Check browser console for details.</small></div>`;
                return;
            }
            
            // Update counselorStudents array
            counselorStudents = allStudents;
            
            // Get current counselor ID
            const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
            
            // Filter students based on assignment to current counselor
            // For 'active' filter, show active students assigned to current counselor (not archived, isActive = true)
            // For 'inactive' filter, show inactive students assigned to current counselor (not archived, isActive = false)
            // For 'archived' filter, show archived students assigned to current counselor
            const filtered = allStudents.filter(s => {
                // Check if student is assigned to current counselor
                const isAssignedToMe = s.counselorId && s.counselorId === currentCounselorId;
                
                if(filter === 'active') {
                    // Show active students assigned to this counselor that are not archived
                    return isAssignedToMe && s.status !== 'archived' && s.isActive !== false;
                } else if(filter === 'inactive') {
                    // Show inactive students assigned to this counselor that are not archived
                    return isAssignedToMe && s.status !== 'archived' && s.isActive === false;
                } else if(filter === 'archived') {
                    // Show archived students assigned to this counselor
                    return isAssignedToMe && s.status === 'archived';
                }
                return true;
            });
            
            // Clear loading message
            list.innerHTML = "";
            
            if (filtered.length === 0) {
                if(filter === 'active') {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-users' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No active students assigned to you yet.</p><p style='font-size: 0.9rem; margin-top: 10px;'>Go to "Available Students" to select and assign students.</p></div>`;
                } else if(filter === 'inactive') {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-user-slash' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No inactive students found.</p><p style='font-size: 0.9rem; margin-top: 10px;'>Students marked as inactive will appear here.</p></div>`;
                } else {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-archive' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No archived students found.</p></div>`;
                }
                // Show empty state on right panel
                const emptyStatePanel = document.getElementById('coun-empty-state');
                const interactionPanel = document.getElementById('coun-interaction');
                if(emptyStatePanel) emptyStatePanel.style.display = 'block';
                if(interactionPanel) interactionPanel.style.display = 'none';
                return;
            }

            filtered.forEach(s => {
                const div = document.createElement('div');
                const isActive = String(currentStudentId) === String(s.id);
                div.className = `student-item ${isActive ? 'active' : ''}`;
                div.setAttribute('data-student-id', s.id);
                div.onclick = (e) => { if(!e.target.closest('button')) selectStudent(s.id); };
                
                // Escape ID for use in onclick handlers
                const safeId = String(s.id).replace(/'/g, "\\'");
                let actions = '';
                if(filter === 'active') {
                    actions = `
                        <div>
                            <button class="coun-action-btn" title="Edit" onclick="event.stopPropagation(); editStudent('${safeId}')"><i class="fas fa-edit"></i></button>
                            <button class="coun-action-btn" title="Mark Inactive" onclick="event.stopPropagation(); toggleStudentActive('${safeId}', false)"><i class="fas fa-user-slash"></i></button>
                            <button class="coun-action-btn" title="Archive" onclick="event.stopPropagation(); archiveStudent('${safeId}')"><i class="fas fa-archive"></i></button>
                            <button class="coun-action-btn delete" title="Delete" onclick="event.stopPropagation(); deleteStudent('${safeId}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                } else if(filter === 'inactive') {
                    actions = `
                        <div>
                            <button class="coun-action-btn" title="Reactivate" onclick="event.stopPropagation(); toggleStudentActive('${safeId}', true)"><i class="fas fa-user-check"></i></button>
                            <button class="coun-action-btn" title="Edit" onclick="event.stopPropagation(); editStudent('${safeId}')"><i class="fas fa-edit"></i></button>
                            <button class="coun-action-btn" title="Archive" onclick="event.stopPropagation(); archiveStudent('${safeId}')"><i class="fas fa-archive"></i></button>
                        </div>
                    `;
                } else {
                    actions = `<div><button class="coun-action-btn" title="Restore" onclick="event.stopPropagation(); archiveStudent('${safeId}', true)"><i class="fas fa-undo"></i></button></div>`;
                }
                
                // Add status badge
                const statusBadge = s.isActive === false ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">Inactive</span>' : 
                                 s.isActive === true ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">Active</span>' : '';
                
                // Add milestone badge
                const milestoneColors = {
                    'Joined': '#17a2b8',
                    'IELTS Completed': '#007bff',
                    'Applied for College': '#6c757d',
                    'Offer Letter Approved': '#28a745',
                    'Offer Letter Denied': '#dc3545',
                    'Visa Applied': '#ffc107',
                    'Visa Approved': '#28a745',
                    'Visa Denied': '#dc3545'
                };
                const milestoneBadge = s.milestone ? `<span style="background: ${milestoneColors[s.milestone] || '#6c757d'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px; font-weight: 500;">${s.milestone}</span>` : '';

                div.innerHTML = `
                    <div>
                        <div style="font-weight:600; font-size:0.95rem; display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
                            ${s.name || 'Unknown Student'}${statusBadge}${milestoneBadge}
                        </div>
                        <div style="font-size:0.8rem; color:#666;">${s.target || 'Not specified'} â€¢ ${s.intake || 'Not specified'}</div>
                    </div>
                    ${actions}
                `;
                list.appendChild(div);
            });
            
            // Show empty state if no student is currently selected
            const emptyStatePanel = document.getElementById('coun-empty-state');
            const interactionPanel = document.getElementById('coun-interaction');
            if(!currentStudentId) {
                    if(emptyStatePanel) {
                        emptyStatePanel.style.display = 'block';
                        // Update empty state message based on filter
                        if(filter === 'active') {
                            emptyStatePanel.innerHTML = `
                            <i class="fas fa-comments" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3>Select a Student</h3>
                            <p>Click on a student from the list to view their profile, documents, and chat.</p>
                        `;
                        }
                    }
                if(interactionPanel) interactionPanel.style.display = 'none';
            }
            
            // Update workspace stats
            updateWorkspaceStats(allStudents, currentCounselorId);
            
            // Update dashboard stats
            updateCounselorDashboardStats(allStudents, currentCounselorId);
        };
        
        // Update counselor dashboard statistics
        async function updateCounselorDashboardStats(allStudents, counselorId) {
            const activeStudents = allStudents.filter(s => 
                s.counselorId === counselorId && s.status !== 'archived' && s.isActive !== false
            );
            
            // Update active students count
            const activeEl = document.getElementById('coun-stat-active');
            if(activeEl) activeEl.textContent = activeStudents.length;
            
            // Count pending tasks across all active students
            let pendingTasks = 0;
            let upcomingAppointments = 0;
            
            if(db && activeStudents.length > 0) {
                try {
                    // Get all tasks for counselor's students
                    const tasksSnapshot = await getDocs(collection(db, "tasks"));
                    tasksSnapshot.forEach(doc => {
                        const taskData = doc.data();
                        if(taskData.studentId && activeStudents.find(s => String(s.id) === String(taskData.studentId)) && !taskData.completed) {
                            pendingTasks++;
                        }
                    });
                    
                    // Get upcoming appointments (next 7 days)
                    const appointmentsSnapshot = await getDocs(collection(db, "appointments"));
                    const today = new Date();
                    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    
                    appointmentsSnapshot.forEach(doc => {
                        const aptData = doc.data();
                        if(aptData.studentId && activeStudents.find(s => String(s.id) === String(aptData.studentId))) {
                            const aptDate = new Date(aptData.date);
                            if(aptDate >= today && aptDate <= nextWeek && aptData.status === 'scheduled') {
                                upcomingAppointments++;
                            }
                        }
                    });
                } catch(e) {
                    console.error('Error loading dashboard stats:', e);
                }
            }
            
            // Update stats
            const tasksEl = document.getElementById('coun-stat-tasks');
            const appointmentsEl = document.getElementById('coun-stat-appointments');
            const alertsEl = document.getElementById('coun-stat-alerts');
            
            if(tasksEl) tasksEl.textContent = pendingTasks;
            if(appointmentsEl) appointmentsEl.textContent = upcomingAppointments;
            if(alertsEl) alertsEl.textContent = 0; // Can be enhanced with actual alerts
        }
        
        // Update workspace statistics
        function updateWorkspaceStats(allStudents, counselorId) {
            const activeStudents = allStudents.filter(s => 
                s.counselorId === counselorId && s.status !== 'archived' && s.isActive !== false
            );
            const pendingStudents = allStudents.filter(s => 
                s.counselorId === counselorId && s.status === 'Draft' && s.status !== 'archived'
            );
            const completedStudents = allStudents.filter(s => 
                s.counselorId === counselorId && (s.milestone === 'Visa Approved' || s.status === 'archived')
            );
            
            // Update stat cards
            const activeEl = document.getElementById('workspace-stat-active');
            const pendingEl = document.getElementById('workspace-stat-pending');
            const completedEl = document.getElementById('workspace-stat-completed');
            
            if(activeEl) activeEl.textContent = activeStudents.length;
            if(pendingEl) pendingEl.textContent = pendingStudents.length;
            if(completedEl) completedEl.textContent = completedStudents.length;
            
            // Update nav badges
            const navActiveCount = document.getElementById('nav-active-count');
            const navInactiveCount = document.getElementById('nav-inactive-count');
            
            if(navActiveCount) {
                const inactiveCount = allStudents.filter(s => 
                    s.counselorId === counselorId && s.status !== 'archived' && s.isActive === false
                ).length;
                navActiveCount.textContent = activeStudents.length || '';
                if(activeStudents.length === 0) navActiveCount.style.display = 'none';
                else navActiveCount.style.display = 'inline-block';
            }
            
            if(navInactiveCount) {
                const inactiveCount = allStudents.filter(s => 
                    s.counselorId === counselorId && s.status !== 'archived' && s.isActive === false
                ).length;
                navInactiveCount.textContent = inactiveCount || '';
                if(inactiveCount === 0) navInactiveCount.style.display = 'none';
                else navInactiveCount.style.display = 'inline-block';
            }
        }

        // Render all available students with checkboxes for selection
        window.renderAvailableStudents = async function() {
            // Show dashboard view, hide student detail view
            const dashboardView = document.getElementById('coun-dashboard-view');
            const interactionView = document.getElementById('coun-interaction');
            if(dashboardView) dashboardView.style.display = 'block';
            if(interactionView) interactionView.style.display = 'none';
            
            // Update filter buttons
            const btnActive = document.getElementById('btn-filter-active');
            const btnInactive = document.getElementById('btn-filter-inactive');
            const btnAvailable = document.getElementById('btn-filter-available');
            if(btnActive) btnActive.classList.remove('btn-primary');
            if(btnInactive) btnInactive.classList.remove('btn-primary');
            if(btnAvailable) btnAvailable.classList.add('btn-primary');
            
            const list = document.getElementById('coun-student-list');
            const header = document.getElementById('coun-list-header');
            const actions = document.getElementById('coun-list-actions');
            
            if(!list) {
                console.error('Counselor student list element not found');
                return;
            }
            
            // Update header and actions
            header.innerText = 'Available Students';
            actions.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="select-all-students" onchange="toggleSelectAllStudents()" style="width: 16px; height: 16px; accent-color: var(--primary);">
                        <span>Select All</span>
                    </label>
                    <button class="btn btn-sm btn-success" onclick="assignSelectedStudents()" id="assign-selected-btn" disabled>
                        <i class="fas fa-user-check"></i> Assign Selected (<span id="selected-count">0</span>)
                    </button>
                </div>
            `;
            
            list.innerHTML = "<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-spinner fa-spin'></i> Loading all students from database...</div>";
            
            let allStudents = [];
            
            // Check if Firebase is initialized
            if(!db) {
                console.error('Firebase database not initialized');
                list.innerHTML = "<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Database not initialized. Please refresh the page.</div>";
                return;
            }
            
            // Load all students from Firebase database
            try {
                console.log('Fetching all students from Firebase...');
                const usersSnapshot = await getDocs(collection(db, "users"));
                console.log(`Found ${usersSnapshot.size} documents in users collection`);
                
                usersSnapshot.forEach((doc) => {
                    try {
                        const userData = doc.data();
                        if(!userData) {
                            console.warn(`Document ${doc.id} has no data`);
                            return;
                        }
                        
                        // Include all students who have created profiles
                        if(userData.fname || userData.email || userData.status) {
                            const studentData = {
                                id: doc.id,
                                name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                email: userData.email || 'noemail@example.com',
                                fname: userData.fname || '',
                                lname: userData.lname || '',
                                target: userData.country || 'Not specified',
                                phone: userData.phone || '',
                                address: userData.address || '',
                                dob: userData.dob || '',
                                gender: userData.gender || '',
                                citizen: userData.citizen || '',
                                state: userData.state || '',
                                intake: userData.intake || '',
                                universities: Array.isArray(userData.universities) ? userData.universities : [],
                                docs: Array.isArray(userData.docs) ? userData.docs : [],
                                counselorId: userData.counselorId || null,
                                status: userData.status === 'Submitted' ? 'active' : (userData.status === 'Draft' ? 'draft' : (userData.status || 'active')),
                                isActive: userData.isActive !== undefined ? userData.isActive : true, // Default to active
                                milestone: userData.milestone || null, // Student milestone
                                updatedAt: userData.updatedAt || null
                            };
                            
                            allStudents.push(studentData);
                        }
                    } catch(docError) {
                        console.error(`Error processing document ${doc.id}:`, docError);
                    }
                });
                
                console.log(`Processed ${allStudents.length} students`);
            } catch(e) {
                console.error("Error loading students from Firebase:", e);
                let errorMessage = "Error loading students. ";
                if(e.code === 'permission-denied') {
                    errorMessage += "Permission denied. Please check Firebase security rules.";
                } else if(e.code === 'unavailable') {
                    errorMessage += "Database unavailable. Please check your internet connection.";
                } else {
                    errorMessage += `Error: ${e.message || 'Unknown error'}. Please try again.`;
                }
                
                list.innerHTML = `<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> ${errorMessage}</div>`;
                return;
            }
            
            // Clear loading message
            list.innerHTML = "";
            
            if (allStudents.length === 0) {
                list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-users' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No students found.</p></div>`;
                return;
            }

            // Render students with checkboxes
            allStudents.forEach(s => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.setAttribute('data-student-id', s.id);
                
                const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
                const isAssigned = s.counselorId && s.counselorId;
                const isAssignedToMe = s.counselorId === currentCounselorId;
                const isAssignedToOther = isAssigned && !isAssignedToMe;
                
                // Disable checkbox if assigned to another counselor
                const checkboxDisabled = isAssignedToOther ? 'disabled' : '';
                const checkboxChecked = isAssignedToMe ? 'checked' : '';
                const itemStyle = isAssignedToOther ? 'opacity: 0.6; background-color: #f5f5f5;' : '';
                
                div.innerHTML = `
                    <div class="student-item-checkbox" style="${itemStyle}">
                        <input type="checkbox" 
                               id="student-checkbox-${s.id}" 
                               data-student-id="${s.id}"
                               data-assigned-to-other="${isAssignedToOther}"
                               onchange="updateSelectedCount()"
                               ${checkboxChecked}
                               ${checkboxDisabled}>
                        <label for="student-checkbox-${s.id}" style="flex: 1; cursor: ${isAssignedToOther ? 'not-allowed' : 'pointer'};">
                            <div class="student-info">
                                <div class="student-name" style="${isAssignedToOther ? 'color: #999;' : ''}">${s.name || 'Unknown Student'}</div>
                                <div class="student-details">
                                    <i class="fas fa-globe" style="margin-right: 5px;"></i>${s.target || 'Not specified'}
                                    ${s.intake ? ` â€¢ <i class="fas fa-calendar" style="margin-left: 10px; margin-right: 5px;"></i>${s.intake}` : ''}
                                    ${s.email ? ` â€¢ <i class="fas fa-envelope" style="margin-left: 10px; margin-right: 5px;"></i>${s.email}` : ''}
                                    ${isAssignedToMe ? `<span style="color: #28a745; font-size: 0.85rem; margin-left: 10px; font-weight: 600;"><i class="fas fa-check-circle"></i> Assigned to You</span>` : (isAssignedToOther ? `<span style="color: #dc3545; font-size: 0.85rem; margin-left: 10px; font-weight: 600;"><i class="fas fa-lock"></i> Assigned to Another Counselor</span>` : '<span style="color: #6c757d; font-size: 0.85rem; margin-left: 10px;"><i class="fas fa-user-plus"></i> Available</span>')}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Initialize selected count
            updateSelectedCount();
            
            // Show empty state and hide interaction panel
            const emptyState = document.getElementById('coun-empty-state');
            const interactionPanel = document.getElementById('coun-interaction');
            if(emptyState) emptyState.style.display = 'block';
            if(interactionPanel) interactionPanel.style.display = 'none';
            
            // Update workspace stats
            const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
            updateWorkspaceStats(allStudents, currentCounselorId);
        };

        // Toggle select all students
        window.toggleSelectAllStudents = function() {
            const selectAllCheckbox = document.getElementById('select-all-students');
            // Only get checkboxes that are not disabled and not assigned to others
            const checkboxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled])');
            const isChecked = selectAllCheckbox.checked;
            
            checkboxes.forEach(checkbox => {
                // Only check/uncheck if not assigned to another counselor
                if(checkbox.getAttribute('data-assigned-to-other') !== 'true') {
                    checkbox.checked = isChecked;
                }
            });
            
            updateSelectedCount();
        };

        // Update selected count
        window.updateSelectedCount = function() {
            const checkboxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled])');
            const checkedBoxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled]):checked');
            const selectAllCheckbox = document.getElementById('select-all-students');
            const assignBtn = document.getElementById('assign-selected-btn');
            const countSpan = document.getElementById('selected-count');
            
            // Filter out students assigned to others (shouldn't be selectable, but double-check)
            const validCheckedBoxes = Array.from(checkedBoxes).filter(cb => {
                return cb.getAttribute('data-assigned-to-other') !== 'true';
            });
            
            const selectedCount = validCheckedBoxes.length;
            
            if(countSpan) {
                countSpan.textContent = selectedCount;
            }
            
            if(assignBtn) {
                assignBtn.disabled = selectedCount === 0;
            }
            
            // Update select all checkbox state
            if(selectAllCheckbox && checkboxes.length > 0) {
                selectAllCheckbox.checked = selectedCount === checkboxes.length && checkboxes.length > 0;
                selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
            }
        };

        // Assign selected students to counselor
        window.assignSelectedStudents = async function() {
            const checkboxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled]):checked');
            
            if(checkboxes.length === 0) {
                alert('Please select at least one student to assign.');
                return;
            }
            
            const selectedIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-student-id'));
            const selectedStudents = [];
            
            // Get student data for selected IDs
            if(!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }
            
            // Confirm assignment
            const confirmMessage = `Are you sure you want to assign ${selectedIds.length} student(s) to you?`;
            if(!confirm(confirmMessage)) {
                return;
            }
            
            // Check for students already assigned to other counselors
            const alreadyAssignedStudents = [];
            for(const id of selectedIds) {
                try {
                    const studentDoc = await getDoc(doc(db, "users", id));
                    if(studentDoc.exists()) {
                        const userData = studentDoc.data();
                        if(userData.counselorId && userData.counselorId !== auth.currentUser.uid) {
                            const studentName = `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student';
                            alreadyAssignedStudents.push(studentName);
                        }
                    }
                } catch(e) {
                    console.error(`Error checking student ${id}:`, e);
                }
            }
            
            // Prevent assignment if students are already assigned to others
            if(alreadyAssignedStudents.length > 0) {
                const studentList = alreadyAssignedStudents.join(', ');
                alert(`Cannot assign the following student(s) as they are already assigned to another counselor:\n\n${studentList}\n\nPlease select only available students.`);
                // Uncheck the selected students that are assigned to others
                selectedIds.forEach(id => {
                    const checkbox = document.querySelector(`#student-checkbox-${id}`);
                    if(checkbox && checkbox.getAttribute('data-assigned-to-other') === 'true') {
                        checkbox.checked = false;
                    }
                });
                updateSelectedCount();
                return;
            }
            
            // Assign students
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for(const id of selectedIds) {
                try {
                    const counselorId = auth.currentUser.uid;
                    
                    // Update student's profile with counselorId
                    await updateDoc(doc(db, "users", id), {
                        counselorId: counselorId,
                        assignedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    
                    successCount++;
                } catch(e) {
                    console.error(`Error assigning student ${id}:`, e);
                    errorCount++;
                    errors.push(e.message);
                }
            }
            
            // Show result
            if(successCount > 0) {
                // Update counselorStudents array with newly assigned students
                for(const id of selectedIds) {
                    try {
                        const studentDoc = await getDoc(doc(db, "users", id));
                        if(studentDoc.exists()) {
                            const userData = studentDoc.data();
                            const updatedStudent = {
                                id: id,
                                name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                email: userData.email || 'noemail@example.com',
                                fname: userData.fname || '',
                                lname: userData.lname || '',
                                target: userData.country || 'Not specified',
                                phone: userData.phone || '',
                                address: userData.address || '',
                                dob: userData.dob || '',
                                gender: userData.gender || '',
                                citizen: userData.citizen || '',
                                state: userData.state || '',
                                intake: userData.intake || '',
                                universities: Array.isArray(userData.universities) ? userData.universities : [],
                                docs: Array.isArray(userData.docs) ? userData.docs : [],
                                counselorId: userData.counselorId || null,
                                status: userData.status === 'Submitted' ? 'active' : (userData.status === 'Draft' ? 'draft' : (userData.status || 'active')),
                                isActive: userData.isActive !== undefined ? userData.isActive : true, // Default to active
                                milestone: userData.milestone || null, // Student milestone
                                updatedAt: userData.updatedAt || null
                            };
                            
                            // Update or add to counselorStudents array
                            const existingIndex = counselorStudents.findIndex(stu => String(stu.id) === String(id));
                            if(existingIndex >= 0) {
                                counselorStudents[existingIndex] = updatedStudent;
                            } else {
                                counselorStudents.push(updatedStudent);
                            }
                        }
                    } catch(e) {
                        console.error(`Error updating student data for ${id}:`, e);
                    }
                }
                
                alert(`Successfully assigned ${successCount} student(s) to you.${errorCount > 0 ? `\n${errorCount} student(s) failed to assign.` : ''}\n\nSwitching to Active Students view...`);
                
                // Switch to Active Students view and refresh
                renderStudentList('active');
                
                // Refresh available students list (to update checkboxes)
                setTimeout(() => {
                    renderAvailableStudents();
                }, 500);
            } else {
                alert(`Failed to assign students. Errors: ${errors.join(', ')}`);
            }
        };

        window.selectStudent = async function(id) {
            currentStudentId = id;
            let s = counselorStudents.find(stu => String(stu.id) === String(id));
            
            // If student not found in loaded list, load from Firebase
            if(!s && db) {
                try {
                    const studentDoc = await getDoc(doc(db, "users", id));
                    if(studentDoc.exists()) {
                        const userData = studentDoc.data();
                        s = {
                            id: id,
                            name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                            email: userData.email || 'N/A',
                            fname: userData.fname || '',
                            lname: userData.lname || '',
                            phone: userData.phone || 'N/A',
                            address: userData.address || 'N/A',
                            dob: userData.dob || 'N/A',
                            gender: userData.gender || 'N/A',
                            citizen: userData.citizen || 'N/A',
                            target: userData.country || 'N/A',
                            state: userData.state || 'N/A',
                            intake: userData.intake || 'N/A',
                            universities: userData.universities || [],
                            docs: userData.docs || [],
                            counselorId: userData.counselorId || null,
                            status: userData.status || 'Draft',
                            milestone: userData.milestone || null,
                            updatedAt: userData.updatedAt || null
                        };
                        // Add to counselorStudents array for future reference
                        const existingIndex = counselorStudents.findIndex(stu => String(stu.id) === String(id));
                        if(existingIndex >= 0) {
                            counselorStudents[existingIndex] = s;
                        } else {
                            counselorStudents.push(s);
                        }
                    }
                } catch(e) {
                    console.error('Error loading student from Firebase:', e);
                }
            }
            
            if(!s) {
                console.error('Student not found:', id);
                alert('Student information not found.');
                return;
            }

            // Highlight selected - update active class
            document.querySelectorAll('.student-item').forEach(el => {
                el.classList.remove('active');
                if(el.getAttribute('data-student-id') == id || el.getAttribute('data-student-id') === id) {
                    el.classList.add('active');
                }
            });

            // Update UI - hide dashboard, show student detail view
            const dashboardView = document.getElementById('coun-dashboard-view');
            const interactionView = document.getElementById('coun-interaction');
            const tabsContainer = document.getElementById('coun-tabs-container');
            
            if(dashboardView) dashboardView.style.display = 'none';
            if(interactionView) interactionView.style.display = 'block';
            if(tabsContainer) tabsContainer.style.display = 'none'; // Hide tabs by default, show when clicking specific actions
            
            // Header Information
            const fullName = s.name || `${s.fname || ''} ${s.lname || ''}`.trim() || 'Unknown Student';
            document.getElementById('coun-header-name').innerHTML = `<i class="fas fa-user-graduate" style="margin-right: 10px;"></i>${fullName}`;
            document.getElementById('coun-header-status').innerHTML = `<i class="fas fa-envelope" style="margin-right: 5px;"></i>${s.email || 'N/A'}`;
            document.getElementById('cp-status-badge').innerText = s.status === 'Submitted' ? 'Submitted' : 'Active';
            document.getElementById('cp-last-updated').innerText = s.updatedAt ? new Date(s.updatedAt).toLocaleDateString() : 'Recently Active';
            document.getElementById('coun-chat-student-name').innerText = fullName;

            // Profile Tab Data - Personal Information
            document.getElementById('cp-fullname').innerText = fullName;
            document.getElementById('cp-phone').innerText = s.phone || 'N/A';
            document.getElementById('cp-addr').innerText = s.address || 'N/A';
            document.getElementById('cp-dob').innerText = s.dob || 'N/A';
            document.getElementById('cp-gender').innerText = s.gender || 'N/A';
            document.getElementById('cp-citizen').innerText = s.citizen || 'N/A';
            
            // Profile Tab Data - Academic Information
            document.getElementById('cp-edu').innerText = "Bachelor's Degree"; // Could be enhanced with actual education data
            document.getElementById('cp-target').innerText = s.target || 'N/A';
            document.getElementById('cp-state').innerText = s.state || 'N/A';
            document.getElementById('cp-intake').innerText = s.intake || 'N/A';
            
            // Universities List
            const unisContainer = document.getElementById('cp-unis');
            if(s.universities && s.universities.length > 0) {
                unisContainer.innerHTML = s.universities.map(uni => 
                    `<span class="uni-tag" style="display: inline-block; margin: 4px 4px 4px 0;">${uni}</span>`
                ).join('');
            } else {
                unisContainer.innerHTML = '<span style="color: #999; font-style: italic;">None selected</span>';
            }
            
            // Application Status
            const statusBadge = document.getElementById('cp-app-status');
            statusBadge.className = s.status === 'Submitted' ? 'status-badge status-submitted' : 'status-badge status-draft';
            statusBadge.innerText = s.status || 'Draft';
            
            // Milestone
            const milestoneSelect = document.getElementById('cp-milestone-select');
            const currentMilestoneDiv = document.getElementById('cp-current-milestone');
            if(milestoneSelect) {
                milestoneSelect.value = s.milestone || '';
            }
            if(currentMilestoneDiv) {
                if(s.milestone) {
                    const milestoneColors = {
                        'Joined': '#17a2b8',
                        'IELTS Completed': '#007bff',
                        'Applied for College': '#6c757d',
                        'Offer Letter Approved': '#28a745',
                        'Offer Letter Denied': '#dc3545',
                        'Visa Applied': '#ffc107',
                        'Visa Approved': '#28a745',
                        'Visa Denied': '#dc3545'
                    };
                    currentMilestoneDiv.innerHTML = `<span style="background: ${milestoneColors[s.milestone] || '#6c757d'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 500;">Current: ${s.milestone}</span>`;
                } else {
                    currentMilestoneDiv.innerHTML = '<span style="color: #999; font-style: italic;">No milestone set</span>';
                }
            }

            // Documents Tab Data
            const docList = document.getElementById('cp-docs-list');
            const docsCount = document.getElementById('cp-docs-count');
            
            if(s.docs && s.docs.length > 0) {
                docsCount.innerText = s.docs.length;
                docsCount.style.display = 'inline-block';
                
                // Group documents by type
                const docsByType = {};
                s.docs.forEach(d => {
                    const docType = d.type || 'Other';
                    if(!docsByType[docType]) {
                        docsByType[docType] = [];
                    }
                    docsByType[docType].push(d);
                });
                
                // Define category order and icons (matching student upload form)
                const categoryOrder = ['Passport', 'Transcript', 'IELTS/PTE', 'Financial', 'SOP', 'Other'];
                const categoryIcons = {
                    'Passport': 'fa-passport',
                    'Transcript': 'fa-graduation-cap',
                    'IELTS/PTE': 'fa-certificate',
                    'Financial': 'fa-dollar-sign',
                    'SOP': 'fa-file-alt',
                    'Other': 'fa-folder'
                };
                const categoryColors = {
                    'Passport': '#007bff',
                    'Transcript': '#28a745',
                    'IELTS/PTE': '#ffc107',
                    'Financial': '#17a2b8',
                    'SOP': '#6f42c1',
                    'Other': '#6c757d'
                };
                
                // Sort categories: known categories first in order, then others
                const sortedCategories = [
                    ...categoryOrder.filter(cat => docsByType[cat]),
                    ...Object.keys(docsByType).filter(cat => !categoryOrder.includes(cat))
                ];
                
                docList.innerHTML = sortedCategories.map(docType => {
                    const typeDocs = docsByType[docType];
                    const icon = categoryIcons[docType] || 'fa-folder';
                    const color = categoryColors[docType] || 'var(--primary)';
                    
                    return `
                        <div style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%); color: white; padding: 15px 20px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                                <i class="fas ${icon}" style="font-size: 1.2rem;"></i>
                                <span style="flex: 1;">${docType}</span>
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">${typeDocs.length} ${typeDocs.length === 1 ? 'file' : 'files'}</span>
                            </div>
                            <div style="padding: 0;">
                                ${typeDocs.map((d, index) => {
                                    const docName = d.name || 'file.pdf';
                                    const docSize = d.size ? `(${(d.size / 1024).toFixed(2)} KB)` : '';
                                    const uploadedDate = d.uploadedAt ? new Date(d.uploadedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'recently';
                                    const safeDocName = docName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    const safeDocType = docType.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    
                                    // Determine file icon based on extension
                                    const fileExt = docName.split('.').pop()?.toLowerCase();
                                    let fileIcon = 'fa-file';
                                    let fileIconColor = '#6c757d';
                                    if(fileExt === 'pdf') {
                                        fileIcon = 'fa-file-pdf';
                                        fileIconColor = '#dc3545';
                                    } else if(['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                                        fileIcon = 'fa-file-image';
                                        fileIconColor = '#28a745';
                                    } else if(['doc', 'docx'].includes(fileExt)) {
                                        fileIcon = 'fa-file-word';
                                        fileIconColor = '#007bff';
                                    }
                                    
                                    return `
                                        <div style="padding: 15px 20px; border-bottom: ${index < typeDocs.length - 1 ? '1px solid #f0f0f0' : 'none'}; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; background: white;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                            <div style="display: flex; align-items: center; flex: 1; min-width: 0;">
                                                <i class="fas ${fileIcon}" style="color: ${fileIconColor}; margin-right: 12px; font-size: 1.3rem; flex-shrink: 0;"></i>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 500; color: var(--text-dark); margin-bottom: 4px; word-break: break-word;">${docName}</div>
                                                    <div style="font-size: 0.8rem; color: #999; display: flex; gap: 12px; flex-wrap: wrap;">
                                                        ${docSize ? `<span><i class="fas fa-weight"></i> ${docSize}</span>` : ''}
                                                        <span><i class="fas fa-calendar"></i> ${uploadedDate}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm" style="padding: 8px 16px; font-size: 0.85rem; margin-left: 15px; flex-shrink: 0; background: var(--primary); color: white; border: none;" onclick="downloadCounselorDocument('${safeDocName}', '${safeDocType}', '${d.downloadURL || ''}', '${d.id || ''}')" title="Download ${docName}">
                                                <i class="fas fa-download"></i> Download
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                docsCount.style.display = 'none';
                docList.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px; color: #999;">
                        <i class="fas fa-file-alt" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                        <p style="font-style: italic; font-size: 1.1rem; margin-bottom: 10px;">No documents uploaded by this student yet.</p>
                        <p style="font-size: 0.9rem; color: #bbb;">Documents will appear here once the student uploads them.</p>
                    </div>
                `;
            }

            // Chat Tab - Load chat history
            loadCounselorChat(id);
            
            // Update student-specific dashboard stats
            updateStudentDashboardStats(id);
            
            // Reset to Profile tab (but don't show tabs container yet - already hidden above)
        };
        
        // Update student-specific dashboard stats
        async function updateStudentDashboardStats(studentId) {
            if(!db || !studentId) return;
            
            try {
                // Count documents
                const studentDoc = await getDoc(doc(db, "users", studentId));
                let docsCount = 0;
                if(studentDoc.exists()) {
                    const userData = studentDoc.data();
                    docsCount = userData.docs && Array.isArray(userData.docs) ? userData.docs.length : 0;
                }
                
                // Count tasks
                const tasksQuery = query(collection(db, "tasks"), where("studentId", "==", String(studentId)));
                const tasksSnapshot = await getDocs(tasksQuery);
                const tasksCount = tasksSnapshot.size;
                const pendingTasksCount = tasksSnapshot.docs.filter(doc => !doc.data().completed).length;
                
                // Count appointments
                const appointmentsQuery = query(collection(db, "appointments"), where("studentId", "==", String(studentId)));
                const appointmentsSnapshot = await getDocs(appointmentsQuery);
                const appointmentsCount = appointmentsSnapshot.size;
                
                // Update dashboard stats
                const docsCountDash = document.getElementById('cp-docs-count-dash');
                const tasksCountDash = document.getElementById('cp-tasks-count-dash');
                const appointmentsCountDash = document.getElementById('cp-appointments-count-dash');
                
                if(docsCountDash) docsCountDash.textContent = docsCount;
                if(tasksCountDash) tasksCountDash.textContent = pendingTasksCount;
                if(appointmentsCountDash) appointmentsCountDash.textContent = appointmentsCount;
                
                // Also update tab badges
                const docsCountTab = document.getElementById('cp-docs-count');
                const tasksCountTab = document.getElementById('cp-tasks-count');
                
                if(docsCountTab) {
                    docsCountTab.textContent = docsCount;
                    docsCountTab.style.display = docsCount > 0 ? 'inline-block' : 'none';
                }
                if(tasksCountTab) {
                    tasksCountTab.textContent = pendingTasksCount;
                    tasksCountTab.style.display = pendingTasksCount > 0 ? 'inline-block' : 'none';
                }
            } catch(e) {
                console.error('Error updating student dashboard stats:', e);
            }
        }
        
        // Download document for counselor
        window.downloadCounselorDocument = async function(fileName, docType, downloadURL, fileId) {
            try {
                // If we have a Firebase Storage download URL, use it
                if(downloadURL) {
                    const a = document.createElement('a');
                    a.href = downloadURL;
                    a.download = fileName;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    return;
                }
                
                // If no download URL, try to get it from the student's document data
                if(currentStudentId && db) {
                    try {
                        const studentDoc = await getDoc(doc(db, "users", currentStudentId));
                        if(studentDoc.exists()) {
                            const userData = studentDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                                // Try to find by fileId first, then by name and type
                                let docItem = null;
                                if(fileId) {
                                    docItem = userData.docs.find(d => d.id === fileId);
                                }
                                if(!docItem) {
                                    docItem = userData.docs.find(d => d.name === fileName && d.type === docType);
                                }
                                
                                // Check if it's a chunked file
                                if (docItem.isChunked && docItem.chunkedFileId) {
                                    const loadingMsg = document.createElement('div');
                                    loadingMsg.id = 'dl-msg-counselor';
                                    loadingMsg.style.cssText = "position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:5px; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3);";
                                    loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reassembling large file...';
                                    document.body.appendChild(loadingMsg);
                                    
                                    try {
                                        // Fetch all chunks
                                        let fullBase64 = "";
                                        const count = docItem.chunkCount || 100; // fallback safety
                                        
                                        console.log(`Downloading chunked file: ${fileName}, ${count} chunks`);
                                        
                                        for (let i = 0; i < count; i++) {
                                            // Update loading message
                                            loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading chunk ${i + 1}/${count}...`;
                                            
                                            // Fetch chunk i
                                            const chunkRef = doc(db, `file_data/${docItem.chunkedFileId}/chunks/${i}`);
                                            const snap = await getDoc(chunkRef);
                                            
                                            if (snap.exists()) {
                                                fullBase64 += snap.data().data;
                                            } else {
                                                break; // No more chunks
                                            }
                                        }
                                        
                                        // Trigger Download
                                        const a = document.createElement('a');
                                        a.href = fullBase64;
                                        a.download = fileName;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        
                                        loadingMsg.innerHTML = '<i class="fas fa-check-circle"></i> Download started!';
                                        setTimeout(() => loadingMsg.remove(), 2000);
                                        
                                    } catch (e) {
                                        console.error("Download failed:", e);
                                        loadingMsg.remove();
                                        alert("Failed to download large file: " + e.message);
                                    }
                                    return;
                                    
                                } else if(docItem && docItem.downloadURL) {
                                    // Standard small file (Firebase Storage URL)
                                    const a = document.createElement('a');
                                    a.href = docItem.downloadURL;
                                    a.download = fileName;
                                    a.target = '_blank';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    return;
                                }
                            }
                        }
                    } catch(e) {
                        console.error("Error fetching document from database:", e);
                    }
                }
                
                // Fallback: Show alert if file not found
                alert(`File "${fileName}" is not available for download. The file may not have been uploaded to cloud storage yet.`);
            } catch(error) {
                console.error("Error downloading document:", error);
                alert("Error downloading document. Please try again.");
            }
        };

        window.switchCounselorTab = function(tabName) {
            // Show tabs container
            const tabsContainer = document.getElementById('coun-tabs-container');
            if(tabsContainer) {
                tabsContainer.style.display = 'block';
            }
            
            // Update Tab UI
            document.querySelectorAll('.coun-tab').forEach(t => t.classList.remove('active'));
            const tabs = document.querySelectorAll('.coun-tab');
            tabs.forEach(tab => {
                const tabText = tab.innerHTML.toLowerCase();
                if((tabName === 'profile' && tabText.includes('profile')) ||
                   (tabName === 'docs' && tabText.includes('documents')) ||
                   (tabName === 'tasks' && tabText.includes('tasks')) ||
                   (tabName === 'notes' && tabText.includes('notes')) ||
                   (tabName === 'timeline' && tabText.includes('timeline')) ||
                   (tabName === 'appointments' && tabText.includes('appointments')) ||
                   (tabName === 'chat' && tabText.includes('chat'))) {
                    tab.classList.add('active');
                }
            });
            
            // Show Content
            document.querySelectorAll('.coun-content').forEach(c => c.style.display = 'none');
            const targetTab = document.getElementById('tab-' + tabName);
            if(targetTab) {
                targetTab.style.display = 'block';
                
                // Load data for specific tabs
                if(tabName === 'chat' && currentStudentId) {
                    loadCounselorChat(currentStudentId);
                } else if(tabName === 'tasks' && currentStudentId) {
                    loadTasks();
                } else if(tabName === 'notes' && currentStudentId) {
                    loadNotes();
                } else if(tabName === 'timeline' && currentStudentId) {
                    loadStudentTimeline();
                } else if(tabName === 'appointments' && currentStudentId) {
                    loadAppointments();
                }
            }
        };
        
        // Clear student selection and return to dashboard
        window.clearStudentSelection = function() {
            currentStudentId = null;
            document.getElementById('coun-interaction').style.display = 'none';
            document.getElementById('coun-dashboard-view').style.display = 'block';
            // Reload student list
            if(typeof renderStudentList === 'function') {
                renderStudentList('active');
            }
        };

        // CRUD Actions
        window.addStudent = async function() {
            // Show modal
            const modal = document.getElementById('add-student-modal');
            const listContainer = document.getElementById('available-students-list');
            modal.classList.add('active');
            listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Loading available students from database...</p></div>';
            
            try {
                let availableStudents = [];
                
                // Get all students from Firebase who have created profiles
                if(db) {
                    try {
                        const usersSnapshot = await getDocs(collection(db, "users"));
                        usersSnapshot.forEach((doc) => {
                            const userData = doc.data();
                            // Include students who have at least basic info (name or submitted application)
                            if(userData.fname || userData.status) {
                                // Check if student is already in counselor's list
                                const existingStudent = counselorStudents.find(s => 
                                    String(s.id) === String(doc.id) || 
                                    (s.email && userData.email && s.email === userData.email)
                                );
                                
                                if(!existingStudent) {
                                    availableStudents.push({
                                        id: doc.id,
                                        name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                        email: userData.email || 'noemail@example.com',
                                        fname: userData.fname || '',
                                        lname: userData.lname || '',
                                        target: userData.country || 'Not specified',
                                        phone: userData.phone || '',
                                        address: userData.address || '',
                                        dob: userData.dob || '',
                                        gender: userData.gender || '',
                                        citizen: userData.citizen || '',
                                        state: userData.state || '',
                                        intake: userData.intake || '',
                                        universities: userData.universities || [],
                                        status: userData.status || 'Draft',
                                        docs: userData.docs || [],
                                        counselorId: userData.counselorId || null,
                                        updatedAt: userData.updatedAt || null
                                    });
                                }
                            }
                        });
                    } catch(e) {
                        console.error("Error loading students:", e);
                    }
                }
                
                // Display available students
                if(availableStudents.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 10px;">No available students</p>
                            <p style="font-size: 0.9rem;">All students with profiles have been added to your list.</p>
                        </div>
                    `;
                } else {
                    listContainer.innerHTML = '';
                    // Store available students in modal data attribute for access
                    modal.setAttribute('data-available-students', JSON.stringify(availableStudents));
                    
                    availableStudents.forEach((student, index) => {
                        const studentDiv = document.createElement('div');
                        studentDiv.className = 'modal-student-item';
                        studentDiv.setAttribute('data-student-index', index);
                        
                        const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
                        const isAssigned = student.counselorId && student.counselorId;
                        const isAssignedToMe = student.counselorId === currentCounselorId;
                        const isAssignedToOther = isAssigned && !isAssignedToMe;
                        
                        // Only allow click if not assigned to another counselor
                        if(!isAssignedToOther) {
                            studentDiv.onclick = function() {
                                const storedStudents = JSON.parse(modal.getAttribute('data-available-students') || '[]');
                                selectAndAddStudentFromList(index, storedStudents);
                            };
                        } else {
                            studentDiv.style.cursor = 'not-allowed';
                            studentDiv.style.opacity = '0.6';
                        }
                        
                        studentDiv.innerHTML = `
                            <div class="student-info" style="flex: 1; ${isAssignedToOther ? 'opacity: 0.6;' : ''}">
                                <div class="student-name" style="${isAssignedToOther ? 'color: #999;' : ''}">${student.name}</div>
                                <div class="student-details">
                                    <i class="fas fa-globe" style="margin-right: 5px;"></i>${student.target}
                                    ${student.intake ? ` â€¢ <i class="fas fa-calendar" style="margin-left: 10px; margin-right: 5px;"></i>${student.intake}` : ''}
                                    ${student.email ? ` â€¢ <i class="fas fa-envelope" style="margin-left: 10px; margin-right: 5px;"></i>${student.email}` : ''}
                                    ${isAssignedToMe ? ` â€¢ <span style="color: #28a745; font-size: 0.85rem; font-weight: 600;"><i class="fas fa-check-circle" style="margin-left: 10px; margin-right: 5px;"></i>Assigned to You</span>` : (isAssignedToOther ? ` â€¢ <span style="color: #dc3545; font-size: 0.85rem; font-weight: 600;"><i class="fas fa-lock" style="margin-left: 10px; margin-right: 5px;"></i>Assigned to Another Counselor</span>` : '<span style="color: #6c757d; font-size: 0.85rem;"><i class="fas fa-user-plus" style="margin-left: 10px; margin-right: 5px;"></i>Available</span>')}
                                </div>
                            </div>
                            <button class="btn btn-sm ${isAssignedToOther ? 'btn-secondary' : (isAssignedToMe ? 'btn-success' : 'btn-success')}" 
                                    style="margin-left: 15px; ${isAssignedToOther ? 'opacity: 0.5; cursor: not-allowed;' : ''}" 
                                    ${isAssignedToOther ? 'disabled' : ''}
                                    onclick="event.stopPropagation(); ${isAssignedToOther ? '' : `(function() { const modal = document.getElementById('add-student-modal'); const students = JSON.parse(modal.getAttribute('data-available-students') || '[]'); selectAndAddStudentFromList(${index}, students); })()`}">
                                <i class="fas ${isAssignedToOther ? 'fa-lock' : (isAssignedToMe ? 'fa-check' : 'fa-plus')}"></i> ${isAssignedToOther ? 'Locked' : (isAssignedToMe ? 'Already Assigned' : 'Assign')}
                            </button>
                        `;
                        listContainer.appendChild(studentDiv);
                    });
                }
            } catch(error) {
                console.error('Error loading available students:', error);
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Error loading students. Please try again.</p>
                    </div>
                `;
            }
        };
        
        window.closeAddStudentModal = function() {
            document.getElementById('add-student-modal').classList.remove('active');
        };
        
        window.selectAndAddStudentFromList = async function(index, availableStudentsList) {
            if(!availableStudentsList || !availableStudentsList[index]) {
                console.error('Student not found in list');
                return;
            }
            
            const student = availableStudentsList[index];
            
            // Check if student already exists
            const exists = counselorStudents.find(s => String(s.id) === String(student.id));
            if(exists) {
                alert('This student is already in your list.');
                closeAddStudentModal();
                return;
            }
            
            // Check if student already has a counselor assigned
            if(student.counselorId && student.counselorId !== auth.currentUser.uid) {
                alert(`${student.name} is already assigned to another counselor and cannot be reassigned. Please contact the administrator if you need to transfer this student.`);
                return;
            }
            
            // Assign counselor to student in Firebase
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const counselorId = auth.currentUser.uid;
                    
                    // Update student's profile with counselorId
                    await updateDoc(doc(db, "users", student.id), {
                        counselorId: counselorId,
                        assignedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    
                    console.log(`Student ${student.id} assigned to counselor ${counselorId}`);
                } catch(e) {
                    console.error("Error assigning student to counselor:", e);
                    alert(`Error assigning student: ${e.message}. Please try again.`);
                    return;
                }
            }
            
            // Add student to counselorStudents array
            const newStudent = {
                ...student,
                counselorId: auth && auth.currentUser ? auth.currentUser.uid : null,
                status: student.status === 'Submitted' ? 'active' : (student.status || 'active')
            };
            counselorStudents.push(newStudent);
            
            // Close modal and refresh list
            closeAddStudentModal();
            renderStudentList('active');
            
            // Select the newly added student
            setTimeout(() => {
                selectStudent(student.id);
            }, 100);
            
            alert(`${student.name} has been assigned to you and added to your student list.`);
        };
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('add-student-modal');
            if(modal) {
                modal.addEventListener('click', function(e) {
                    if(e.target === modal) {
                        closeAddStudentModal();
                    }
                });
            }
        });

        window.editStudent = async function(id) {
            const s = counselorStudents.find(stu => String(stu.id) === String(id));
            if(!s) {
                alert('Student not found');
                return;
            }
            const newName = prompt("Edit Name (First Last):", s.name);
            if(newName && newName.trim()) {
                const nameParts = newName.trim().split(' ');
                const fname = nameParts[0] || '';
                const lname = nameParts.slice(1).join(' ') || '';
                
                // Update in Firebase
                if(db) {
                    try {
                        await updateDoc(doc(db, "users", id), {
                            fname: fname,
                            lname: lname,
                            updatedAt: new Date().toISOString()
                        });
                        
                        // Update local array
                        s.fname = fname;
                        s.lname = lname;
                        s.name = newName.trim();
                        
                renderStudentList('active');
                        if(String(currentStudentId) === String(id)) selectStudent(id); // Refresh view if open
                        alert('Student name updated successfully.');
                    } catch(e) {
                        console.error('Error updating student:', e);
                        alert('Error updating student. Please try again.');
                    }
                } else {
                    // Fallback for demo mode
                    s.name = newName.trim();
                    renderStudentList('active');
                    if(String(currentStudentId) === String(id)) selectStudent(id);
                }
            }
        };

        window.deleteStudent = async function(id) {
            if(confirm("Are you sure you want to delete this student? This will remove them from your view, but their data will remain in the database.")) {
                // Remove from counselorStudents array (not deleting from database)
                counselorStudents = counselorStudents.filter(s => String(s.id) !== String(id));
                renderStudentList('active');
                document.getElementById('coun-interaction').style.display = 'none';
                document.getElementById('coun-empty-state').style.display = 'block';
                currentStudentId = null;
            }
        };

        window.archiveStudent = async function(id, restore = false) {
            const s = counselorStudents.find(stu => String(stu.id) === String(id));
            if(s && db) {
                try {
                    const newStatus = restore ? 'Submitted' : 'archived';
                    // Update status in Firebase
                    await updateDoc(doc(db, "users", id), {
                        status: newStatus,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update local array
                s.status = restore ? 'active' : 'archived';
                renderStudentList(restore ? 'archived' : 'active'); // Refresh current view
                    
                    // If current student was archived, hide the interaction panel
                    if(!restore && String(currentStudentId) === String(id)) {
                        document.getElementById('coun-interaction').style.display = 'none';
                        document.getElementById('coun-empty-state').style.display = 'block';
                        currentStudentId = null;
                    }
                } catch(e) {
                    console.error('Error archiving student:', e);
                    alert('Error updating student status. Please try again.');
                }
            }
        };

        window.toggleStudentActive = async function(id, makeActive = true) {
            const s = counselorStudents.find(stu => String(stu.id) === String(id));
            if(s && db) {
                try {
                    // Update isActive in Firebase
                    await updateDoc(doc(db, "users", id), {
                        isActive: makeActive,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update local array
                    s.isActive = makeActive;
                    
                    alert(makeActive ? 'Student activated successfully!' : 'Student marked as inactive successfully!');
                    
                    // Refresh the appropriate view
                    const currentFilter = document.querySelector('.dash-menu-item.active')?.textContent || '';
                    if(currentFilter.includes('Active')) {
                        renderStudentList('active');
                    } else if(currentFilter.includes('Inactive')) {
                        renderStudentList('inactive');
                    } else {
                        renderStudentList('active');
                    }
                } catch(e) {
                    console.error('Error toggling student active status:', e);
                    alert('Error updating student status. Please try again.');
                }
            }
        };

        window.updateStudentMilestone = async function() {
            if(!currentStudentId || !db) {
                alert('No student selected or database not available.');
                return;
            }
            
            const milestoneSelect = document.getElementById('cp-milestone-select');
            if(!milestoneSelect) {
                alert('Milestone selector not found.');
                return;
            }
            
            const newMilestone = milestoneSelect.value || null;
            
            try {
                // Update milestone in Firebase
                const updateData = {
                    updatedAt: new Date().toISOString()
                };
                if(newMilestone) {
                    updateData.milestone = newMilestone;
                } else {
                    updateData.milestone = null;
                }
                
                await updateDoc(doc(db, "users", currentStudentId), updateData);
                
                // Update local array
                const s = counselorStudents.find(stu => String(stu.id) === String(currentStudentId));
                if(s) {
                    s.milestone = newMilestone;
                }
                
                // Refresh the display
                selectStudent(currentStudentId);
                renderStudentList('active');
                
                alert(newMilestone ? `Milestone updated to: ${newMilestone}` : 'Milestone removed successfully!');
            } catch(e) {
                console.error('Error updating milestone:', e);
                alert('Error updating milestone. Please try again.');
            }
        };

        // --- SHARED ROUTER ---
        window.router = function(page, role = null) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));

            const navBtn = document.querySelector(`button[onclick*="'${page}'"]`);
            if(navBtn) navBtn.classList.add('active');

            if(page === 'auth') {
                window.currentRole = role;
                document.getElementById('auth-title').innerText = 'Login';
                document.getElementById('page-auth').classList.add('active');
            } else if (page === 'student' || page === 'student-apps') {
                const target = page === 'student' ? 'page-student-dash' : 'page-student-apps';
                document.getElementById(target).classList.add('active');
                document.getElementById('public-nav').style.display = 'none';
                document.getElementById('private-nav').style.display = 'flex';
                
                // Load student chat when on dashboard
                if(page === 'student') {
                    setTimeout(() => {
                        if(typeof loadStudentChat === 'function') {
                            loadStudentChat();
                        }
                    }, 100);
                }
                
                // Load data from Firestore or localStorage
                if(page === 'student-apps') {
                if(isDemoMode) {
                    const saved = localStorage.getItem('demoApp');
                    if(saved) {
                        currentApplication = JSON.parse(saved);
                        selectedUnis = currentApplication.universities || [];
                        }
                    } else if(auth && auth.currentUser) {
                        // Data should already be loaded in auth state handler, but ensure it's loaded
                        getDoc(doc(db, "users", auth.currentUser.uid)).then(docSnap => {
                            if(docSnap.exists()) {
                                currentApplication = docSnap.data();
                                selectedUnis = currentApplication.universities || [];
                                loadFormData();
                            }
                        }).catch(e => console.error('Error loading data:', e));
                    }
                    // Load form data after a small delay to ensure DOM is ready
                    setTimeout(() => loadFormData(), 100);
                }
                updateDashboardUI();
            } else if (page === 'counselor') {
                document.getElementById('page-counselor-dash').classList.add('active');
                document.getElementById('public-nav').style.display = 'none';
                document.getElementById('private-nav').style.display = 'flex';
                // Wait a bit to ensure Firebase is ready, then show available students selection
                setTimeout(() => {
                    if(typeof renderAvailableStudents === 'function') {
                        renderAvailableStudents();
                    } else if(typeof renderStudentList === 'function') {
                        // Fallback if renderAvailableStudents is not available
                        renderStudentList('active');
                    } else {
                        console.error('renderAvailableStudents is not a function');
                    }
                }, 100);
            } else if (page === 'admin') {
                document.getElementById('page-admin-dash').classList.add('active');
                document.getElementById('public-nav').style.display = 'none';
                document.getElementById('private-nav').style.display = 'flex';
                // Show "Back to Counselor Panel" link if user is a counselor
                const backLink = document.getElementById('back-to-counselor-link');
                if(backLink) {
                    backLink.style.display = window.currentRole === 'counselor' ? 'block' : 'none';
                }
                // Wait a bit to ensure Firebase is ready, then show dashboard
                setTimeout(() => {
                    if(typeof showAdminView === 'function') {
                        showAdminView('dashboard');
                    } else if(typeof renderAdminUsers === 'function') {
                        renderAdminUsers('all');
                    }
                }, 100);
            } else if (page === 'blogs') {
                document.getElementById('page-blogs').classList.add('active');
                document.getElementById('public-nav').style.display = 'flex';
                document.getElementById('private-nav').style.display = 'none';
                if (typeof loadBlogPage === 'function') {
                    setTimeout(() => loadBlogPage(), 100);
                }
            } else if (page === 'blog-detail') {
                document.getElementById('page-blog-detail').classList.add('active');
                document.getElementById('public-nav').style.display = 'flex';
                document.getElementById('private-nav').style.display = 'none';
            } else {
                document.getElementById('page-' + page).classList.add('active');
                document.getElementById('public-nav').style.display = 'flex';
                document.getElementById('private-nav').style.display = 'none';
            }
            window.scrollTo(0, 0);
        };

        // --- ADMIN FUNCTIONS ---
        window.renderAdminUsers = async function(filter = 'all') {
            // Show users view
            showAdminView('users');
            
            // Update active menu item (exclude back link)
            document.querySelectorAll('.dash-menu-item').forEach(item => {
                // Skip the back to counselor link
                if(item.id === 'back-to-counselor-link') return;
                
                const itemText = item.textContent || '';
                if((filter === 'all' && itemText.includes('All Users')) ||
                   (filter === 'students' && itemText.includes('Students')) ||
                   (filter === 'counselors' && itemText.includes('Counselors')) ||
                   (filter === 'admins' && itemText.includes('Admins'))) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            const list = document.getElementById('admin-users-list');
            const header = document.getElementById('admin-list-header');
            
            if(!list) {
                console.error('Admin users list element not found');
                return;
            }
            
            // Update header
            const headers = {
                'all': 'All Users',
                'students': 'Students',
                'counselors': 'Counselors',
                'admins': 'Administrators'
            };
            if(header) header.innerText = headers[filter] || 'All Users';
            
            list.innerHTML = "<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-spinner fa-spin'></i> Loading users...</div>";
            
            if(!db) {
                list.innerHTML = "<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Database not initialized.</div>";
                return;
            }
            
            try {
                let allUsers = [];
                
                // Get all users from users collection (exclude deleted)
                const usersSnapshot = await getDocs(collection(db, "users"));
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Skip deleted users
                    if(userData.deleted) return;
                    const role = userData.role || 'student';
                    allUsers.push({
                        id: doc.id,
                        email: userData.email || 'N/A',
                        fname: userData.fname || '',
                        lname: userData.lname || '',
                        role: role,
                        milestone: userData.milestone || null,
                        counselorId: userData.counselorId || null,
                        status: userData.status || 'Draft',
                        createdAt: userData.createdAt || null,
                        updatedAt: userData.updatedAt || null
                    });
                });
                
                // Get counselors from counselors collection (for those not in users)
                const counselorsSnapshot = await getDocs(collection(db, "counselors"));
                counselorsSnapshot.forEach((doc) => {
                    const counselorData = doc.data();
                    // Skip deleted counselors
                    if(counselorData.deleted) return;
                    // Check if already in allUsers
                    const exists = allUsers.find(u => u.id === doc.id);
                    if(!exists) {
                        allUsers.push({
                            id: doc.id,
                            email: counselorData.email || 'N/A',
                            fname: '',
                            lname: '',
                            role: 'counselor',
                            counselorId: null,
                            status: null,
                            createdAt: counselorData.createdAt || null,
                            updatedAt: counselorData.updatedAt || null
                        });
                    } else {
                        // Update role if not set
                        const userIndex = allUsers.findIndex(u => u.id === doc.id);
                        if(userIndex >= 0 && allUsers[userIndex].role !== 'counselor') {
                            allUsers[userIndex].role = 'counselor';
                        }
                    }
                });
                
                // Filter users
                let filteredUsers = allUsers;
                if(filter === 'students') {
                    filteredUsers = allUsers.filter(u => u.role === 'student');
                } else if(filter === 'counselors') {
                    filteredUsers = allUsers.filter(u => u.role === 'counselor');
                } else if(filter === 'admins') {
                    filteredUsers = allUsers.filter(u => u.role === 'admin');
                }
                
                list.innerHTML = "";
                
                if(filteredUsers.length === 0) {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-users' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No ${filter} users found.</p></div>`;
                    return;
                }
                
                // Render users
                filteredUsers.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'student-item';
                    div.style.padding = '15px';
                    
                    const roleBadge = {
                        'admin': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-user-shield"></i> Admin</span>',
                        'counselor': '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-user-tie"></i> Counselor</span>',
                        'student': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-user-graduate"></i> Student</span>'
                    };
                    
                    const userName = `${u.fname || ''} ${u.lname || ''}`.trim() || u.email || 'Unknown User';
                    
                    // Add milestone badge for students
                    const milestoneColors = {
                        'Joined': '#17a2b8',
                        'IELTS Completed': '#007bff',
                        'Applied for College': '#6c757d',
                        'Offer Letter Approved': '#28a745',
                        'Offer Letter Denied': '#dc3545',
                        'Visa Applied': '#ffc107',
                        'Visa Approved': '#28a745',
                        'Visa Denied': '#dc3545'
                    };
                    const milestoneBadge = (u.role === 'student' && u.milestone) ? 
                        `<span style="background: ${milestoneColors[u.milestone] || '#6c757d'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px; font-weight: 500;">${u.milestone}</span>` : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <input type="checkbox" data-user-id="${u.id}" onchange="updateBulkActions()" style="width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
                                    ${userName}${milestoneBadge}
                                </div>
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                                    <i class="fas fa-envelope" style="margin-right: 5px;"></i>${u.email}
                                    ${u.role ? ` â€¢ ${roleBadge[u.role] || ''}` : ''}
                                    ${u.status ? ` â€¢ <span style="color: #999;">Status: ${u.status}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="coun-action-btn" title="Edit" onclick="editAdminUser('${u.id}')"><i class="fas fa-edit"></i></button>
                            ${u.role !== 'admin' ? `<button class="coun-action-btn delete" title="Delete" onclick="deleteAdminUser('${u.id}', '${u.role}')"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch(e) {
                console.error('Error loading users:', e);
                let errorMsg = e.message;
                if(e.message && e.message.includes('permission') || e.message.includes('Permission')) {
                    errorMsg = 'Permission denied. Please ensure you are logged in as an admin and your admin role is properly set in the database.';
                }
                list.innerHTML = `<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Error loading users: ${errorMsg}<br><small style='margin-top:10px; display:block;'>If you are an admin, please check that your user document exists and has role='admin' set.</small></div>`;
            }
        };
        
        window.showCreateUserModal = function() {
            document.getElementById('create-user-modal').classList.add('active');
            // Clear form
            document.getElementById('create-user-email').value = '';
            document.getElementById('create-user-password').value = '';
            document.getElementById('create-user-role').value = 'student';
            document.getElementById('create-user-fname').value = '';
            document.getElementById('create-user-lname').value = '';
        };
        
        window.closeCreateUserModal = function() {
            document.getElementById('create-user-modal').classList.remove('active');
        };
        
        window.createNewUser = async function() {
            const email = document.getElementById('create-user-email').value;
            const password = document.getElementById('create-user-password').value;
            const role = document.getElementById('create-user-role').value;
            const fname = document.getElementById('create-user-fname').value;
            const lname = document.getElementById('create-user-lname').value;
            
            if(!email || !password) {
                alert('Please enter email and password.');
                return;
            }
            if(password.length < 6) {
                alert('Password must be at least 6 characters.');
                return;
            }
            
            try {
                // Create auth user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user document
                const userData = {
                    email: email,
                    fname: fname || '',
                    lname: lname || '',
                    role: role,
                    status: role === 'student' ? 'Draft' : null,
                    counselorId: null, // Explicitly set to null - no auto-assignment
                    milestone: null, // Explicitly set to null - no milestone by default
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await setDoc(doc(db, "users", user.uid), userData);
                
                // If counselor, also create in counselors collection
                if(role === 'counselor') {
                    const counselorName = (fname + ' ' + lname).trim() || email.split('@')[0];
                    await setDoc(doc(db, "counselors", user.uid), {
                        email: email,
                        name: counselorName,
                        studentCount: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                
                alert('User created successfully!');
                closeCreateUserModal();
                const activeItem = document.querySelector('.dash-menu-item.active');
                const activeText = activeItem ? activeItem.textContent : '';
                const filter = activeText.includes('Students') ? 'students' : 
                              activeText.includes('Counselors') ? 'counselors' :
                              activeText.includes('Admins') ? 'admins' : 'all';
                renderAdminUsers(filter);
            } catch(err) {
                console.error('Error creating user:', err);
                alert(`Error creating user: ${err.message}`);
            }
        };
        
        window.editAdminUser = async function(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if(!userDoc.exists()) {
                    alert('User not found.');
                    return;
                }
                
                const userData = userDoc.data();
                
                // Populate edit form
                document.getElementById('edit-user-id').value = userId;
                document.getElementById('edit-user-email').value = userData.email || '';
                document.getElementById('edit-user-role').value = userData.role || 'student';
                document.getElementById('edit-user-fname').value = userData.fname || '';
                document.getElementById('edit-user-lname').value = userData.lname || '';
                
                // Load counselors for assignment (if student)
                if(userData.role === 'student') {
                    document.getElementById('edit-student-counselor').style.display = 'block';
                    const counselorSelect = document.getElementById('edit-user-counselor');
                    counselorSelect.innerHTML = '<option value="">None (Not Assigned)</option>';
                    
                    const counselorsSnapshot = await getDocs(collection(db, "counselors"));
                    counselorsSnapshot.forEach((doc) => {
                        const counselorData = doc.data();
                        if(counselorData.deleted) return; // Skip deleted counselors
                        const selected = userData.counselorId === doc.id ? 'selected' : '';
                        counselorSelect.innerHTML += `<option value="${doc.id}" ${selected}>${counselorData.name || counselorData.email || doc.id}</option>`;
                    });
                    
                    // Explicitly set to empty string if no counselor assigned
                    counselorSelect.value = userData.counselorId || '';
                } else {
                    document.getElementById('edit-student-counselor').style.display = 'none';
                }
                
                document.getElementById('edit-user-modal').classList.add('active');
            } catch(e) {
                console.error('Error loading user:', e);
                alert('Error loading user data.');
            }
        };
        
        window.closeEditUserModal = function() {
            document.getElementById('edit-user-modal').classList.remove('active');
        };
        
        window.saveUserChanges = async function() {
            const userId = document.getElementById('edit-user-id').value;
            const role = document.getElementById('edit-user-role').value;
            const fname = document.getElementById('edit-user-fname').value;
            const lname = document.getElementById('edit-user-lname').value;
            const counselorId = document.getElementById('edit-user-counselor')?.value || null;
            
            if(!userId) {
                alert('User ID missing.');
                return;
            }
            
            try {
                // Get current user data
                const userDoc = await getDoc(doc(db, "users", userId));
                if(!userDoc.exists()) {
                    alert('User not found.');
                    return;
                }
                
                const currentData = userDoc.data();
                const currentRole = currentData.role || 'student';
                
                // Update user document
                const updateData = {
                    fname: fname || '',
                    lname: lname || '',
                    role: role,
                    updatedAt: new Date().toISOString()
                };
                
                // If student, update counselor assignment (only if explicitly set)
                if(role === 'student') {
                    // Only update counselorId if it was explicitly changed
                    const counselorSelect = document.getElementById('edit-user-counselor');
                    if(counselorSelect) {
                        const selectedCounselorId = counselorSelect.value || null;
                        updateData.counselorId = selectedCounselorId;
                        if(selectedCounselorId) {
                            updateData.assignedAt = new Date().toISOString();
                        } else {
                            // If set to "None", remove assignment
                            updateData.counselorId = null;
                            updateData.assignedAt = null;
                        }
                    }
                }
                
                await updateDoc(doc(db, "users", userId), updateData);
                
                // Handle role changes
                if(currentRole !== role) {
                    // If changing from counselor, remove from counselors collection
                    if(currentRole === 'counselor' && role !== 'counselor') {
                        try {
                            await updateDoc(doc(db, "counselors", userId), {
                                deleted: true,
                                updatedAt: new Date().toISOString()
                            });
                        } catch(e) {
                            console.log('Counselor document may not exist');
                        }
                    }
                    
                    // If changing to counselor, add to counselors collection
                    if(role === 'counselor' && currentRole !== 'counselor') {
                        const counselorName = (fname + ' ' + lname).trim() || (currentData.email ? currentData.email.split('@')[0] : '') || 'Counselor';
                        await setDoc(doc(db, "counselors", userId), {
                            email: currentData.email || '',
                            name: counselorName,
                            studentCount: 0,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }
                }
                
                alert('User updated successfully!');
                closeEditUserModal();
                const activeItem = document.querySelector('.dash-menu-item.active');
                const activeText = activeItem ? activeItem.textContent : '';
                const activeFilter = activeText.includes('Students') ? 'students' : 
                                   activeText.includes('Counselors') ? 'counselors' :
                                   activeText.includes('Admins') ? 'admins' : 'all';
                renderAdminUsers(activeFilter);
            } catch(e) {
                console.error('Error updating user:', e);
                alert(`Error updating user: ${e.message}`);
            }
        };
        
        window.deleteAdminUser = async function(userId, role) {
            if(!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Delete from users collection
                await updateDoc(doc(db, "users", userId), {
                    deleted: true,
                    deletedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                // If counselor, also mark in counselors collection
                if(role === 'counselor') {
                    try {
                        await updateDoc(doc(db, "counselors", userId), {
                            deleted: true,
                            deletedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    } catch(e) {
                        console.log('Counselor document may not exist');
                    }
                }
                
                alert('User deleted successfully!');
                const activeItem = document.querySelector('.dash-menu-item.active');
                const activeText = activeItem ? activeItem.textContent : '';
                const activeFilter = activeText.includes('Students') ? 'students' : 
                                   activeText.includes('Counselors') ? 'counselors' :
                                   activeText.includes('Admins') ? 'admins' : 'all';
                renderAdminUsers(activeFilter);
            } catch(e) {
                console.error('Error deleting user:', e);
                alert(`Error deleting user: ${e.message}`);
            }
        };

        // --- NEW ADMIN FEATURES ---
        
        // View switcher
        window.showAdminView = function(view) {
            // Hide all views
            document.getElementById('admin-dashboard-view').style.display = 'none';
            document.getElementById('admin-users-view').style.display = 'none';
            document.getElementById('admin-analytics-view').style.display = 'none';
            document.getElementById('admin-activity-view').style.display = 'none';
            document.getElementById('admin-contacts-view').style.display = 'none';
            document.getElementById('admin-blogs-view').style.display = 'none';
            
            // Update menu items
            document.querySelectorAll('.dash-menu-item').forEach(item => {
                if(item.id === 'back-to-counselor-link') return;
                item.classList.remove('active');
            });
            
            // Show selected view
            if(view === 'dashboard') {
                document.getElementById('admin-dashboard-view').style.display = 'block';
                document.getElementById('admin-menu-dashboard').classList.add('active');
                loadAdminDashboard();
            } else if(view === 'users') {
                document.getElementById('admin-users-view').style.display = 'block';
                document.getElementById('admin-menu-users').classList.add('active');
                renderAdminUsers('all');
            } else if(view === 'analytics') {
                document.getElementById('admin-analytics-view').style.display = 'block';
                document.getElementById('admin-menu-analytics').classList.add('active');
                loadAdminAnalytics();
            } else if(view === 'activity') {
                document.getElementById('admin-activity-view').style.display = 'block';
                document.getElementById('admin-menu-activity').classList.add('active');
                loadActivityLogs();
            } else if(view === 'contacts') {
                document.getElementById('admin-contacts-view').style.display = 'block';
                document.getElementById('admin-menu-contacts').classList.add('active');
                loadContactMessages();
            } else if(view === 'blogs') {
                document.getElementById('admin-blogs-view').style.display = 'block';
                document.getElementById('admin-menu-blogs').classList.add('active');
                // Load blogs after a small delay to ensure view is visible
                setTimeout(() => {
                    if (typeof loadAdminBlogs === 'function') {
                        loadAdminBlogs();
                    } else {
                        console.error('loadAdminBlogs function not found');
                        const listEl = document.getElementById('admin-blogs-list');
                        if (listEl) {
                            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">Blog management function not available. Please refresh the page.</div>';
                        }
                    }
                }, 100);
            }
        };

        // Load dashboard statistics
        window.loadAdminDashboard = async function() {
            if(!db) return;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const counselorsSnapshot = await getDocs(collection(db, "counselors"));
                
                let totalUsers = 0, students = 0, counselors = 0, admins = 0;
                const recentActivity = [];
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    totalUsers++;
                    const role = data.role || 'student';
                    if(role === 'student') students++;
                    else if(role === 'counselor') counselors++;
                    else if(role === 'admin') admins++;
                    
                    if(data.createdAt) {
                        recentActivity.push({
                            type: 'user_created',
                            user: data.email || 'Unknown',
                            role: role,
                            date: data.createdAt,
                            timestamp: new Date(data.createdAt).getTime()
                        });
                    }
                    if(data.updatedAt && data.updatedAt !== data.createdAt) {
                        recentActivity.push({
                            type: 'user_updated',
                            user: data.email || 'Unknown',
                            role: role,
                            date: data.updatedAt,
                            timestamp: new Date(data.updatedAt).getTime()
                        });
                    }
                });
                
                counselorsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    if(!usersSnapshot.docs.find(d => d.id === doc.id)) {
                        counselors++;
                        totalUsers++;
                    }
                });
                
                // Update statistics
                document.getElementById('admin-stat-total').textContent = totalUsers;
                document.getElementById('admin-stat-students').textContent = students;
                document.getElementById('admin-stat-counselors').textContent = counselors;
                document.getElementById('admin-stat-admins').textContent = admins;
                
                // Render pie chart (simple text-based)
                const pieChart = document.getElementById('admin-pie-chart');
                if(pieChart) {
                    const total = students + counselors + admins;
                    if(total > 0) {
                        pieChart.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="background: #28a745; height: ${(students/total)*100}%; min-height: 20px; border-radius: 4px; margin-bottom: 5px;"></div>
                                    <div style="text-align: center; font-size: 0.9rem;">Students: ${Math.round((students/total)*100)}%</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="background: #ffc107; height: ${(counselors/total)*100}%; min-height: 20px; border-radius: 4px; margin-bottom: 5px;"></div>
                                    <div style="text-align: center; font-size: 0.9rem;">Counselors: ${Math.round((counselors/total)*100)}%</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="background: #dc3545; height: ${(admins/total)*100}%; min-height: 20px; border-radius: 4px; margin-bottom: 5px;"></div>
                                    <div style="text-align: center; font-size: 0.9rem;">Admins: ${Math.round((admins/total)*100)}%</div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Render recent activity
                recentActivity.sort((a, b) => b.timestamp - a.timestamp);
                const activityHtml = recentActivity.slice(0, 10).map(activity => {
                    const date = new Date(activity.date);
                    const timeAgo = getTimeAgo(date);
                    const icon = activity.type === 'user_created' ? 'fa-user-plus' : 'fa-user-edit';
                    const color = activity.type === 'user_created' ? '#28a745' : '#007bff';
                    return `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                            <i class="fas ${icon}" style="color: ${color};"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${activity.user}</div>
                                <div style="font-size: 0.85rem; color: #666;">${activity.role} â€¢ ${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('admin-recent-activity').innerHTML = activityHtml || '<div style="text-align: center; padding: 20px; color: #999;">No recent activity</div>';
                
            } catch(e) {
                console.error('Error loading dashboard:', e);
            }
        };

        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if(seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if(minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if(hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if(days < 7) return `${days}d ago`;
            const weeks = Math.floor(days / 7);
            return `${weeks}w ago`;
        }

        // Load analytics
        window.loadAdminAnalytics = async function() {
            if(!db) return;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                let newUsers = 0;
                const statusCounts = { Draft: 0, Submitted: 0, 'In Review': 0, Approved: 0, Rejected: 0 };
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    
                    if(data.createdAt) {
                        const created = new Date(data.createdAt);
                        if(created >= thirtyDaysAgo) newUsers++;
                    }
                    
                    if(data.status) {
                        statusCounts[data.status] = (statusCounts[data.status] || 0) + 1;
                    }
                });
                
                // Render new users chart
                document.getElementById('admin-new-users-chart').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; color: #007bff; font-weight: bold;">${newUsers}</div>
                        <div style="color: #666; margin-top: 10px;">New users in last 30 days</div>
                    </div>
                `;
                
                // Render status chart
                const statusHtml = Object.entries(statusCounts).filter(([status, count]) => count > 0).map(([status, count]) => {
                    const colors = {
                        'Draft': '#6c757d',
                        'Submitted': '#007bff',
                        'In Review': '#ffc107',
                        'Approved': '#28a745',
                        'Rejected': '#dc3545'
                    };
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>${status}</span>
                                <span style="font-weight: 600;">${count}</span>
                            </div>
                            <div style="background: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${colors[status] || '#007bff'}; height: 100%; width: ${(count / Math.max(...Object.values(statusCounts))) * 100}%;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('admin-status-chart').innerHTML = statusHtml || '<div style="text-align: center; color: #999;">No status data</div>';
                
                // Detailed stats table
                const statsHtml = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Metric</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">Total Users</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;" id="analytics-total">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">New Users (30 days)</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${newUsers}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">Students</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;" id="analytics-students">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">Counselors</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;" id="analytics-counselors">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px;">Admins</td>
                                <td style="padding: 10px; text-align: right;" id="analytics-admins">-</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                document.getElementById('admin-detailed-stats').innerHTML = statsHtml;
                
                // Update detailed stats
                const total = usersSnapshot.size;
                document.getElementById('analytics-total').textContent = total;
                document.getElementById('analytics-students').textContent = statusCounts.Draft + statusCounts.Submitted + (statusCounts['In Review'] || 0);
                document.getElementById('analytics-counselors').textContent = Object.keys(statusCounts).length;
                document.getElementById('analytics-admins').textContent = '1';
                
            } catch(e) {
                console.error('Error loading analytics:', e);
            }
        };

        // Load activity logs
        window.loadActivityLogs = async function() {
            if(!db) return;
            
            const dateFrom = document.getElementById('activity-date-from').value;
            const dateTo = document.getElementById('activity-date-to').value;
            const filterType = document.getElementById('activity-filter-type').value;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const activities = [];
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    
                    if(data.createdAt) {
                        const date = new Date(data.createdAt);
                        if((!dateFrom || date >= new Date(dateFrom)) && (!dateTo || date <= new Date(dateTo))) {
                            if(filterType === 'all' || filterType === 'user_created') {
                                activities.push({
                                    type: 'user_created',
                                    user: data.email || 'Unknown',
                                    role: data.role || 'student',
                                    date: data.createdAt,
                                    timestamp: date.getTime()
                                });
                            }
                        }
                    }
                    
                    if(data.updatedAt && data.updatedAt !== data.createdAt) {
                        const date = new Date(data.updatedAt);
                        if((!dateFrom || date >= new Date(dateFrom)) && (!dateTo || date <= new Date(dateTo))) {
                            if(filterType === 'all' || filterType === 'user_updated') {
                                activities.push({
                                    type: 'user_updated',
                                    user: data.email || 'Unknown',
                                    role: data.role || 'student',
                                    date: data.updatedAt,
                                    timestamp: date.getTime()
                                });
                            }
                        }
                    }
                });
                
                activities.sort((a, b) => b.timestamp - a.timestamp);
                
                const logsHtml = activities.length > 0 ? activities.map(activity => {
                    const date = new Date(activity.date);
                    const icon = activity.type === 'user_created' ? 'fa-user-plus' : 
                                activity.type === 'user_deleted' ? 'fa-user-times' : 'fa-user-edit';
                    const color = activity.type === 'user_created' ? '#28a745' : 
                                 activity.type === 'user_deleted' ? '#dc3545' : '#007bff';
                    const typeText = activity.type === 'user_created' ? 'User Created' :
                                    activity.type === 'user_deleted' ? 'User Deleted' : 'User Updated';
                    
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
                            <div style="width: 40px; height: 40px; background: ${color}20; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${icon}" style="color: ${color};"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${typeText}</div>
                                <div style="font-size: 0.9rem; color: #666;">${activity.user} (${activity.role})</div>
                                <div style="font-size: 0.85rem; color: #999; margin-top: 5px;">${date.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }).join('') : '<div style="text-align: center; padding: 40px; color: #999;">No activities found</div>';
                
                document.getElementById('admin-activity-logs').innerHTML = logsHtml;
                
            } catch(e) {
                console.error('Error loading activity logs:', e);
                document.getElementById('admin-activity-logs').innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Error loading activity logs</div>';
            }
        };

        // --- CONTACT MESSAGES FUNCTIONS ---
        let currentContactId = null;
        let contactMessagesUnsubscribe = null;

        // Handle contact form submission
        window.handleContactSubmit = async function(event) {
            event.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const message = document.getElementById('contact-message').value;
            const statusEl = document.getElementById('contact-form-status');

            if(!name || !email || !message) {
                statusEl.style.display = 'block';
                statusEl.style.color = 'var(--danger)';
                statusEl.textContent = 'Please fill in all fields';
                return;
            }

            const contactData = {
                name: name,
                email: email,
                message: message,
                status: 'new',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                replies: []
            };

            // Try Firebase first, fallback to localStorage if it fails
            if(db && !isDemoMode) {
                try {
                    await addDoc(collection(db, "contactMessages"), contactData);
                    statusEl.style.display = 'block';
                    statusEl.style.color = 'var(--success)';
                    statusEl.textContent = 'Thank you! We will contact you shortly.';
                    document.getElementById('contact-form').reset();
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                    return; // Success, exit function
                } catch(e) {
                    console.error('Firebase error, falling back to localStorage:', e);
                    // Fall through to localStorage fallback
                }
            }

            // Fallback to localStorage (demo mode or if Firebase fails)
            try {
                const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                messages.push({ ...contactData, id: 'demo-' + Date.now() });
                localStorage.setItem('demoContactMessages', JSON.stringify(messages));
                statusEl.style.display = 'block';
                statusEl.style.color = 'var(--success)';
                statusEl.textContent = 'Thank you! Your message has been received.';
                document.getElementById('contact-form').reset();
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            } catch(e) {
                console.error('Error saving to localStorage:', e);
                statusEl.style.display = 'block';
                statusEl.style.color = 'var(--danger)';
                statusEl.textContent = 'Error saving message. Please try again or contact us directly.';
            }
        };

        // Load contact messages
        window.loadContactMessages = async function() {
            const listEl = document.getElementById('contact-messages-list');
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Loading messages...</p></div>';

            try {
                let messages = [];

                if(db && !isDemoMode) {
                    const snapshot = await getDocs(collection(db, "contactMessages"));
                    snapshot.forEach((doc) => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                } else {
                    // Demo mode
                    const demoMessages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    messages = demoMessages;
                }

                // Sort by date (newest first)
                messages.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                if(messages.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px;"></i><p>No messages yet</p></div>';
                    return;
                }

                listEl.innerHTML = messages.map(msg => {
                    const date = new Date(msg.createdAt);
                    const isNew = msg.status === 'new';
                    const unreadCount = (msg.replies || []).filter(r => !r.read).length;
                    return `
                        <div class="student-item ${currentContactId === msg.id ? 'active' : ''}" data-contact-id="${msg.id}" onclick="openContactChat('${msg.id}', this)" style="cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                    <strong style="color: var(--primary);">${msg.name}</strong>
                                    ${isNew ? '<span class="status-badge" style="background: #d1e7dd; color: #0f5132; font-size: 0.75rem;">New</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">${msg.email}</div>
                                <div style="font-size: 0.8rem; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px;">
                                    ${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}
                                </div>
                                <div style="font-size: 0.75rem; color: #999; margin-top: 5px;">${date.toLocaleDateString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Set up real-time listener for new messages
                if(db && !isDemoMode && !contactMessagesUnsubscribe) {
                    contactMessagesUnsubscribe = onSnapshot(collection(db, "contactMessages"), (snapshot) => {
                        loadContactMessages();
                    });
                }

            } catch(e) {
                console.error('Error loading contact messages:', e);
                listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i><p>Error loading messages</p></div>';
            }
        };

        // Open contact chat
        window.openContactChat = async function(contactId, clickedElement) {
            currentContactId = contactId;
            
            // Update active state
            document.querySelectorAll('#contact-messages-list .student-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activate the clicked item
            if(clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Fallback: find by data attribute
                const item = document.querySelector(`[data-contact-id="${contactId}"]`);
                if(item) item.classList.add('active');
            }

            try {
                let contactData = null;

                if(db && !isDemoMode) {
                    const docRef = doc(db, "contactMessages", contactId);
                    const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) {
                        contactData = { id: docSnap.id, ...docSnap.data() };
                    }
                } else {
                    // Demo mode
                    const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    contactData = messages.find(m => m.id === contactId);
                }

                if(!contactData) {
                    alert('Contact not found');
                    return;
                }

                // Update chat header
                document.getElementById('contact-chat-name').textContent = contactData.name;
                document.getElementById('contact-chat-email').textContent = contactData.email;
                const statusBadge = document.getElementById('contact-chat-status');
                if(contactData.status === 'new') {
                    statusBadge.textContent = 'New';
                    statusBadge.style.background = '#d1e7dd';
                    statusBadge.style.color = '#0f5132';
                } else if(contactData.status === 'replied') {
                    statusBadge.textContent = 'Replied';
                    statusBadge.style.background = '#cfe2ff';
                    statusBadge.style.color = '#084298';
                } else {
                    statusBadge.textContent = 'Closed';
                    statusBadge.style.background = '#f8d7da';
                    statusBadge.style.color = '#842029';
                }

                // Load messages
                const chatBody = document.getElementById('contact-chat-body');
                const initialMessage = {
                    text: contactData.message,
                    sender: 'contact',
                    timestamp: contactData.createdAt
                };
                const replies = contactData.replies || [];
                const allMessages = [initialMessage, ...replies].sort((a, b) => 
                    new Date(a.timestamp || a.createdAt || 0) - new Date(b.timestamp || b.createdAt || 0)
                );

                chatBody.innerHTML = allMessages.map(msg => {
                    const isAdmin = msg.sender === 'admin';
                    const date = new Date(msg.timestamp || msg.createdAt);
                    return `
                        <div class="message ${isAdmin ? 'msg-out' : 'msg-in'}" style="max-width: 70%;">
                            <div>${msg.text || msg.message}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">
                                ${date.toLocaleString()}
                            </div>
                        </div>
                    `;
                }).join('');

                chatBody.scrollTop = chatBody.scrollHeight;

                // Show chat view
                document.getElementById('contact-chat-empty').style.display = 'none';
                document.getElementById('contact-chat-view').style.display = 'flex';

                // Mark as read if new
                if(contactData.status === 'new' && db && !isDemoMode) {
                    await updateDoc(doc(db, "contactMessages", contactId), {
                        status: 'replied',
                        updatedAt: new Date().toISOString()
                    });
                } else if(contactData.status === 'new' && isDemoMode) {
                    const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    const index = messages.findIndex(m => m.id === contactId);
                    if(index !== -1) {
                        messages[index].status = 'replied';
                        localStorage.setItem('demoContactMessages', JSON.stringify(messages));
                    }
                }

            } catch(e) {
                console.error('Error opening contact chat:', e);
                alert('Error loading contact details');
            }
        };

        // Send reply to contact
        window.sendContactReply = async function() {
            if(!currentContactId) return;

            const input = document.getElementById('contact-chat-input');
            const messageText = input.value.trim();
            if(!messageText) return;

            try {
                const reply = {
                    text: messageText,
                    sender: 'admin',
                    timestamp: new Date().toISOString(),
                    read: false
                };

                if(db && !isDemoMode) {
                    const contactRef = doc(db, "contactMessages", currentContactId);
                    const contactSnap = await getDoc(contactRef);
                    if(!contactSnap.exists()) {
                        alert('Contact not found');
                        return;
                    }

                    const currentReplies = contactSnap.data().replies || [];
                    await updateDoc(contactRef, {
                        replies: [...currentReplies, reply],
                        status: 'replied',
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    // Demo mode
                    const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    const index = messages.findIndex(m => m.id === currentContactId);
                    if(index !== -1) {
                        if(!messages[index].replies) messages[index].replies = [];
                        messages[index].replies.push(reply);
                        messages[index].status = 'replied';
                        localStorage.setItem('demoContactMessages', JSON.stringify(messages));
                    }
                }

                // Add message to UI
                const chatBody = document.getElementById('contact-chat-body');
                const date = new Date();
                chatBody.innerHTML += `
                    <div class="message msg-out" style="max-width: 70%;">
                        <div>${messageText}</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">
                            ${date.toLocaleString()}
                        </div>
                    </div>
                `;
                chatBody.scrollTop = chatBody.scrollHeight;

                input.value = '';
                
                // Reload messages list to update status
                loadContactMessages();

            } catch(e) {
                console.error('Error sending reply:', e);
                alert('Error sending reply. Please try again.');
            }
        };

        // === BLOG MANAGEMENT FUNCTIONS ===
        
        // Load all blogs for admin
        window.loadAdminBlogs = async function() {
            const listEl = document.getElementById('admin-blogs-list');
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Loading blogs...</p></div>';

            try {
                if (!db) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">Database not available</div>';
                    return;
                }

                const blogsRef = collection(db, 'blogs');
                // Admins can query all blogs, but we'll filter client-side if needed
                // Note: Firebase rules will enforce that only published blogs are readable by non-admins
                let q;
                try {
                    // Try to get all blogs (for admin)
                    q = query(blogsRef, orderBy('createdAt', 'desc'));
                } catch(e) {
                    // If orderBy fails (no index), try without ordering
                    q = query(blogsRef);
                }
                const querySnapshot = await getDocs(q);

                const blogs = [];
                querySnapshot.forEach((doc) => {
                    blogs.push({ id: doc.id, ...doc.data() });
                });

                if (blogs.length === 0) {
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-light);">
                            <i class="fas fa-blog" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 20px;">No blogs found</p>
                            <button class="btn btn-accent" onclick="showCreateBlogModal()">
                                <i class="fas fa-plus"></i> Create Your First Blog
                            </button>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = blogs.map(blog => `
                    <div class="dash-card" style="margin-bottom: 15px; border-left: 4px solid ${blog.status === 'published' ? 'var(--success)' : 'var(--warning)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h3 style="margin: 0; color: var(--primary);">${blog.title || 'Untitled'}</h3>
                                    <span style="padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; 
                                        background: ${blog.status === 'published' ? '#d1e7dd' : '#fff3cd'}; 
                                        color: ${blog.status === 'published' ? '#0f5132' : '#856404'};">
                                        ${blog.status === 'published' ? 'Published' : 'Draft'}
                                    </span>
                                </div>
                                <p style="color: var(--text-light); margin: 5px 0; font-size: 0.9rem;">${blog.excerpt || 'No description'}</p>
                                <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                                    <span style="color: var(--text-light); font-size: 0.85rem;">
                                        <i class="fas fa-tag"></i> ${blog.category || 'Uncategorized'}
                                    </span>
                                    <span style="color: var(--text-light); font-size: 0.85rem;">
                                        <i class="fas fa-calendar"></i> ${blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : 'N/A'}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-sm" onclick="editBlog('${blog.id}')" style="padding: 8px 16px; background: var(--primary); color: white;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm" onclick="deleteBlog('${blog.id}', '${blog.title}')" style="padding: 8px 16px; background: var(--danger); color: white;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch(e) {
                console.error('Error loading blogs:', e);
                let errorMsg = 'Error loading blogs. ';
                if (e.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Make sure you are logged in as admin and Firebase rules are deployed.';
                } else if (e.message && e.message.includes('index')) {
                    errorMsg += 'Firebase index required. Please create an index for blogs collection on createdAt field.';
                } else {
                    errorMsg += e.message || 'Please try again.';
                }
                listEl.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger);">${errorMsg}</div>`;
            }
        };

        // Show create blog modal
        window.showCreateBlogModal = function() {
            document.getElementById('blog-modal-title').innerHTML = '<i class="fas fa-plus"></i> Create New Blog Post';
            document.getElementById('blog-form').reset();
            document.getElementById('blog-id').value = '';
            document.getElementById('blog-status').value = 'draft';
            document.getElementById('blog-modal').classList.add('active');
        };

        // Show edit blog modal
        window.editBlog = async function(blogId) {
            try {
                if (!db) {
                    alert('Database not available');
                    return;
                }

                const blogDoc = await getDoc(doc(db, 'blogs', blogId));
                if (!blogDoc.exists()) {
                    alert('Blog not found');
                    return;
                }

                const blogData = blogDoc.data();
                document.getElementById('blog-modal-title').innerHTML = '<i class="fas fa-edit"></i> Edit Blog Post';
                document.getElementById('blog-id').value = blogId;
                document.getElementById('blog-title').value = blogData.title || '';
                document.getElementById('blog-excerpt').value = blogData.excerpt || '';
                document.getElementById('blog-content').value = blogData.content || '';
                document.getElementById('blog-category').value = blogData.category || '';
                document.getElementById('blog-status').value = blogData.status || 'draft';
                document.getElementById('blog-image').value = blogData.imageUrl || '';
                document.getElementById('blog-modal').classList.add('active');

            } catch(e) {
                console.error('Error loading blog:', e);
                alert('Error loading blog. Please try again.');
            }
        };

        // Save blog (create or update)
        window.saveBlog = async function(event) {
            event.preventDefault();
            
            try {
                if (!db) {
                    alert('Database not available');
                    return;
                }

                const blogId = document.getElementById('blog-id').value;
                const blogData = {
                    title: document.getElementById('blog-title').value.trim(),
                    excerpt: document.getElementById('blog-excerpt').value.trim(),
                    content: document.getElementById('blog-content').value.trim(),
                    category: document.getElementById('blog-category').value,
                    status: document.getElementById('blog-status').value,
                    imageUrl: document.getElementById('blog-image').value.trim() || null,
                    updatedAt: new Date().toISOString()
                };

                if (blogId) {
                    // Update existing blog
                    await updateDoc(doc(db, 'blogs', blogId), blogData);
                    alert('Blog updated successfully!');
                } else {
                    // Create new blog
                    blogData.createdAt = new Date().toISOString();
                    blogData.author = 'Admin'; // You can get this from auth user
                    await addDoc(collection(db, 'blogs'), blogData);
                    alert('Blog created successfully!');
                }

                closeBlogModal();
                loadAdminBlogs();
                loadHomeBlogs(); // Refresh home page blogs

            } catch(e) {
                console.error('Error saving blog:', e);
                alert('Error saving blog. Please try again.');
            }
        };

        // Delete blog
        window.deleteBlog = async function(blogId, blogTitle) {
            if (!confirm(`Are you sure you want to delete "${blogTitle}"? This action cannot be undone.`)) {
                return;
            }

            try {
                if (!db) {
                    alert('Database not available');
                    return;
                }

                await deleteDoc(doc(db, 'blogs', blogId));
                alert('Blog deleted successfully!');
                loadAdminBlogs();
                loadHomeBlogs(); // Refresh home page blogs

            } catch(e) {
                console.error('Error deleting blog:', e);
                alert('Error deleting blog. Please try again.');
            }
        };

        // Close blog modal
        window.closeBlogModal = function() {
            document.getElementById('blog-modal').classList.remove('active');
        };

        // Filter blogs
        window.filterBlogs = function(searchTerm) {
            const blogs = document.querySelectorAll('#admin-blogs-list .dash-card');
            blogs.forEach(blog => {
                const text = blog.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    blog.style.display = 'block';
                } else {
                    blog.style.display = 'none';
                }
            });
        };

        window.filterBlogsByStatus = function(status) {
            const blogs = document.querySelectorAll('#admin-blogs-list .dash-card');
            blogs.forEach(blog => {
                if (status === 'all') {
                    blog.style.display = 'block';
                } else {
                    const statusBadge = blog.querySelector('span[style*="background"]');
                    const isPublished = statusBadge && statusBadge.textContent.trim() === 'Published';
                    if ((status === 'published' && isPublished) || (status === 'draft' && !isPublished)) {
                        blog.style.display = 'block';
                    } else {
                        blog.style.display = 'none';
                    }
                }
            });
        };

        // Load blogs for home page
        window.loadHomeBlogs = async function() {
            const container = document.getElementById('home-blogs-container');
            if (!container) return;

            try {
                if (!db) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">Blog posts will appear here</div>';
                    return;
                }

                const blogsRef = collection(db, 'blogs');
                let querySnapshot;
                
                try {
                    // Try query with status filter and ordering
                    const q = query(blogsRef, where('status', '==', 'published'), orderBy('createdAt', 'desc'), limit(3));
                    querySnapshot = await getDocs(q);
                } catch(e) {
                    console.warn('Index query failed, trying alternative:', e);
                    // If index doesn't exist, try getting all and filtering client-side
                    try {
                        const allBlogsQuery = query(blogsRef);
                        const allSnapshot = await getDocs(allBlogsQuery);
                        const allBlogs = [];
                        allSnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.status === 'published') {
                                allBlogs.push({ id: doc.id, ...data });
                            }
                        });
                        // Sort by createdAt and limit to 3
                        allBlogs.sort((a, b) => {
                            const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                            const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                            return dateB - dateA;
                        });
                        const blogs = allBlogs.slice(0, 3);
                        
                        if (blogs.length === 0) {
                            container.innerHTML = `
                                <div style="text-align: center; padding: 60px; color: var(--text-light); grid-column: 1 / -1;">
                                    <i class="fas fa-blog" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                    <p style="font-size: 1.1rem;">No blog posts available yet. Check back soon!</p>
                                </div>
                            `;
                            return;
                        }

                        container.innerHTML = blogs.map(blog => `
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="blog-card h-100" onclick="viewBlog('${blog.id}')">
                                    <div class="blog-card-image-wrapper">
                                        ${blog.imageUrl ? `<img src="${blog.imageUrl}" alt="${blog.title}" class="blog-card-image" onerror="this.style.display='none'">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 3rem;"><i class="fas fa-blog"></i></div>'}
                                    </div>
                                    <div class="blog-card-content">
                                        <span class="blog-card-tag">${blog.category || 'General'}</span>
                                        <h3 class="blog-card-title">${blog.title || 'Untitled'}</h3>
                                        <p class="blog-card-excerpt">${blog.excerpt || 'No description available'}</p>
                                        <div class="blog-card-meta">
                                            <span><i class="fas fa-calendar"></i> ${blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : 'N/A'}</span>
                                            <span><i class="fas fa-clock"></i> ${Math.ceil((blog.content || '').split(' ').length / 200)} min read</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        return;
                    } catch(err) {
                        throw err;
                    }
                }

                const blogs = [];
                querySnapshot.forEach((doc) => {
                    blogs.push({ id: doc.id, ...doc.data() });
                });

                if (blogs.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-light); grid-column: 1 / -1;">
                            <i class="fas fa-blog" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 1.1rem;">No blog posts available yet. Check back soon!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = blogs.map(blog => `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="blog-card h-100" onclick="viewBlog('${blog.id}')">
                            <div class="blog-card-image-wrapper">
                                ${blog.imageUrl ? `<img src="${blog.imageUrl}" alt="${blog.title}" class="blog-card-image" onerror="this.style.display='none'">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 3rem;"><i class="fas fa-blog"></i></div>'}
                            </div>
                            <div class="blog-card-content">
                                <span class="blog-card-tag">${blog.category || 'General'}</span>
                                <h3 class="blog-card-title">${blog.title || 'Untitled'}</h3>
                                <p class="blog-card-excerpt">${blog.excerpt || 'No description available'}</p>
                                <div class="blog-card-meta">
                                    <span><i class="fas fa-calendar"></i> ${blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : 'N/A'}</span>
                                    <span><i class="fas fa-clock"></i> ${Math.ceil((blog.content || '').split(' ').length / 200)} min read</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch(e) {
                console.error('Error loading home blogs:', e);
                let errorMsg = 'Error loading blog posts. ';
                if (e.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Please check Firebase rules.';
                } else if (e.code === 'failed-precondition') {
                    errorMsg += 'Firebase index required. Please create a composite index for blogs collection (status, createdAt).';
                } else {
                    errorMsg += e.message || 'Please try again.';
                }
                const container = document.getElementById('home-blogs-container');
                if (container) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger); grid-column: 1 / -1;">${errorMsg}</div>`;
                }
            }
        };

        // View blog - redirects to detail view
        window.viewBlog = function(blogId) {
            viewBlogDetail(blogId);
        };

        // Load blogs for blog page
        window.loadBlogPage = async function() {
            const container = document.getElementById('blog-page-list');
            if (!container) return;

            try {
                if (!db) {
                    container.innerHTML = '<div style="text-align: center; padding: 60px; color: var(--text-light); grid-column: 1 / -1;">Blog posts will appear here</div>';
                    return;
                }

                const blogsRef = collection(db, 'blogs');
                let querySnapshot;
                
                try {
                    // Try query with status filter and ordering
                    const q = query(blogsRef, where('status', '==', 'published'), orderBy('createdAt', 'desc'));
                    querySnapshot = await getDocs(q);
                } catch(e) {
                    console.warn('Index query failed, trying alternative:', e);
                    // If index doesn't exist, try getting all and filtering client-side
                    try {
                        const allBlogsQuery = query(blogsRef);
                        const allSnapshot = await getDocs(allBlogsQuery);
                        const allBlogs = [];
                        allSnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.status === 'published') {
                                allBlogs.push({ id: doc.id, ...data });
                            }
                        });
                        // Sort by createdAt
                        allBlogs.sort((a, b) => {
                            const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                            const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                            return dateB - dateA;
                        });
                        
                if (allBlogs.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-blog text-muted" style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.3;"></i>
                                <h3 class="text-muted mb-3">No Blog Posts Yet</h3>
                                <p class="text-muted">Check back soon for our latest articles and insights!</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                        container.innerHTML = allBlogs.map(blog => `
                            <div class="blog-card" onclick="viewBlogDetail('${blog.id}')">
                                ${blog.imageUrl ? `<img src="${blog.imageUrl}" alt="${blog.title}" class="blog-card-image" onerror="this.style.display='none'">` : ''}
                                <div class="blog-card-content">
                                    <span class="blog-card-tag">${blog.category || 'General'}</span>
                                    <h3 class="blog-card-title">${blog.title || 'Untitled'}</h3>
                                    <p class="blog-card-excerpt">${blog.excerpt || 'No description available'}</p>
                                    <div class="blog-card-meta">
                                        <span><i class="fas fa-calendar"></i> ${blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : 'N/A'}</span>
                                        <span><i class="fas fa-clock"></i> ${Math.ceil((blog.content || '').split(' ').length / 200)} min read</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        return;
                    } catch(err) {
                        throw err;
                    }
                }

                const blogs = [];
                querySnapshot.forEach((doc) => {
                    blogs.push({ id: doc.id, ...doc.data() });
                });

                if (blogs.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-light); grid-column: 1 / -1;">
                            <i class="fas fa-blog" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 1.1rem;">No blog posts available yet. Check back soon!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = blogs.map(blog => `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="blog-card h-100" onclick="viewBlogDetail('${blog.id}')">
                            <div class="blog-card-image-wrapper">
                                ${blog.imageUrl ? `<img src="${blog.imageUrl}" alt="${blog.title}" class="blog-card-image" onerror="this.style.display='none'">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 3rem;"><i class="fas fa-blog"></i></div>'}
                            </div>
                            <div class="blog-card-content">
                                <span class="blog-card-tag">${blog.category || 'General'}</span>
                                <h3 class="blog-card-title">${blog.title || 'Untitled'}</h3>
                                <p class="blog-card-excerpt">${blog.excerpt || 'No description available'}</p>
                                <div class="blog-card-meta">
                                    <span><i class="fas fa-calendar"></i> ${blog.createdAt ? new Date(blog.createdAt).toLocaleDateString() : 'N/A'}</span>
                                    <span><i class="fas fa-clock"></i> ${Math.ceil((blog.content || '').split(' ').length / 200)} min read</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch(e) {
                console.error('Error loading blog page:', e);
                let errorMsg = 'Error loading blog posts. ';
                if (e.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Please check Firebase rules are deployed correctly.';
                } else if (e.code === 'failed-precondition') {
                    errorMsg += 'Firebase index required. Please create a composite index for blogs collection (status, createdAt). Check the browser console for the index link.';
                } else if (e.message) {
                    errorMsg += e.message;
                } else {
                    errorMsg += 'Please try again.';
                }
                if (container) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger); grid-column: 1 / -1;">${errorMsg}</div>`;
                }
            }
        };

        // Filter blog page
        window.filterBlogPage = function(searchTerm) {
            const blogs = document.querySelectorAll('#blog-page-list .blog-card');
            blogs.forEach(blog => {
                const text = blog.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    blog.style.display = 'block';
                } else {
                    blog.style.display = 'none';
                }
            });
        };

        window.filterBlogPageByCategory = function(category) {
            const blogs = document.querySelectorAll('#blog-page-list .blog-card');
            blogs.forEach(blog => {
                if (category === 'all') {
                    blog.style.display = 'block';
                } else {
                    const tag = blog.querySelector('.blog-card-tag');
                    if (tag && tag.textContent.trim() === category) {
                        blog.style.display = 'block';
                    } else {
                        blog.style.display = 'none';
                    }
                }
            });
        };

        // View blog detail (for future implementation)
        // View blog detail
        window.viewBlogDetail = async function(blogId) {
            // Navigate to blog detail page
            router('blog-detail');
            
            const container = document.getElementById('blog-detail-container');
            if (!container) {
                console.error('Blog detail container not found');
                return;
            }
            
            container.innerHTML = '<div style="text-align: center; padding: 60px; color: var(--text-light);"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Loading blog post...</p></div>';
            
            try {
                if (!db) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">Database not available</div>';
                    return;
                }
                
                const blogDoc = await getDoc(doc(db, 'blogs', blogId));
                
                if (!blogDoc.exists()) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h2>Blog Post Not Found</h2>
                            <p style="margin: 20px 0;">The blog post you're looking for doesn't exist or has been removed.</p>
                            <button class="btn btn-accent" onclick="router('blogs')">Back to Blog</button>
                        </div>
                    `;
                    return;
                }
                
                const blog = { id: blogDoc.id, ...blogDoc.data() };
                
                // Check if blog is published (unless user is admin)
                if (blog.status !== 'published') {
                    // Check if user is admin
                    let isAdminUser = false;
                    if (auth && auth.currentUser) {
                        try {
                            const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
                            if (userDoc.exists() && userDoc.data().role === 'admin') {
                                isAdminUser = true;
                            }
                        } catch(e) {
                            console.error('Error checking admin status:', e);
                        }
                    }
                    
                    if (!isAdminUser) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 60px; color: var(--danger);">
                                <i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                <h2>Blog Post Not Available</h2>
                                <p style="margin: 20px 0;">This blog post is not published yet.</p>
                                <button class="btn btn-accent" onclick="router('blogs')">Back to Blog</button>
                            </div>
                        `;
                        return;
                    }
                }
                
                // Calculate read time
                const wordCount = (blog.content || '').split(/\s+/).length;
                const readTime = Math.ceil(wordCount / 200);
                
                // Format date
                const publishDate = blog.createdAt ? new Date(blog.createdAt) : new Date();
                const formattedDate = publishDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Escape HTML in title and excerpt for safety, but allow HTML in content
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                container.innerHTML = `
                    <article class="blog-detail-article">
                        <!-- Blog Header -->
                        <header class="blog-detail-header">
                            <div class="blog-detail-meta">
                                <span class="blog-detail-category">${escapeHtml(blog.category || 'General')}</span>
                                <span class="blog-detail-date">
                                    <i class="fas fa-calendar"></i> ${formattedDate}
                                </span>
                                <span class="blog-detail-read-time">
                                    <i class="fas fa-clock"></i> ${readTime} min read
                                </span>
                            </div>
                            <h1 class="blog-detail-title">${escapeHtml(blog.title || 'Untitled')}</h1>
                            ${blog.excerpt ? `<p class="blog-detail-excerpt">${escapeHtml(blog.excerpt)}</p>` : ''}
                        </header>
                        
                        <!-- Featured Image -->
                        ${blog.imageUrl ? `
                            <div class="blog-detail-image">
                                <img src="${blog.imageUrl}" alt="${escapeHtml(blog.title)}" onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                        
                        <!-- Blog Content -->
                        <div class="blog-detail-content">
                            ${blog.content || '<p>No content available.</p>'}
                        </div>
                        
                        <!-- Blog Footer -->
                        <footer class="blog-detail-footer">
                            <div style="border-top: 2px solid var(--border-light); padding-top: 30px; margin-top: 40px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                                    <div>
                                        <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                                            <strong style="color: var(--primary);">Author:</strong> ${escapeHtml(blog.author || 'Global Edu Nepal')}
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                        <button class="btn btn-sm" onclick="shareBlog('${blog.id}', '${escapeHtml(blog.title)}')" style="background: var(--primary); color: white;">
                                            <i class="fas fa-share-alt"></i> Share
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </footer>
                    </article>
                `;
                
            } catch(e) {
                console.error('Error loading blog detail:', e);
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h2>Error Loading Blog Post</h2>
                        <p style="margin: 20px 0;">${e.message || 'An error occurred while loading the blog post.'}</p>
                        <button class="btn btn-accent" onclick="router('blogs')">Back to Blog</button>
                    </div>
                `;
            }
        };
        
        // Share blog function
        window.shareBlog = function(blogId, blogTitle) {
            const currentUrl = window.location.href.split('#')[0];
            const blogUrl = currentUrl + '#blog-detail-' + blogId;
            const shareText = `Check out this blog post: ${blogTitle} - Global Edu Nepal`;
            
            // Try Web Share API first (works on mobile and modern browsers)
            if (navigator.share) {
                navigator.share({
                    title: blogTitle,
                    text: shareText,
                    url: blogUrl
                }).catch(err => {
                    // User cancelled or error occurred, fall back to copy
                    console.log('Share cancelled or error:', err);
                    copyBlogLink(blogUrl, blogTitle);
                });
            } else if (navigator.clipboard && navigator.clipboard.writeText) {
                // Fallback: copy to clipboard
                copyBlogLink(blogUrl, blogTitle);
            } else {
                // Final fallback: show prompt
                showShareDialog(blogUrl, blogTitle);
            }
        };
        
        // Helper function to copy blog link
        function copyBlogLink(url, title) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Blog link copied to clipboard!', 'success');
                }).catch(() => {
                    showShareDialog(url, title);
                });
            } else {
                showShareDialog(url, title);
            }
        }
        
        // Show share dialog with copy option
        function showShareDialog(url, title) {
            const shareModal = document.createElement('div');
            shareModal.className = 'share-modal-overlay';
            shareModal.innerHTML = `
                <div class="share-modal-content">
                    <div class="share-modal-header">
                        <h3>Share Blog Post</h3>
                        <button class="share-modal-close" onclick="this.closest('.share-modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="share-modal-body">
                        <p><strong>${title}</strong></p>
                        <div class="input-group mb-3">
                            <input type="text" id="share-url-input" class="form-control" value="${url}" readonly>
                            <button class="btn btn-primary" onclick="copyShareUrl()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <div class="share-social-links">
                            <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fab fa-facebook"></i> Facebook
                            </a>
                            <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}" target="_blank" class="btn btn-sm btn-outline-info">
                                <i class="fab fa-twitter"></i> Twitter
                            </a>
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fab fa-linkedin"></i> LinkedIn
                            </a>
                            <a href="mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(url)}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-envelope"></i> Email
                            </a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(shareModal);
            
            // Close on overlay click
            shareModal.addEventListener('click', function(e) {
                if (e.target === shareModal) {
                    shareModal.remove();
                }
            });
        }
        
        // Copy share URL
        window.copyShareUrl = function() {
            const input = document.getElementById('share-url-input');
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices
            try {
                document.execCommand('copy');
                showToast('Link copied to clipboard!', 'success');
            } catch(err) {
                // Fallback if execCommand doesn't work
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(input.value).then(() => {
                        showToast('Link copied to clipboard!', 'success');
                    });
                }
            }
        };
        
        // Simple toast notification
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type || 'info'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        

        // Load blogs when home page is active
        if (document.getElementById('page-home')) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const homePage = document.getElementById('page-home');
                        if (homePage && homePage.classList.contains('active')) {
                            if (typeof loadHomeBlogs === 'function') {
                                loadHomeBlogs();
                            }
                        }
                    }
                });
            });
            
            observer.observe(document.getElementById('page-home'), {
                attributes: true,
                attributeFilter: ['class']
            });
        }

        // Filter contact messages
        window.filterContactMessages = function(searchTerm) {
            const items = document.querySelectorAll('#contact-messages-list .student-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = !searchTerm || text.includes(searchTerm.toLowerCase()) ? 'flex' : 'none';
            });
        };

        // Filter and search functions
        window.filterAdminUsers = function() {
            const searchTerm = document.getElementById('admin-search-users').value.toLowerCase();
            const roleFilter = document.getElementById('admin-filter-role').value;
            const statusFilter = document.getElementById('admin-filter-status').value;
            
            const items = document.querySelectorAll('#admin-users-list .student-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                const matchesSearch = !searchTerm || text.includes(searchTerm);
                const matchesRole = roleFilter === 'all' || text.includes(roleFilter);
                const matchesStatus = statusFilter === 'all' || text.includes(statusFilter);
                
                item.style.display = (matchesSearch && matchesRole && matchesStatus) ? 'flex' : 'none';
            });
        };

        window.clearAdminFilters = function() {
            document.getElementById('admin-search-users').value = '';
            document.getElementById('admin-filter-role').value = 'all';
            document.getElementById('admin-filter-status').value = 'all';
            filterAdminUsers();
        };

        // Bulk operations
        window.toggleSelectAllUsers = function() {
            const selectAll = document.getElementById('admin-select-all').checked;
            document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]').forEach(cb => {
                cb.checked = selectAll;
            });
            updateBulkActions();
        };

        window.updateBulkActions = function() {
            const selected = document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]:checked').length;
            const bulkActions = document.getElementById('admin-bulk-actions');
            const countSpan = document.getElementById('admin-selected-count');
            
            if(selected > 0) {
                bulkActions.style.display = 'block';
                countSpan.textContent = `${selected} user${selected > 1 ? 's' : ''} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
        };

        window.clearUserSelection = function() {
            document.getElementById('admin-select-all').checked = false;
            document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkActions();
        };

        window.bulkDeleteUsers = async function() {
            const selected = Array.from(document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]:checked'))
                .map(cb => cb.getAttribute('data-user-id'));
            
            if(selected.length === 0) {
                alert('No users selected');
                return;
            }
            
            if(!confirm(`Are you sure you want to delete ${selected.length} user(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                for(const userId of selected) {
                    await updateDoc(doc(db, "users", userId), {
                        deleted: true,
                        deletedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                alert(`${selected.length} user(s) deleted successfully!`);
                clearUserSelection();
                renderAdminUsers('all');
            } catch(e) {
                console.error('Error bulk deleting users:', e);
                alert(`Error deleting users: ${e.message}`);
            }
        };

        window.bulkAssignCounselor = async function() {
            const selected = Array.from(document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]:checked'))
                .map(cb => cb.getAttribute('data-user-id'));
            
            if(selected.length === 0) {
                alert('No users selected');
                return;
            }
            
            // Get all counselors
            const counselorsSnapshot = await getDocs(collection(db, "counselors"));
            const counselors = [];
            counselorsSnapshot.forEach(doc => {
                const data = doc.data();
                if(!data.deleted) {
                    counselors.push({ id: doc.id, name: data.name || data.email || 'Unknown' });
                }
            });
            
            if(counselors.length === 0) {
                alert('No counselors available');
                return;
            }
            
            const counselorOptions = counselors.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const counselorId = prompt(`Select counselor ID:\n\n${counselors.map((c, i) => `${i+1}. ${c.name} (${c.id})`).join('\n')}\n\nEnter counselor ID:`, '');
            
            if(!counselorId) return;
            
            try {
                for(const userId of selected) {
                    await updateDoc(doc(db, "users", userId), {
                        counselorId: counselorId,
                        assignedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                alert(`${selected.length} user(s) assigned to counselor successfully!`);
                clearUserSelection();
                renderAdminUsers('all');
            } catch(e) {
                console.error('Error bulk assigning counselor:', e);
                alert(`Error assigning counselor: ${e.message}`);
            }
        };

        // Export data
        window.exportUsersData = async function() {
            if(!db) return;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const data = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if(userData.deleted) return;
                    data.push({
                        id: doc.id,
                        email: userData.email || '',
                        firstName: userData.fname || '',
                        lastName: userData.lname || '',
                        role: userData.role || 'student',
                        status: userData.status || '',
                        createdAt: userData.createdAt || '',
                        updatedAt: userData.updatedAt || ''
                    });
                });
                
                const csv = [
                    ['ID', 'Email', 'First Name', 'Last Name', 'Role', 'Status', 'Created At', 'Updated At'],
                    ...data.map(u => [u.id, u.email, u.firstName, u.lastName, u.role, u.status, u.createdAt, u.updatedAt])
                ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch(e) {
                console.error('Error exporting data:', e);
                alert(`Error exporting data: ${e.message}`);
            }
        };
        
        // Close modals when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modals = ['create-user-modal', 'edit-user-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if(modal) {
                    modal.addEventListener('click', function(e) {
                        if(e.target === modal) {
                            if(modalId === 'create-user-modal') closeCreateUserModal();
                            else if(modalId === 'edit-user-modal') closeEditUserModal();
                        }
                    });
                }
            });
        });

        // --- AUTH & DEMO ---
        window.startDemoMode = function() {
            isDemoMode = true;
            document.getElementById('demo-badge').style.display = 'block';
            const roleText = window.currentRole === 'student' ? 'Demo Student' : 
                           window.currentRole === 'admin' ? 'Demo Admin' : 'Demo Counselor';
            document.getElementById('user-display').innerText = roleText;
            if(window.currentRole === 'student') window.router('student');
            else if(window.currentRole === 'admin') window.router('admin');
            else window.router('counselor');
        };

        console.log('Defining handleLogin function...');
        window.handleLogin = async function() {
            try {
                const e = document.getElementById('auth-email').value;
                const p = document.getElementById('auth-pass').value;
                if(!e || !p) return showAuthError("Enter credentials.");
            if(isDemoMode) return alert("In Demo Mode. Use button below.");
            
            // Hardcoded admin credentials
            const ADMIN_EMAIL = 'admin@gmail.com';
            const ADMIN_PASSWORD = 'admin123';
            
            // Check for hardcoded admin credentials
            if(e === ADMIN_EMAIL && p === ADMIN_PASSWORD) {
                if (!auth || !db) return alert("Firebase Failed.");
                
                try {
                    // Try to sign in with Firebase using admin credentials
                    let userCredential;
                    try {
                        userCredential = await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                    } catch(signInError) {
                        // If user doesn't exist, create the admin account
                        if(signInError.code === 'auth/user-not-found') {
                            userCredential = await createUserWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                        } else {
                            throw signInError;
                        }
                    }
                    
                    const user = userCredential.user;
                    
                    // Ensure admin user document exists in Firestore
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(!userDoc.exists()) {
                        await setDoc(doc(db, "users", user.uid), {
                            email: ADMIN_EMAIL,
                            role: 'admin',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    } else {
                        // Update role to admin if not already set
                        const userData = userDoc.data();
                        if(userData.role !== 'admin') {
                            await updateDoc(doc(db, "users", user.uid), {
                                role: 'admin',
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }
                    
                    // User will be automatically routed by onAuthStateChanged
                    showAuthError(""); // Clear any errors
                } catch(err) {
                    console.error('Admin login error:', err);
                    showAuthError(err.message || "Failed to authenticate admin.");
                }
                return;
            }
            
            if (!auth) return alert("Firebase Failed.");
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { showAuthError(err.message); }
            } catch(err) {
                console.error('Error in handleLogin:', err);
                alert('An error occurred during login. Please check the console for details.');
            }
        };

        window.toggleSignupMode = function() {
            const toggleBtn = document.getElementById('signup-toggle-btn');
            const submitBtn = document.getElementById('signup-submit-btn');
            
            if(toggleBtn.style.display === 'none') {
                toggleBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            } else {
                toggleBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            }
        };

        window.handleSignup = async function() {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            
            if(!e || !p) return showAuthError("Enter email and password.");
            if(p.length < 6) return showAuthError("Password must be at least 6 characters.");
            if(isDemoMode) return alert("In Demo Mode. Use button below.");
            if (!auth || !db) return alert("Firebase Failed.");
            
            try {
                // Create user account - default to student
                const userCredential = await createUserWithEmailAndPassword(auth, e, p);
                const user = userCredential.user;
                
                // Create student/user document
                await setDoc(doc(db, "users", user.uid), {
                    email: e,
                    fname: '',
                    lname: '',
                    role: 'student',
                    status: 'Draft',
                    counselorId: null, // Explicitly set to null - no auto-assignment, counselors will choose
                    milestone: null, // Explicitly set to null - no milestone by default
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                console.log('Student account created successfully');
                
                // User will be automatically signed in and routed by onAuthStateChanged
                showAuthError(""); // Clear any errors
                alert('Student account created successfully!');
            } catch(err) {
                console.error('Signup error:', err);
                let errorMsg = err.message;
                if(err.code === 'auth/email-already-in-use') {
                    errorMsg = "This email is already registered. Please sign in instead.";
                } else if(err.code === 'auth/weak-password') {
                    errorMsg = "Password is too weak. Please use a stronger password.";
                } else if(err.code === 'auth/invalid-email') {
                    errorMsg = "Invalid email address.";
                }
                showAuthError(errorMsg);
            }
        };

        window.handleLogout = async function() {
            if(isDemoMode) window.location.reload();
            else { if(auth) await signOut(auth); window.location.reload(); }
        };

        // Store uploaded files
        let uploadedFiles = {};
        let uploadedFilesCounter = 0;
        
        window.handleUpload = async function(docId, docType) {
            const fileInput = document.getElementById('file-' + docId);
            const files = fileInput.files;
            
            if(!files || files.length === 0) {
                alert("Please select file(s) to upload.");
                return;
            }
            
            const list = document.getElementById('stu-file-list');
            if(!list) {
                console.error('File list container not found');
                return;
            }
            
            const noDocsDiv = list.querySelector('.no-docs');
            if(noDocsDiv) {
                noDocsDiv.remove();
            }
            
            // Initialize array for this document type if it doesn't exist
            if(!uploadedFiles[docType]) {
                uploadedFiles[docType] = [];
            }
            
            // Check for duplicate files by name to prevent duplicates
            const existingFileNames = uploadedFiles[docType].map(f => f.name.toLowerCase());
            
            // Helper function to compress images
            const compressImage = (file, maxWidth = 1920, quality = 0.8) => {
                return new Promise((resolve) => {
                    if (!file.type.startsWith('image/')) {
                        resolve(file); // Return original file if not an image
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Resize if too large
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob((blob) => {
                                if (blob && blob.size < file.size) {
                                    resolve(new File([blob], file.name, { type: file.type }));
                                } else {
                                    resolve(file); // Return original if compression didn't help
                                }
                            }, file.type, quality);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };
            
            // Process multiple files
            const uploadTime = new Date().toISOString();
            let newFilesCount = 0;
            const uploadPromises = [];
            const filesToUpload = [];
            
            // Prepare files for upload
            for (const file of Array.from(files)) {
                // Skip if file with same name already exists
                if(existingFileNames.includes(file.name.toLowerCase())) {
                    console.log(`File ${file.name} already exists, skipping duplicate`);
                    continue;
                }
                
                // No size limit - we'll use chunking for large files
                
                const fileId = `file-${uploadedFilesCounter++}`;
                existingFileNames.push(file.name.toLowerCase());
                newFilesCount++;
                filesToUpload.push({ file, fileId });
            }
            
            if(filesToUpload.length === 0) {
                alert("No new files to upload. All selected files may already be uploaded or are too large.");
                return;
            }
            
            // Show uploading indicator with file count
            const uploadingDiv = document.createElement('div');
            uploadingDiv.id = 'uploading-indicator';
            uploadingDiv.style.cssText = 'padding:15px; background:#e3f2fd; border:1px solid #2196f3; margin-top:10px; border-radius:6px; font-size:0.9rem;';
            uploadingDiv.innerHTML = `<div style="text-align:center; margin-bottom:10px;"><i class="fas fa-spinner fa-spin"></i> Uploading ${filesToUpload.length} file(s)...</div>`;
            list.appendChild(uploadingDiv);
            
            // Process each file with individual progress
            for (const { file, fileId } of filesToUpload) {
                // Create individual progress indicator
                const fileProgressDiv = document.createElement('div');
                fileProgressDiv.id = `progress-${fileId}`;
                fileProgressDiv.style.cssText = 'padding:8px; background:#fff; border:1px solid #ddd; margin-top:5px; border-radius:4px; font-size:0.85rem;';
                fileProgressDiv.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <span><i class="fas fa-file" style="margin-right:8px;"></i>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                        <span id="status-${fileId}" style="color:#2196f3;"><i class="fas fa-spinner fa-spin"></i> Uploading...</span>
                    </div>
                    <div style="margin-top:5px; background:#f0f0f0; border-radius:4px; height:4px; overflow:hidden;">
                        <div id="bar-${fileId}" style="background:#2196f3; height:100%; width:0%; transition:width 0.3s;"></div>
                    </div>
                `;
                uploadingDiv.appendChild(fileProgressDiv);
                
                // Upload to Firebase Storage if authenticated
                if(auth && auth.currentUser && !isDemoMode && storage && db) {
                    const uploadPromise = (async () => {
                        try {
                            // Use chunking for ALL files to stay within Firestore 1MB limit
                            // Compress image if it's an image file
                            let processedFile = file;
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            document.getElementById(`bar-${fileId}`).style.width = '5%';
                            processedFile = await compressImage(file);
                            
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            document.getElementById(`bar-${fileId}`).style.width = '10%';
                            
                            // Convert to Base64
                            const base64 = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = (e) => reject(new Error('Failed to read file'));
                                reader.readAsDataURL(processedFile);
                            });
                            
                            console.log(`File "${file.name}": Original size: ${(processedFile.size / 1024).toFixed(2)}KB, Base64 size: ${(base64.length / 1024).toFixed(2)}KB`);
                            
                            document.getElementById(`bar-${fileId}`).style.width = '15%';
                            
                            // Generate unique file ID for chunked storage
                            const chunkedFileId = `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            
                            // Chunking Logic - Base64 increases size by ~33%, so we use 500KB chunks
                            // This ensures base64 chunks stay well under 1MB Firestore limit
                            // 500KB * 1.33 = ~665KB base64, safely under 1MB limit
                            const CHUNK_SIZE = 500 * 1024; // 500KB base64 string length (safe for 1MB Firestore limit)
                            const totalChunks = Math.ceil(base64.length / CHUNK_SIZE);
                            
                            console.log(`Splitting into ${totalChunks} chunks of max ${(CHUNK_SIZE / 1024).toFixed(2)}KB each`);
                            
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            document.getElementById(`bar-${fileId}`).style.width = '20%';
                            
                            // Save Chunks to 'file_data' collection using batches
                            const BATCH_SIZE = 500; // Firestore batch limit
                            let batch = writeBatch(db);
                            let batchCount = 0;
                            
                            for (let i = 0; i < totalChunks; i++) {
                                const chunkData = base64.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                                
                                // Validate chunk size (should be under 1MB)
                                const chunkSizeKB = chunkData.length / 1024;
                                if (chunkData.length > 1024 * 1024) {
                                    throw new Error(`Chunk ${i + 1} is too large: ${chunkSizeKB.toFixed(2)}KB. Please use a smaller file or contact support.`);
                                }
                                
                                console.log(`Chunk ${i + 1}/${totalChunks}: ${chunkSizeKB.toFixed(2)}KB`);
                                
                                const chunkRef = doc(db, `file_data/${chunkedFileId}/chunks/${i}`);
                                batch.set(chunkRef, { 
                                    data: chunkData,
                                    userId: auth.currentUser.uid, // Store userId for security rule verification
                                    uploadedAt: new Date().toISOString()
                                });
                                batchCount++;
                                
                                // Commit batch when it reaches limit or is the last chunk
                                if (batchCount >= BATCH_SIZE || i === totalChunks - 1) {
                                    if (batchCount > 0) {
                                        try {
                                            console.log(`Committing batch with ${batchCount} chunks (chunk ${i - batchCount + 1} to ${i + 1})...`);
                                            console.log(`Chunk path: file_data/${chunkedFileId}/chunks/${i}`);
                                            console.log(`User ID: ${auth.currentUser.uid}`);
                                            
                                            await batch.commit();
                                            console.log(`âœ… Batch committed successfully (chunks ${i - batchCount + 1} to ${i + 1})`);
                                            
                                            // Update progress
                                            const progress = 20 + ((i + 1) / totalChunks) * 70;
                                            document.getElementById(`bar-${fileId}`).style.width = `${Math.min(progress, 90)}%`;
                                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                                        } catch (batchError) {
                                            console.error(`âŒ Error committing batch at chunk ${i}:`, batchError);
                                            console.error('Error code:', batchError.code);
                                            console.error('Error message:', batchError.message);
                                            console.error('Full error:', batchError);
                                            
                                            // More detailed error message
                                            let errorMsg = `Failed to upload chunk ${i + 1}/${totalChunks}`;
                                            if (batchError.code === 'permission-denied') {
                                                errorMsg += ': Permission denied. Please check Firestore security rules for file_data collection.';
                                            } else if (batchError.message) {
                                                errorMsg += `: ${batchError.message}`;
                                            }
                                            throw new Error(errorMsg);
                                        }
                                    }
                                    // Create new batch for next iteration
                                    if (i < totalChunks - 1) {
                                        batch = writeBatch(db);
                                        batchCount = 0;
                                    }
                                }
                            }
                            
                            console.log(`âœ… All ${totalChunks} chunks uploaded successfully`);
                            
                            document.getElementById(`bar-${fileId}`).style.width = '90%';
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            
                            // Save METADATA to User Profile (Keep this small!)
                            const fileMetadata = {
                                id: fileId,
                                name: file.name,
                                type: docType,
                                size: processedFile.size,
                                uploadedAt: uploadTime,
                                isChunked: true, // Flag to tell downloader to look in file_data
                                chunkCount: totalChunks,
                                chunkedFileId: chunkedFileId // Store the ID used for chunks
                            };
                            
                            console.log('Saving file metadata:', fileMetadata);
                            
                            // Update local state for UI
                            uploadedFiles[docType].push(fileMetadata);
                            
                            // Save metadata to Firestore User Document
                            try {
                                const userRef = doc(db, "users", auth.currentUser.uid);
                                
                                // Get current user document to merge properly
                                let currentDocs = [];
                                try {
                                    const userDoc = await getDoc(userRef);
                                    if (userDoc.exists()) {
                                        currentDocs = userDoc.data().docs || [];
                                        // Also update currentApplication from database
                                        currentApplication = { ...currentApplication, ...userDoc.data() };
                                    }
                                } catch (readError) {
                                    console.warn('Could not read current user document:', readError);
                                }
                                
                                // Check if file with same ID already exists and replace it, otherwise add new
                                const existingIndex = currentDocs.findIndex(d => d.id === fileId);
                                if (existingIndex >= 0) {
                                    currentDocs[existingIndex] = fileMetadata;
                                    console.log(`Replacing existing document at index ${existingIndex}`);
                                } else {
                                    currentDocs.push(fileMetadata);
                                    console.log('Adding new document to array');
                                }
                                
                                console.log('Updating user document with docs array:', currentDocs.length, 'documents');
                                await setDoc(userRef, { docs: currentDocs }, { merge: true });
                                console.log('âœ… Metadata saved to user document');
                                
                                // Update local state
                                currentApplication.docs = currentDocs;
                                
                                // Refresh checklist immediately after saving
                                setTimeout(() => {
                                    if(typeof loadDocumentChecklist === 'function') {
                                        loadDocumentChecklist();
                                    }
                                    if(typeof loadDocumentChecklistModal === 'function') {
                                        loadDocumentChecklistModal();
                                    }
                                    if(typeof updateDashboardStats === 'function') {
                                        updateDashboardStats();
                                    }
                                }, 500);
                            } catch (metaError) {
                                console.error('âŒ Error saving metadata:', metaError);
                                console.error('Error details:', {
                                    code: metaError.code,
                                    message: metaError.message,
                                    stack: metaError.stack
                                });
                                throw new Error(`Failed to save file metadata: ${metaError.message}`);
                            }
                                
                                document.getElementById(`bar-${fileId}`).style.width = '100%';
                                document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-check-circle" style="color:#28a745;"></i> Complete';
                                fileProgressDiv.style.borderColor = '#28a745';
                            
                            // Remove progress indicator and add to uploaded files list
                            setTimeout(() => {
                                fileProgressDiv.remove();
                                
                                // Display in the uploaded files list
                                const fileDiv = document.createElement('div');
                                fileDiv.id = fileId;
                                fileDiv.style.cssText = 'padding:10px; background:#fff; border:1px solid #eee; margin-top:5px; border-radius:4px; font-size:0.9rem; display:flex; align-items:center; justify-content:space-between;';
                                
                                const safeFileName = file.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    const fileSizeDisplay = processedFile.size > 1024 * 1024 
                                        ? `${(processedFile.size / (1024 * 1024)).toFixed(2)} MB` 
                                        : `${(processedFile.size / 1024).toFixed(2)} KB`;
                                fileDiv.innerHTML = `
                                    <div style="display:flex; align-items:center; flex:1;">
                                        <span class="doc-status-light doc-uploaded"></span>
                                        <strong style="margin-left:10px;">${docType}:</strong>
                                        <a href="#" onclick="downloadStudentDocument('${fileId}', '${docType}', '${safeFileName}'); return false;" style="margin-left:5px; color:var(--primary); text-decoration:none; cursor:pointer; font-weight:500; border-bottom:1px dotted var(--primary);" title="Click to download ${file.name}">
                                            ${file.name}
                                        </a>
                                            <span style="margin-left:10px; color:#999; font-size:0.85rem;">(${fileSizeDisplay})</span>
                                    </div>
                                    <button onclick="removeUploadedFileById('${fileId}', '${docType}')" style="background:none; border:none; color:#dc3545; cursor:pointer; padding:5px; margin-left:10px;" title="Remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                                list.appendChild(fileDiv);
                            }, 500);
                            
                                return { fileId, success: true, isChunked: true };
                        } catch(error) {
                            console.error(`Error uploading ${file.name}:`, error);
                            
                            // Update status to error with detailed message
                            const errorMsg = error.message || 'Unknown error occurred';
                            document.getElementById(`status-${fileId}`).innerHTML = `<i class="fas fa-exclamation-triangle" style="color:#dc3545;"></i> Failed: ${errorMsg.substring(0, 50)}`;
                            fileProgressDiv.style.borderColor = '#dc3545';
                            
                            // Show error alert
                            alert(`Upload failed for "${file.name}": ${errorMsg}\n\nPlease try again or contact support if the problem persists.`);
                            
                            // Remove progress after showing error
                            setTimeout(() => {
                                fileProgressDiv.remove();
                            }, 3000);
                            
                            return { fileId, success: false, error: error.message };
                        }
                    })();
                    
                    uploadPromises.push(uploadPromise);
                } else {
                    // Demo mode or not authenticated - store locally only
                    uploadedFiles[docType].push({
                        id: fileId,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: uploadTime,
                        blob: file
                    });
                    
                    // Display in the uploaded files list
                    const fileDiv = document.createElement('div');
                    fileDiv.id = fileId;
                    fileDiv.style.cssText = 'padding:10px; background:#fff; border:1px solid #eee; margin-top:5px; border-radius:4px; font-size:0.9rem; display:flex; align-items:center; justify-content:space-between;';
                    
                    const safeFileName = file.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    fileDiv.innerHTML = `
                        <div style="display:flex; align-items:center; flex:1;">
                            <span class="doc-status-light doc-uploaded"></span>
                            <strong style="margin-left:10px;">${docType}:</strong>
                            <a href="#" onclick="downloadStudentDocument('${fileId}', '${docType}', '${safeFileName}'); return false;" style="margin-left:5px; color:var(--primary); text-decoration:none; cursor:pointer; font-weight:500; border-bottom:1px dotted var(--primary);" title="Click to download ${file.name}">
                                ${file.name}
                            </a>
                            <span style="margin-left:10px; color:#999; font-size:0.85rem;">(${(file.size / 1024).toFixed(2)} KB)</span>
                        </div>
                        <button onclick="removeUploadedFileById('${fileId}', '${docType}')" style="background:none; border:none; color:#dc3545; cursor:pointer; padding:5px; margin-left:10px;" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    list.appendChild(fileDiv);
                }
            }
            
            // Wait for all uploads to complete
            if(uploadPromises.length > 0) {
                try {
                    await Promise.all(uploadPromises);
                } catch(error) {
                    console.error('Error during file uploads:', error);
                }
            }
            
            // Remove uploading indicator after a short delay (to show completion)
            setTimeout(() => {
                const indicator = document.getElementById('uploading-indicator');
                if(indicator) {
                    indicator.style.opacity = '0';
                    indicator.style.transition = 'opacity 0.3s';
                    setTimeout(() => indicator.remove(), 300);
                }
                
                // Refresh checklist and dashboard stats after upload completes
                if(typeof loadDocumentChecklist === 'function') {
                    loadDocumentChecklist();
                }
                if(typeof loadDocumentChecklistModal === 'function') {
                    loadDocumentChecklistModal();
                }
                if(typeof updateDashboardStats === 'function') {
                    updateDashboardStats();
                }
            }, 1000);
            
            if(newFilesCount === 0) {
                alert("One or more files were already uploaded. Duplicate files were skipped.");
                return;
            }
            
            // Save documents to database immediately after upload
            // Note: This is a backup save - the main save happens in the upload promise
            // We use collectFormData to ensure all files are included
            try {
                const formData = collectFormData();
                if(auth && auth.currentUser && !isDemoMode && db) {
                    try {
                        // Get current docs from database to merge properly
                        const userRef = doc(db, "users", auth.currentUser.uid);
                        let currentDocs = [];
                        try {
                            const userDoc = await getDoc(userRef);
                            if (userDoc.exists()) {
                                currentDocs = userDoc.data().docs || [];
                            }
                        } catch (readError) {
                            console.warn('Could not read user document for final save:', readError);
                        }
                        
                        // Merge: Use formData.docs (which includes all uploadedFiles) as source of truth
                        // But preserve any docs that might have been added elsewhere
                        const mergedDocs = [...formData.docs];
                        console.log(`Final save: ${mergedDocs.length} documents to save`);
                        
                        await setDoc(userRef, { docs: mergedDocs }, { merge: true });
                        console.log('âœ… Documents saved to database (final save)');
                        
                        // Update currentApplication
                        currentApplication.docs = mergedDocs;
                    } catch(e) {
                        console.error("âŒ Error saving documents to database:", e);
                        console.error("Error details:", {
                            code: e.code,
                            message: e.message
                        });
                    }
                } else if(isDemoMode) {
                    // Update currentApplication with docs
                    currentApplication = { ...currentApplication, docs: formData.docs };
                    localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                    console.log('Documents saved to localStorage (demo mode)');
                }
            } catch(error) {
                console.error('âŒ Error saving documents:', error);
            }
            
            // Clear the file input after upload
            fileInput.value = '';
            
            if(newFilesCount > 0) {
                const storageMsg = (auth && auth.currentUser && !isDemoMode && storage) ? ' and saved to cloud storage' : '';
                alert(`Successfully uploaded ${newFilesCount} file(s) for ${docType}${storageMsg}.`);
            }
        };
        
        // Download document function
        window.downloadStudentDocument = async function(fileId, docType, fileName) {
            try {
                // 1. Find metadata
                let fileData = null;
                
                // Search local state first
                if(uploadedFiles[docType]) {
                    fileData = uploadedFiles[docType].find(f => f.id === fileId);
                }
                
                // Fallback to loaded application data - try by ID first, then by name and type
                if (!fileData && currentApplication && currentApplication.docs) {
                    fileData = currentApplication.docs.find(d => d.id === fileId);
                    // If not found by ID, try by name and type (in case ID doesn't match)
                    if (!fileData) {
                        fileData = currentApplication.docs.find(d => d.name === fileName && d.type === docType);
                    }
                }
                
                // If still not found, check database
                if (!fileData && auth && auth.currentUser && !isDemoMode && db) {
                    try {
                        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                                fileData = userData.docs.find(d => d.id === fileId);
                                if(!fileData) {
                                    fileData = userData.docs.find(d => d.name === fileName && d.type === docType);
                                }
                                
                                // Update currentApplication with fresh data from database
                                if(fileData) {
                                    currentApplication = { ...currentApplication, ...userData };
                                }
                            }
                        }
                    } catch(e) {
                        console.error("Error fetching file from database:", e);
                    }
                }
                
                // If fileData exists but is missing critical fields, try to get complete data
                if (fileData && fileData.isChunked && !fileData.chunkedFileId && db && auth && auth.currentUser) {
                    console.log('File data missing chunkedFileId, fetching from database...');
                    try {
                        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                                const completeFileData = userData.docs.find(d => d.id === fileId || (d.name === fileName && d.type === docType));
                                if(completeFileData) {
                                    fileData = completeFileData; // Use complete data
                                    console.log('Found complete file data:', completeFileData);
                                }
                            }
                        }
                    } catch(e) {
                        console.error("Error fetching complete file data:", e);
                    }
                }
                
                if (!fileData) {
                    alert(`File "${fileName}" not found.`);
                    return;
                }
                
                console.log('File data for download:', {
                    id: fileData.id,
                    name: fileData.name,
                    isChunked: fileData.isChunked,
                    chunkedFileId: fileData.chunkedFileId,
                    chunkCount: fileData.chunkCount,
                    downloadURL: fileData.downloadURL,
                    hasBlob: !!fileData.blob
                });
                
                // 2. Check if it's a "Chunked" file (Large file)
                if (fileData.isChunked && fileData.chunkedFileId) {
                    const loadingMsg = document.createElement('div');
                    loadingMsg.id = 'dl-msg';
                    loadingMsg.style.cssText = "position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:5px; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3);";
                    loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reassembling large file...';
                    document.body.appendChild(loadingMsg);
                    
                    try {
                        // Fetch all chunks
                        let fullBase64 = "";
                        const count = fileData.chunkCount || 100; // fallback safety
                        
                        for (let i = 0; i < count; i++) {
                            // Update loading message
                            loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading chunk ${i + 1}/${count}...`;
                            
                            // Fetch chunk i
                            const chunkRef = doc(db, `file_data/${fileData.chunkedFileId}/chunks/${i}`);
                            const snap = await getDoc(chunkRef);
                            
                            if (snap.exists()) {
                                fullBase64 += snap.data().data;
                            } else {
                                break; // No more chunks
                            }
                        }
                        
                        // Trigger Download
                        const a = document.createElement('a');
                        a.href = fullBase64;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        loadingMsg.innerHTML = '<i class="fas fa-check-circle"></i> Download started!';
                        setTimeout(() => loadingMsg.remove(), 2000);
                        
                    } catch (e) {
                        console.error("Download failed:", e);
                        loadingMsg.remove();
                        alert("Failed to download large file: " + e.message);
                    }
                    
                } else if (fileData.downloadURL) {
                    // Standard small file (Firebase Storage URL)
                    const a = document.createElement('a');
                    a.href = fileData.downloadURL;
                    a.download = fileName;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                } else if (fileData.blob instanceof File) {
                    // Local blob (for recently uploaded files not yet in Storage)
                    const url = URL.createObjectURL(fileData.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    
                } else {
                    // Check if file data is stored as data URL in DOM
                    const fileDiv = document.getElementById(fileId);
                    if(fileDiv) {
                        const blobData = fileDiv.getAttribute('data-file-blob');
                        if(blobData) {
                            // Convert data URL to blob and download
                            const response = await fetch(blobData);
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            setTimeout(() => URL.revokeObjectURL(url), 100);
                            return;
                        }
                    }
                    
                    // If we get here, the file metadata exists but content is missing
                    console.error('File content missing for:', fileData);
                    console.error('File data:', {
                        id: fileData.id,
                        name: fileData.name,
                        isChunked: fileData.isChunked,
                        chunkedFileId: fileData.chunkedFileId,
                        downloadURL: fileData.downloadURL,
                        hasBlob: !!fileData.blob
                    });
                    
                    // Try one more time to get from database if it's chunked but chunkedFileId might be missing
                    if (fileData.isChunked && !fileData.chunkedFileId && db && auth && auth.currentUser) {
                        console.log('Attempting to find chunkedFileId in database...');
                        try {
                            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                            if(userDoc.exists()) {
                                const userData = userDoc.data();
                                if(userData.docs && Array.isArray(userData.docs)) {
                                    const dbFileData = userData.docs.find(d => d.id === fileId || (d.name === fileName && d.type === docType));
                                    if(dbFileData && dbFileData.isChunked && dbFileData.chunkedFileId) {
                                        console.log('Found chunkedFileId in database, retrying download...');
                                        // Retry with the correct chunkedFileId
                                        fileData.chunkedFileId = dbFileData.chunkedFileId;
                                        fileData.chunkCount = dbFileData.chunkCount;
                                        // Recursively call the function with updated data
                                        // But we'll handle it inline to avoid recursion issues
                                        const loadingMsg = document.createElement('div');
                                        loadingMsg.id = 'dl-msg';
                                        loadingMsg.style.cssText = "position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:5px; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3);";
                                        loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reassembling large file...';
                                        document.body.appendChild(loadingMsg);
                                        
                                        try {
                                            let fullBase64 = "";
                                            const count = dbFileData.chunkCount || 100;
                                            
                                            for (let i = 0; i < count; i++) {
                                                loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading chunk ${i + 1}/${count}...`;
                                                const chunkRef = doc(db, `file_data/${dbFileData.chunkedFileId}/chunks/${i}`);
                                                const snap = await getDoc(chunkRef);
                                                
                                                if (snap.exists()) {
                                                    fullBase64 += snap.data().data;
                                                } else {
                                                    break;
                                                }
                                            }
                                            
                                            const a = document.createElement('a');
                                            a.href = fullBase64;
                                            a.download = fileName;
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            
                                            loadingMsg.innerHTML = '<i class="fas fa-check-circle"></i> Download started!';
                                            setTimeout(() => loadingMsg.remove(), 2000);
                                            return;
                                        } catch (e) {
                                            console.error("Retry download failed:", e);
                                            loadingMsg.remove();
                                            alert("Failed to download file: " + e.message);
                                            return;
                                        }
                                    }
                                }
                            }
                        } catch(e) {
                            console.error("Error retrying download:", e);
                        }
                    }
                    
                    alert(`File "${fileName}" content is missing. The file may need to be re-uploaded.`);
                }
            } catch(error) {
                console.error('Error in downloadStudentDocument:', error);
                alert('Error downloading document. Please try again.');
            }
        };
        
        window.removeUploadedFileById = async function(fileId, docType) {
            // Find the file data to check if it's chunked
            let fileData = null;
            if(uploadedFiles[docType]) {
                fileData = uploadedFiles[docType].find(f => f.id === fileId);
            }
            
            // If not in local state, check currentApplication
            if (!fileData && currentApplication && currentApplication.docs) {
                fileData = currentApplication.docs.find(d => d.id === fileId);
            }
            
            // If still not found and authenticated, check database
            if (!fileData && auth && auth.currentUser && !isDemoMode && db) {
                try {
                        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                            fileData = userData.docs.find(d => d.id === fileId);
                        }
                    }
                } catch(e) {
                    console.error("Error fetching file data for removal:", e);
                }
            }
            
            // If it's a chunked file, delete all chunks from Firestore
            if (fileData && fileData.isChunked && fileData.chunkedFileId && db && auth && auth.currentUser && !isDemoMode) {
                try {
                    const chunkCount = fileData.chunkCount || 100;
                    // Delete chunks in batches
                    const BATCH_SIZE = 500;
                    let batch = writeBatch(db);
                    let batchCount = 0;
                    
                    for (let i = 0; i < chunkCount; i++) {
                        const chunkRef = doc(db, `file_data/${fileData.chunkedFileId}/chunks/${i}`);
                        batch.delete(chunkRef);
                        batchCount++;
                        
                        // Commit batch when it reaches limit or is the last chunk
                        if (batchCount >= BATCH_SIZE || i === chunkCount - 1) {
                            await batch.commit();
                            batch = writeBatch(db);
                            batchCount = 0;
                        }
                    }
                    console.log(`Deleted ${chunkCount} chunks for file ${fileId}`);
                    } catch(e) {
                    console.error("Error deleting chunks:", e);
                }
            }
            
            // Remove from data structure
            if(uploadedFiles[docType]) {
                uploadedFiles[docType] = uploadedFiles[docType].filter(f => f.id !== fileId);
                if(uploadedFiles[docType].length === 0) {
                    delete uploadedFiles[docType];
                }
            }
            
            // Remove from DOM
            const fileDiv = document.getElementById(fileId);
            if(fileDiv) {
                fileDiv.remove();
            }
            
            // Save updated documents list to database
            try {
                const formData = collectFormData();
                if(auth && auth.currentUser && !isDemoMode && db) {
                    try {
                        await setDoc(doc(db, "users", auth.currentUser.uid), { docs: formData.docs }, { merge: true });
                        console.log('Documents updated in database after removal');
                    } catch(e) {
                        console.error("Error updating documents in database:", e);
                    }
                } else if(isDemoMode) {
                    currentApplication = { ...currentApplication, docs: formData.docs };
                    localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                }
            } catch(error) {
                console.error('Error saving documents after removal:', error);
            }
            
            // Show "no docs" message if list is empty
            const list = document.getElementById('stu-file-list');
            const fileDivs = Array.from(list.children).filter(child => child.id && child.id.startsWith('file-'));
            if(fileDivs.length === 0) {
                list.innerHTML = '<h4 style="font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">Uploaded Files</h4><div class="no-docs" style="color: #999; font-style: italic; font-size: 0.9rem;">No documents uploaded yet.</div>';
            }
        };

        window.sendMessage = async function(role) {
            const input = document.getElementById(role === 'student' ? 'stu-chat-input' : 'coun-chat-input');
            const box = document.getElementById(role === 'student' ? 'stu-chat-box' : 'coun-chat-box');
            if(!input || !input.value.trim()) return;
            
            const messageText = input.value.trim();
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Create message element
            const div = document.createElement('div');
            div.className = 'message msg-out';
            div.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${role === 'student' ? 'You' : 'You (Counselor)'}</div>
                <div style="margin-bottom: 4px;">${messageText}</div>
                <div style="font-size: 0.75rem; opacity: 0.7; text-align: right;">${timestamp}</div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight; // Auto scroll to bottom
            
            // Save message to Firebase if authenticated
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    let studentId, counselorId;
                    
                    if(role === 'student') {
                        // Student sending message - need to find their counselor
                        studentId = auth.currentUser.uid;
                        // Try to get counselor ID from user's profile
                        try {
                            const userDoc = await getDoc(doc(db, "users", studentId));
                            if(userDoc.exists()) {
                                const userData = userDoc.data();
                                counselorId = userData.counselorId || null;
                                
                                // If student doesn't have a counselor, they can't send messages yet
                                if(!counselorId) {
                                    showInfo("You don't have a counselor assigned yet. A counselor will be assigned to you soon!");
                                    // Remove the message from UI
                                    if(div && div.parentNode) {
                                        div.remove();
                                    }
                                    input.value = messageText; // Restore message text
                                    return;
                                }
                            } else {
                                alert("Your profile is not set up. Please complete your application first.");
                                if(div && div.parentNode) {
                                    div.remove();
                                }
                                input.value = messageText;
                                return;
                            }
                        } catch(e) {
                            console.error("Error getting student counselor:", e);
                            alert("Error loading your profile. Please try again.");
                            if(div && div.parentNode) {
                                div.remove();
                            }
                            input.value = messageText;
                            return;
                        }
                    } else {
                        // Counselor sending message
                        counselorId = auth.currentUser.uid;
                        studentId = currentStudentId || null;
                        
                        if(!studentId) {
                            alert("Please select a student first.");
                            return;
                        }
                    }
                    
                    if(!studentId) {
                        console.error("Cannot send message: studentId is missing");
                        return;
                    }
                    
                    // Ensure counselorId is set for counselor messages
                    if(role === 'counselor' && !counselorId) {
                        counselorId = auth.currentUser.uid;
                    }
                    
                    const messageData = {
                        text: messageText,
                        sender: role === 'student' ? 'student' : 'counselor',
                        senderId: auth.currentUser.uid,
                        studentId: studentId,
                        counselorId: counselorId || null,
                        timestamp: new Date().toISOString(),
                        read: false
                    };
                    
                    // Save to messages collection
                    await addDoc(collection(db, "messages"), messageData);
                    console.log('Message saved successfully');
                } catch(e) {
                    console.error("Error saving message:", e);
                    console.error("Error details:", {
                        code: e.code,
                        message: e.message,
                        studentId: studentId,
                        counselorId: counselorId,
                        role: role
                    });
                    
                    // Show more specific error message
                    let errorMsg = "Failed to send message. ";
                    if(e.code === 'permission-denied') {
                        errorMsg += "Permission denied. Please check that you have the correct permissions.";
                    } else if(e.code === 'unavailable') {
                        errorMsg += "Database unavailable. Please check your internet connection.";
                    } else {
                        errorMsg += `Error: ${e.message || 'Unknown error'}. Please try again.`;
                    }
                    alert(errorMsg);
                    
                    // Remove the message from UI if save failed
                    if(div && div.parentNode) {
                        div.remove();
                    }
                }
            }
            
            input.value = '';
        };
        
        // Store chat listeners to unsubscribe when needed
        let chatUnsubscribers = {};
        
        // Load chat history for counselor
        function loadCounselorChat(studentId) {
            const chatBox = document.getElementById('coun-chat-box');
            if(!chatBox || !studentId) return;
            
            // Unsubscribe from previous chat listener
            if(chatUnsubscribers['counselor']) {
                chatUnsubscribers['counselor']();
                delete chatUnsubscribers['counselor'];
            }
            
            // Clear existing messages
            chatBox.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
            
            // Load messages from Firebase if authenticated
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const counselorId = auth.currentUser.uid;
                    
                    // Query messages between this counselor and student
                    // Use simple query by studentId only (no index required)
                    // Filter by counselorId and sort by timestamp in memory
                    const messagesQuery = query(
                        collection(db, "messages"),
                        where("studentId", "==", studentId)
                    );
                    
                    // Use real-time listener for live updates
                    const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                        chatBox.innerHTML = '';
                        
                        let messages = [];
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            // Filter by counselorId if we used fallback query
                            if(!msg.counselorId || msg.counselorId === counselorId) {
                                messages.push({ id: doc.id, ...msg });
                            }
                        });
                        
                        // Sort by timestamp
                        messages.sort((a, b) => {
                            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                            return timeA - timeB;
                        });
                        
                        if(messages.length === 0) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No previous messages. Start a conversation with the student!
                                </div>
                            `;
                        } else {
                            messages.forEach(msg => {
                                const msgDiv = document.createElement('div');
                                const isCounselor = msg.sender === 'counselor' || msg.senderId === counselorId;
                                msgDiv.className = isCounselor ? 'message msg-out' : 'message msg-in';
                                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                msgDiv.innerHTML = `
                                    <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${isCounselor ? 'You (Counselor)' : 'Student'}</div>
                                    <div style="margin-bottom: 4px;">${msg.text || ''}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.7; ${isCounselor ? 'text-align: right;' : ''}">${time}</div>
                                `;
                                chatBox.appendChild(msgDiv);
                            });
                            chatBox.scrollTop = chatBox.scrollHeight;
                        }
                    }, async (error) => {
                        console.error("Error loading chat:", error);
                        console.error("Error details:", {
                            code: error.code,
                            message: error.message,
                            studentId: studentId,
                            counselorId: counselorId
                        });
                        
                        // If index error, try querying without orderBy
                        if(error.code === 'failed-precondition') {
                            console.log("Index required, retrying without orderBy...");
                            try {
                                const fallbackQuery = query(
                                    collection(db, "messages"),
                                    where("studentId", "==", studentId)
                                );
                                
                                const unsubscribe = onSnapshot(fallbackQuery, (snapshot) => {
                                    chatBox.innerHTML = '';
                                    
                                    let messages = [];
                                    snapshot.forEach(doc => {
                                        const msg = doc.data();
                                        // Filter by counselorId
                                        if(!msg.counselorId || msg.counselorId === counselorId) {
                                            messages.push({ id: doc.id, ...msg });
                                        }
                                    });
                                    
                                    // Sort by timestamp in memory
                                    messages.sort((a, b) => {
                                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                                        return timeA - timeB;
                                    });
                                    
                                    if(messages.length === 0) {
                                        chatBox.innerHTML = `
                                            <div class="message msg-in">
                                                <strong>System:</strong> No previous messages. Start a conversation with the student!
                                            </div>
                                        `;
                                    } else {
                                        messages.forEach(msg => {
                                            const msgDiv = document.createElement('div');
                                            const isCounselor = msg.sender === 'counselor' || msg.senderId === counselorId;
                                            msgDiv.className = isCounselor ? 'message msg-out' : 'message msg-in';
                                            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                            msgDiv.innerHTML = `
                                                <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${isCounselor ? 'You (Counselor)' : 'Student'}</div>
                                                <div style="margin-bottom: 4px;">${msg.text || ''}</div>
                                                <div style="font-size: 0.75rem; opacity: 0.7; ${isCounselor ? 'text-align: right;' : ''}">${time}</div>
                                            `;
                                            chatBox.appendChild(msgDiv);
                                        });
                                        chatBox.scrollTop = chatBox.scrollHeight;
                                    }
                                }, (fallbackError) => {
                                    console.error("Fallback query also failed:", fallbackError);
                                    chatBox.innerHTML = `
                                        <div class="message msg-in">
                                            <strong>System:</strong> Error loading messages. ${fallbackError.message || 'Please try again.'}
                                        </div>
                                    `;
                                });
                                
                                // Store unsubscribe for cleanup
                                if(chatUnsubscribers['counselor']) {
                                    chatUnsubscribers['counselor']();
                                }
                                chatUnsubscribers['counselor'] = unsubscribe;
                                return; // Success, exit error handler
                            } catch(fallbackError) {
                                console.error("Fallback query setup failed:", fallbackError);
                            }
                        }
                        
                        let errorMsg = "Error loading messages. ";
                        if(error.code === 'permission-denied') {
                            errorMsg += "Permission denied. Please check Firestore security rules.";
                        } else if(error.code === 'failed-precondition') {
                            errorMsg += "Database index required. Please create the composite index in Firebase Console.";
                        } else if(error.code === 'unavailable') {
                            errorMsg += "Database unavailable. Please check your internet connection.";
                        } else {
                            errorMsg += `${error.message || 'Unknown error'}. Please try again.`;
                        }
                        
                        chatBox.innerHTML = `
                            <div class="message msg-in">
                                <strong>System:</strong> ${errorMsg}
                            </div>
                        `;
                    });
                    
                    // Store unsubscribe function
                    chatUnsubscribers['counselor'] = unsubscribe;
                } catch(e) {
                    console.error("Error setting up chat:", e);
                    chatBox.innerHTML = `
                        <div class="message msg-in">
                            <strong>System:</strong> Error setting up chat. Please refresh the page.
                        </div>
                    `;
                }
            } else {
                // Demo mode or not authenticated
                chatBox.innerHTML = `
                    <div class="message msg-in">
                        <strong>System:</strong> Start a conversation with the student! Chat messages will be saved when authenticated.
                    </div>
                `;
            }
        }
        
        // Load chat history for student
        function loadStudentChat() {
            const chatBox = document.getElementById('stu-chat-box');
            if(!chatBox || !auth || !auth.currentUser) return;
            
            // Unsubscribe from previous chat listener
            if(chatUnsubscribers['student']) {
                chatUnsubscribers['student']();
                delete chatUnsubscribers['student'];
            }
            
            // Clear existing messages
            chatBox.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
            
            // Load messages from Firebase if authenticated
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const studentId = auth.currentUser.uid;
                    
                    // Get student's counselor ID
                    getDoc(doc(db, "users", studentId)).then(userDoc => {
                        if(!userDoc.exists()) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No counselor assigned yet. Please contact support.
                                </div>
                            `;
                            return;
                        }
                        
                        const userData = userDoc.data();
                        const counselorId = userData.counselorId;
                        
                        if(!counselorId) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No counselor assigned yet. A counselor will be assigned to you soon!
                                </div>
                            `;
                            return;
                        }
                        
                        // Query messages between this student and their counselor
                        // Use simple query by studentId only (no index required)
                        // Filter by counselorId and sort by timestamp in memory
                        const messagesQuery = query(
                            collection(db, "messages"),
                            where("studentId", "==", studentId)
                        );
                        
                        // Use real-time listener for live updates
                        const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                            chatBox.innerHTML = '';
                            
                            let messages = [];
                            snapshot.forEach(doc => {
                                const msg = doc.data();
                                // Filter by counselorId if we used fallback query
                                if(!msg.counselorId || msg.counselorId === counselorId) {
                                    messages.push({ id: doc.id, ...msg });
                                }
                            });
                            
                            // Sort by timestamp
                            messages.sort((a, b) => {
                                const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                                const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                                return timeA - timeB;
                            });
                            
                            if(messages.length === 0) {
                                chatBox.innerHTML = `
                                    <div class="message msg-in">
                                        <strong>System:</strong> No previous messages. Start a conversation with your counselor!
                                    </div>
                                `;
                            } else {
                                messages.forEach(msg => {
                                    const msgDiv = document.createElement('div');
                                    const isStudent = msg.sender === 'student' || msg.senderId === studentId;
                                    msgDiv.className = isStudent ? 'message msg-out' : 'message msg-in';
                                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                    msgDiv.innerHTML = `
                                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${isStudent ? 'You' : 'Your Counselor'}</div>
                                        <div style="margin-bottom: 4px;">${msg.text || ''}</div>
                                        <div style="font-size: 0.75rem; opacity: 0.7; ${isStudent ? 'text-align: right;' : ''}">${time}</div>
                                    `;
                                    chatBox.appendChild(msgDiv);
                                });
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }
                        }, (error) => {
                            console.error("Error loading chat:", error);
                            console.error("Error details:", {
                                code: error.code,
                                message: error.message,
                                studentId: studentId,
                                counselorId: counselorId
                            });
                            
                            let errorMsg = "Error loading messages. ";
                            if(error.code === 'permission-denied') {
                                errorMsg += "Permission denied. Please check Firestore security rules.";
                            } else if(error.code === 'failed-precondition') {
                                errorMsg += "Database index required. Please create the composite index in Firebase Console.";
                            } else if(error.code === 'unavailable') {
                                errorMsg += "Database unavailable. Please check your internet connection.";
                            } else {
                                errorMsg += `${error.message || 'Unknown error'}. Please try again.`;
                            }
                            
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> ${errorMsg}
                                </div>
                            `;
                        });
                        
                        // Store unsubscribe function
                        chatUnsubscribers['student'] = unsubscribe;
                    }).catch(e => {
                        console.error("Error getting student data:", e);
                        chatBox.innerHTML = `
                            <div class="message msg-in">
                                <strong>System:</strong> Error loading chat. Please try again.
                            </div>
                        `;
                    });
                } catch(e) {
                    console.error("Error setting up chat:", e);
                    chatBox.innerHTML = `
                        <div class="message msg-in">
                            <strong>System:</strong> Error setting up chat. Please refresh the page.
                        </div>
                    `;
                }
            } else {
                // Demo mode or not authenticated
                chatBox.innerHTML = `
                    <div class="message msg-in">
                        <strong>System:</strong> Start a conversation! Chat messages will be saved when authenticated.
                    </div>
                `;
            }
        }

        if(auth) {
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    try {
                        // Check user role from users collection first
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        let userRole = null;
                        
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            userRole = userData.role || null;
                        }
                        
                        // If no role in users collection, check counselors collection
                        if(!userRole) {
                            const counDoc = await getDoc(doc(db, "counselors", user.uid));
                            if(counDoc.exists()) {
                                userRole = 'counselor';
                            }
                        }
                        
                        // Route based on role
                        if(userRole === 'admin') {
                            window.currentRole = 'admin';
                            window.router('admin');
                        } else if(userRole === 'counselor') {
                            window.currentRole = 'counselor';
                            window.router('counselor');
                        } else {
                            // Default to student
                            if(userDoc.exists()) {
                                currentApplication = userDoc.data();
                                selectedUnis = currentApplication.universities || [];
                                updateSelectedList();
                                setTimeout(() => loadFormData(), 200);
                            }
                            window.currentRole = 'student';
                            window.router('student');
                        }
                        document.getElementById('user-display').innerText = user.email;
                    } catch (e) { 
                        console.error('Auth state error:', e);
                        window.router('student'); 
                    }
                }
            });
        }

        // ========== NEW FEATURES FUNCTIONS ==========

        // --- NOTIFICATION CENTER ---
        window.toggleNotificationPanel = function() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('active');
            loadNotifications();
        };

        window.loadNotifications = async function() {
            if(!auth || !auth.currentUser || !db) return;
            
            try {
                const userId = auth.currentUser.uid;
                const notificationsQuery = query(
                    collection(db, "notifications"),
                    where("userId", "==", userId),
                    orderBy("createdAt", "desc"),
                    limit(50)
                );
                
                const snapshot = await getDocs(notificationsQuery);
                const notifications = [];
                snapshot.forEach(doc => {
                    notifications.push({ id: doc.id, ...doc.data() });
                });
                
                renderNotifications(notifications);
                updateNotificationBadge(notifications.filter(n => !n.read).length);
            } catch(e) {
                console.error('Error loading notifications:', e);
            }
        };

        function renderNotifications(notifications) {
            const list = document.getElementById('notification-list');
            if(notifications.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;"><i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i><p>No notifications</p></div>';
                return;
            }
            
            list.innerHTML = notifications.map(notif => {
                const time = notif.createdAt ? new Date(notif.createdAt).toLocaleString() : '';
                return `
                    <div class="notification-item ${!notif.read ? 'unread' : ''}" onclick="markNotificationRead('${notif.id}')" style="position: relative;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${notif.title || 'Notification'}</div>
                        <div style="color: #666; font-size: 0.9rem;">${notif.message || ''}</div>
                        <div class="notification-time">${time}</div>
                    </div>
                `;
            }).join('');
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-count');
            if(count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        window.markNotificationRead = async function(notifId) {
            if(!db) return;
            try {
                await updateDoc(doc(db, "notifications", notifId), { read: true, readAt: new Date().toISOString() });
                loadNotifications();
            } catch(e) {
                console.error('Error marking notification read:', e);
            }
        };

        window.markAllNotificationsRead = async function() {
            if(!auth || !auth.currentUser || !db) return;
            try {
                const userId = auth.currentUser.uid;
                const notificationsQuery = query(
                    collection(db, "notifications"),
                    where("userId", "==", userId),
                    where("read", "==", false)
                );
                const snapshot = await getDocs(notificationsQuery);
                const batch = writeBatch(db);
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { read: true, readAt: new Date().toISOString() });
                });
                await batch.commit();
                loadNotifications();
            } catch(e) {
                console.error('Error marking all notifications read:', e);
            }
        };

        // Create notification helper
        async function createNotification(userId, title, message, type = 'info') {
            if(!db) return;
            try {
                await addDoc(collection(db, "notifications"), {
                    userId: userId,
                    title: title,
                    message: message,
                    type: type,
                    read: false,
                    createdAt: new Date().toISOString()
                });
            } catch(e) {
                console.error('Error creating notification:', e);
            }
        }

        // --- TEST SCORE MANAGEMENT ---
        window.openTestScoreModal = function() {
            document.getElementById('test-score-modal').classList.add('active');
        };

        window.closeTestScoreModal = function() {
            document.getElementById('test-score-modal').classList.remove('active');
            document.getElementById('test-type').value = 'IELTS';
            document.getElementById('test-score').value = '';
            document.getElementById('test-date').value = '';
            document.getElementById('test-expiry').value = '';
        };

        window.saveTestScore = async function() {
            const testType = document.getElementById('test-type').value;
            const score = document.getElementById('test-score').value;
            const testDate = document.getElementById('test-date').value;
            const expiryDate = document.getElementById('test-expiry').value;
            
            if(!testType || !score || !testDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            if(!auth || !auth.currentUser || !db) {
                alert('Please login to save test scores');
                return;
            }
            
            try {
                const testScoreData = {
                    testType: testType,
                    score: score,
                    testDate: testDate,
                    expiryDate: expiryDate || null,
                    createdAt: new Date().toISOString()
                };
                
                const userRef = doc(db, "users", auth.currentUser.uid);
                const userDoc = await getDoc(userRef);
                const userData = userDoc.exists() ? userDoc.data() : {};
                const testScores = userData.testScores || [];
                testScores.push(testScoreData);
                
                await updateDoc(userRef, { testScores: testScores });
                closeTestScoreModal();
                loadTestScores();
                loadTestScoresModal();
                updateDashboardStats();
                // Reopen the view modal
                setTimeout(() => {
                    openTestScoresModal();
                }, 100);
                alert('Test score saved successfully!');
            } catch(e) {
                console.error('Error saving test score:', e);
                alert('Error saving test score. Please try again.');
            }
        };

        window.loadTestScores = async function() {
            if(!auth || !auth.currentUser || !db) return;
            
            try {
                const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const testScores = userData.testScores || [];
                
                const list = document.getElementById('test-scores-list');
                if(testScores.length === 0) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No test scores added yet</p>';
                    return;
                }
                
                list.innerHTML = testScores.map((score, index) => {
                    const expiryDate = score.expiryDate ? new Date(score.expiryDate) : null;
                    const today = new Date();
                    let expiryClass = 'valid';
                    let expiryText = 'Valid';
                    
                    if(expiryDate) {
                        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                        if(daysUntilExpiry < 0) {
                            expiryClass = 'expired';
                            expiryText = 'Expired';
                        } else if(daysUntilExpiry < 30) {
                            expiryClass = 'expiring';
                            expiryText = `Expires in ${daysUntilExpiry} days`;
                        } else {
                            expiryText = `Expires ${expiryDate.toLocaleDateString()}`;
                        }
                    }
                    
                    return `
                        <div class="test-score-card">
                            <div class="test-score-header">
                                <div>
                                    <strong>${score.testType}</strong>
                                    <div style="font-size: 1.2rem; color: var(--primary); margin-top: 5px;">Score: ${score.score}</div>
                                </div>
                                <span class="score-expiry ${expiryClass}">${expiryText}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 10px;">
                                Test Date: ${new Date(score.testDate).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch(e) {
                console.error('Error loading test scores:', e);
            }
        };

        // --- PAYMENT TRACKING ---
        window.openPaymentModal = function() {
            document.getElementById('payment-modal').classList.add('active');
        };

        window.closePaymentModal = function() {
            document.getElementById('payment-modal').classList.remove('active');
            document.getElementById('payment-type').value = 'Application Fee';
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-date').value = '';
            document.getElementById('payment-status').value = 'paid';
            document.getElementById('payment-notes').value = '';
        };

        window.savePayment = async function() {
            const paymentType = document.getElementById('payment-type').value;
            const amount = document.getElementById('payment-amount').value;
            const paymentDate = document.getElementById('payment-date').value;
            const status = document.getElementById('payment-status').value;
            const notes = document.getElementById('payment-notes').value;
            
            if(!paymentType || !amount || !paymentDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            if(!auth || !auth.currentUser || !db) {
                alert('Please login to save payments');
                return;
            }
            
            try {
                const paymentData = {
                    type: paymentType,
                    amount: parseFloat(amount),
                    date: paymentDate,
                    status: status,
                    notes: notes || '',
                    createdAt: new Date().toISOString()
                };
                
                const userRef = doc(db, "users", auth.currentUser.uid);
                const userDoc = await getDoc(userRef);
                const userData = userDoc.exists() ? userDoc.data() : {};
                const payments = userData.payments || [];
                payments.push(paymentData);
                
                await updateDoc(userRef, { payments: payments });
                closePaymentModal();
                loadPayments();
                loadPaymentsModal();
                updateDashboardStats();
                // Reopen the view modal
                setTimeout(() => {
                    openPaymentsModal();
                }, 100);
                alert('Payment saved successfully!');
            } catch(e) {
                console.error('Error saving payment:', e);
                alert('Error saving payment. Please try again.');
            }
        };

        window.loadPayments = async function() {
            if(!auth || !auth.currentUser || !db) return;
            
            try {
                const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const payments = userData.payments || [];
                
                const list = document.getElementById('payments-list');
                if(payments.length === 0) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No payments recorded yet</p>';
                    return;
                }
                
                const totalPaid = payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + (p.amount || 0), 0);
                const totalPending = payments.filter(p => p.status === 'pending').reduce((sum, p) => sum + (p.amount || 0), 0);
                
                list.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #d1e7dd; padding: 15px; border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: #0f5132; margin-bottom: 5px;">Total Paid</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #0f5132;">$${totalPaid.toFixed(2)}</div>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: #856404; margin-bottom: 5px;">Total Pending</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #856404;">$${totalPending.toFixed(2)}</div>
                        </div>
                    </div>
                    ${payments.map(payment => `
                        <div class="payment-card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <strong>${payment.type}</strong>
                                    <div class="payment-amount">$${payment.amount?.toFixed(2) || '0.00'}</div>
                                </div>
                                <span class="payment-status ${payment.status}">${payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                Date: ${new Date(payment.date).toLocaleDateString()}
                                ${payment.notes ? `<div style="margin-top: 5px;">${payment.notes}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                `;
            } catch(e) {
                console.error('Error loading payments:', e);
            }
        };

        // --- DOCUMENT CHECKLIST ---
        window.loadDocumentChecklist = async function() {
            if(!auth || !auth.currentUser || !db) return;
            
            try {
                const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const docs = userData.docs || [];
                
                const checklist = [
                    { id: 'passport', label: 'Passport (Front & Back)', required: true, types: ['Passport'] },
                    { id: 'transcript', label: 'Academic Transcripts', required: true, types: ['Transcript'] },
                    { id: 'ielts', label: 'IELTS/PTE Score Card', required: true, types: ['IELTS/PTE'] },
                    { id: 'financial', label: 'Financial Documents', required: true, types: ['Financial'] },
                    { id: 'sop', label: 'Statement of Purpose', required: false, types: ['SOP'] },
                    { id: 'recommendation', label: 'Recommendation Letters', required: false, types: ['Recommendation'] },
                    { id: 'cv', label: 'CV/Resume', required: false, types: ['CV', 'Resume'] },
                    { id: 'other', label: 'Other Documents', required: false, types: ['Other'] }
                ];
                
                const completed = checklist.filter(item => {
                    return docs.some(doc => {
                        // Check if document type matches any of the mapped types for this checklist item
                        return item.types.some(type => doc.type === type || doc.type?.toLowerCase() === type.toLowerCase());
                    });
                }).length;
                
                const total = checklist.length;
                const percentage = Math.round((completed / total) * 100);
                
                document.getElementById('checklist-progress-bar').style.width = percentage + '%';
                document.getElementById('checklist-completed').textContent = completed;
                document.getElementById('checklist-total').textContent = total;
                
                const checklistDiv = document.getElementById('document-checklist');
                checklistDiv.innerHTML = checklist.map(item => {
                    const isCompleted = docs.some(doc => {
                        // Check if document type matches any of the mapped types for this checklist item
                        return item.types.some(type => doc.type === type || doc.type?.toLowerCase() === type.toLowerCase());
                    });
                    return `
                        <div class="checklist-item ${isCompleted ? 'completed' : ''}">
                            <input type="checkbox" class="checklist-checkbox" ${isCompleted ? 'checked' : ''} disabled>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${item.label} ${item.required ? '<span style="color: var(--danger);">*</span>' : ''}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch(e) {
                console.error('Error loading checklist:', e);
            }
        };

        // --- TASK MANAGEMENT (Counselor) ---
        window.openTaskModal = function() {
            if(!currentStudentId) {
                alert('Please select a student first');
                return;
            }
            document.getElementById('task-modal').classList.add('active');
        };

        window.closeTaskModal = function() {
            document.getElementById('task-modal').classList.remove('active');
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-due-date').value = '';
            document.getElementById('task-priority').value = 'medium';
        };

        window.saveTask = async function() {
            if(!currentStudentId || !db) {
                alert('No student selected or database not available');
                console.error('Cannot save task: currentStudentId =', currentStudentId, 'db =', db);
                return;
            }
            
            console.log('saveTask called with currentStudentId:', currentStudentId);
            
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            
            if(!title || !dueDate) {
                alert('Please fill in title and due date');
                return;
            }
            
            try {
                const taskData = {
                    studentId: String(currentStudentId), // Ensure it's a string
                    title: title,
                    description: description || '',
                    dueDate: dueDate,
                    priority: priority,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser.uid
                };
                
                console.log('Saving task with data:', taskData);
                const taskRef = await addDoc(collection(db, "tasks"), taskData);
                console.log('Task saved successfully with ID:', taskRef.id);
                console.log('Task studentId:', taskData.studentId, 'Type:', typeof taskData.studentId);
                
                // Clear form
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-due-date').value = '';
                document.getElementById('task-priority').value = 'medium';
                
                closeTaskModal();
                
                // Switch to tasks tab if not already there
                const tasksTab = document.querySelector('.coun-tab[onclick*="tasks"]');
                const tasksContent = document.getElementById('tab-tasks');
                if(tasksTab && tasksContent) {
                    // Switch to tasks tab
                    switchCounselorTab('tasks');
                }
                
                // Reload tasks (real-time listener will pick it up automatically, but ensure it's loaded)
                // Give it a moment for the tab to become visible
                setTimeout(() => {
                    loadTasks();
                    console.log('Tasks reloaded after creation');
                }, 500);
                
                alert('Task created successfully!');
            } catch(e) {
                console.error('Error saving task:', e);
                let errorMsg = 'Error saving task. ';
                if(e.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Please check Firestore security rules.';
                } else {
                    errorMsg += e.message || 'Unknown error';
                }
                alert(errorMsg);
            }
        };

        // Store task listener to unsubscribe when needed
        let taskUnsubscriber = null;
        
        // Helper function to render tasks
        function renderTasksList(tasks, listElement) {
            if(!listElement) return;
            
            if(tasks.length === 0) {
                listElement.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No tasks created yet</p>';
                
                // Update task count
                const countEl = document.getElementById('cp-tasks-count');
                if(countEl) {
                    countEl.textContent = '';
                    countEl.style.display = 'none';
                }
                return;
            }
            
            listElement.innerHTML = tasks.map(task => {
                const dueDate = new Date(task.dueDate);
                const today = new Date();
                const isOverdue = !task.completed && dueDate < today;
                const dueDateText = dueDate.toLocaleDateString();
                const safeId = String(task.id).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                return `
                    <div class="task-card priority-${task.priority} ${task.completed ? 'completed' : ''}">
                        <div class="task-header">
                            <div>
                                <strong>${task.title}</strong>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">${task.description || ''}</div>
                            </div>
                            <div>
                                <button onclick="toggleTaskComplete('${safeId}', ${!task.completed})" style="background: none; border: none; cursor: pointer; color: ${task.completed ? 'var(--success)' : '#999'};">
                                    <i class="fas fa-${task.completed ? 'check-circle' : 'circle'}"></i>
                                </button>
                            </div>
                        </div>
                        <div class="task-due-date ${isOverdue ? 'overdue' : ''}">
                            <i class="fas fa-calendar"></i> Due: ${dueDateText} ${isOverdue ? '(Overdue)' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update task count
            const pendingCount = tasks.filter(t => !t.completed).length;
            const countEl = document.getElementById('cp-tasks-count');
            if(countEl) {
                countEl.textContent = pendingCount;
                countEl.style.display = pendingCount > 0 ? 'inline-block' : 'none';
            }
        }
        
        window.loadTasks = async function() {
            if(!currentStudentId || !db) {
                const list = document.getElementById('tasks-list');
                if(list) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No student selected</p>';
                }
                return;
            }
            
            const list = document.getElementById('tasks-list');
            if(!list) {
                console.error('Tasks list element not found');
                return;
            }
            
            // Unsubscribe from previous listener
            if(taskUnsubscriber) {
                taskUnsubscriber();
                taskUnsubscriber = null;
            }
            
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading tasks...</div>';
            
            try {
                // Ensure studentId is a string for consistent querying
                const studentIdStr = String(currentStudentId);
                console.log('Loading tasks for studentId:', studentIdStr, 'Type:', typeof studentIdStr);
                
                // First, try a one-time query to get tasks immediately
                let tasksQuery;
                let useOrderBy = true;
                
                try {
                    tasksQuery = query(
                        collection(db, "tasks"),
                        where("studentId", "==", studentIdStr),
                        orderBy("createdAt", "desc")
                    );
                } catch(queryError) {
                    // If orderBy fails, use simple query without orderBy
                    console.log('OrderBy not available, using simple query');
                    useOrderBy = false;
                    tasksQuery = query(
                        collection(db, "tasks"),
                        where("studentId", "==", studentIdStr)
                    );
                }
                
                // Do a one-time fetch first for immediate display
                let fetchSucceeded = false;
                try {
                    console.log('Fetching tasks for studentId:', studentIdStr);
                    const snapshot = await getDocs(tasksQuery);
                    console.log('Tasks query returned', snapshot.size, 'documents');
                    const tasks = [];
                    snapshot.forEach(doc => {
                        const taskData = doc.data();
                        console.log('Task found:', doc.id, taskData);
                        tasks.push({ id: doc.id, ...taskData });
                    });
                    
                    // Sort by createdAt in memory if we used fallback query
                    if(!useOrderBy) {
                        tasks.sort((a, b) => {
                            const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                            const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                            return timeB - timeA; // Descending order
                        });
                    }
                    
                    console.log('Rendering', tasks.length, 'tasks');
                    renderTasksList(tasks, list);
                    fetchSucceeded = true;
                } catch(fetchError) {
                    console.error('Error fetching tasks:', fetchError);
                    console.error('Error details:', {
                        code: fetchError.code,
                        message: fetchError.message,
                        studentId: studentIdStr
                    });
                    
                    // If orderBy query failed, try without orderBy
                    if(useOrderBy && (fetchError.code === 'failed-precondition' || fetchError.code === 'permission-denied')) {
                        console.log('Retrying with simple query (no orderBy)');
                        try {
                            const simpleQuery = query(
                                collection(db, "tasks"),
                                where("studentId", "==", studentIdStr)
                            );
                            const simpleSnapshot = await getDocs(simpleQuery);
                            const tasks = [];
                            simpleSnapshot.forEach(doc => {
                                tasks.push({ id: doc.id, ...doc.data() });
                            });
                            tasks.sort((a, b) => {
                                const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                                const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                                return timeB - timeA;
                            });
                            renderTasksList(tasks, list);
                            tasksQuery = simpleQuery; // Use simple query for listener too
                            useOrderBy = false;
                            fetchSucceeded = true;
                        } catch(simpleError) {
                            console.error('Simple query also failed:', simpleError);
                            let errorMsg = 'Error loading tasks. ';
                            if(simpleError.code === 'permission-denied') {
                                errorMsg += 'Permission denied. Please check Firestore security rules.';
                            } else {
                                errorMsg += simpleError.message || 'Unknown error';
                            }
                            list.innerHTML = `
                                <div style="padding: 20px; color: var(--danger); text-align: center;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>${errorMsg}</p>
                                    <button class="btn btn-sm" onclick="loadTasks()" style="margin-top: 10px;">Retry</button>
                                </div>
                            `;
                            return; // Don't set up listener if fetch failed
                        }
                    } else {
                        // Show error and return
                        let errorMsg = 'Error loading tasks. ';
                        if(fetchError.code === 'permission-denied') {
                            errorMsg += 'Permission denied. Please check Firestore security rules.';
                        } else if(fetchError.code === 'failed-precondition') {
                            errorMsg += 'Firestore index required. Please create a composite index.';
                        } else {
                            errorMsg += fetchError.message || 'Unknown error';
                        }
                        list.innerHTML = `
                            <div style="padding: 20px; color: var(--danger); text-align: center;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>${errorMsg}</p>
                                <button class="btn btn-sm" onclick="loadTasks()" style="margin-top: 10px;">Retry</button>
                            </div>
                        `;
                        return; // Don't set up listener if fetch failed
                    }
                }
                
                // Only set up listener if fetch succeeded
                if(!fetchSucceeded) return;
                
                // Now set up real-time listener for live updates
                console.log('Setting up real-time listener for tasks');
                taskUnsubscriber = onSnapshot(tasksQuery, (snapshot) => {
                    console.log('Tasks listener triggered, received', snapshot.size, 'tasks');
                    const tasks = [];
                    snapshot.forEach(doc => {
                        const taskData = doc.data();
                        console.log('Listener task:', doc.id, taskData);
                        tasks.push({ id: doc.id, ...taskData });
                    });
                    
                    // Sort by createdAt in memory if we used fallback query
                    if(!useOrderBy) {
                        tasks.sort((a, b) => {
                            const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                            const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                            return timeB - timeA; // Descending order
                        });
                    }
                    
                    console.log('Rendering', tasks.length, 'tasks from listener');
                    renderTasksList(tasks, list);
                }, (error) => {
                    console.error('Tasks listener error:', error);
                    console.error('Error in tasks listener:', error);
                    // Don't show error if it's just an index issue and we already have data
                    if(error.code === 'failed-precondition' && list.innerHTML && !list.innerHTML.includes('Error')) {
                        console.log('Listener failed but we have cached data');
                        return;
                    }
                    
                    let errorMsg = 'Error loading tasks. ';
                    if(error.code === 'failed-precondition') {
                        errorMsg += 'Firestore index required. Please create a composite index for tasks collection.';
                    } else if(error.code === 'permission-denied') {
                        errorMsg += 'Permission denied. Please check Firestore security rules.';
                    } else {
                        errorMsg += error.message || 'Unknown error';
                    }
                    
                    list.innerHTML = `
                        <div style="padding: 20px; color: var(--danger); text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>${errorMsg}</p>
                            <button class="btn btn-sm" onclick="loadTasks()" style="margin-top: 10px;">Retry</button>
                        </div>
                    `;
                });
            } catch(e) {
                console.error('Error setting up tasks:', e);
                list.innerHTML = `
                    <div style="padding: 20px; color: var(--danger); text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading tasks: ${e.message || 'Unknown error'}</p>
                        <button class="btn btn-sm" onclick="loadTasks()" style="margin-top: 10px;">Retry</button>
                    </div>
                `;
            }
        };

        window.toggleTaskComplete = async function(taskId, completed) {
            if(!db) return;
            try {
                await updateDoc(doc(db, "tasks", taskId), {
                    completed: completed,
                    completedAt: completed ? new Date().toISOString() : null
                });
                loadTasks();
            } catch(e) {
                console.error('Error updating task:', e);
            }
        };

        // --- NOTES MANAGEMENT (Counselor) ---
        window.openNoteModal = function() {
            if(!currentStudentId) {
                alert('Please select a student first');
                return;
            }
            document.getElementById('note-modal').classList.add('active');
        };

        window.closeNoteModal = function() {
            document.getElementById('note-modal').classList.remove('active');
            document.getElementById('note-content').value = '';
            document.getElementById('note-tags').value = '';
        };

        window.saveNote = async function() {
            if(!currentStudentId || !db) {
                alert('No student selected or database not available');
                console.error('Cannot save note: currentStudentId =', currentStudentId, 'db =', db);
                return;
            }
            
            console.log('saveNote called with currentStudentId:', currentStudentId);
            
            const content = document.getElementById('note-content').value;
            const tagsInput = document.getElementById('note-tags').value;
            
            if(!content) {
                alert('Please enter note content');
                return;
            }
            
            try {
                const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
                
                const noteData = {
                    studentId: String(currentStudentId), // Ensure it's a string
                    content: content,
                    tags: tags,
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser.uid
                };
                
                console.log('Saving note with data:', noteData);
                const noteRef = await addDoc(collection(db, "notes"), noteData);
                console.log('Note saved successfully with ID:', noteRef.id);
                console.log('Note studentId:', noteData.studentId, 'Type:', typeof noteData.studentId);
                
                // Clear form
                document.getElementById('note-content').value = '';
                document.getElementById('note-tags').value = '';
                
                closeNoteModal();
                
                // Switch to notes tab if not already there
                const notesTab = document.querySelector('.coun-tab[onclick*="notes"]');
                const notesContent = document.getElementById('tab-notes');
                if(notesTab && notesContent) {
                    // Switch to notes tab
                    switchCounselorTab('notes');
                }
                
                // Reload notes (real-time listener will pick it up automatically, but ensure it's loaded)
                // Give it a moment for the tab to become visible
                setTimeout(() => {
                    loadNotes();
                    console.log('Notes reloaded after creation');
                }, 500);
                
                alert('Note saved successfully!');
            } catch(e) {
                console.error('Error saving note:', e);
                let errorMsg = 'Error saving note. ';
                if(e.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Please check Firestore security rules.';
                } else {
                    errorMsg += e.message || 'Unknown error';
                }
                alert(errorMsg);
            }
        };

        // Store notes listener to unsubscribe when needed
        let notesUnsubscriber = null;
        
        // Helper function to render notes
        function renderNotesList(notes, listElement) {
            if(!listElement) return;
            
            if(notes.length === 0) {
                listElement.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No notes added yet</p>';
                return;
            }
            
            listElement.innerHTML = notes.map(note => {
                const date = new Date(note.createdAt).toLocaleString();
                const tagsHtml = note.tags && note.tags.length > 0 ? 
                    `<div class="note-tags">${note.tags.map(tag => `<span class="note-tag">${tag}</span>`).join('')}</div>` : '';
                
                return `
                    <div class="note-item">
                        <div class="note-header">
                            <div class="note-date">${date}</div>
                        </div>
                        <div>${note.content}</div>
                        ${tagsHtml}
                    </div>
                `;
            }).join('');
        }
        
        window.loadNotes = async function() {
            if(!currentStudentId || !db) {
                const list = document.getElementById('notes-list');
                if(list) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No student selected</p>';
                }
                return;
            }
            
            const list = document.getElementById('notes-list');
            if(!list) {
                console.error('Notes list element not found');
                return;
            }
            
            // Unsubscribe from previous listener
            if(notesUnsubscriber) {
                notesUnsubscriber();
                notesUnsubscriber = null;
            }
            
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading notes...</div>';
            
            try {
                // Ensure studentId is a string for consistent querying
                const studentIdStr = String(currentStudentId);
                console.log('Loading notes for studentId:', studentIdStr);
                
                // First, try a one-time query to get notes immediately
                let notesQuery;
                let useOrderBy = true;
                
                try {
                    notesQuery = query(
                        collection(db, "notes"),
                        where("studentId", "==", studentIdStr),
                        orderBy("createdAt", "desc")
                    );
                } catch(queryError) {
                    // If orderBy fails, use simple query without orderBy
                    console.log('OrderBy not available for notes, using simple query');
                    useOrderBy = false;
                    notesQuery = query(
                        collection(db, "notes"),
                        where("studentId", "==", studentIdStr)
                    );
                }
                
                // Do a one-time fetch first for immediate display
                let fetchSucceeded = false;
                try {
                    console.log('Fetching notes for studentId:', studentIdStr);
                    const snapshot = await getDocs(notesQuery);
                    console.log('Notes query returned', snapshot.size, 'documents');
                    const notes = [];
                    snapshot.forEach(doc => {
                        const noteData = doc.data();
                        console.log('Note found:', doc.id, noteData);
                        notes.push({ id: doc.id, ...noteData });
                    });
                    
                    // Sort by createdAt in memory if we used fallback query
                    if(!useOrderBy) {
                        notes.sort((a, b) => {
                            const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                            const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                            return timeB - timeA; // Descending order
                        });
                    }
                    
                    console.log('Rendering', notes.length, 'notes');
                    renderNotesList(notes, list);
                    fetchSucceeded = true;
                } catch(fetchError) {
                    console.error('Error fetching notes:', fetchError);
                    console.error('Error details:', {
                        code: fetchError.code,
                        message: fetchError.message,
                        studentId: studentIdStr
                    });
                    
                    // If orderBy query failed, try without orderBy
                    if(useOrderBy && (fetchError.code === 'failed-precondition' || fetchError.code === 'permission-denied')) {
                        console.log('Retrying with simple query (no orderBy)');
                        try {
                            const simpleQuery = query(
                                collection(db, "notes"),
                                where("studentId", "==", studentIdStr)
                            );
                            const simpleSnapshot = await getDocs(simpleQuery);
                            const notes = [];
                            simpleSnapshot.forEach(doc => {
                                notes.push({ id: doc.id, ...doc.data() });
                            });
                            notes.sort((a, b) => {
                                const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                                const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                                return timeB - timeA;
                            });
                            renderNotesList(notes, list);
                            notesQuery = simpleQuery; // Use simple query for listener too
                            useOrderBy = false;
                            fetchSucceeded = true;
                        } catch(simpleError) {
                            console.error('Simple query also failed:', simpleError);
                            let errorMsg = 'Error loading notes. ';
                            if(simpleError.code === 'permission-denied') {
                                errorMsg += 'Permission denied. Please check Firestore security rules.';
                            } else {
                                errorMsg += simpleError.message || 'Unknown error';
                            }
                            list.innerHTML = `
                                <div style="padding: 20px; color: var(--danger); text-align: center;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>${errorMsg}</p>
                                    <button class="btn btn-sm" onclick="loadNotes()" style="margin-top: 10px;">Retry</button>
                                </div>
                            `;
                            return; // Don't set up listener if fetch failed
                        }
                    } else {
                        // Show error and return
                        let errorMsg = 'Error loading notes. ';
                        if(fetchError.code === 'permission-denied') {
                            errorMsg += 'Permission denied. Please check Firestore security rules.';
                        } else if(fetchError.code === 'failed-precondition') {
                            errorMsg += 'Firestore index required. Please create a composite index.';
                        } else {
                            errorMsg += fetchError.message || 'Unknown error';
                        }
                        list.innerHTML = `
                            <div style="padding: 20px; color: var(--danger); text-align: center;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>${errorMsg}</p>
                                <button class="btn btn-sm" onclick="loadNotes()" style="margin-top: 10px;">Retry</button>
                            </div>
                        `;
                        return; // Don't set up listener if fetch failed
                    }
                }
                
                // Only set up listener if fetch succeeded
                if(!fetchSucceeded) return;
                
                // Now set up real-time listener for live updates
                console.log('Setting up real-time listener for notes');
                notesUnsubscriber = onSnapshot(notesQuery, (snapshot) => {
                    console.log('Notes listener triggered, received', snapshot.size, 'notes');
                    const notes = [];
                    snapshot.forEach(doc => {
                        const noteData = doc.data();
                        console.log('Listener note:', doc.id, noteData);
                        notes.push({ id: doc.id, ...noteData });
                    });
                    
                    // Sort by createdAt in memory if we used fallback query
                    if(!useOrderBy) {
                        notes.sort((a, b) => {
                            const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                            const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                            return timeB - timeA; // Descending order
                        });
                    }
                    
                    console.log('Rendering', notes.length, 'notes from listener');
                    renderNotesList(notes, list);
                }, (error) => {
                    console.error('Notes listener error:', error);
                    // Don't show error if it's just an index issue and we already have data
                    if(error.code === 'failed-precondition' && list.innerHTML && !list.innerHTML.includes('Error')) {
                        console.log('Listener failed but we have cached data');
                        return;
                    }
                    
                    let errorMsg = 'Error loading notes. ';
                    if(error.code === 'failed-precondition') {
                        errorMsg += 'Firestore index required. Please create a composite index for notes collection.';
                    } else if(error.code === 'permission-denied') {
                        errorMsg += 'Permission denied. Please check Firestore security rules.';
                    } else {
                        errorMsg += error.message || 'Unknown error';
                    }
                    
                    list.innerHTML = `
                        <div style="padding: 20px; color: var(--danger); text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>${errorMsg}</p>
                            <button class="btn btn-sm" onclick="loadNotes()" style="margin-top: 10px;">Retry</button>
                        </div>
                    `;
                });
            } catch(e) {
                console.error('Error setting up notes:', e);
                list.innerHTML = `
                    <div style="padding: 20px; color: var(--danger); text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading notes: ${e.message || 'Unknown error'}</p>
                        <button class="btn btn-sm" onclick="loadNotes()" style="margin-top: 10px;">Retry</button>
                    </div>
                `;
            }
        };

        // --- APPOINTMENT MANAGEMENT ---
        window.openAppointmentModal = function() {
            if(!currentStudentId) {
                alert('Please select a student first');
                return;
            }
            document.getElementById('appointment-modal').classList.add('active');
        };

        window.closeAppointmentModal = function() {
            document.getElementById('appointment-modal').classList.remove('active');
            document.getElementById('appointment-date').value = '';
            document.getElementById('appointment-time').value = '';
            document.getElementById('appointment-duration').value = '30';
            document.getElementById('appointment-type').value = 'in-person';
            document.getElementById('appointment-notes').value = '';
        };

        window.saveAppointment = async function() {
            if(!currentStudentId || !db) {
                alert('No student selected or database not available');
                console.error('Cannot save appointment: currentStudentId =', currentStudentId, 'db =', db);
                return;
            }
            
            console.log('saveAppointment called with currentStudentId:', currentStudentId);
            
            const date = document.getElementById('appointment-date').value;
            const time = document.getElementById('appointment-time').value;
            const duration = document.getElementById('appointment-duration').value;
            const type = document.getElementById('appointment-type').value;
            const notes = document.getElementById('appointment-notes').value;
            
            if(!date || !time) {
                alert('Please fill in date and time');
                return;
            }
            
            try {
                const appointmentData = {
                    studentId: String(currentStudentId), // Ensure it's a string
                    date: date,
                    time: time,
                    duration: parseInt(duration) || 30,
                    type: type,
                    notes: notes || '',
                    status: 'scheduled',
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser.uid
                };
                
                console.log('Saving appointment with data:', appointmentData);
                const appointmentRef = await addDoc(collection(db, "appointments"), appointmentData);
                console.log('Appointment saved successfully with ID:', appointmentRef.id);
                console.log('Appointment studentId:', appointmentData.studentId, 'Type:', typeof appointmentData.studentId);
                
                // Clear form
                document.getElementById('appointment-date').value = '';
                document.getElementById('appointment-time').value = '';
                document.getElementById('appointment-duration').value = '30';
                document.getElementById('appointment-type').value = 'consultation';
                document.getElementById('appointment-notes').value = '';
                
                closeAppointmentModal();
                
                // Switch to appointments tab if not already there
                const appointmentsTab = document.querySelector('.coun-tab[onclick*="appointments"]');
                const appointmentsContent = document.getElementById('tab-appointments');
                if(appointmentsTab && appointmentsContent) {
                    // Switch to appointments tab
                    switchCounselorTab('appointments');
                }
                
                // Reload appointments (real-time listener will pick it up automatically, but ensure it's loaded)
                // Give it a moment for the tab to become visible
                setTimeout(() => {
                    loadAppointments();
                    console.log('Appointments reloaded after creation');
                }, 500);
                
                alert('Appointment scheduled successfully!');
            } catch(e) {
                console.error('Error saving appointment:', e);
                let errorMsg = 'Error saving appointment. ';
                if(e.code === 'permission-denied') {
                    errorMsg += 'Permission denied. Please check Firestore security rules.';
                } else {
                    errorMsg += e.message || 'Unknown error';
                }
                alert(errorMsg);
            }
        };

        // Store appointments listener to unsubscribe when needed
        let appointmentsUnsubscriber = null;
        
        // Helper function to render appointments
        function renderAppointmentsList(appointments, listElement) {
            if(!listElement) return;
            
            if(appointments.length === 0) {
                listElement.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No appointments scheduled</p>';
                return;
            }
            
            listElement.innerHTML = appointments.map(apt => {
                const date = new Date(apt.date).toLocaleDateString();
                return `
                    <div class="appointment-card">
                        <div class="appointment-time">
                            <i class="fas fa-calendar"></i> ${date} at ${apt.time}
                        </div>
                        <div style="margin-top: 8px;">
                            <strong>${apt.type.charAt(0).toUpperCase() + apt.type.slice(1)}</strong>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Duration: ${apt.duration} minutes</div>
                            ${apt.notes ? `<div style="font-size: 0.85rem; color: #666; margin-top: 5px;">${apt.notes}</div>` : ''}
                        </div>
                        <span class="appointment-status ${apt.status}">${apt.status.charAt(0).toUpperCase() + apt.status.slice(1)}</span>
                    </div>
                `;
            }).join('');
        }
        
        window.loadAppointments = async function() {
            if(!currentStudentId || !db) {
                const list = document.getElementById('appointments-list');
                if(list) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No student selected</p>';
                }
                return;
            }
            
            const list = document.getElementById('appointments-list');
            if(!list) {
                console.error('Appointments list element not found');
                return;
            }
            
            // Unsubscribe from previous listener
            if(appointmentsUnsubscriber) {
                appointmentsUnsubscriber();
                appointmentsUnsubscriber = null;
            }
            
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading appointments...</div>';
            
            try {
                // Ensure studentId is a string for consistent querying
                const studentIdStr = String(currentStudentId);
                console.log('Loading appointments for studentId:', studentIdStr);
                
                // First, try a one-time query to get appointments immediately
                let appointmentsQuery;
                let useOrderBy = true;
                
                try {
                    appointmentsQuery = query(
                        collection(db, "appointments"),
                        where("studentId", "==", studentIdStr),
                        orderBy("date", "desc")
                    );
                } catch(queryError) {
                    // If orderBy fails, use simple query without orderBy
                    console.log('OrderBy not available for appointments, using simple query');
                    useOrderBy = false;
                    appointmentsQuery = query(
                        collection(db, "appointments"),
                        where("studentId", "==", studentIdStr)
                    );
                }
                
                // Do a one-time fetch first for immediate display
                let fetchSucceeded = false;
                try {
                    console.log('Fetching appointments for studentId:', studentIdStr);
                    const snapshot = await getDocs(appointmentsQuery);
                    console.log('Appointments query returned', snapshot.size, 'documents');
                    const appointments = [];
                    snapshot.forEach(doc => {
                        const aptData = doc.data();
                        console.log('Appointment found:', doc.id, aptData);
                        appointments.push({ id: doc.id, ...aptData });
                    });
                    
                    // Sort by date in memory if we used fallback query
                    if(!useOrderBy) {
                        appointments.sort((a, b) => {
                            const timeA = a.date ? new Date(a.date).getTime() : 0;
                            const timeB = b.date ? new Date(b.date).getTime() : 0;
                            return timeB - timeA; // Descending order
                        });
                    }
                    
                    console.log('Rendering', appointments.length, 'appointments');
                    renderAppointmentsList(appointments, list);
                    fetchSucceeded = true;
                } catch(fetchError) {
                    console.error('Error fetching appointments:', fetchError);
                    console.error('Error details:', {
                        code: fetchError.code,
                        message: fetchError.message,
                        studentId: studentIdStr
                    });
                    
                    // If orderBy query failed, try without orderBy
                    if(useOrderBy && (fetchError.code === 'failed-precondition' || fetchError.code === 'permission-denied')) {
                        console.log('Retrying with simple query (no orderBy)');
                        try {
                            const simpleQuery = query(
                                collection(db, "appointments"),
                                where("studentId", "==", studentIdStr)
                            );
                            const simpleSnapshot = await getDocs(simpleQuery);
                            const appointments = [];
                            simpleSnapshot.forEach(doc => {
                                appointments.push({ id: doc.id, ...doc.data() });
                            });
                            appointments.sort((a, b) => {
                                const timeA = a.date ? new Date(a.date).getTime() : 0;
                                const timeB = b.date ? new Date(b.date).getTime() : 0;
                                return timeB - timeA;
                            });
                            renderAppointmentsList(appointments, list);
                            appointmentsQuery = simpleQuery; // Use simple query for listener too
                            useOrderBy = false;
                            fetchSucceeded = true;
                        } catch(simpleError) {
                            console.error('Simple query also failed:', simpleError);
                            let errorMsg = 'Error loading appointments. ';
                            if(simpleError.code === 'permission-denied') {
                                errorMsg += 'Permission denied. Please check Firestore security rules.';
                            } else {
                                errorMsg += simpleError.message || 'Unknown error';
                            }
                            list.innerHTML = `
                                <div style="padding: 20px; color: var(--danger); text-align: center;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>${errorMsg}</p>
                                    <button class="btn btn-sm" onclick="loadAppointments()" style="margin-top: 10px;">Retry</button>
                                </div>
                            `;
                            return; // Don't set up listener if fetch failed
                        }
                    } else {
                        // Show error and return
                        let errorMsg = 'Error loading appointments. ';
                        if(fetchError.code === 'permission-denied') {
                            errorMsg += 'Permission denied. Please check Firestore security rules.';
                        } else if(fetchError.code === 'failed-precondition') {
                            errorMsg += 'Firestore index required. Please create a composite index.';
                        } else {
                            errorMsg += fetchError.message || 'Unknown error';
                        }
                        list.innerHTML = `
                            <div style="padding: 20px; color: var(--danger); text-align: center;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>${errorMsg}</p>
                                <button class="btn btn-sm" onclick="loadAppointments()" style="margin-top: 10px;">Retry</button>
                            </div>
                        `;
                        return; // Don't set up listener if fetch failed
                    }
                }
                
                // Only set up listener if fetch succeeded
                if(!fetchSucceeded) return;
                
                // Now set up real-time listener for live updates
                console.log('Setting up real-time listener for appointments');
                appointmentsUnsubscriber = onSnapshot(appointmentsQuery, (snapshot) => {
                    console.log('Appointments listener triggered, received', snapshot.size, 'appointments');
                    const appointments = [];
                    snapshot.forEach(doc => {
                        const aptData = doc.data();
                        console.log('Listener appointment:', doc.id, aptData);
                        appointments.push({ id: doc.id, ...aptData });
                    });
                    
                    // Sort by date in memory if we used fallback query
                    if(!useOrderBy) {
                        appointments.sort((a, b) => {
                            const timeA = a.date ? new Date(a.date).getTime() : 0;
                            const timeB = b.date ? new Date(b.date).getTime() : 0;
                            return timeB - timeA;
                        });
                    }
                    
                    console.log('Rendering', appointments.length, 'appointments from listener');
                    renderAppointmentsList(appointments, list);
                }, (error) => {
                    console.error('Appointments listener error:', error);
                    // Don't show error if it's just an index issue and we already have data
                    if(error.code === 'failed-precondition' && list.innerHTML && !list.innerHTML.includes('Error')) {
                        console.log('Listener failed but we have cached data');
                        return;
                    }
                    
                    let errorMsg = 'Error loading appointments. ';
                    if(error.code === 'failed-precondition') {
                        errorMsg += 'Firestore index required. Please create a composite index for appointments collection.';
                    } else if(error.code === 'permission-denied') {
                        errorMsg += 'Permission denied. Please check Firestore security rules.';
                    } else {
                        errorMsg += error.message || 'Unknown error';
                    }
                    
                    list.innerHTML = `
                        <div style="padding: 20px; color: var(--danger); text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>${errorMsg}</p>
                            <button class="btn btn-sm" onclick="loadAppointments()" style="margin-top: 10px;">Retry</button>
                        </div>
                    `;
                });
            } catch(e) {
                console.error('Error setting up appointments:', e);
                list.innerHTML = `
                    <div style="padding: 20px; color: var(--danger); text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading appointments: ${e.message || 'Unknown error'}</p>
                        <button class="btn btn-sm" onclick="loadAppointments()" style="margin-top: 10px;">Retry</button>
                    </div>
                `;
            }
        };

        // --- STUDENT TIMELINE ---
        window.loadStudentTimeline = async function() {
            if(!currentStudentId || !db) return;
            
            try {
                const studentDoc = await getDoc(doc(db, "users", currentStudentId));
                if(!studentDoc.exists()) return;
                
                const studentData = studentDoc.data();
                const timeline = [];
                
                // Add milestones
                if(studentData.milestone) {
                    timeline.push({
                        date: studentData.updatedAt || new Date().toISOString(),
                        title: studentData.milestone,
                        type: 'milestone'
                    });
                }
                
                // Add application submission
                if(studentData.status === 'Submitted') {
                    timeline.push({
                        date: studentData.updatedAt || new Date().toISOString(),
                        title: 'Application Submitted',
                        type: 'submission'
                    });
                }
                
                // Sort by date
                timeline.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const timelineDiv = document.getElementById('student-timeline');
                if(timeline.length === 0) {
                    timelineDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Timeline will appear here</p>';
                    return;
                }
                
                timelineDiv.innerHTML = timeline.map((item, index) => {
                    const date = new Date(item.date).toLocaleDateString();
                    const isActive = index === 0;
                    const isCompleted = index > 0;
                    
                    return `
                        <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div style="font-weight: 600; margin-bottom: 5px;">${item.title}</div>
                                <div style="font-size: 0.85rem; color: #666;">${date}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch(e) {
                console.error('Error loading timeline:', e);
            }
        };


        // Load data when student dashboard loads
        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if(user && window.currentRole === 'student') {
                    setTimeout(() => {
                        loadTestScores();
                        loadPayments();
                        loadDocumentChecklist();
                        loadNotifications();
                    }, 1000);
                }
            });
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if(e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });

        // Close notification panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notification-panel');
            const bell = document.querySelector('.notification-bell');
            if(panel && !panel.contains(e.target) && !bell.contains(e.target)) {
                panel.classList.remove('active');
            }
        });

        // ========== STUDENT DASHBOARD MODAL FUNCTIONS ==========

        // --- CHAT MODAL ---
        window.openChatModal = function() {
            const modal = document.getElementById('chat-modal');
            modal.classList.add('active');
            // Load chat when modal opens
            setTimeout(() => {
                loadStudentChatModal();
            }, 100);
        };

        window.closeChatModal = function() {
            document.getElementById('chat-modal').classList.remove('active');
        };

        function loadStudentChatModal() {
            const chatBox = document.getElementById('stu-chat-box-modal');
            if(!chatBox || !auth || !auth.currentUser) return;
            
            chatBox.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
            
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const studentId = auth.currentUser.uid;
                    
                    getDoc(doc(db, "users", studentId)).then(userDoc => {
                        if(!userDoc.exists()) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No counselor assigned yet. Please contact support.
                                </div>
                            `;
                            return;
                        }
                        
                        const userData = userDoc.data();
                        const counselorId = userData.counselorId;
                        
                        if(!counselorId) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No counselor assigned yet. A counselor will be assigned to you soon!
                                </div>
                            `;
                            return;
                        }
                        
                        const messagesQuery = query(
                            collection(db, "messages"),
                            where("studentId", "==", studentId)
                        );
                        
                        const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                            chatBox.innerHTML = '';
                            
                            let messages = [];
                            snapshot.forEach(doc => {
                                const msg = doc.data();
                                if(!msg.counselorId || msg.counselorId === counselorId) {
                                    messages.push({ id: doc.id, ...msg });
                                }
                            });
                            
                            messages.sort((a, b) => {
                                const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                                const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                                return timeA - timeB;
                            });
                            
                            if(messages.length === 0) {
                                chatBox.innerHTML = `
                                    <div class="message msg-in">
                                        <strong>System:</strong> No previous messages. Start a conversation with your counselor!
                                    </div>
                                `;
                            } else {
                                messages.forEach(msg => {
                                    const msgDiv = document.createElement('div');
                                    const isStudent = msg.sender === 'student' || msg.senderId === studentId;
                                    msgDiv.className = isStudent ? 'message msg-out' : 'message msg-in';
                                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                    msgDiv.innerHTML = `
                                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${isStudent ? 'You' : 'Your Counselor'}</div>
                                        <div style="margin-bottom: 4px;">${msg.text || ''}</div>
                                        <div style="font-size: 0.75rem; opacity: 0.7; ${isStudent ? 'text-align: right;' : ''}">${time}</div>
                                    `;
                                    chatBox.appendChild(msgDiv);
                                });
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }
                        }, (error) => {
                            console.error("Error loading chat:", error);
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> Error loading messages. Please try again.
                                </div>
                            `;
                        });
                    }).catch(e => {
                        console.error("Error getting student data:", e);
                        chatBox.innerHTML = `
                            <div class="message msg-in">
                                <strong>System:</strong> Error loading chat. Please try again.
                            </div>
                        `;
                    });
                } catch(e) {
                    console.error("Error setting up chat:", e);
                    chatBox.innerHTML = `
                        <div class="message msg-in">
                            <strong>System:</strong> Error setting up chat. Please refresh the page.
                        </div>
                    `;
                }
            } else {
                chatBox.innerHTML = `
                    <div class="message msg-in">
                        <strong>System:</strong> Start a conversation! Chat messages will be saved when authenticated.
                    </div>
                `;
            }
        }

        window.sendMessageFromModal = async function(role) {
            const input = document.getElementById('stu-chat-input-modal');
            const messageText = input.value.trim();
            if(!messageText) return;
            
            const chatBox = document.getElementById('stu-chat-box-modal');
            
            // Add message to UI immediately
            const div = document.createElement('div');
            div.className = 'message msg-out';
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            div.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">You</div>
                <div style="margin-bottom: 4px;">${messageText}</div>
                <div style="font-size: 0.75rem; opacity: 0.7; text-align: right;">${timestamp}</div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // Save to Firebase
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const studentId = auth.currentUser.uid;
                    const userDoc = await getDoc(doc(db, "users", studentId));
                    if(!userDoc.exists()) {
                        alert("Your profile is not set up. Please complete your application first.");
                        div.remove();
                        input.value = messageText;
                        return;
                    }
                    
                    const userData = userDoc.data();
                    const counselorId = userData.counselorId || null;
                    
                    if(!counselorId) {
                        showInfo("You don't have a counselor assigned yet. A counselor will be assigned to you soon!");
                        div.remove();
                        input.value = messageText;
                        return;
                    }
                    
                    const messageData = {
                        text: messageText,
                        sender: 'student',
                        senderId: studentId,
                        studentId: studentId,
                        counselorId: counselorId,
                        timestamp: new Date().toISOString(),
                        read: false
                    };
                    
                    await addDoc(collection(db, "messages"), messageData);
                    input.value = '';
                } catch(e) {
                    console.error("Error saving message:", e);
                    alert("Failed to send message. Please try again.");
                    div.remove();
                    input.value = messageText;
                }
            } else {
                input.value = '';
            }
        };

        // --- STATUS TRACKER MODAL ---
        window.openStatusTrackerModal = function() {
            const modal = document.getElementById('status-tracker-modal');
            modal.classList.add('active');
            loadStatusTracker();
        };

        window.closeStatusTrackerModal = function() {
            document.getElementById('status-tracker-modal').classList.remove('active');
        };

        function loadStatusTracker() {
            if(!auth || !auth.currentUser || !db) return;
            
            getDoc(doc(db, "users", auth.currentUser.uid)).then(userDoc => {
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const status = userData.status || 'Draft';
                const milestone = userData.milestone || null;
                
                // Update status steps based on current status
                const steps = document.querySelectorAll('#status-tracker-modal-content .status-step');
                steps.forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if(index === 0 && status === 'Submitted') {
                        step.classList.add('completed');
                    } else if(index === 1 && status === 'Submitted') {
                        step.classList.add('active');
                    } else if(index === 2 && milestone && milestone.includes('Offer')) {
                        step.classList.add('completed');
                        if(milestone.includes('Approved')) {
                            steps[3].classList.add('active');
                        }
                    } else if(index === 4 && milestone === 'Visa Approved') {
                        step.classList.add('completed');
                    }
                });
                
                // Update details
                let details = "Your application is currently under review. We'll update you as soon as there are any changes.";
                if(milestone) {
                    details = `Current milestone: ${milestone}. Your counselor is working on your application.`;
                }
                document.getElementById('status-tracker-details').textContent = details;
            }).catch(e => console.error('Error loading status:', e));
        }

        // --- DOCUMENT CHECKLIST MODAL ---
        window.openDocumentChecklistModal = function() {
            const modal = document.getElementById('document-checklist-modal');
            modal.classList.add('active');
            loadDocumentChecklistModal();
        };

        window.closeDocumentChecklistModal = function() {
            document.getElementById('document-checklist-modal').classList.remove('active');
        };

        function loadDocumentChecklistModal() {
            if(!auth || !auth.currentUser || !db) return;
            
            getDoc(doc(db, "users", auth.currentUser.uid)).then(userDoc => {
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const docs = userData.docs || [];
                
                // Map document types as stored in database to checklist IDs
                const typeMapping = {
                    'Passport': 'passport',
                    'Transcript': 'transcript',
                    'IELTS/PTE': 'ielts',
                    'Financial': 'financial',
                    'SOP': 'sop',
                    'Other': 'other',
                    'Recommendation': 'recommendation',
                    'CV': 'cv',
                    'Resume': 'cv'
                };
                
                const checklist = [
                    { id: 'passport', label: 'Passport (Front & Back)', required: true, types: ['Passport'] },
                    { id: 'transcript', label: 'Academic Transcripts', required: true, types: ['Transcript'] },
                    { id: 'ielts', label: 'IELTS/PTE Score Card', required: true, types: ['IELTS/PTE'] },
                    { id: 'financial', label: 'Financial Documents', required: true, types: ['Financial'] },
                    { id: 'sop', label: 'Statement of Purpose', required: false, types: ['SOP'] },
                    { id: 'recommendation', label: 'Recommendation Letters', required: false, types: ['Recommendation'] },
                    { id: 'cv', label: 'CV/Resume', required: false, types: ['CV', 'Resume'] },
                    { id: 'other', label: 'Other Documents', required: false, types: ['Other'] }
                ];
                
                const completed = checklist.filter(item => {
                    return docs.some(doc => {
                        // Check if document type matches any of the mapped types for this checklist item
                        return item.types.some(type => doc.type === type || doc.type?.toLowerCase() === type.toLowerCase());
                    });
                }).length;
                
                const total = checklist.length;
                const percentage = Math.round((completed / total) * 100);
                
                document.getElementById('checklist-progress-bar-modal').style.width = percentage + '%';
                document.getElementById('checklist-completed-modal').textContent = completed;
                document.getElementById('checklist-total-modal').textContent = total;
                document.getElementById('checklist-percentage-modal').textContent = percentage + '%';
                
                const checklistDiv = document.getElementById('document-checklist-modal-content');
                checklistDiv.innerHTML = checklist.map(item => {
                    const isCompleted = docs.some(doc => {
                        // Check if document type matches any of the mapped types for this checklist item
                        return item.types.some(type => doc.type === type || doc.type?.toLowerCase() === type.toLowerCase());
                    });
                    return `
                        <div class="checklist-item ${isCompleted ? 'completed' : ''}">
                            <input type="checkbox" class="checklist-checkbox" ${isCompleted ? 'checked' : ''} disabled>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${item.label} ${item.required ? '<span style="color: var(--danger);">*</span>' : ''}</div>
                                ${isCompleted ? '<div style="font-size: 0.8rem; color: var(--success); margin-top: 3px;"><i class="fas fa-check"></i> Uploaded</div>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }).catch(e => console.error('Error loading checklist:', e));
        }

        // --- TEST SCORES MODAL ---
        window.openTestScoresModal = function() {
            const modal = document.getElementById('test-scores-modal');
            modal.classList.add('active');
            loadTestScoresModal();
        };

        window.closeTestScoresModal = function() {
            document.getElementById('test-scores-modal').classList.remove('active');
        };

        function loadTestScoresModal() {
            if(!auth || !auth.currentUser || !db) return;
            
            getDoc(doc(db, "users", auth.currentUser.uid)).then(userDoc => {
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const testScores = userData.testScores || [];
                
                const list = document.getElementById('test-scores-list-modal');
                if(testScores.length === 0) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No test scores added yet. Click "Add Score" to get started.</p>';
                    return;
                }
                
                list.innerHTML = testScores.map((score, index) => {
                    const expiryDate = score.expiryDate ? new Date(score.expiryDate) : null;
                    const today = new Date();
                    let expiryClass = 'valid';
                    let expiryText = 'Valid';
                    
                    if(expiryDate) {
                        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                        if(daysUntilExpiry < 0) {
                            expiryClass = 'expired';
                            expiryText = 'Expired';
                        } else if(daysUntilExpiry < 30) {
                            expiryClass = 'expiring';
                            expiryText = `Expires in ${daysUntilExpiry} days`;
                        } else {
                            expiryText = `Expires ${expiryDate.toLocaleDateString()}`;
                        }
                    }
                    
                    return `
                        <div class="test-score-card">
                            <div class="test-score-header">
                                <div>
                                    <strong>${score.testType}</strong>
                                    <div style="font-size: 1.2rem; color: var(--primary); margin-top: 5px;">Score: ${score.score}</div>
                                </div>
                                <span class="score-expiry ${expiryClass}">${expiryText}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 10px;">
                                Test Date: ${new Date(score.testDate).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                }).join('');
            }).catch(e => console.error('Error loading test scores:', e));
        }

        // Update openTestScoreModal to close test scores modal first
        const originalOpenTestScore = window.openTestScoreModal;
        window.openTestScoreModal = function() {
            closeTestScoresModal();
            if(originalOpenTestScore) originalOpenTestScore();
        };

        // --- PAYMENTS MODAL ---
        window.openPaymentsModal = function() {
            const modal = document.getElementById('payments-modal');
            modal.classList.add('active');
            loadPaymentsModal();
        };

        window.closePaymentsModal = function() {
            document.getElementById('payments-modal').classList.remove('active');
        };

        function loadPaymentsModal() {
            if(!auth || !auth.currentUser || !db) return;
            
            getDoc(doc(db, "users", auth.currentUser.uid)).then(userDoc => {
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                const payments = userData.payments || [];
                
                const list = document.getElementById('payments-list-modal');
                if(payments.length === 0) {
                    list.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No payments recorded yet. Click "Add Payment" to get started.</p>';
                    return;
                }
                
                const totalPaid = payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + (p.amount || 0), 0);
                const totalPending = payments.filter(p => p.status === 'pending').reduce((sum, p) => sum + (p.amount || 0), 0);
                
                list.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #d1e7dd; padding: 15px; border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: #0f5132; margin-bottom: 5px;">Total Paid</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #0f5132;">$${totalPaid.toFixed(2)}</div>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: #856404; margin-bottom: 5px;">Total Pending</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: #856404;">$${totalPending.toFixed(2)}</div>
                        </div>
                    </div>
                    ${payments.map(payment => `
                        <div class="payment-card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <strong>${payment.type}</strong>
                                    <div class="payment-amount">$${payment.amount?.toFixed(2) || '0.00'}</div>
                                </div>
                                <span class="payment-status ${payment.status}">${payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                Date: ${new Date(payment.date).toLocaleDateString()}
                                ${payment.notes ? `<div style="margin-top: 5px;">${payment.notes}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                `;
            }).catch(e => console.error('Error loading payments:', e));
        }

        // Update openPaymentModal to close payments modal first
        const originalOpenPayment = window.openPaymentModal;
        window.openPaymentModal = function() {
            closePaymentsModal();
            if(originalOpenPayment) originalOpenPayment();
        };

        // Update dashboard stats
        function updateDashboardStats() {
            if(!auth || !auth.currentUser || !db) return;
            
            getDoc(doc(db, "users", auth.currentUser.uid)).then(userDoc => {
                if(!userDoc.exists()) return;
                
                const userData = userDoc.data();
                
                // Update checklist count
                const docs = userData.docs || [];
                const checklistTypes = [
                    { id: 'passport', types: ['Passport'] },
                    { id: 'transcript', types: ['Transcript'] },
                    { id: 'ielts', types: ['IELTS/PTE'] },
                    { id: 'financial', types: ['Financial'] },
                    { id: 'sop', types: ['SOP'] },
                    { id: 'recommendation', types: ['Recommendation'] },
                    { id: 'cv', types: ['CV', 'Resume'] },
                    { id: 'other', types: ['Other'] }
                ];
                const completed = checklistTypes.filter(item => {
                    return docs.some(doc => {
                        return item.types.some(type => doc.type === type || doc.type?.toLowerCase() === type.toLowerCase());
                    });
                }).length;
                const checklistEl = document.getElementById('dash-checklist-count');
                if(checklistEl) checklistEl.textContent = `${completed}/8`;
                
                // Update payment status
                const payments = userData.payments || [];
                const totalPaid = payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + (p.amount || 0), 0);
                const paymentEl = document.getElementById('dash-payment-status');
                if(paymentEl) paymentEl.textContent = `$${totalPaid.toFixed(0)}`;
                
                // Update welcome email
                const emailEl = document.getElementById('student-welcome-email');
                if(emailEl && userData.email) emailEl.textContent = userData.email;
                
                // Show status badge if submitted
                const statusBadge = document.getElementById('dash-status-badge');
                if(statusBadge && userData.status === 'Submitted') {
                    statusBadge.style.display = 'inline-block';
                }
            }).catch(e => console.error('Error updating stats:', e));
        }

        // Load stats when dashboard loads
        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if(user && window.currentRole === 'student') {
                    setTimeout(() => {
                        updateDashboardStats();
                    }, 1000);
                }
            });
        }

        // === NEW FEATURES JAVASCRIPT ===

        // Make functions globally accessible
        window.toggleFAQ = function(element) {
            const faqItem = element.closest('.faq-item');
            const isActive = faqItem.classList.contains('active');
            
            // Close all FAQ items
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Open clicked item if it wasn't active
            if (!isActive) {
                faqItem.classList.add('active');
            }
        };

        // Eligibility Checker
        window.checkEligibility = function() {
            const country = document.getElementById('eligibility-country').value;
            const ielts = parseFloat(document.getElementById('eligibility-ielts').value);
            const gpa = parseFloat(document.getElementById('eligibility-gpa').value);
            const budget = parseFloat(document.getElementById('eligibility-budget').value);
            const resultDiv = document.getElementById('eligibility-result');

            if (!country || !ielts || !gpa || !budget) {
                resultDiv.className = 'eligibility-result warning';
                resultDiv.innerHTML = '<strong><i class="fas fa-exclamation-triangle"></i> Please fill in all fields</strong>';
                resultDiv.style.display = 'block';
                return;
            }

            const requirements = {
                canada: { minIELTS: 6.0, minGPA: 3.0, minBudget: 25000 },
                uk: { minIELTS: 6.0, minGPA: 3.0, minBudget: 22000 },
                usa: { minIELTS: 6.5, minGPA: 3.0, minBudget: 30000 },
                australia: { minIELTS: 6.0, minGPA: 3.0, minBudget: 30000 }
            };

            const req = requirements[country];
            let eligible = true;
            let issues = [];

            if (ielts < req.minIELTS) {
                eligible = false;
                issues.push(`IELTS score should be at least ${req.minIELTS}`);
            }
            if (gpa < req.minGPA) {
                eligible = false;
                issues.push(`GPA should be at least ${req.minGPA}`);
            }
            if (budget < req.minBudget) {
                eligible = false;
                issues.push(`Budget should be at least $${req.minBudget.toLocaleString()}/year`);
            }

            if (eligible) {
                resultDiv.className = 'eligibility-result success';
                resultDiv.innerHTML = `<strong><i class="fas fa-check-circle"></i> You're Eligible!</strong><br>Based on your profile, you meet the basic requirements for studying in ${country.toUpperCase()}. <a href="#" onclick="router('auth', 'student'); return false;" style="color: #0f5132; text-decoration: underline;">Apply now</a> to get started!`;
            } else {
                resultDiv.className = 'eligibility-result warning';
                resultDiv.innerHTML = `<strong><i class="fas fa-exclamation-triangle"></i> Areas to Improve:</strong><ul style="margin: 10px 0 0 20px; padding: 0;">${issues.map(issue => `<li>${issue}</li>`).join('')}</ul><p style="margin-top: 10px;">Don't worry! Our counselors can help you improve your profile. <a href="#" onclick="router('contact'); return false;" style="color: #856404; text-decoration: underline;">Contact us</a> for guidance.</p>`;
            }
            resultDiv.style.display = 'block';
        };

        // Cost Calculator
        window.updateCostCalculator = function() {
            const country = document.getElementById('calc-country').value;
            const duration = parseFloat(document.getElementById('calc-duration').value) || 0;
            const tuition = parseFloat(document.getElementById('calc-tuition').value) || 0;
            const living = parseFloat(document.getElementById('calc-living').value) || 0;

            if (tuition > 0 || living > 0) {
                const totalTuition = tuition * duration;
                const totalLiving = living * 12 * duration;
                const grandTotal = totalTuition + totalLiving;

                const currency = {
                    canada: 'CAD',
                    uk: 'Â£',
                    usa: '$',
                    australia: 'AUD $'
                }[country] || '$';

                document.getElementById('calc-tuition-total').textContent = currency + totalTuition.toLocaleString();
                document.getElementById('calc-living-total').textContent = currency + totalLiving.toLocaleString();
                document.getElementById('calc-grand-total').textContent = currency + grandTotal.toLocaleString();
                document.getElementById('calc-total').textContent = currency + grandTotal.toLocaleString();
                document.getElementById('calc-result').style.display = 'block';
            } else {
                document.getElementById('calc-result').style.display = 'none';
            }
        };

        window.updateCostCalculatorDest = function() {
            const country = document.getElementById('calc-country-dest').value;
            const duration = parseFloat(document.getElementById('calc-duration-dest').value) || 0;
            const tuition = parseFloat(document.getElementById('calc-tuition-dest').value) || 0;
            const living = parseFloat(document.getElementById('calc-living-dest').value) || 0;

            if (tuition > 0 || living > 0) {
                const totalTuition = tuition * duration;
                const totalLiving = living * 12 * duration;
                const grandTotal = totalTuition + totalLiving;

                const currency = {
                    canada: 'CAD',
                    uk: 'Â£',
                    usa: '$',
                    australia: 'AUD $'
                }[country] || '$';

                document.getElementById('calc-tuition-total-dest').textContent = currency + totalTuition.toLocaleString();
                document.getElementById('calc-living-total-dest').textContent = currency + totalLiving.toLocaleString();
                document.getElementById('calc-grand-total-dest').textContent = currency + grandTotal.toLocaleString();
                document.getElementById('calc-total-dest').textContent = currency + grandTotal.toLocaleString();
                document.getElementById('calc-result-dest').style.display = 'block';
            } else {
                document.getElementById('calc-result-dest').style.display = 'none';
            }
        };

        // Document Checklist Generator
        const checklistData = {
            canada: {
                bachelor: ['Valid Passport', 'High School Transcripts', 'IELTS/TOEFL Score (6.0+)', 'Statement of Purpose', 'Financial Documents', 'Medical Examination', 'Police Clearance Certificate'],
                master: ['Valid Passport', 'Bachelor Degree Certificate', 'University Transcripts', 'IELTS/TOEFL Score (6.5+)', 'Statement of Purpose', 'Letters of Recommendation (2)', 'Financial Documents', 'Medical Examination', 'Police Clearance Certificate'],
                phd: ['Valid Passport', 'Master Degree Certificate', 'University Transcripts', 'IELTS/TOEFL Score (7.0+)', 'Research Proposal', 'Letters of Recommendation (3)', 'Financial Documents', 'Medical Examination', 'Police Clearance Certificate', 'CV/Resume']
            },
            uk: {
                bachelor: ['Valid Passport', 'High School Transcripts', 'IELTS/TOEFL Score (6.0+)', 'Personal Statement', 'Financial Documents', 'Tuberculosis Test Certificate'],
                master: ['Valid Passport', 'Bachelor Degree Certificate', 'University Transcripts', 'IELTS/TOEFL Score (6.5+)', 'Personal Statement', 'Letters of Recommendation (2)', 'Financial Documents', 'Tuberculosis Test Certificate'],
                phd: ['Valid Passport', 'Master Degree Certificate', 'University Transcripts', 'IELTS/TOEFL Score (7.0+)', 'Research Proposal', 'Letters of Recommendation (3)', 'Financial Documents', 'Tuberculosis Test Certificate', 'CV/Resume']
            },
            usa: {
                bachelor: ['Valid Passport', 'High School Transcripts', 'SAT/ACT Scores', 'TOEFL/IELTS Score (6.5+)', 'Personal Essay', 'Financial Documents', 'Medical Records'],
                master: ['Valid Passport', 'Bachelor Degree Certificate', 'University Transcripts', 'GRE/GMAT Scores', 'TOEFL/IELTS Score (7.0+)', 'Statement of Purpose', 'Letters of Recommendation (3)', 'Financial Documents', 'Medical Records'],
                phd: ['Valid Passport', 'Master Degree Certificate', 'University Transcripts', 'GRE Scores', 'TOEFL/IELTS Score (7.5+)', 'Research Proposal', 'Letters of Recommendation (3)', 'Financial Documents', 'Medical Records', 'CV/Resume', 'Publications (if any)']
            },
            australia: {
                bachelor: ['Valid Passport', 'High School Transcripts', 'IELTS/TOEFL Score (6.0+)', 'Statement of Purpose', 'Financial Documents', 'Medical Examination', 'Police Clearance Certificate'],
                master: ['Valid Passport', 'Bachelor Degree Certificate', 'University Transcripts', 'IELTS/TOEFL Score (6.5+)', 'Statement of Purpose', 'Letters of Recommendation (2)', 'Financial Documents', 'Medical Examination', 'Police Clearance Certificate'],
                phd: ['Valid Passport', 'Master Degree Certificate', 'University Transcripts', 'IELTS/TOEFL Score (7.0+)', 'Research Proposal', 'Letters of Recommendation (3)', 'Financial Documents', 'Medical Examination', 'Police Clearance Certificate', 'CV/Resume']
            }
        };

        window.generateChecklist = function() {
            const country = document.getElementById('checklist-country').value;
            const level = document.getElementById('checklist-level').value;
            const container = document.getElementById('checklist-items-container');
            const printBtn = document.getElementById('print-checklist-btn');

            if (!country || !level) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Select a country and program level to generate your personalized checklist</p>';
                printBtn.style.display = 'none';
                return;
            }

            const items = checklistData[country]?.[level] || [];
            if (items.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No checklist available for this combination</p>';
                printBtn.style.display = 'none';
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="checklist-generator-item" id="checklist-item-${index}">
                    <input type="checkbox" id="check-${index}" onchange="toggleChecklistItem(${index})">
                    <label for="check-${index}" style="flex: 1; cursor: pointer; color: var(--text-dark);">${item}</label>
                </div>
            `).join('');

            printBtn.style.display = 'block';
        };

        window.generateChecklistServices = function() {
            const country = document.getElementById('checklist-country-services').value;
            const level = document.getElementById('checklist-level-services').value;
            const container = document.getElementById('checklist-items-container-services');
            const printBtn = document.getElementById('print-checklist-btn-services');

            if (!country || !level) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Select a country and program level to generate your personalized checklist</p>';
                printBtn.style.display = 'none';
                return;
            }

            const items = checklistData[country]?.[level] || [];
            if (items.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No checklist available for this combination</p>';
                printBtn.style.display = 'none';
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="checklist-generator-item" id="checklist-item-services-${index}">
                    <input type="checkbox" id="check-services-${index}" onchange="toggleChecklistItemServices(${index})">
                    <label for="check-services-${index}" style="flex: 1; cursor: pointer; color: var(--text-dark);">${item}</label>
                </div>
            `).join('');

            printBtn.style.display = 'block';
        };

        window.toggleChecklistItem = function(index) {
            const item = document.getElementById(`checklist-item-${index}`);
            const checkbox = document.getElementById(`check-${index}`);
            if (checkbox && item) {
                if (checkbox.checked) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            }
        };

        window.toggleChecklistItemServices = function(index) {
            const item = document.getElementById(`checklist-item-services-${index}`);
            const checkbox = document.getElementById(`check-services-${index}`);
            if (checkbox && item) {
                if (checkbox.checked) {
                    item.classList.add('completed');
                } else {
                    item.classList.remove('completed');
                }
            }
        };

        window.printChecklist = function() {
            window.print();
        };

        window.printChecklistServices = function() {
            window.print();
        };

        // Application Deadline Countdown
        window.updateDeadlineCountdown = function() {
            const deadlines = [
                { id: 'deadline-1', date: new Date('2025-01-15') },
                { id: 'deadline-2', date: new Date('2025-02-01') },
                { id: 'deadline-3', date: new Date('2025-01-31') }
            ];

            deadlines.forEach(deadline => {
                const element = document.getElementById(deadline.id);
                if (!element) return;

                const now = new Date();
                const diff = deadline.date - now;

                if (diff <= 0) {
                    element.innerHTML = '<span style="color: var(--danger); font-weight: 600;">Deadline Passed</span>';
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                element.innerHTML = `
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <div><strong>${days}</strong><br><small>Days</small></div>
                        <div><strong>${hours}</strong><br><small>Hours</small></div>
                        <div><strong>${minutes}</strong><br><small>Mins</small></div>
                    </div>
                `;
            });
        };

        // Initialize countdown when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateDeadlineCountdown();
                setInterval(updateDeadlineCountdown, 60000);
            });
        } else {
            updateDeadlineCountdown();
            setInterval(updateDeadlineCountdown, 60000);
        }

    </script>

    
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>