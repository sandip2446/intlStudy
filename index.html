<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Edu Nepal | Leading Study Abroad Consultants</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS RESET & VARIABLES --- */
        :root {
            --primary: #002B5B; /* Deep Navy */
            --primary-light: #1A5F7A;
            --accent: #F9D923; /* Professional Gold */
            --light: #F8F9FA;
            --white: #ffffff;
            --text-dark: #2C3333;
            --text-light: #666666;
            --border: #e5e5e5;
            --success: #198754;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--white); 
            color: var(--text-dark); 
            line-height: 1.6;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3, h4 { color: var(--primary); font-weight: 700; margin-top: 0; }
        p { color: var(--text-light); }
        a { text-decoration: none; color: inherit; }

        /* --- NAVIGATION --- */
        header { 
            background-color: var(--white); 
            height: 80px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 5%;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo { 
            font-size: 1.5rem; 
            font-weight: 800; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            letter-spacing: -0.5px;
        }
        .logo i { color: var(--accent); }
        
        nav { display: flex; gap: 30px; align-items: center; }
        
        nav button { 
            background: transparent; 
            border: none; 
            color: var(--text-dark); 
            font-size: 0.95rem; 
            font-weight: 600;
            cursor: pointer; 
            transition: 0.3s;
            padding: 8px 0;
            position: relative;
        }
        
        nav button:hover, nav button.active { color: var(--primary); }
        nav button.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent);
        }

        .nav-cta {
            background-color: var(--primary) !important;
            color: white !important;
            padding: 10px 25px !important;
            border-radius: 50px;
            transition: transform 0.2s !important;
        }
        .nav-cta:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,43,91,0.3); }
        .nav-cta::after { display: none; }

        .logout-btn { 
            background-color: #dc3545 !important; 
            color: white !important;
            padding: 8px 20px !important;
            border-radius: 4px;
        }

        /* --- LAYOUT UTILITIES --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .section { display: none; padding: 60px 0; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            nav { display: none; /* In a real app, adding a hamburger menu would be next */ }
            .hero h1 { font-size: 2.5rem !important; }
            .hero p { font-size: 1rem !important; }
            .hero-stats { flex-direction: column; gap: 30px !important; }
            .section-title { font-size: 2rem !important; }
            .marketing-section { padding: 50px 0 !important; }
            .dest-highlights { flex-direction: column; gap: 10px !important; }
            .dest-detail-header { height: 200px !important; }
            table { font-size: 0.9rem; }
            table th, table td { padding: 10px !important; }
            #admin-contacts-view > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
            #admin-contacts-view > div[style*="grid-template-columns"] > div:last-child { display: none; }
        }

        /* --- HERO SECTION --- */
        .hero {
            background: linear-gradient(rgba(0,43,91,0.9), rgba(0,43,91,0.8)), url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 100px 0;
            text-align: center;
        }
        .hero h1 { color: white; font-size: 3.5rem; margin-bottom: 20px; line-height: 1.2; }
        .hero p { color: rgba(255,255,255,0.9); font-size: 1.25rem; max-width: 700px; margin: 0 auto 40px auto; }
        
        .hero-stats {
            display: flex; justify-content: center; gap: 50px; margin-top: 60px; padding-top: 40px; border-top: 1px solid rgba(255,255,255,0.2);
        }
        .stat-item h3 { color: var(--accent); font-size: 2.5rem; margin-bottom: 5px; }
        .stat-item p { color: white; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* --- CARDS & SERVICES --- */
        .service-card {
            background: white; padding: 30px; border-radius: 8px; border: 1px solid var(--border); transition: 0.3s;
            text-align: center;
        }
        .service-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: var(--accent); }
        .service-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 20px; }

        .dest-card {
            height: 200px; border-radius: 12px; overflow: hidden; position: relative; cursor: pointer;
        }
        .dest-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .dest-card:hover img { transform: scale(1.1); }
        .dest-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 20px; color: white;
        }

        /* --- MARKETING SECTIONS --- */
        .marketing-section {
            padding: 80px 0;
        }
        .marketing-section.alt-bg {
            background-color: var(--light);
        }
        .section-title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        .section-subtitle {
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-light);
            max-width: 700px;
            margin: 0 auto 60px;
        }
        .feature-card {
            background: white;
            padding: 40px 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: 0.3s;
            border: 1px solid var(--border);
        }
        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
            border-color: var(--accent);
        }
        .feature-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        .testimonial-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--accent);
        }
        .testimonial-text {
            font-style: italic;
            color: var(--text-light);
            margin-bottom: 20px;
            line-height: 1.8;
        }
        .testimonial-author {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .testimonial-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .why-us-item {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: start;
        }
        .why-us-icon {
            font-size: 2rem;
            color: var(--accent);
            min-width: 50px;
        }
        .dest-detail-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: 0.3s;
            margin-bottom: 30px;
        }
        .dest-detail-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .dest-detail-header {
            height: 250px;
            position: relative;
            overflow: hidden;
        }
        .dest-detail-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .dest-detail-content {
            padding: 30px;
        }
        .dest-highlights {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .dest-highlight {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
        }
        .dest-highlight i {
            color: var(--accent);
        }

        /* --- BUTTONS & FORMS --- */
        .btn {
            display: inline-block; padding: 14px 32px; background-color: var(--primary); color: white; border: none; 
            border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { background-color: #004080; }
        .btn-accent { background-color: var(--accent); color: var(--primary); }
        .btn-accent:hover { background-color: #e6c81b; }
        .btn-outline { background: transparent; border: 2px solid white; color: white; }
        .btn-outline:hover { background: white; color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #146c43; }
        .btn-danger { background-color: var(--danger); }
        .btn-sm { padding: 5px 12px; font-size: 0.8rem; }

        input, select, textarea {
            width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 4px; 
            font-family: inherit; background: #fdfdfd;
        }
        input:focus { border-color: var(--primary); outline: none; }

        /* --- DASHBOARDS --- */
        .dashboard-layout { display: grid; grid-template-columns: 280px 1fr; min-height: 80vh; }
        .dash-sidebar { background: var(--primary); color: white; padding: 30px 20px; }
        .dash-main { padding: 40px; background: var(--light); }
        
        .dash-menu-item {
            display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; color: rgba(255,255,255,0.7); border-radius: 6px; margin-bottom: 5px; cursor: pointer;
        }
        .dash-menu-item:hover, .dash-menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        .dash-menu-item i { width: 25px; }
        .nav-badge-simple {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .dash-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }

        /* --- CHAT UI --- */
        .chat-wrapper { display: flex; flex-direction: column; height: 500px; border: 1px solid var(--border); background: white; border-radius: 8px; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: #f8f9fa; }
        .chat-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-color: #fff; }
        .message { max-width: 70%; padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; }
        .msg-in { background-color: #f0f2f5; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-out { background-color: var(--primary-light); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-footer { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        /* --- DEMO MODE BADGE --- */
        .demo-badge { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: var(--primary); padding: 8px 15px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 999; display: none; }
        .error-message { color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none; }

        /* --- TAGS FOR SELECTED UNIVERSITIES --- */
        .uni-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e3f2fd;
            color: #0d47a1;
            padding: 5px 12px;
            border-radius: 20px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .uni-tag i { margin-left: 8px; cursor: pointer; color: #d32f2f; }
        .uni-tag i:hover { color: #b71c1c; }

        /* --- PREVIEW STYLES --- */
        .preview-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .preview-label { font-weight: 600; color: var(--text-light); font-size: 0.9rem; }
        .preview-value { color: var(--primary); font-size: 1rem; font-weight: 500; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .status-draft { background-color: #f0f0f0; color: #666; }
        .status-submitted { background-color: #d1e7dd; color: #0f5132; }

        /* --- COUNSELOR SPECIFIC --- */
        .coun-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .coun-tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #666; border-bottom: 2px solid transparent; }
        .coun-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .coun-tab:hover { background-color: #f9f9f9; }
        
        .student-item { 
            padding: 16px; 
            border-bottom: 1px solid #e5e7eb; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.2s;
            border-radius: 8px;
            margin: 4px;
        }
        .student-item:hover { 
            background-color: #f0f8ff; 
            transform: translateX(2px);
        }
        .student-item.active { 
            background-color: #e0e7ff; 
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .student-item-checkbox { display: flex; align-items: center; gap: 12px; flex: 1; }
        .student-item-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        .student-item-checkbox label { cursor: pointer; flex: 1; margin: 0; }
        .student-item-checkbox .student-info { flex: 1; }
        .student-item-checkbox .student-name { font-weight: 600; color: var(--primary); margin-bottom: 3px; }
        .student-item-checkbox .student-details { font-size: 0.85rem; color: #666; }
        
        .coun-action-btn { background: none; border: none; cursor: pointer; color: #999; padding: 5px; transition:0.2s; }
        .coun-action-btn:hover { color: var(--primary); }
        .coun-action-btn.delete:hover { color: var(--danger); }

        /* --- WORKSPACE DESIGN --- */
        .workspace-layout { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
        .workspace-sidebar { 
            background: linear-gradient(180deg, #1e3a5f 0%, #2c5282 100%); 
            color: white; 
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .workspace-main { 
            padding: 0; 
            background: #f5f7fa; 
            overflow-y: auto;
        }

        .workspace-brand {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        .workspace-logo {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .workspace-nav {
            padding: 0 15px;
        }
        .workspace-nav-item {
            display: block;
            padding: 14px 15px;
            color: rgba(255,255,255,0.8);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .workspace-nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .workspace-nav-item.active {
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: 600;
        }
        .nav-item-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .nav-item-main {
            display: flex;
            align-items: center;
        }
        .workspace-nav-item i {
            width: 24px;
            margin-right: 12px;
        }
        .nav-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            align-self: flex-start;
            margin-left: 36px;
        }

        .workspace-header {
            background: white;
            padding: 30px 40px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workspace-stats {
            display: flex;
            gap: 20px;
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            min-width: 140px;
        }
        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .stat-info {
            flex: 1;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .workspace-content {
            padding: 30px 40px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        .workspace-panel-left, .workspace-panel-right {
            min-width: 0;
        }

        .workspace-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .workspace-card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }
        .workspace-card-body {
            padding: 0;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        .workspace-list {
            padding: 8px;
        }

        .workspace-empty-state {
            background: white;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
            color: #9ca3af;
        }
        .workspace-empty-state h3 {
            margin: 0 0 10px 0;
            color: #1a1a1a;
            font-size: 1.3rem;
        }
        .workspace-empty-state p {
            color: #6b7280;
            margin: 8px 0;
            line-height: 1.6;
        }
        .empty-state-hint {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 15px;
        }

        .workspace-student-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .student-header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .student-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        .student-header-info h2 {
            color: white;
        }
        .student-header-info p {
            color: rgba(255,255,255,0.9);
        }
        .student-header-meta {
            text-align: right;
        }
        .status-badge-modern {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 8px;
        }
        .badge-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }
        .last-updated {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            margin: 0;
        }

        .workspace-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: #fafbfc;
            padding: 0 24px;
        }
        .workspace-tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
            top: 2px;
        }
        .workspace-tab:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .workspace-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        .tab-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 4px;
        }

        .workspace-tab-content {
            padding: 30px;
        }
        .profile-section {
            margin-bottom: 30px;
        }
        .section-title {
            color: #1a1a1a;
            margin: 0 0 12px 0;
            font-size: 1.2rem;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title i {
            color: var(--primary);
        }
        .section-description {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .profile-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .info-field {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .info-field:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        .info-label {
            font-size: 0.8rem;
            color: #6b7280;
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .info-label i {
            margin-right: 6px;
            color: #9ca3af;
        }
        .info-value {
            margin: 0;
            font-weight: 500;
            color: #1a1a1a;
            font-size: 0.95rem;
        }
        .highlight-field {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #bfdbfe;
        }
        .highlight-value {
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }
        .highlight-value-accent {
            color: var(--accent);
            font-weight: 600;
            font-size: 1.1rem;
        }
        .milestone-field {
            background: #fff7ed;
            border-color: #fed7aa;
        }
        .milestone-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .milestone-select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }
        .milestone-btn {
            padding: 10px 16px;
            border-radius: 6px;
        }
        .current-milestone {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6b7280;
        }
        .unis-list {
            margin-top: 8px;
        }
        .empty-text {
            color: #9ca3af;
            font-style: italic;
        }

        .docs-list {
            margin-top: 20px;
        }
        .empty-docs {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        .empty-docs i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        .empty-docs p {
            font-style: italic;
        }

        .workspace-chat {
            height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .workspace-chat-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .chat-avatar {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .chat-header-info {
            flex: 1;
        }
        .chat-header-info strong {
            display: block;
            color: white;
            margin-bottom: 4px;
        }
        .chat-status {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.9);
        }
        .chat-status i {
            font-size: 0.5rem;
            color: #10b981;
            margin-right: 4px;
        }
        .workspace-chat-body {
            background: #f9fafb;
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        .workspace-chat-footer {
            background: white;
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .chat-input {
            flex: 1;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            border-radius: 24px;
            padding: 12px 20px;
            font-size: 0.95rem;
            outline: none;
        }
        .chat-input:focus {
            border-color: var(--primary);
            background: white;
        }
        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chat-send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .workspace-btn {
            border-radius: 6px;
            font-weight: 500;
        }

        /* --- WIZARD STEPS --- */
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; max-width: 600px; margin-left: auto; margin-right: auto; }
        .step-indicator::before { content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 2px; background: #eee; z-index: 0; }
        .step { position: relative; z-index: 1; background: white; padding: 0 10px; text-align: center; width: 33%; }
        .step-circle { width: 32px; height: 32px; background: #eee; color: #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-weight: bold; transition: 0.3s; border: 2px solid white; }
        .step.active .step-circle { background: var(--primary); color: white; border-color: var(--accent); }
        .step.completed .step-circle { background: var(--success); color: white; }
        .step-label { font-size: 0.8rem; color: #666; font-weight: 500; }
        .step.active .step-label { color: var(--primary); font-weight: 700; }

        .wizard-content { display: none; animation: fadeIn 0.4s; }
        .wizard-content.active { display: block; }

        /* --- GREEN LIGHT INDICATOR --- */
        .doc-status-light { width: 12px; height: 12px; border-radius: 50%; background: #ccc; display: inline-block; margin-right: 10px; vertical-align: middle; transition: 0.3s; }
        .doc-uploaded .doc-status-light { background: var(--success); box-shadow: 0 0 8px var(--success); transform: scale(1.2); }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 { margin: 0; color: var(--primary); }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { color: var(--danger); }
        .modal-student-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-student-item:hover {
            background: #f8f9fa;
            border-color: var(--primary);
        }
        .modal-student-item .student-info {
            flex: 1;
        }
        .modal-student-item .student-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        .modal-student-item .student-details {
            font-size: 0.85rem;
            color: #666;
        }

    </style>
</head>
<body>

    <!-- SAFETY SCRIPT -->
    <script>
        function scriptError() {
            alert("⚠️ SCRIPT ERROR: The application logic failed to load.\nPlease use 'Live Server' in VS Code.");
        }
        window.router = scriptError;
        window.handleLogin = scriptError;
        window.handleSignup = scriptError;
        window.handleLogout = scriptError;
        window.startDemoMode = scriptError;
        window.handleUpload = scriptError;
        window.sendMessage = scriptError;
        window.selectStudent = scriptError;
        window.handleAddUniversity = scriptError;
        window.saveApplication = scriptError;
        window.editApplication = scriptError;
        window.submitApplication = scriptError;
        window.renderStudentList = scriptError;
        window.switchCounselorTab = scriptError;
        window.addStudent = scriptError;
        window.deleteStudent = scriptError;
        window.archiveStudent = scriptError;
        window.updateProfile = scriptError;
        window.goToStep = scriptError;
    </script>

    <!-- NAVIGATION -->
    <header>
        <div class="logo">
            <i class="fas fa-graduation-cap"></i> GLOBAL EDU NEPAL
        </div>
        <nav id="public-nav">
            <button onclick="router('home')" class="active">Home</button>
            <button onclick="router('services')">Services</button>
            <button onclick="router('destinations')">Destinations</button>
            <button onclick="router('contact')">Contact</button>
            <button onclick="router('auth', 'student')" class="nav-cta">Login</button>
        </nav>
        <nav id="private-nav" style="display: none;">
            <span id="user-display" style="font-weight: 600; color: var(--primary);"></span>
            <button onclick="handleLogout()" class="logout-btn">Logout</button>
        </nav>
    </header>

    <!-- DEMO BADGE -->
    <div id="demo-badge" class="demo-badge"><i class="fas fa-flask"></i> Demo Mode Active</div>

    <!-- ADD STUDENT MODAL -->
    <div id="add-student-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Select Student to Add</h3>
                <button class="modal-close" onclick="closeAddStudentModal()">&times;</button>
            </div>
            <div id="available-students-list">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Loading available students...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- === HOME PAGE === -->
    <div id="page-home" class="section active">
        <div class="hero">
            <div class="container">
                <h1>Turn Your Dream of Studying<br>Abroad Into Reality</h1>
                <p>We provide expert guidance for students in Nepal looking to study in Canada, USA, UK, and Australia. Your future begins with the right counseling.</p>
                <div>
                    <button class="btn btn-accent" onclick="router('auth', 'student')">Apply Now</button>
                    <button class="btn btn-outline" onclick="router('services')">Our Services</button>
                </div>

                <div class="hero-stats">
                    <div class="stat-item">
                        <h3>10k+</h3>
                        <p>Students Placed</p>
                    </div>
                    <div class="stat-item">
                        <h3>98%</h3>
                        <p>Visa Success Rate</p>
                    </div>
                    <div class="stat-item">
                        <h3>500+</h3>
                        <p>Partner Universities</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popular Destinations Section -->
        <div class="container marketing-section">
            <h2 class="section-title">Popular Destinations</h2>
            <p class="section-subtitle">Explore world-class education opportunities in top study destinations</p>
            <div class="grid-4">
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1517935706615-2717063c2225?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="Canada">
                    <div class="dest-overlay"><h3>Canada</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">Top Quality Education</p></div>
                </div>
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="UK">
                    <div class="dest-overlay"><h3>United Kingdom</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">Prestigious Universities</p></div>
                </div>
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1525026198548-4baa812f1183?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="USA">
                    <div class="dest-overlay"><h3>United States</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">World's Best Programs</p></div>
                </div>
                <div class="dest-card" onclick="router('destinations')">
                    <img src="https://images.unsplash.com/photo-1506973035872-a4ec16b8e8d9?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60" alt="Australia">
                    <div class="dest-overlay"><h3>Australia</h3><p style="margin:5px 0 0 0; font-size:0.9rem;">Vibrant Student Life</p></div>
                </div>
            </div>
        </div>

        <!-- Why Choose Us Section -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Why Choose Global Edu Nepal?</h2>
            <p class="section-subtitle">We are committed to making your study abroad journey smooth and successful</p>
            <div class="grid-3">
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-user-graduate"></i></div>
                    <div>
                        <h3 style="margin-top:0;">Expert Counselors</h3>
                        <p>Our experienced team provides personalized guidance tailored to your academic goals and career aspirations.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-check-circle"></i></div>
                    <div>
                        <h3 style="margin-top:0;">98% Visa Success Rate</h3>
                        <p>We have a proven track record of helping students secure visas with comprehensive documentation support.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-handshake"></i></div>
                    <div>
                        <h3 style="margin-top:0;">500+ Partner Universities</h3>
                        <p>Extensive network of accredited institutions across Canada, USA, UK, and Australia.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div>
                        <h3 style="margin-top:0;">Transparent Pricing</h3>
                        <p>No hidden fees. Clear, upfront pricing with flexible payment options for all our services.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-headset"></i></div>
                    <div>
                        <h3 style="margin-top:0;">24/7 Support</h3>
                        <p>Round-the-clock assistance for all your queries, from application to post-arrival support.</p>
                    </div>
                </div>
                <div class="why-us-item">
                    <div class="why-us-icon"><i class="fas fa-book-reader"></i></div>
                    <div>
                        <h3 style="margin-top:0;">Test Preparation</h3>
                        <p>Comprehensive IELTS, PTE, and TOEFL training to help you achieve your target scores.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Our Services Preview -->
        <div class="container marketing-section">
            <h2 class="section-title">Our Services</h2>
            <p class="section-subtitle">End-to-end support for your complete study abroad journey</p>
            <div class="grid-3">
                <div class="feature-card">
                    <i class="fas fa-university feature-icon"></i>
                    <h3>University Selection</h3>
                    <p>Expert guidance to choose the right university and program that matches your career goals and budget.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-file-alt feature-icon"></i>
                    <h3>Application Support</h3>
                    <p>Complete assistance with application forms, essays, recommendation letters, and all required documentation.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-passport feature-icon"></i>
                    <h3>Visa Processing</h3>
                    <p>Professional visa guidance including document preparation, interview coaching, and financial statement support.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-book-open feature-icon"></i>
                    <h3>Test Preparation</h3>
                    <p>Structured classes for IELTS, PTE, TOEFL, and GRE/GMAT with practice tests and personalized feedback.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-plane feature-icon"></i>
                    <h3>Pre-Departure Briefing</h3>
                    <p>Essential information about your destination country, accommodation, banking, and student life preparation.</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-heart feature-icon"></i>
                    <h3>Post-Arrival Support</h3>
                    <p>Continued assistance after you arrive, helping you settle in and navigate your new academic environment.</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-accent" onclick="router('services')">View All Services</button>
            </div>
        </div>

        <!-- Testimonials Section -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Success Stories</h2>
            <p class="section-subtitle">Hear from students who achieved their dreams with our help</p>
            <div class="grid-3">
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "Global Edu Nepal made my dream of studying in Canada come true. Their counselors were patient, professional, and guided me through every step. I'm now pursuing my Master's at University of Toronto!"
                    </div>
                    <div class="testimonial-author">
                        <div class="testimonial-avatar">SP</div>
                        <div>
                            <strong>Sarita Pandey</strong><br>
                            <small style="color: var(--text-light);">University of Toronto, Canada</small>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "The visa process seemed overwhelming, but the team at Global Edu Nepal handled everything perfectly. Their attention to detail and expertise resulted in a successful visa approval. Highly recommended!"
                    </div>
                    <div class="testimonial-author">
                        <div class="testimonial-avatar">RK</div>
                        <div>
                            <strong>Rajesh Kumar</strong><br>
                            <small style="color: var(--text-light);">University of Melbourne, Australia</small>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-text">
                        "From test preparation to university selection and visa processing, Global Edu Nepal provided comprehensive support. I'm grateful for their dedication in helping me secure admission to a top UK university."
                    </div>
                    <div class="testimonial-author">
                        <div class="testimonial-avatar">PM</div>
                        <div>
                            <strong>Priya Maharjan</strong><br>
                            <small style="color: var(--text-light);">University of Manchester, UK</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CTA Section -->
        <div class="container marketing-section" style="text-align: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; padding: 60px 40px; color: white;">
            <h2 style="color: white; font-size: 2.5rem; margin-bottom: 20px;">Ready to Start Your Journey?</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 1.2rem; max-width: 600px; margin: 0 auto 40px;">
                Join thousands of successful students who have achieved their study abroad dreams with Global Edu Nepal
            </p>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Apply Now</button>
                <button class="btn btn-outline" onclick="router('contact')" style="font-size: 1.1rem; padding: 16px 40px;">Contact Us</button>
            </div>
        </div>
    </div>

    <!-- === DESTINATIONS PAGE === -->
    <div id="page-destinations" class="section">
        <div class="container" style="padding-top: 60px;">
            <div style="text-align: center; margin-bottom: 60px;">
                <h1 class="section-title">Study Destinations</h1>
                <p class="section-subtitle">Discover world-class education opportunities in top study destinations around the globe</p>
            </div>

            <!-- Canada -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1517935706615-2717063c2225?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Canada">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> Canada</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        Canada is one of the most popular study destinations for international students, offering high-quality education, 
                        multicultural environment, and excellent post-graduation opportunities. With world-renowned universities and 
                        a welcoming atmosphere, Canada provides an ideal setting for academic and personal growth.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> University of Toronto, McGill University, UBC</div>
                        <div class="dest-highlight"><i class="fas fa-dollar-sign"></i> <strong>Tuition:</strong> CAD $15,000 - $35,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> CAD $10,000 - $15,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> Up to 3 years post-graduation</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English & French</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>IELTS:</strong> 6.0 - 7.0 required</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in Canada?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>High-quality education recognized worldwide</li>
                            <li>Safe and multicultural society</li>
                            <li>Post-graduation work permit (PGWP) opportunities</li>
                            <li>Pathway to permanent residency</li>
                            <li>Affordable tuition fees compared to other countries</li>
                            <li>Beautiful landscapes and high quality of life</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for Canada</button>
                    </div>
                </div>
            </div>

            <!-- United Kingdom -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="United Kingdom">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> United Kingdom</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        The UK is home to some of the world's oldest and most prestigious universities. With a rich academic heritage, 
                        innovative research opportunities, and shorter degree programs, the UK offers an excellent education system 
                        that is respected globally. Students benefit from world-class facilities and a vibrant cultural experience.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> Oxford, Cambridge, Imperial College, LSE</div>
                        <div class="dest-highlight"><i class="fas fa-pound-sign"></i> <strong>Tuition:</strong> £12,000 - £35,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> £10,000 - £15,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> 2 years post-graduation (Graduate Route)</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>IELTS:</strong> 6.0 - 7.5 required</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in the UK?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>World-renowned universities with excellent reputation</li>
                            <li>Shorter degree programs (3 years for Bachelor's, 1 year for Master's)</li>
                            <li>Rich cultural heritage and diverse student community</li>
                            <li>Strong research opportunities and industry connections</li>
                            <li>Graduate Route visa allows 2 years of work after graduation</li>
                            <li>Gateway to Europe and global career opportunities</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for UK</button>
                    </div>
                </div>
            </div>

            <!-- United States -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1525026198548-4baa812f1183?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="United States">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> United States</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        The United States boasts the largest number of top-ranked universities in the world. With cutting-edge research facilities, 
                        flexible curriculum, and diverse academic programs, the US offers unparalleled educational opportunities. 
                        Students can choose from thousands of institutions and programs tailored to their interests.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> MIT, Harvard, Stanford, UC Berkeley</div>
                        <div class="dest-highlight"><i class="fas fa-dollar-sign"></i> <strong>Tuition:</strong> $20,000 - $60,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> $12,000 - $20,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> OPT (12-36 months post-graduation)</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>TOEFL/IELTS:</strong> 80-100 (TOEFL) / 6.5-7.5 (IELTS)</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in the USA?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>World's best universities and research facilities</li>
                            <li>Flexible education system with diverse course options</li>
                            <li>Strong industry connections and internship opportunities</li>
                            <li>Optional Practical Training (OPT) for work experience</li>
                            <li>Innovation and entrepreneurship culture</li>
                            <li>Global recognition of US degrees</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for USA</button>
                    </div>
                </div>
            </div>

            <!-- Australia -->
            <div class="dest-detail-card">
                <div class="dest-detail-header">
                    <img src="https://images.unsplash.com/photo-1506973035872-a4ec16b8e8d9?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Australia">
                </div>
                <div class="dest-detail-content">
                    <h2 style="color: var(--primary); margin-top: 0;"><i class="fas fa-map-marker-alt"></i> Australia</h2>
                    <p style="font-size: 1.1rem; color: var(--text-light); line-height: 1.8;">
                        Australia offers a perfect blend of high-quality education, stunning natural beauty, and a relaxed lifestyle. 
                        With world-class universities, excellent student support services, and a strong focus on research and innovation, 
                        Australia provides an ideal environment for international students to thrive academically and personally.
                    </p>
                    <div class="dest-highlights">
                        <div class="dest-highlight"><i class="fas fa-graduation-cap"></i> <strong>Top Universities:</strong> ANU, University of Melbourne, University of Sydney</div>
                        <div class="dest-highlight"><i class="fas fa-dollar-sign"></i> <strong>Tuition:</strong> AUD $20,000 - $45,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-home"></i> <strong>Living Cost:</strong> AUD $15,000 - $20,000/year</div>
                        <div class="dest-highlight"><i class="fas fa-briefcase"></i> <strong>Work Permit:</strong> 2-4 years post-graduation</div>
                        <div class="dest-highlight"><i class="fas fa-language"></i> <strong>Language:</strong> English</div>
                        <div class="dest-highlight"><i class="fas fa-certificate"></i> <strong>IELTS:</strong> 6.0 - 7.0 required</div>
                    </div>
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">Why Study in Australia?</h3>
                        <ul style="color: var(--text-light); line-height: 2;">
                            <li>World-class education system with excellent student support</li>
                            <li>Beautiful landscapes and high quality of life</li>
                            <li>Post-study work rights (2-4 years depending on degree)</li>
                            <li>Strong pathway to permanent residency</li>
                            <li>Multicultural society with welcoming environment</li>
                            <li>Excellent research opportunities and modern facilities</li>
                        </ul>
                    </div>
                    <div style="margin-top: 25px;">
                        <button class="btn btn-accent" onclick="router('auth', 'student')">Apply for Australia</button>
                    </div>
                </div>
            </div>

            <!-- Comparison Table -->
            <div class="dash-card" style="margin-top: 60px;">
                <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">Quick Comparison</h2>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--primary); color: white;">
                                <th style="padding: 15px; text-align: left;">Country</th>
                                <th style="padding: 15px; text-align: left;">Avg. Tuition/Year</th>
                                <th style="padding: 15px; text-align: left;">Living Cost/Year</th>
                                <th style="padding: 15px; text-align: left;">Work Permit</th>
                                <th style="padding: 15px; text-align: left;">IELTS Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">Canada</td>
                                <td style="padding: 15px;">CAD $15,000 - $35,000</td>
                                <td style="padding: 15px;">CAD $10,000 - $15,000</td>
                                <td style="padding: 15px;">Up to 3 years</td>
                                <td style="padding: 15px;">6.0 - 7.0</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">United Kingdom</td>
                                <td style="padding: 15px;">£12,000 - £35,000</td>
                                <td style="padding: 15px;">£10,000 - £15,000</td>
                                <td style="padding: 15px;">2 years</td>
                                <td style="padding: 15px;">6.0 - 7.5</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">United States</td>
                                <td style="padding: 15px;">$20,000 - $60,000</td>
                                <td style="padding: 15px;">$12,000 - $20,000</td>
                                <td style="padding: 15px;">12-36 months (OPT)</td>
                                <td style="padding: 15px;">6.5 - 7.5</td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; font-weight: 600; color: var(--primary);">Australia</td>
                                <td style="padding: 15px;">AUD $20,000 - $45,000</td>
                                <td style="padding: 15px;">AUD $15,000 - $20,000</td>
                                <td style="padding: 15px;">2-4 years</td>
                                <td style="padding: 15px;">6.0 - 7.0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CTA Section -->
            <div style="text-align: center; margin-top: 60px; padding: 50px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; color: white;">
                <h2 style="color: white; margin-bottom: 20px;">Ready to Choose Your Destination?</h2>
                <p style="color: rgba(255,255,255,0.9); font-size: 1.1rem; max-width: 600px; margin: 0 auto 30px;">
                    Our expert counselors will help you select the perfect destination and university based on your goals, budget, and preferences.
                </p>
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Start Your Application</button>
            </div>
        </div>
    </div>

    <!-- === SERVICES PAGE === -->
    <div id="page-services" class="section" style="padding-top: 0;">
        <!-- Hero Section -->
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 100px 0; text-align: center;">
            <div class="container">
                <h1 style="color: white; font-size: 3.5rem; margin-bottom: 20px;">Our Comprehensive Services</h1>
                <p style="color: rgba(255,255,255,0.9); font-size: 1.3rem; max-width: 800px; margin: 0 auto 40px;">
                    From university selection to post-arrival support, we guide you through every step of your study abroad journey
                </p>
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Get Started Today</button>
            </div>
        </div>

        <!-- Main Services -->
        <div class="container marketing-section">
            <h2 class="section-title">What We Offer</h2>
            <p class="section-subtitle">Comprehensive support services designed to maximize your success</p>
            
            <div class="grid-3">
                <div class="feature-card" style="border-top: 4px solid var(--primary);">
                    <i class="fas fa-university feature-icon" style="color: var(--primary);"></i>
                    <h3>University Selection & Admission</h3>
                    <p style="margin-bottom: 20px;">Expert guidance to choose the perfect university and program that aligns with your career aspirations and financial capacity.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Personalized university matching</li>
                        <li>Program and course recommendations</li>
                        <li>Scholarship opportunities research</li>
                        <li>Application deadline management</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid var(--accent);">
                    <i class="fas fa-file-alt feature-icon" style="color: var(--accent);"></i>
                    <h3>Application Support</h3>
                    <p style="margin-bottom: 20px;">Complete assistance with all application requirements to ensure your submission stands out.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Application form completion</li>
                        <li>Statement of Purpose (SOP) writing</li>
                        <li>Recommendation letter guidance</li>
                        <li>Document verification & compilation</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid var(--success);">
                    <i class="fas fa-passport feature-icon" style="color: var(--success);"></i>
                    <h3>Visa Processing & Guidance</h3>
                    <p style="margin-bottom: 20px;">Professional visa assistance with a 98% success rate to help you secure your study visa.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Visa document preparation</li>
                        <li>Financial statement support</li>
                        <li>Interview coaching & preparation</li>
                        <li>Application submission & tracking</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid #007bff;">
                    <i class="fas fa-book-open feature-icon" style="color: #007bff;"></i>
                    <h3>Test Preparation</h3>
                    <p style="margin-bottom: 20px;">Comprehensive test preparation courses to help you achieve your target scores for IELTS, PTE, TOEFL, and more.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>IELTS/PTE/TOEFL training</li>
                        <li>GRE/GMAT preparation</li>
                        <li>Mock tests & practice sessions</li>
                        <li>Personalized feedback & improvement</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid #ff6b6b;">
                    <i class="fas fa-plane feature-icon" style="color: #ff6b6b;"></i>
                    <h3>Pre-Departure Briefing</h3>
                    <p style="margin-bottom: 20px;">Essential information and guidance to prepare you for life in your new country.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Country & culture orientation</li>
                        <li>Accommodation assistance</li>
                        <li>Banking & finance setup</li>
                        <li>Travel & packing guidance</li>
                    </ul>
                </div>

                <div class="feature-card" style="border-top: 4px solid #9b59b6;">
                    <i class="fas fa-heart feature-icon" style="color: #9b59b6;"></i>
                    <h3>Post-Arrival Support</h3>
                    <p style="margin-bottom: 20px;">Continued assistance after you arrive to help you settle in smoothly.</p>
                    <ul style="text-align: left; color: var(--text-light); line-height: 2; margin: 0; padding-left: 20px;">
                        <li>Airport pickup coordination</li>
                        <li>Accommodation assistance</li>
                        <li>Student life guidance</li>
                        <li>Ongoing counseling support</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Process Timeline -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Our Process</h2>
            <p class="section-subtitle">A simple, step-by-step journey to your dream university</p>
            
            <div style="max-width: 900px; margin: 0 auto; position: relative;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-top: 50px;">
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(0,43,91,0.3);">1</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Consultation</h3>
                        <p style="color: var(--text-light);">Free initial consultation to understand your goals, preferences, and budget.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: var(--accent); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(249,217,35,0.3);">2</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">University Selection</h3>
                        <p style="color: var(--text-light);">We help you choose the best universities and programs matching your profile.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: var(--success); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(25,135,84,0.3);">3</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Application</h3>
                        <p style="color: var(--text-light);">Complete application support with document preparation and submission.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(0,123,255,0.3);">4</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Visa Processing</h3>
                        <p style="color: var(--text-light);">Expert visa guidance and documentation to secure your study visa.</p>
                    </div>
                    <div style="text-align: center; position: relative;">
                        <div style="width: 80px; height: 80px; background: #9b59b6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; box-shadow: 0 5px 15px rgba(155,89,182,0.3);">5</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">Pre-Departure</h3>
                        <p style="color: var(--text-light);">Comprehensive briefing and preparation for your new journey abroad.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Why Choose Our Services -->
        <div class="container marketing-section">
            <h2 class="section-title">Why Choose Our Services?</h2>
            <div class="grid-2" style="gap: 40px; align-items: center;">
                <div>
                    <div class="why-us-item" style="margin-bottom: 30px;">
                        <div class="why-us-icon"><i class="fas fa-check-circle"></i></div>
                        <div>
                            <h3 style="margin-top: 0;">98% Visa Success Rate</h3>
                            <p>Our proven track record speaks for itself. We have successfully helped thousands of students secure their study visas.</p>
                        </div>
                    </div>
                    <div class="why-us-item" style="margin-bottom: 30px;">
                        <div class="why-us-icon"><i class="fas fa-users"></i></div>
                        <div>
                            <h3 style="margin-top: 0;">Expert Counselors</h3>
                            <p>Our team of experienced counselors provides personalized guidance tailored to your unique situation and goals.</p>
                        </div>
                    </div>
                    <div class="why-us-item" style="margin-bottom: 30px;">
                        <div class="why-us-icon"><i class="fas fa-clock"></i></div>
                        <div>
                            <h3 style="margin-top: 0;">24/7 Support</h3>
                            <p>Round-the-clock assistance ensures you never feel alone in your journey. We're here whenever you need us.</p>
                        </div>
                    </div>
                </div>
                <div>
                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; padding: 50px; color: white; text-align: center;">
                        <h2 style="color: white; margin-bottom: 30px;">10,000+</h2>
                        <p style="font-size: 1.2rem; margin-bottom: 40px; color: rgba(255,255,255,0.9);">Students Successfully Placed</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px;">
                            <div>
                                <h3 style="color: var(--accent); font-size: 2.5rem; margin: 0;">500+</h3>
                                <p style="margin: 5px 0 0 0;">Partner Universities</p>
                            </div>
                            <div>
                                <h3 style="color: var(--accent); font-size: 2.5rem; margin: 0;">15+</h3>
                                <p style="margin: 5px 0 0 0;">Years Experience</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Packages -->
        <div class="container marketing-section alt-bg">
            <h2 class="section-title">Service Packages</h2>
            <p class="section-subtitle">Choose the package that best fits your needs</p>
            
            <div class="grid-3" style="margin-top: 50px;">
                <div class="dash-card" style="text-align: center; border: 2px solid var(--border); transition: 0.3s;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Basic Package</h3>
                    <div style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 20px 0;">Free</div>
                    <ul style="text-align: left; list-style: none; padding: 0; margin: 30px 0;">
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Initial Consultation</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> University Information</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Basic Guidance</li>
                    </ul>
                    <button class="btn" style="width: 100%;" onclick="router('contact')">Get Started</button>
                </div>

                <div class="dash-card" style="text-align: center; border: 2px solid var(--accent); transform: scale(1.05); box-shadow: 0 10px 30px rgba(249,217,35,0.2); position: relative;">
                    <div style="position: absolute; top: -15px; right: 20px; background: var(--accent); color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">MOST POPULAR</div>
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Complete Package</h3>
                    <div style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 20px 0;">Custom Price</div>
                    <ul style="text-align: left; list-style: none; padding: 0; margin: 30px 0;">
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Everything in Basic</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> University Application</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Visa Processing</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Test Preparation</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Pre & Post Arrival Support</li>
                    </ul>
                    <button class="btn btn-accent" style="width: 100%;" onclick="router('contact')">Contact Us</button>
                </div>

                <div class="dash-card" style="text-align: center; border: 2px solid var(--border); transition: 0.3s;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;">Premium Package</h3>
                    <div style="font-size: 2.5rem; color: var(--primary); font-weight: bold; margin: 20px 0;">Custom Price</div>
                    <ul style="text-align: left; list-style: none; padding: 0; margin: 30px 0;">
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Everything in Complete</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Priority Support</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Scholarship Assistance</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Extended Post-Arrival Support</li>
                        <li style="padding: 10px 0; border-bottom: 1px solid #eee;"><i class="fas fa-check" style="color: var(--success); margin-right: 10px;"></i> Career Counseling</li>
                    </ul>
                    <button class="btn" style="width: 100%;" onclick="router('contact')">Contact Us</button>
                </div>
            </div>
        </div>

        <!-- FAQ Section -->
        <div class="container marketing-section">
            <h2 class="section-title">Frequently Asked Questions</h2>
            <p class="section-subtitle">Get answers to common questions about our services</p>
            
            <div style="max-width: 800px; margin: 50px auto 0;">
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> How long does the application process take?</h3>
                    <p style="color: var(--text-light); margin: 0;">The timeline varies by country and university, but typically ranges from 3-6 months from application to visa approval. We'll provide you with a detailed timeline during your consultation.</p>
                </div>
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> What documents do I need to get started?</h3>
                    <p style="color: var(--text-light); margin: 0;">Basic documents include academic transcripts, passport, English test scores (if available), and financial documents. We'll provide a complete checklist during your initial consultation.</p>
                </div>
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> Do you help with scholarships?</h3>
                    <p style="color: var(--text-light); margin: 0;">Yes! We help identify scholarship opportunities and assist with scholarship applications. Our Premium package includes dedicated scholarship assistance.</p>
                </div>
                <div class="dash-card" style="margin-bottom: 20px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-question-circle" style="color: var(--accent); margin-right: 10px;"></i> What if my visa gets rejected?</h3>
                    <p style="color: var(--text-light); margin: 0;">While we maintain a 98% success rate, if a visa is rejected, we provide free reapplication support and help address the reasons for rejection to improve your chances.</p>
                </div>
            </div>
        </div>

        <!-- CTA Section -->
        <div class="container marketing-section" style="text-align: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 20px; padding: 60px 40px; color: white;">
            <h2 style="color: white; font-size: 2.5rem; margin-bottom: 20px;">Ready to Start Your Journey?</h2>
            <p style="color: rgba(255,255,255,0.9); font-size: 1.2rem; max-width: 600px; margin: 0 auto 40px;">
                Book a free consultation today and take the first step towards your dream education abroad
            </p>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-accent" onclick="router('auth', 'student')" style="font-size: 1.1rem; padding: 16px 40px;">Apply Now</button>
                <button class="btn btn-outline" onclick="router('contact')" style="font-size: 1.1rem; padding: 16px 40px;">Contact Us</button>
            </div>
        </div>
    </div>

    <!-- === CONTACT PAGE === -->
    <div id="page-contact" class="section">
        <div class="container">
            <div class="grid-2">
                <div>
                    <h1>Get in Touch</h1>
                    <p style="margin-bottom: 30px;">Visit our office in Kathmandu or send us a message.</p>
                    
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-map-marker-alt"></i> Head Office</h3>
                        <p>Putalisadak, Kathmandu, Nepal</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-phone"></i> Phone</h3>
                        <p>+977 1 4444444</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-envelope"></i> Email</h3>
                        <p>info@globaledunepal.com</p>
                    </div>
                </div>
                
                <div class="dash-card">
                    <h3>Send Message</h3>
                    <form id="contact-form" onsubmit="handleContactSubmit(event); return false;">
                        <input type="text" id="contact-name" placeholder="Full Name" required>
                        <input type="email" id="contact-email" placeholder="Email Address" required>
                        <textarea rows="4" id="contact-message" placeholder="How can we help?" required></textarea>
                        <button type="submit" class="btn" style="width: 100%;">Submit Inquiry</button>
                        <p id="contact-form-status" style="margin-top: 10px; display: none;"></p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- === AUTHENTICATION === -->
    <div id="page-auth" class="section">
        <div class="container" style="display: flex; justify-content: center;">
            <div class="dash-card" style="width: 100%; max-width: 450px; text-align: center; padding: 40px;">
                <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;">
                    <i class="fas fa-user-circle"></i>
                </div>
                <h2 id="auth-title">Login</h2>
                <p id="auth-subtitle">Welcome back</p>
                
                <div style="margin-top: 30px;">
                    <input type="email" id="auth-email" placeholder="Email Address">
                    <input type="password" id="auth-pass" placeholder="Password">
                    <p id="auth-error-msg" class="error-message"></p>
                    
                    <button class="btn" style="width: 100%; margin-bottom: 10px;" onclick="handleLogin()">Sign In</button>
                    <button class="btn btn-outline" style="width: 100%; color: var(--text-light); border-color: var(--border);" onclick="toggleSignupMode()" id="signup-toggle-btn">Create Account</button>
                    <button class="btn btn-success" style="width: 100%; margin-top: 10px; display: none;" id="signup-submit-btn" onclick="handleSignup()">Create Account</button>
                </div>

                <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                    <p style="font-size: 0.8rem; margin-bottom: 10px;">Preview Mode:</p>
                    <button class="btn btn-accent" style="width: 100%; margin-bottom: 15px;" onclick="startDemoMode()">
                        <i class="fas fa-flask"></i> Try Demo Mode (Skip Login)
                    </button>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 20px; font-size: 0.85rem;">
                        <p style="margin: 0 0 10px 0; font-weight: 600; color: #333;"><i class="fas fa-info-circle"></i> How to Login:</p>
                        <ul style="margin: 0; padding-left: 20px; color: #666;">
                            <li><strong>Students:</strong> Click "Create Account" → Sign up</li>
                            <li><strong>Counselors:</strong> Click "Create Account" → Sign up</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; color: #999; font-size: 0.8rem;">After signup, you'll be automatically logged in and routed to your portal.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === STUDENT DASHBOARD === -->
    <div id="page-student-dash" class="section" style="padding: 0;">
        <div class="dashboard-layout">
            <div class="dash-sidebar">
                <div style="margin-bottom: 40px;">
                    <h3 style="color: white;">Student Portal</h3>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">Manage your application</p>
                </div>
                <a class="dash-menu-item active" onclick="router('student')"><i class="fas fa-home"></i> Dashboard</a>
                <a class="dash-menu-item" id="student-side-app-link" onclick="router('student-apps')"><i class="fas fa-file-alt"></i> Application Form</a>
            </div>

            <div class="dash-main">
                <h2 style="margin-bottom: 30px;">Welcome, Student</h2>
                
                <!-- Profile Summary Card (Visible after submit) -->
                <div id="dash-profile-view" class="dash-card" style="display:none; margin-bottom: 25px; border-left: 5px solid var(--accent);">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <h3 style="margin-bottom: 5px; color: var(--primary);"><i class="fas fa-id-card-alt"></i> My Student Profile</h3>
                            <p style="margin:0; font-size:1.1rem; font-weight:600; color:var(--text-dark);" id="dash-full-name">Student Name</p>
                        </div>
                        <span class="status-badge status-submitted"><i class="fas fa-check-circle"></i> Application Submitted</span>
                    </div>
                    <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">
                    <div class="grid-2" style="gap: 20px;">
                        <div>
                            <p style="margin:5px 0;"><strong>Phone:</strong> <span id="dash-phone"></span></p>
                            <p style="margin:5px 0;"><strong>Address:</strong> <span id="dash-address"></span></p>
                        </div>
                        <div>
                            <p style="margin:5px 0;"><strong>Target Country:</strong> <span id="dash-target"></span></p>
                            <p style="margin:5px 0;"><strong>Intake:</strong> <span id="dash-intake-val"></span></p>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-sm btn-outline" style="color:var(--primary); border-color:var(--primary);" onclick="router('student-apps')"><i class="fas fa-edit"></i> Edit Profile</button>
                    </div>
                </div>

                <div class="grid-3" style="margin-bottom: 30px;">
                    <div class="dash-card" style="text-align:center;">
                        <i class="fas fa-globe-americas" style="font-size:2rem; color:var(--primary); margin-bottom:10px;"></i>
                        <h3 style="margin-bottom:0;" id="dash-countries-count">0</h3>
                        <p style="margin-top:0; font-size:0.9rem;">Countries Applied</p>
                    </div>
                    <div class="dash-card" style="text-align:center;">
                        <i class="fas fa-university" style="font-size:2rem; color:var(--accent); margin-bottom:10px;"></i>
                        <h3 style="margin-bottom:0;" id="dash-colleges-count">0</h3>
                        <p style="margin-top:0; font-size:0.9rem;">Colleges Selected</p>
                    </div>
                    <div class="dash-card" style="text-align:center;">
                        <i class="fas fa-user-tie" style="font-size:2rem; color:var(--success); margin-bottom:10px;"></i>
                        <h3 style="margin-bottom:0;" id="stu-match-status">Active</h3>
                        <p style="margin-top:0; font-size:0.9rem;">Counselor Status</p>
                    </div>
                </div>

                <div class="chat-wrapper">
                    <div class="chat-header">
                        <div style="width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div>
                            <strong style="display: block;">Your Counselor</strong>
                            <span style="font-size: 0.8rem; color: var(--success);">Online</span>
                        </div>
                    </div>
                    <div id="stu-chat-box" class="chat-body">
                        <div class="message msg-in">Namaste! How can I help you with your study abroad plans today?</div>
                    </div>
                    <div class="chat-footer">
                        <input type="text" id="stu-chat-input" placeholder="Type a message..." style="margin: 0; border: none; background: #f0f2f5; border-radius: 20px;" onkeypress="if(event.key === 'Enter') sendMessage('student')">
                        <button class="btn" style="border-radius: 50%; width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center;" onclick="sendMessage('student')"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === STUDENT APPLICATION FORM PAGE === -->
    <div id="page-student-apps" class="section" style="padding: 0;">
        <div class="dashboard-layout">
            <div class="dash-sidebar">
                <div style="margin-bottom: 40px;">
                    <h3 style="color: white;">Student Portal</h3>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">Manage your application</p>
                </div>
                <a class="dash-menu-item" onclick="router('student')"><i class="fas fa-home"></i> Dashboard</a>
                <a class="dash-menu-item active" onclick="router('student-apps')"><i class="fas fa-file-alt"></i> My Profile</a>
            </div>

            <div class="dash-main">
                <h2 style="margin-bottom: 30px;" id="app-page-title">Application Wizard</h2>
                
                <!-- WIZARD STEP INDICATOR -->
                <div id="wizard-steps" class="step-indicator">
                    <div class="step active" id="step-ind-1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Basic Info</div>
                    </div>
                    <div class="step" id="step-ind-2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Destination</div>
                    </div>
                    <div class="step" id="step-ind-3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Documents</div>
                    </div>
                </div>

                <div class="container" style="max-width: 800px; padding: 0;">
                    
                    <!-- Application Form View (Wizard) -->
                    <div id="app-form-view" class="dash-card">
                        
                        <!-- STEP 1 -->
                        <div id="wizard-step-1" class="wizard-content active">
                            <h3><i class="fas fa-user-edit"></i> Basic Information</h3>
                            <div style="margin-top: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <input type="text" placeholder="First Name" id="app-fname">
                                    <input type="text" placeholder="Last Name" id="app-lname">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <input type="date" placeholder="Date of Birth" id="app-dob">
                                    <select id="app-gender">
                                        <option value="" disabled selected>Gender</option>
                                        <option>Male</option>
                                        <option>Female</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <input type="text" placeholder="Citizenship" id="app-citizen">
                                <input type="text" placeholder="Phone Number" id="app-phone">
                                <input type="text" placeholder="Current Address" id="app-address">
                                
                                <div style="text-align: right; margin-top: 20px;">
                                    <button class="btn" onclick="goToStep(2)">Next: Study Preferences <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 2 -->
                        <div id="wizard-step-2" class="wizard-content">
                            <h3><i class="fas fa-globe"></i> Study Destination</h3>
                            <div style="margin-top: 20px;">
                                <label style="font-size: 0.9rem; font-weight: 600;">1. Select Target Country</label>
                                <select id="app-country" onchange="updateLocations()">
                                    <option value="" disabled selected>Choose Country...</option>
                                    <option value="Canada">Canada</option>
                                    <option value="USA">USA</option>
                                    <option value="Australia">Australia</option>
                                    <option value="UK">UK</option>
                                </select>

                                <label style="font-size: 0.9rem; font-weight: 600;">2. Select Location (State/Province)</label>
                                <select id="app-state" disabled onchange="updateUniversities()">
                                    <option value="" disabled selected>Select Country First</option>
                                </select>

                                <label style="font-size: 0.9rem; font-weight: 600;">3. Select University/College</label>
                                <select id="app-university" disabled onchange="handleAddUniversity()">
                                    <option value="" disabled selected>Select Location First</option>
                                </select>

                                <!-- SELECTED LIST -->
                                <div id="selected-universities-list" style="margin-top: 10px; min-height: 20px;"></div>

                                <label style="font-size: 0.9rem; font-weight: 600; margin-top: 15px; display: block;">4. Preferred Intake</label>
                                <select id="app-intake">
                                    <option value="" disabled selected>Select Intake Season</option>
                                    <option>Fall (Sept) 2025</option>
                                    <option>Winter (Jan) 2026</option>
                                    <option>Summer (May) 2026</option>
                                </select>

                                <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                                    <button class="btn btn-outline" style="color: var(--text-dark); border-color: #ddd;" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i> Back</button>
                                    <button class="btn" onclick="goToStep(3)">Next: Documents <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 3 -->
                        <div id="wizard-step-3" class="wizard-content">
                            <h3><i class="fas fa-cloud-upload-alt"></i> Upload Documents</h3>
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">Upload required documents for IRCC compliance. Ensure scans are clear.</p>
                            
                            <!-- Document Upload Grid -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; margin-bottom: 15px; font-weight: 600; font-size: 0.9rem; color: var(--text-dark); padding-bottom: 10px; border-bottom: 2px solid #ddd;">
                                    <div>Document Type</div>
                                    <div>Choose File(s)</div>
                                    <div style="text-align: center;">Action</div>
                                </div>
                                
                                <!-- Passport Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Passport (Front & Back)</div>
                                    <div>
                                        <input type="file" id="file-passport" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('passport', 'Passport')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- Transcript Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Academic Transcripts</div>
                                    <div>
                                        <input type="file" id="file-transcript" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('transcript', 'Transcript')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- IELTS/PTE Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">IELTS/PTE Score Card</div>
                                    <div>
                                        <input type="file" id="file-ielts" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('ielts', 'IELTS/PTE')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- Financial Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Financial Documents</div>
                                    <div>
                                        <input type="file" id="file-financial" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('financial', 'Financial')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- SOP Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid #e5e5e5;">
                                    <div style="font-weight: 500;">Statement of Purpose</div>
                                    <div>
                                        <input type="file" id="file-sop" class="doc-file-input" multiple accept=".pdf,.doc,.docx" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('sop', 'SOP')">Upload</button>
                                    </div>
                                </div>
                                
                                <!-- Other Documents Row -->
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: center; padding: 12px 0;">
                                    <div style="font-weight: 500;">Other Documents</div>
                                    <div>
                                        <input type="file" id="file-other" class="doc-file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt" style="width: 100%; border: 1px solid #ccc; background: white; padding: 8px; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <button class="btn btn-outline" style="padding: 8px 20px; font-size: 0.85rem; color: var(--primary); border-color: var(--primary);" onclick="handleUpload('other', 'Other')">Upload</button>
                                    </div>
                                </div>
                            </div>

                            <div id="stu-file-list" style="margin-bottom: 30px;">
                                <h4 style="font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">Uploaded Files</h4>
                                <div class="no-docs" style="color: #999; font-style: italic; font-size: 0.9rem;">No documents uploaded yet.</div>
                            </div>

                            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                                <button class="btn btn-outline" style="color: var(--text-dark); border-color: #ddd;" onclick="goToStep(2)"><i class="fas fa-arrow-left"></i> Back</button>
                                
                                <button id="btn-app-save" class="btn" onclick="saveApplication()">Preview Application</button>
                                <button id="btn-app-update" class="btn btn-success" style="display:none;" onclick="updateProfile()">Update Profile</button>
                            </div>
                        </div>

                    </div>

                    <!-- Preview View -->
                    <div id="app-preview-view" class="dash-card" style="display: none;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                            <h3>Application Review</h3>
                            <span id="preview-status-badge" class="status-badge status-draft">Draft</span>
                        </div>
                        <div id="preview-content"></div>
                        <div style="margin-top:20px; display:flex; gap:15px;">
                            <button class="btn btn-secondary" onclick="editApplication()"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-success" onclick="submitApplication()"><i class="fas fa-paper-plane"></i> Submit Application</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === COUNSELOR PORTAL === -->
    <div id="page-counselor-dash" class="section" style="padding: 0;">
        <div class="dashboard-layout">
            <div class="dash-sidebar">
                <div style="margin-bottom: 40px;">
                    <h3 style="color: white;">Counselor Panel</h3>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">Staff Access</p>
                </div>
                <a class="dash-menu-item" onclick="renderStudentList('active')">
                    <i class="fas fa-users"></i> Active Students
                    <span class="nav-badge-simple" id="nav-active-count"></span>
                </a>
                <a class="dash-menu-item" onclick="renderStudentList('inactive')">
                    <i class="fas fa-user-slash"></i> Inactive Students
                    <span class="nav-badge-simple" id="nav-inactive-count"></span>
                </a>
                <a class="dash-menu-item active" onclick="renderAvailableStudents()">
                    <i class="fas fa-user-check"></i> Available Students
                </a>
                <a class="dash-menu-item" onclick="renderStudentList('archived')">
                    <i class="fas fa-archive"></i> Archives
                </a>
            </div>

            <div class="dash-main">
                <div class="grid-2" style="grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div>
                        <div class="dash-card" style="padding: 0; overflow: hidden;">
                            <div style="padding: 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <h3 id="coun-list-header" style="margin:0;">Students</h3>
                                <div id="coun-list-actions">
                                    <button class="btn btn-sm btn-success" onclick="addStudent()"><i class="fas fa-plus"></i> Add</button>
                                </div>
                            </div>
                            <div id="coun-student-list" style="max-height: 600px; overflow-y: auto; padding: 10px;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <div>
                        <div id="coun-empty-state" class="dash-card" style="text-align: center; padding: 50px;">
                            <i class="fas fa-user-check" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3>Select Students to Assign</h3>
                            <p>Use the checkboxes to select students from the list, then click "Assign Selected" to add them to your student list.</p>
                            <p style="margin-top: 15px; font-size: 0.9rem; color: #999;">After assigning students, switch to "Active Students" to view and manage them.</p>
                        </div>

                        <div id="coun-interaction" style="display: none;">
                            <!-- Student Header Card -->
                            <div class="dash-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h2 id="coun-header-name" style="color: white; margin-bottom: 8px; font-size: 1.5rem;">
                                            <i class="fas fa-user-graduate" style="margin-right: 10px;"></i>Student Name
                                        </h2>
                                        <p id="coun-header-status" style="font-size: 0.95rem; color: rgba(255,255,255,0.9); margin: 0;">
                                            <i class="fas fa-envelope" style="margin-right: 5px;"></i>Email: N/A
                                        </p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: inline-block; margin-bottom: 5px;">
                                            <span id="cp-status-badge" style="font-size: 0.85rem; font-weight: 600;">Active</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin: 5px 0 0 0;">
                                            <i class="fas fa-calendar"></i> <span id="cp-last-updated">Recently Active</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                                
                            <!-- Tabs -->
                            <div class="dash-card" style="padding: 0;">
                                <div class="coun-tabs" style="border-bottom: 2px solid #eee;">
                                    <div class="coun-tab active" onclick="switchCounselorTab('profile')">
                                        <i class="fas fa-user-circle"></i> Profile
                                    </div>
                                    <div class="coun-tab" onclick="switchCounselorTab('docs')">
                                        <i class="fas fa-file-alt"></i> Documents
                                        <span id="cp-docs-count" style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                                    </div>
                                    <div class="coun-tab" onclick="switchCounselorTab('chat')">
                                        <i class="fas fa-comments"></i> Chat
                                    </div>
                                </div>

                                <!-- 1. PROFILE TAB -->
                                <div id="tab-profile" class="coun-content" style="padding: 25px;">
                                    <div style="margin-bottom: 25px;">
                                        <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 8px;">
                                            <i class="fas fa-info-circle"></i> Personal Information
                                        </h4>
                                    <div class="grid-2" style="gap: 20px;">
                                        <div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">Full Name</label>
                                                    <p style="margin: 0; font-weight: 600; color: var(--primary);" id="cp-fullname">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-phone"></i> Phone Number
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-phone">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-map-marker-alt"></i> Address
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-addr">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-birthday-cake"></i> Date of Birth
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-dob">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-venus-mars"></i> Gender
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-gender">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-id-card"></i> Citizenship
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-citizen">N/A</p>
                                                </div>
                                        </div>
                                        <div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-graduation-cap"></i> Education Level
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-edu">N/A</p>
                                        </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-globe"></i> Target Country
                                                    </label>
                                                    <p style="margin: 0; font-weight: 600; color: var(--primary); font-size: 1.1rem;" id="cp-target">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-map-pin"></i> Preferred Location
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-state">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-calendar-alt"></i> Preferred Intake
                                                    </label>
                                                    <p style="margin: 0; font-weight: 600; color: var(--accent);" id="cp-intake">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-university"></i> Selected Universities
                                                    </label>
                                                    <div id="cp-unis" style="margin-top: 8px;">
                                                        <span style="color: #999; font-style: italic;">None selected</span>
                                                    </div>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px;">
                                                        <i class="fas fa-file-check"></i> Application Status
                                                    </label>
                                                    <p style="margin: 0; font-weight: 500;" id="cp-status">N/A</p>
                                                </div>
                                                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                                    <label style="font-size: 0.85rem; color: #666; display: block; margin-bottom: 8px;">
                                                        <i class="fas fa-flag-checkered"></i> Milestone
                                                    </label>
                                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                                        <select id="cp-milestone-select" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                                            <option value="">No Milestone</option>
                                                            <option value="Joined">Joined</option>
                                                            <option value="IELTS Completed">IELTS Completed</option>
                                                            <option value="Applied for College">Applied for College</option>
                                                            <option value="Offer Letter Approved">Offer Letter Approved</option>
                                                            <option value="Offer Letter Denied">Offer Letter Denied</option>
                                                            <option value="Visa Applied">Visa Applied</option>
                                                            <option value="Visa Approved">Visa Approved</option>
                                                            <option value="Visa Denied">Visa Denied</option>
                                                        </select>
                                                        <button class="btn btn-sm btn-primary" onclick="updateStudentMilestone()" style="padding: 8px 15px;">
                                                            <i class="fas fa-save"></i> Update
                                                        </button>
                                                    </div>
                                                    <div id="cp-current-milestone" style="margin-top: 8px; font-size: 0.85rem; color: #666;"></div>
                                                </div>
                                                    <p style="margin: 0;">
                                                        <span id="cp-app-status" class="status-badge status-draft">Draft</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. DOCUMENTS TAB -->
                                <div id="tab-docs" class="coun-content" style="display: none; padding: 25px;">
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 8px;">
                                            <i class="fas fa-file-upload"></i> Student Documents
                                        </h4>
                                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">All documents uploaded by the student are listed below.</p>
                                    </div>
                                    <div id="cp-docs-list">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                            <p style="font-style: italic;">No documents uploaded.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- 3. CHAT TAB -->
                                <div id="tab-chat" class="coun-content" style="display: none; padding: 0;">
                                    <div class="chat-wrapper" style="height: 500px;">
                                        <div class="chat-header" style="background: var(--primary); color: white;">
                                            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-user-graduate"></i>
                                            </div>
                                            <div>
                                                <strong style="display: block; color: white;">Chat with <span id="coun-chat-student-name">Student</span></strong>
                                                <span style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">
                                                    <i class="fas fa-circle" style="font-size: 0.5rem; color: var(--success);"></i> Online
                                                </span>
                                            </div>
                                        </div>
                                        <div id="coun-chat-box" class="chat-body" style="background: #f8f9fa;">
                                            <div class="message msg-in">
                                                <strong>System:</strong> Chat history will appear here. Start a conversation with the student!
                                            </div>
                                        </div>
                                        <div class="chat-footer" style="background: white;">
                                            <input type="text" id="coun-chat-input" placeholder="Type your message..." style="margin: 0; border: 1px solid #ddd; background: #f0f2f5; border-radius: 20px; padding: 10px 15px;" onkeypress="if(event.key === 'Enter') sendMessage('counselor')">
                                            <button class="btn" style="border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; align-items: center; justify-content: center; background: var(--primary);" onclick="sendMessage('counselor')" title="Send message">
                                                <i class="fas fa-paper-plane" style="color: white;"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === ADMIN PORTAL === -->
    <div id="page-admin-dash" class="section" style="padding: 0;">
        <div class="dashboard-layout">
            <div class="dash-sidebar">
                <div style="margin-bottom: 40px;">
                    <h3 style="color: white;">Admin Panel</h3>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">Administrator Access</p>
                </div>
                <a class="dash-menu-item" id="back-to-counselor-link" onclick="showAdminView('dashboard')" style="display: none;"><i class="fas fa-arrow-left"></i> Back to Counselor Panel</a>
                <a class="dash-menu-item active" onclick="showAdminView('dashboard')" id="admin-menu-dashboard"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('all')" id="admin-menu-users"><i class="fas fa-users"></i> All Users</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('students')" id="admin-menu-students"><i class="fas fa-user-graduate"></i> Students</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('counselors')" id="admin-menu-counselors"><i class="fas fa-user-tie"></i> Counselors</a>
                <a class="dash-menu-item" onclick="renderAdminUsers('admins')" id="admin-menu-admins"><i class="fas fa-user-shield"></i> Admins</a>
                <a class="dash-menu-item" onclick="showAdminView('analytics')" id="admin-menu-analytics"><i class="fas fa-chart-bar"></i> Analytics</a>
                <a class="dash-menu-item" onclick="showAdminView('activity')" id="admin-menu-activity"><i class="fas fa-history"></i> Activity Logs</a>
                <a class="dash-menu-item" onclick="showAdminView('contacts')" id="admin-menu-contacts"><i class="fas fa-envelope"></i> Contact Messages</a>
            </div>

            <div class="dash-main">
                <!-- DASHBOARD VIEW -->
                <div id="admin-dashboard-view" style="display: block;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
                        <p style="color: #666;">Overview of system statistics and recent activity</p>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid-4" style="margin-bottom: 30px; gap: 20px;">
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #007bff;">
                            <div style="font-size: 2.5rem; color: #007bff; margin-bottom: 10px;">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-total">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Total Users</p>
                        </div>
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #28a745;">
                            <div style="font-size: 2.5rem; color: #28a745; margin-bottom: 10px;">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-students">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Students</p>
                        </div>
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #ffc107;">
                            <div style="font-size: 2.5rem; color: #ffc107; margin-bottom: 10px;">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-counselors">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Counselors</p>
                        </div>
                        <div class="dash-card" style="text-align: center; border-left: 4px solid #dc3545;">
                            <div style="font-size: 2.5rem; color: #dc3545; margin-bottom: 10px;">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <h3 style="margin: 0; font-size: 2rem;" id="admin-stat-admins">0</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">Admins</p>
                        </div>
                    </div>

                    <!-- Additional Stats -->
                    <div class="grid-2" style="margin-bottom: 30px; gap: 20px;">
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-chart-pie"></i> User Distribution</h3>
                            <div id="admin-chart-container" style="height: 250px; display: flex; align-items: center; justify-content: center; color: #999;">
                                <div id="admin-pie-chart" style="width: 100%; height: 100%;"></div>
                            </div>
                        </div>
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-calendar-alt"></i> Recent Activity</h3>
                            <div id="admin-recent-activity" style="max-height: 250px; overflow-y: auto;">
                                <div style="text-align: center; padding: 20px; color: #999;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="dash-card">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-bolt"></i> Quick Actions</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="showCreateUserModal()"><i class="fas fa-user-plus"></i> Create User</button>
                            <button class="btn btn-primary" onclick="showAdminView('users')"><i class="fas fa-users"></i> Manage Users</button>
                            <button class="btn btn-info" onclick="exportUsersData()"><i class="fas fa-download"></i> Export Data</button>
                            <button class="btn btn-warning" onclick="showAdminView('analytics')"><i class="fas fa-chart-bar"></i> View Analytics</button>
                        </div>
                    </div>
                </div>

                <!-- USERS MANAGEMENT VIEW -->
                <div id="admin-users-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin-bottom: 10px;">User Management</h2>
                                <p style="color: #666; margin: 0;">Manage user roles, create profiles, and assign counselors to students.</p>
                            </div>
                            <button class="btn btn-success" onclick="showCreateUserModal()"><i class="fas fa-user-plus"></i> Create New User</button>
                        </div>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <div style="flex: 1; min-width: 200px;">
                                <input type="text" id="admin-search-users" placeholder="Search by name, email..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onkeyup="filterAdminUsers()">
                            </div>
                            <select id="admin-filter-role" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterAdminUsers()">
                                <option value="all">All Roles</option>
                                <option value="student">Students</option>
                                <option value="counselor">Counselors</option>
                                <option value="admin">Admins</option>
                            </select>
                            <select id="admin-filter-status" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterAdminUsers()">
                                <option value="all">All Status</option>
                                <option value="Draft">Draft</option>
                                <option value="Submitted">Submitted</option>
                                <option value="In Review">In Review</option>
                            </select>
                            <button class="btn btn-outline" onclick="clearAdminFilters()"><i class="fas fa-times"></i> Clear</button>
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="dash-card" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; display: none;" id="admin-bulk-actions">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span id="admin-selected-count" style="font-weight: 600; color: #007bff;">0 users selected</span>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-sm btn-danger" onclick="bulkDeleteUsers()"><i class="fas fa-trash"></i> Delete Selected</button>
                                <button class="btn btn-sm btn-primary" onclick="bulkAssignCounselor()"><i class="fas fa-user-tie"></i> Assign Counselor</button>
                                <button class="btn btn-sm btn-outline" onclick="clearUserSelection()"><i class="fas fa-times"></i> Clear Selection</button>
                            </div>
                        </div>
                    </div>

                    <div class="dash-card" style="padding: 0;">
                        <div style="padding: 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <h3 id="admin-list-header" style="margin:0;">All Users</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="admin-select-all" onchange="toggleSelectAllUsers()">
                                    <span style="font-size: 0.9rem;">Select All</span>
                                </label>
                            </div>
                        </div>
                        <div id="admin-users-list" style="max-height: 600px; overflow-y: auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ANALYTICS VIEW -->
                <div id="admin-analytics-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> Analytics & Reports</h2>
                        <p style="color: #666;">Detailed insights and statistics</p>
                    </div>

                    <div class="grid-2" style="margin-bottom: 20px; gap: 20px;">
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-user-plus"></i> New Users (Last 30 Days)</h3>
                            <div id="admin-new-users-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #999;">
                                Loading chart...
                            </div>
                        </div>
                        <div class="dash-card">
                            <h3 style="margin-bottom: 15px;"><i class="fas fa-file-alt"></i> Application Status</h3>
                            <div id="admin-status-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #999;">
                                Loading chart...
                            </div>
                        </div>
                    </div>

                    <div class="dash-card">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-table"></i> Detailed Statistics</h3>
                        <div id="admin-detailed-stats" style="overflow-x: auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- ACTIVITY LOGS VIEW -->
                <div id="admin-activity-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-history"></i> Activity Logs</h2>
                        <p style="color: #666;">Track system activities and user actions</p>
                    </div>

                    <div class="dash-card" style="padding: 0;">
                        <div style="padding: 20px; background: #fff; border-bottom: 1px solid #eee;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <input type="date" id="activity-date-from" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <input type="date" id="activity-date-to" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <select id="activity-filter-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="all">All Activities</option>
                                    <option value="user_created">User Created</option>
                                    <option value="user_updated">User Updated</option>
                                    <option value="user_deleted">User Deleted</option>
                                    <option value="login">Login</option>
                                </select>
                                <button class="btn btn-primary" onclick="loadActivityLogs()"><i class="fas fa-filter"></i> Filter</button>
                            </div>
                        </div>
                        <div id="admin-activity-logs" style="max-height: 600px; overflow-y: auto; padding: 20px;">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Loading activity logs...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONTACT MESSAGES VIEW -->
                <div id="admin-contacts-view" style="display: none;">
                    <div class="dash-card" style="margin-bottom: 20px;">
                        <h2 style="margin-bottom: 10px;"><i class="fas fa-envelope"></i> Contact Messages</h2>
                        <p style="color: #666;">View and respond to inquiries from the contact page</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 250px);">
                        <!-- Messages List -->
                        <div class="dash-card" style="padding: 0; overflow-y: auto;">
                            <div style="padding: 15px; border-bottom: 1px solid #eee; background: #f8f9fa;">
                                <input type="text" id="contact-search" placeholder="Search messages..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onkeyup="filterContactMessages(this.value)">
                            </div>
                            <div id="contact-messages-list" style="padding: 10px;">
                                <div style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <p>Loading messages...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat View -->
                        <div class="dash-card" style="padding: 0; display: flex; flex-direction: column; height: 100%;">
                            <div id="contact-chat-empty" style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #999;">
                                <i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                                <p style="font-size: 1.1rem;">Select a message to start chatting</p>
                            </div>
                            
                            <div id="contact-chat-view" style="display: none; flex: 1; flex-direction: column; height: 100%;">
                                <!-- Chat Header -->
                                <div style="padding: 20px; border-bottom: 1px solid #eee; background: #f8f9fa;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h3 style="margin: 0; color: var(--primary);" id="contact-chat-name">Contact Name</h3>
                                            <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;" id="contact-chat-email">email@example.com</p>
                                        </div>
                                        <div>
                                            <span class="status-badge" id="contact-chat-status" style="background: #d1e7dd; color: #0f5132;">New</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chat Body -->
                                <div id="contact-chat-body" style="flex: 1; padding: 20px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 15px;">
                                    <!-- Messages will be loaded here -->
                                </div>

                                <!-- Chat Footer -->
                                <div style="padding: 15px; border-top: 1px solid #eee; background: #f8f9fa;">
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="contact-chat-input" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px;" onkeypress="if(event.key === 'Enter') sendContactReply()">
                                        <button class="btn" onclick="sendContactReply()" style="padding: 12px 24px;">
                                            <i class="fas fa-paper-plane"></i> Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE USER MODAL -->
    <div id="create-user-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Create New User</h3>
                <button class="modal-close" onclick="closeCreateUserModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email Address</label>
                    <input type="email" id="create-user-email" placeholder="user@example.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Password</label>
                    <input type="password" id="create-user-password" placeholder="Minimum 6 characters" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role</label>
                    <select id="create-user-role" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="student">Student</option>
                        <option value="counselor">Counselor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">First Name</label>
                    <input type="text" id="create-user-fname" placeholder="First Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Last Name</label>
                    <input type="text" id="create-user-lname" placeholder="Last Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="createNewUser()"><i class="fas fa-check"></i> Create User</button>
            </div>
        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div id="edit-user-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit User</h3>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="edit-user-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email Address</label>
                    <input type="email" id="edit-user-email" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role</label>
                    <select id="edit-user-role" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="student">Student</option>
                        <option value="counselor">Counselor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">First Name</label>
                    <input type="text" id="edit-user-fname" placeholder="First Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Last Name</label>
                    <input type="text" id="edit-user-lname" placeholder="Last Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div id="edit-student-counselor" style="margin-bottom: 20px; display: none;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Assigned Counselor</label>
                    <select id="edit-user-counselor" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">None (Not Assigned - Counselors will choose)</option>
                    </select>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> Leave as "None" to let counselors choose students from the Available Students list.
                    </p>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveUserChanges()"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, increment, limit, onSnapshot, orderBy, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

        console.log('Main script loaded, Firebase imports successful');

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCupkWcEuM27tZojhPahJj3g6LAUSn15gs",
            authDomain: "intedu-2595c.firebaseapp.com",
            projectId: "intedu-2595c",
            storageBucket: "intedu-2595c.firebasestorage.app",
            messagingSenderId: "713959040536",
            appId: "1:713959040536:web:3b0d9d34696aeee049c56d"
        };

        let app, auth, db, storage, isDemoMode = false;
        let currentApplication = { status: 'Draft' };
        
        // --- COUNSELOR DATA (Loaded from Database) ---
        let counselorStudents = []; // All students loaded from Firebase
        let currentStudentId = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            console.log("Firebase initialized");
        } catch(e) { console.warn("Firebase Init Error", e); }

        // Seed admin user in Firebase
        window.seedAdminUser = async function() {
            if (!auth || !db) {
                console.warn("Firebase not initialized, cannot seed admin user");
                return;
            }

            const ADMIN_EMAIL = 'admin@gmail.com';
            const ADMIN_PASSWORD = 'admin123';

            try {
                // Sign out any existing user first
                const currentUser = auth.currentUser;
                if(currentUser) {
                    await signOut(auth);
                }

                // Try to sign in first to check if user exists
                let userCredential;
                try {
                    userCredential = await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                    console.log("Admin user already exists in Firebase Auth");
                } catch(signInError) {
                    // If user doesn't exist, create it
                    if(signInError.code === 'auth/user-not-found') {
                        console.log("Creating admin user in Firebase Auth...");
                        userCredential = await createUserWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                        console.log("Admin user created successfully in Firebase Auth");
                    } else {
                        console.warn("Error checking admin user:", signInError);
                        return;
                    }
                }

                const user = userCredential.user;

                // Ensure admin user document exists in Firestore
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(!userDoc.exists()) {
                    console.log("Creating admin user document in Firestore...");
                    await setDoc(doc(db, "users", user.uid), {
                        email: ADMIN_EMAIL,
                        role: 'admin',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    console.log("Admin user document created in Firestore");
                } else {
                    const userData = userDoc.data();
                    if(userData.role !== 'admin') {
                        console.log("Updating user role to admin in Firestore...");
                        await updateDoc(doc(db, "users", user.uid), {
                            role: 'admin',
                            updatedAt: new Date().toISOString()
                        });
                        console.log("Admin role updated in Firestore");
                    } else {
                        console.log("Admin user document already exists with correct role");
                    }
                }

                // Sign out after seeding (user will sign in when they login)
                await signOut(auth);
                console.log("Admin user seeded successfully");
            } catch(err) {
                console.error("Error seeding admin user:", err);
            }
        };

        // Auto-seed admin user when Firebase is ready
        if(auth && db) {
            // Wait a bit for Firebase to be fully ready
            setTimeout(() => {
                seedAdminUser();
            }, 1000);
        }

        window.currentRole = '';

        // --- UNIVERSITY DATA ---
        const universityData = {
            "Canada": {
                "Ontario": [
                    "University of Toronto",
                    "University of Waterloo",
                    "McMaster University",
                    "Western University",
                    "Queen's University",
                    "University of Ottawa",
                    "York University",
                    "Ryerson University",
                    "University of Guelph",
                    "Carleton University",
                    "Seneca College",
                    "Humber College",
                    "George Brown College",
                    "Centennial College",
                    "Sheridan College",
                    "Fanshawe College",
                    "Conestoga College",
                    "Algonquin College"
                ],
                "British Columbia": [
                    "University of British Columbia (UBC)",
                    "Simon Fraser University (SFU)",
                    "University of Victoria",
                    "British Columbia Institute of Technology (BCIT)",
                    "Capilano University",
                    "Kwantlen Polytechnic University",
                    "Langara College",
                    "Douglas College",
                    "Vancouver Community College",
                    "Camosun College"
                ],
                "Alberta": [
                    "University of Alberta",
                    "University of Calgary",
                    "Mount Royal University",
                    "MacEwan University",
                    "SAIT Polytechnic",
                    "NAIT (Northern Alberta Institute of Technology)",
                    "Bow Valley College",
                    "Lethbridge College"
                ],
                "Quebec": [
                    "McGill University",
                    "Université de Montréal",
                    "Concordia University",
                    "Université Laval",
                    "HEC Montréal",
                    "École Polytechnique de Montréal",
                    "Dawson College",
                    "Vanier College",
                    "John Abbott College",
                    "Cégep de Maisonneuve"
                ],
                "Manitoba": [
                    "University of Manitoba",
                    "University of Winnipeg",
                    "Red River College",
                    "Assiniboine Community College",
                    "Manitoba Institute of Trades and Technology"
                ],
                "Saskatchewan": [
                    "University of Saskatchewan",
                    "University of Regina",
                    "Saskatchewan Polytechnic",
                    "Cumberland College"
                ],
                "Nova Scotia": [
                    "Dalhousie University",
                    "Saint Mary's University",
                    "Acadia University",
                    "Nova Scotia Community College (NSCC)",
                    "Mount Saint Vincent University"
                ],
                "New Brunswick": [
                    "University of New Brunswick",
                    "Mount Allison University",
                    "St. Thomas University",
                    "New Brunswick Community College"
                ],
                "Newfoundland and Labrador": [
                    "Memorial University of Newfoundland",
                    "College of the North Atlantic"
                ],
                "Prince Edward Island": [
                    "University of Prince Edward Island",
                    "Holland College"
                ]
            },
            "USA": {
                "California": [
                    "Stanford University",
                    "University of California, Berkeley (UC Berkeley)",
                    "University of California, Los Angeles (UCLA)",
                    "University of Southern California (USC)",
                    "California Institute of Technology (Caltech)",
                    "University of California, San Diego (UCSD)",
                    "University of California, Davis (UC Davis)",
                    "University of California, Irvine (UCI)",
                    "University of California, Santa Barbara (UCSB)",
                    "San Francisco State University",
                    "California State University, Long Beach",
                    "California State University, Fullerton",
                    "San Jose State University",
                    "Santa Monica College",
                    "De Anza College",
                    "Pasadena City College"
                ],
                "New York": [
                    "Columbia University",
                    "New York University (NYU)",
                    "Cornell University",
                    "University of Rochester",
                    "Syracuse University",
                    "Fordham University",
                    "Stony Brook University",
                    "City University of New York (CUNY)",
                    "State University of New York (SUNY)",
                    "Rensselaer Polytechnic Institute",
                    "Rochester Institute of Technology",
                    "Baruch College",
                    "Hunter College",
                    "Queens College"
                ],
                "Massachusetts": [
                    "Harvard University",
                    "Massachusetts Institute of Technology (MIT)",
                    "Boston University",
                    "Northeastern University",
                    "Boston College",
                    "Tufts University",
                    "University of Massachusetts Amherst",
                    "Brandeis University",
                    "Worcester Polytechnic Institute",
                    "Bunker Hill Community College"
                ],
                "Texas": [
                    "University of Texas at Austin",
                    "Texas A&M University",
                    "Rice University",
                    "University of Houston",
                    "Texas Tech University",
                    "Baylor University",
                    "Southern Methodist University",
                    "Austin Community College",
                    "Houston Community College"
                ],
                "Illinois": [
                    "University of Chicago",
                    "Northwestern University",
                    "University of Illinois at Urbana-Champaign",
                    "Illinois Institute of Technology",
                    "DePaul University",
                    "Loyola University Chicago",
                    "City Colleges of Chicago"
                ],
                "Florida": [
                    "University of Florida",
                    "Florida State University",
                    "University of Miami",
                    "University of Central Florida",
                    "Florida International University",
                    "Miami Dade College",
                    "Valencia College"
                ],
                "Pennsylvania": [
                    "University of Pennsylvania",
                    "Carnegie Mellon University",
                    "Penn State University",
                    "Temple University",
                    "Drexel University",
                    "University of Pittsburgh",
                    "Community College of Philadelphia"
                ],
                "Michigan": [
                    "University of Michigan",
                    "Michigan State University",
                    "Wayne State University",
                    "Oakland University",
                    "Washtenaw Community College"
                ],
                "Washington": [
                    "University of Washington",
                    "Washington State University",
                    "Seattle University",
                    "Bellevue College",
                    "Shoreline Community College"
                ],
                "Arizona": [
                    "Arizona State University",
                    "University of Arizona",
                    "Northern Arizona University",
                    "Maricopa Community Colleges"
                ],
                "Georgia": [
                    "Georgia Institute of Technology",
                    "Emory University",
                    "University of Georgia",
                    "Georgia State University",
                    "Georgia Perimeter College"
                ],
                "North Carolina": [
                    "Duke University",
                    "University of North Carolina at Chapel Hill",
                    "North Carolina State University",
                    "Wake Forest University"
                ]
            },
            "Australia": {
                "New South Wales": [
                    "University of Sydney",
                    "University of New South Wales (UNSW)",
                    "Macquarie University",
                    "University of Technology Sydney (UTS)",
                    "Western Sydney University",
                    "University of Wollongong",
                    "Australian Catholic University",
                    "TAFE NSW",
                    "Sydney Institute of Technology",
                    "Navitas English"
                ],
                "Victoria": [
                    "University of Melbourne",
                    "Monash University",
                    "RMIT University",
                    "Deakin University",
                    "La Trobe University",
                    "Swinburne University of Technology",
                    "Victoria University",
                    "TAFE Victoria",
                    "Holmesglen Institute",
                    "Box Hill Institute"
                ],
                "Queensland": [
                    "University of Queensland (UQ)",
                    "Queensland University of Technology (QUT)",
                    "Griffith University",
                    "James Cook University",
                    "Bond University",
                    "TAFE Queensland",
                    "Southbank Institute of Technology"
                ],
                "Western Australia": [
                    "University of Western Australia (UWA)",
                    "Curtin University",
                    "Murdoch University",
                    "Edith Cowan University",
                    "TAFE Western Australia"
                ],
                "South Australia": [
                    "University of Adelaide",
                    "Flinders University",
                    "University of South Australia",
                    "TAFE South Australia"
                ],
                "Tasmania": [
                    "University of Tasmania",
                    "TAFE Tasmania"
                ],
                "Australian Capital Territory": [
                    "Australian National University (ANU)",
                    "University of Canberra",
                    "Canberra Institute of Technology"
                ],
                "Northern Territory": [
                    "Charles Darwin University",
                    "Batchelor Institute of Indigenous Tertiary Education"
                ]
            },
            "UK": {
                "England - London": [
                    "Imperial College London",
                    "University College London (UCL)",
                    "King's College London",
                    "London School of Economics (LSE)",
                    "Queen Mary University of London",
                    "City, University of London",
                    "Birkbeck, University of London",
                    "Goldsmiths, University of London",
                    "Royal Holloway, University of London",
                    "Brunel University London",
                    "University of Westminster",
                    "London Metropolitan University",
                    "Middlesex University",
                    "University of East London"
                ],
                "England - Oxford": [
                    "University of Oxford",
                    "Oxford Brookes University"
                ],
                "England - Cambridge": [
                    "University of Cambridge",
                    "Anglia Ruskin University"
                ],
                "England - Manchester": [
                    "University of Manchester",
                    "Manchester Metropolitan University"
                ],
                "England - Birmingham": [
                    "University of Birmingham",
                    "Aston University",
                    "Birmingham City University"
                ],
                "England - Leeds": [
                    "University of Leeds",
                    "Leeds Beckett University"
                ],
                "England - Liverpool": [
                    "University of Liverpool",
                    "Liverpool John Moores University"
                ],
                "England - Bristol": [
                    "University of Bristol",
                    "University of the West of England"
                ],
                "England - Newcastle": [
                    "Newcastle University",
                    "Northumbria University"
                ],
                "England - Sheffield": [
                    "University of Sheffield",
                    "Sheffield Hallam University"
                ],
                "England - Nottingham": [
                    "University of Nottingham",
                    "Nottingham Trent University"
                ],
                "England - York": [
                    "University of York",
                    "York St John University"
                ],
                "England - Durham": [
                    "Durham University",
                    "Teesside University"
                ],
                "England - Southampton": [
                    "University of Southampton",
                    "Southampton Solent University"
                ],
                "England - Warwick": [
                    "University of Warwick",
                    "Coventry University"
                ],
                "Scotland": [
                    "University of Edinburgh",
                    "University of Glasgow",
                    "University of St Andrews",
                    "University of Aberdeen",
                    "Heriot-Watt University",
                    "University of Strathclyde",
                    "Edinburgh Napier University",
                    "Glasgow Caledonian University",
                    "Robert Gordon University",
                    "Abertay University"
                ],
                "Wales": [
                    "Cardiff University",
                    "Swansea University",
                    "Bangor University",
                    "Aberystwyth University",
                    "University of South Wales"
                ],
                "Northern Ireland": [
                    "Queen's University Belfast",
                    "Ulster University"
                ]
            }
        };

        // --- HELPERS ---
        function showAuthError(msg) {
            const errBox = document.getElementById('auth-error-msg');
            if(msg && msg.trim()) {
                errBox.innerText = msg;
                errBox.style.display = 'block';
            } else {
                errBox.innerText = '';
                errBox.style.display = 'none';
            }
        }

        // --- WIZARD LOGIC (FIXED) ---
        let currentStep = 1;
        window.goToStep = async function(n) {
            try {
            // Validate step 1 if moving forward
            if(n === 2 && currentStep === 1) {
                    const fname = document.getElementById('app-fname');
                    const lname = document.getElementById('app-lname');
                    const phone = document.getElementById('app-phone');
                    if(!fname || !lname || !phone) {
                        console.error('Form fields not found');
                        return;
                    }
                    if(!fname.value || !lname.value || !phone.value) {
                        showWarning("Please fill in First Name, Last Name and Phone Number.");
                        return;
                    }
                }
                
                // Save current step data before moving (both forward and backward)
                await saveFormDataIncrementally();
                
                // Switch tabs - remove inline display styles and use CSS classes
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = ''; // Remove inline display style to let CSS handle it
                });
                const targetStep = document.getElementById('wizard-step-' + n);
                if(!targetStep) {
                    console.error('Step element not found: wizard-step-' + n);
                    return;
                }
                targetStep.classList.add('active');
                targetStep.style.display = ''; // Ensure no inline style blocks CSS
            
            // Update Indicators
            document.querySelectorAll('.step').forEach((el, index) => {
                const stepNum = index + 1;
                el.classList.remove('active', 'completed');
                if(stepNum < n) el.classList.add('completed');
                if(stepNum === n) el.classList.add('active');
            });
            currentStep = n;
                
                // If moving to step 2, restore country selection and update locations
                if(n === 2 && currentApplication.country) {
                    const countrySel = document.getElementById('app-country');
                    const stateSel = document.getElementById('app-state');
                    if(countrySel && currentApplication.country) {
                        countrySel.value = currentApplication.country;
                        updateLocations();
                        // Restore state selection if available
                        if(currentApplication.state && stateSel) {
                            setTimeout(() => {
                                stateSel.value = currentApplication.state;
                                updateUniversities();
                            }, 100);
                        }
                    }
                }
            } catch(error) {
                console.error('Error in goToStep:', error);
                showError('An error occurred. Please try again.');
            }
        };

        // --- STUDENT FORM LOGIC ---
        window.updateLocations = function() {
            const country = document.getElementById('app-country').value;
            const stateSel = document.getElementById('app-state');
            const uniSel = document.getElementById('app-university');
            
            stateSel.innerHTML = '<option value="" disabled selected>Choose Location...</option>';
            uniSel.innerHTML = '<option value="" disabled selected>Select Location First</option>';
            uniSel.disabled = true;

            if (universityData[country]) {
                stateSel.disabled = false;
                Object.keys(universityData[country]).forEach(state => {
                    stateSel.innerHTML += `<option value="${state}">${state}</option>`;
                });
            }
        };

        window.updateUniversities = function() {
            const country = document.getElementById('app-country').value;
            const state = document.getElementById('app-state').value;
            const uniSel = document.getElementById('app-university');

            uniSel.innerHTML = '<option value="" disabled selected>Choose University...</option>';
            if (universityData[country] && universityData[country][state]) {
                uniSel.disabled = false;
                universityData[country][state].forEach(uni => uniSel.innerHTML += `<option value="${uni}">${uni}</option>`);
            }
        };

        let selectedUnis = [];
        window.handleAddUniversity = function() {
            const uniSel = document.getElementById('app-university');
            const uni = uniSel.value;
            if (!uni || selectedUnis.includes(uni)) return;
            selectedUnis.push(uni);
            updateSelectedList();
            uniSel.value = "";
        };

        window.removeUni = function(uni) {
            selectedUnis = selectedUnis.filter(u => u !== uni);
            updateSelectedList();
        };

        function updateSelectedList() {
            const list = document.getElementById('selected-universities-list');
            list.innerHTML = selectedUnis.map(u => 
                `<span class="uni-tag">${u} <i class="fas fa-times" onclick="removeUni('${u}')"></i></span>`
            ).join('');
            document.getElementById('dash-colleges-count').innerText = selectedUnis.length;
        }

        // Function to collect current form data
        function collectFormData() {
            // Convert uploadedFiles object to array format for database storage
            let docsArray = [];
            Object.keys(uploadedFiles).forEach(docType => {
                uploadedFiles[docType].forEach(file => {
                    // Include all file metadata fields, especially for chunked files
                    const fileDoc = {
                        id: file.id || `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        type: docType,
                        name: file.name,
                        size: file.size,
                        fileType: file.type || null,
                        uploadedAt: file.uploadedAt || new Date().toISOString(),
                        downloadURL: file.downloadURL || null, // Include Firebase Storage download URL
                        storagePath: file.storagePath || null, // Include storage path for reference
                        // Chunked file fields
                        isChunked: file.isChunked || false,
                        chunkCount: file.chunkCount || null,
                        chunkedFileId: file.chunkedFileId || null
                    };
                    docsArray.push(fileDoc);
                });
            });
            
            return {
                fname: document.getElementById('app-fname')?.value || '',
                lname: document.getElementById('app-lname')?.value || '',
                dob: document.getElementById('app-dob')?.value || '',
                gender: document.getElementById('app-gender')?.value || '',
                citizen: document.getElementById('app-citizen')?.value || '',
                phone: document.getElementById('app-phone')?.value || '',
                address: document.getElementById('app-address')?.value || '',
                country: document.getElementById('app-country')?.value || '',
                state: document.getElementById('app-state')?.value || '',
                intake: document.getElementById('app-intake')?.value || '',
                universities: selectedUnis,
                docs: docsArray, // Include documents in form data
                lastStep: currentStep, // Track which step they were on
                status: currentApplication.status || 'Draft',
                updatedAt: new Date().toISOString()
            };
        }

        // Function to save data incrementally
        async function saveFormDataIncrementally() {
            const formData = collectFormData();
            currentApplication = { ...currentApplication, ...formData };
            
            // SAVE TO FIRESTORE
            if(auth && auth.currentUser && !isDemoMode) {
                try {
                    await setDoc(doc(db, "users", auth.currentUser.uid), currentApplication, { merge: true });
                    console.log('Form data saved successfully');
                } catch(e) { 
                    console.error("Save error", e); 
                }
            } else if(isDemoMode) {
                localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                console.log('Form data saved to localStorage (demo mode)');
            }
        }

        // Function to load and populate form data
        function loadFormData() {
            if(!currentApplication || Object.keys(currentApplication).length === 0) return;
            
            // Step 1 fields - check if elements exist before setting values
            const fnameEl = document.getElementById('app-fname');
            const lnameEl = document.getElementById('app-lname');
            const dobEl = document.getElementById('app-dob');
            const genderEl = document.getElementById('app-gender');
            const citizenEl = document.getElementById('app-citizen');
            const phoneEl = document.getElementById('app-phone');
            const addressEl = document.getElementById('app-address');
            
            if(fnameEl && currentApplication.fname) fnameEl.value = currentApplication.fname;
            if(lnameEl && currentApplication.lname) lnameEl.value = currentApplication.lname;
            if(dobEl && currentApplication.dob) dobEl.value = currentApplication.dob;
            if(genderEl && currentApplication.gender) genderEl.value = currentApplication.gender;
            if(citizenEl && currentApplication.citizen) citizenEl.value = currentApplication.citizen;
            if(phoneEl && currentApplication.phone) phoneEl.value = currentApplication.phone;
            if(addressEl && currentApplication.address) addressEl.value = currentApplication.address;
            
            // Step 2 fields
            const countryEl = document.getElementById('app-country');
            const stateEl = document.getElementById('app-state');
            const intakeEl = document.getElementById('app-intake');
            
            if(countryEl && currentApplication.country) {
                countryEl.value = currentApplication.country;
                updateLocations();
                // Wait a bit for the state dropdown to populate, then restore state
                if(stateEl && currentApplication.state) {
                    setTimeout(() => {
                        if(document.getElementById('app-state')) {
                            document.getElementById('app-state').value = currentApplication.state;
                            updateUniversities();
                            // Wait a bit more for universities to populate
                            setTimeout(() => {
                                if(currentApplication.universities && currentApplication.universities.length > 0) {
                                    selectedUnis = [...currentApplication.universities];
                                    updateSelectedList();
                                }
                            }, 100);
                        }
                    }, 100);
                } else if(currentApplication.universities && currentApplication.universities.length > 0) {
                    // If no state but universities exist, restore them
                    selectedUnis = [...currentApplication.universities];
                    updateSelectedList();
                }
            }
            if(intakeEl && currentApplication.intake) intakeEl.value = currentApplication.intake;
            
            // Restore universities array (fallback if country wasn't set)
            if(currentApplication.universities && currentApplication.universities.length > 0 && selectedUnis.length === 0) {
                selectedUnis = [...currentApplication.universities];
                updateSelectedList();
            }
            
            // Restore uploaded documents - only if not already loaded to prevent duplicates
            if(currentApplication.docs && currentApplication.docs.length > 0) {
                const list = document.getElementById('stu-file-list');
                if(list) {
                    // Check if documents are already loaded by checking if list has file divs
                    const existingFileDivs = list.querySelectorAll('div[id^="file-"]');
                    if(existingFileDivs.length === 0) {
                        // Only restore if list is empty (not already loaded)
                        uploadedFiles = {};
                        uploadedFilesCounter = 0;
                        
                        const noDocsDiv = list.querySelector('.no-docs');
                        if(noDocsDiv) {
                            noDocsDiv.remove();
                        }
                        
                        currentApplication.docs.forEach((docItem) => {
                            const docType = docItem.type;
                            if(!uploadedFiles[docType]) {
                                uploadedFiles[docType] = [];
                            }
                            
                            // Use the original file ID from the database, or generate a new one if missing
                            const fileId = docItem.id || `file-${uploadedFilesCounter++}`;
                            
                            // Restore all file metadata including chunked file info
                            const fileMetadata = {
                                id: fileId,
                                name: docItem.name,
                                size: docItem.size || 0,
                                type: docItem.fileType || 'application/pdf',
                                uploadedAt: docItem.uploadedAt || new Date().toISOString(),
                                downloadURL: docItem.downloadURL || null, // Restore Firebase Storage URL
                                storagePath: docItem.storagePath || null,
                                // Chunked file metadata
                                isChunked: docItem.isChunked || false,
                                chunkCount: docItem.chunkCount || null,
                                chunkedFileId: docItem.chunkedFileId || null
                            };
                            
                            uploadedFiles[docType].push(fileMetadata);
                            
                            // Display in the uploaded files list
                            const fileDiv = document.createElement('div');
                            fileDiv.id = fileId;
                            fileDiv.style.cssText = 'padding:10px; background:#fff; border:1px solid #eee; margin-top:5px; border-radius:4px; font-size:0.9rem; display:flex; align-items:center; justify-content:space-between;';
                            
                            // Format file size display
                            let fileSize = '';
                            if (docItem.size) {
                                if (docItem.size > 1024 * 1024) {
                                    fileSize = `(${(docItem.size / (1024 * 1024)).toFixed(2)} MB)`;
                                } else {
                                    fileSize = `(${(docItem.size / 1024).toFixed(2)} KB)`;
                                }
                            }
                            
                            const safeFileName = docItem.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            fileDiv.innerHTML = `
                                <div style="display:flex; align-items:center; flex:1;">
                                    <span class="doc-status-light doc-uploaded"></span>
                                    <strong style="margin-left:10px;">${docType}:</strong>
                                    <a href="#" onclick="downloadStudentDocument('${fileId}', '${docType}', '${safeFileName}'); return false;" style="margin-left:5px; color:var(--primary); text-decoration:none; cursor:pointer; font-weight:500; border-bottom:1px dotted var(--primary);" title="Click to download ${docItem.name}">
                                        ${docItem.name}
                                    </a>
                                    ${fileSize ? `<span style="margin-left:10px; color:#999; font-size:0.85rem;">${fileSize}</span>` : ''}
                                </div>
                                <button onclick="removeUploadedFileById('${fileId}', '${docType}')" style="background:none; border:none; color:#dc3545; cursor:pointer; padding:5px; margin-left:10px;" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            list.appendChild(fileDiv);
                        });
                    }
                }
            }
            
            // Restore wizard step if not submitted
            if(currentApplication.status !== 'Submitted' && currentApplication.lastStep) {
                const stepToShow = currentApplication.lastStep;
                currentStep = stepToShow;
                
                // Update wizard display - remove inline styles and use CSS classes
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = ''; // Remove inline display style
                });
                const targetStep = document.getElementById('wizard-step-' + stepToShow);
                if(targetStep) {
                    targetStep.classList.add('active');
                    targetStep.style.display = ''; // Ensure no inline style blocks CSS
                }
                
                // Update step indicators
                document.querySelectorAll('.step').forEach((el, index) => {
                    const stepNum = index + 1;
                    el.classList.remove('active', 'completed');
                    if(stepNum < stepToShow) el.classList.add('completed');
                    if(stepNum === stepToShow) el.classList.add('active');
                });
            }
        }

        window.saveApplication = async function() {
            // Collect all form data
            const formData = collectFormData();
            currentApplication = { ...currentApplication, ...formData };
            
            // SAVE TO FIRESTORE
            if(auth && auth.currentUser && !isDemoMode) {
                try {
                    await setDoc(doc(db, "users", auth.currentUser.uid), currentApplication, { merge: true });
                } catch(e) { console.error("Save error", e); }
            } else if(isDemoMode) {
                localStorage.setItem('demoApp', JSON.stringify(currentApplication));
            }
            
            const previewHTML = `
                <div class="preview-group"><div class="preview-label">Full Name</div><div class="preview-value">${currentApplication.fname} ${currentApplication.lname}</div></div>
                <div class="preview-group"><div class="preview-label">Contact</div><div class="preview-value">${currentApplication.phone}</div></div>
                <div class="preview-group"><div class="preview-label">Target</div><div class="preview-value">${currentApplication.country}</div></div>
                <div class="preview-group"><div class="preview-label">Intake</div><div class="preview-value">${currentApplication.intake}</div></div>
                <div class="preview-group"><div class="preview-label">Universities</div><div class="preview-value">${currentApplication.universities.join(', ') || 'None'}</div></div>
            `;
            document.getElementById('preview-content').innerHTML = previewHTML;
            document.getElementById('app-form-view').style.display = 'none';
            document.getElementById('wizard-steps').style.display = 'none'; // Hide steps in preview
            document.getElementById('app-preview-view').style.display = 'block';
            document.getElementById('dash-countries-count').innerText = currentApplication.country ? "1" : "0";
        };

        window.editApplication = function() {
            document.getElementById('app-form-view').style.display = 'block';
            document.getElementById('wizard-steps').style.display = 'flex';
            document.getElementById('app-preview-view').style.display = 'none';
        };

        window.submitApplication = async function() {
            if(confirm("Submit Application?")) {
                currentApplication.status = 'Submitted';
                
                // SAVE TO FIRESTORE
                if(auth && auth.currentUser && !isDemoMode) {
                    try {
                        await setDoc(doc(db, "users", auth.currentUser.uid), { status: 'Submitted' }, { merge: true });
                    } catch(e) { console.error("Submit error", e); }
                } else if(isDemoMode) {
                    localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                }

                showSuccess("Submitted! Your Profile is now created.");
                window.router('student');
            }
        };

        window.updateProfile = async function() {
            // Collect all form data
            const formData = collectFormData();
            currentApplication = { ...currentApplication, ...formData };
            
            // SAVE TO FIRESTORE
            if(auth && auth.currentUser && !isDemoMode) {
                try {
                    await setDoc(doc(db, "users", auth.currentUser.uid), currentApplication, { merge: true });
                } catch(e) { console.error("Update error", e); }
            } else if(isDemoMode) {
                localStorage.setItem('demoApp', JSON.stringify(currentApplication));
            }
            
            showSuccess("Profile Updated Successfully!");
            updateDashboardUI(); // Refresh dash widgets
        };

        function updateDashboardUI() {
            const isSubmitted = currentApplication.status === 'Submitted';
            
            if (isSubmitted) {
                // Show Profile Widget on Dashboard
                document.getElementById('dash-profile-view').style.display = 'block';
                document.getElementById('dash-full-name').innerText = currentApplication.fname + ' ' + currentApplication.lname;
                document.getElementById('dash-phone').innerText = currentApplication.phone;
                document.getElementById('dash-address').innerText = currentApplication.address;
                document.getElementById('dash-target').innerText = currentApplication.country;
                document.getElementById('dash-intake-val').innerText = currentApplication.intake;
                
                // Update Application Page UI to "Profile Mode"
                document.getElementById('student-side-app-link').innerHTML = '<i class="fas fa-user-circle"></i> My Profile';
                document.getElementById('app-page-title').innerText = 'My Student Profile';
                
                // Switch buttons: Hide Save, Show Update
                document.getElementById('btn-app-save').style.display = 'none';
                document.getElementById('btn-app-update').style.display = 'block';
                
                // Ensure form is visible and step 3 (docs) is active, hide wizard nav
                document.getElementById('wizard-steps').style.display = 'none'; // Hide numbers
                document.getElementById('app-form-view').style.display = 'block';
                document.getElementById('app-preview-view').style.display = 'none';
                
                // Show all sections at once for profile editing instead of wizard
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.style.display = 'block';
                    el.classList.add('active'); // Ensure visiblity
                });
                
                // Hide navigation buttons within wizard (Next/Back)
                document.querySelectorAll('.wizard-content .btn, .wizard-content .btn-outline').forEach(btn => {
                    if(btn.innerHTML.includes('Next') || btn.innerHTML.includes('Back')) {
                        btn.style.display = 'none';
                    }
                });

            } else {
                // Revert to "Application" Mode
                document.getElementById('dash-profile-view').style.display = 'none';
                document.getElementById('student-side-app-link').innerHTML = '<i class="fas fa-file-alt"></i> Application Form';
                document.getElementById('app-page-title').innerText = 'Application Wizard';
                document.getElementById('btn-app-save').style.display = 'block';
                document.getElementById('btn-app-update').style.display = 'none';
                document.getElementById('wizard-steps').style.display = 'flex';
                
                // Reset wizard visibility - use CSS classes instead of inline styles
                document.querySelectorAll('.wizard-content').forEach(el => {
                    el.style.display = ''; // Remove inline display style
                    el.classList.remove('active');
                });
                const step1 = document.getElementById('wizard-step-1');
                if(step1) {
                    step1.classList.add('active');
                    step1.style.display = ''; // Ensure no inline style blocks CSS
                }
                
                // Restore buttons
                document.querySelectorAll('.wizard-content button').forEach(btn => btn.style.display = 'inline-block');
            }
        }

        // --- COUNSELOR LOGIC ---
        window.renderStudentList = async function(filter = 'active') {
            // Update active menu item based on filter
            document.querySelectorAll('.dash-menu-item').forEach(item => {
                const itemText = item.textContent || '';
                if(filter === 'active' && itemText.includes('Active Students')) {
                    item.classList.add('active');
                } else if(filter === 'inactive' && itemText.includes('Inactive Students')) {
                    item.classList.add('active');
                } else if(filter === 'archived' && itemText.includes('Archives')) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            const list = document.getElementById('coun-student-list');
            const header = document.getElementById('coun-list-header');
            const actions = document.getElementById('coun-list-actions');
            
            if(!list) {
                console.error('Counselor student list element not found');
                return;
            }
            
            // Reset header and actions for normal view
            if(header) header.innerText = 'Students';
            if(actions) actions.innerHTML = `<button class="btn btn-sm btn-success" onclick="addStudent()"><i class="fas fa-plus"></i> Add</button>`;
            
            // Update empty state message for active/inactive/archived view
            const emptyStateEl = document.getElementById('coun-empty-state');
            if(emptyStateEl) {
                if(filter === 'active') {
                    emptyStateEl.innerHTML = `
                        <i class="fas fa-comments" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3>Select a Student</h3>
                        <p>Click on a student to view details, docs, and chat.</p>
                    `;
                } else if(filter === 'inactive') {
                    emptyStateEl.innerHTML = `
                        <i class="fas fa-user-slash" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3>Select an Inactive Student</h3>
                        <p>Click on a student to view details and reactivate them.</p>
                    `;
                } else {
                    emptyStateEl.innerHTML = `
                        <i class="fas fa-archive" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3>No Archived Students</h3>
                        <p>Archived students will appear here.</p>
                    `;
                }
            }
            
            list.innerHTML = "<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-spinner fa-spin'></i> Loading students from database...</div>";
            
            let allStudents = [];
            
            // Check if Firebase is initialized
            if(!db) {
                console.error('Firebase database not initialized');
                list.innerHTML = "<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Database not initialized. Please refresh the page.</div>";
                return;
            }
            
            // Load students from Firebase database
            try {
                console.log('Fetching students from Firebase...');
                const usersSnapshot = await getDocs(collection(db, "users"));
                console.log(`Found ${usersSnapshot.size} documents in users collection`);
                
                usersSnapshot.forEach((doc) => {
                    try {
                        const userData = doc.data();
                        if(!userData) {
                            console.warn(`Document ${doc.id} has no data`);
                            return;
                        }
                        
                        // Include all students who have created profiles
                        // Check for any student data (fname, email, or status)
                        if(userData.fname || userData.email || userData.status) {
                            const studentData = {
                                id: doc.id,
                                name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                email: userData.email || 'noemail@example.com',
                                fname: userData.fname || '',
                                lname: userData.lname || '',
                                target: userData.country || 'Not specified',
                                phone: userData.phone || '',
                                address: userData.address || '',
                                dob: userData.dob || '',
                                gender: userData.gender || '',
                                citizen: userData.citizen || '',
                                state: userData.state || '',
                                intake: userData.intake || '',
                                universities: Array.isArray(userData.universities) ? userData.universities : [],
                                docs: Array.isArray(userData.docs) ? userData.docs : [],
                                counselorId: userData.counselorId || null,
                                status: userData.status === 'Submitted' ? 'active' : (userData.status === 'Draft' ? 'draft' : (userData.status || 'active')),
                                isActive: userData.isActive !== undefined ? userData.isActive : true, // Default to active
                                milestone: userData.milestone || null, // Student milestone
                                updatedAt: userData.updatedAt || null
                            };
                            
                            allStudents.push(studentData);
                        }
                    } catch(docError) {
                        console.error(`Error processing document ${doc.id}:`, docError);
                    }
                });
                
                console.log(`Processed ${allStudents.length} students`);
            } catch(e) {
                console.error("Error loading students from Firebase:", e);
                console.error("Error details:", {
                    message: e.message,
                    code: e.code,
                    stack: e.stack
                });
                
                let errorMessage = "Error loading students. ";
                if(e.code === 'permission-denied') {
                    errorMessage += "Permission denied. Please check Firebase security rules.";
                } else if(e.code === 'unavailable') {
                    errorMessage += "Database unavailable. Please check your internet connection.";
                } else {
                    errorMessage += `Error: ${e.message || 'Unknown error'}. Please try again.`;
                }
                
                list.innerHTML = `<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> ${errorMessage}<br><small style='color:#999; margin-top:10px; display:block;'>Check browser console for details.</small></div>`;
                return;
            }
            
            // Update counselorStudents array
            counselorStudents = allStudents;
            
            // Get current counselor ID
            const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
            
            // Filter students based on assignment to current counselor
            // For 'active' filter, show active students assigned to current counselor (not archived, isActive = true)
            // For 'inactive' filter, show inactive students assigned to current counselor (not archived, isActive = false)
            // For 'archived' filter, show archived students assigned to current counselor
            const filtered = allStudents.filter(s => {
                // Check if student is assigned to current counselor
                const isAssignedToMe = s.counselorId && s.counselorId === currentCounselorId;
                
                if(filter === 'active') {
                    // Show active students assigned to this counselor that are not archived
                    return isAssignedToMe && s.status !== 'archived' && s.isActive !== false;
                } else if(filter === 'inactive') {
                    // Show inactive students assigned to this counselor that are not archived
                    return isAssignedToMe && s.status !== 'archived' && s.isActive === false;
                } else if(filter === 'archived') {
                    // Show archived students assigned to this counselor
                    return isAssignedToMe && s.status === 'archived';
                }
                return true;
            });
            
            // Clear loading message
            list.innerHTML = "";
            
            if (filtered.length === 0) {
                if(filter === 'active') {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-users' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No active students assigned to you yet.</p><p style='font-size: 0.9rem; margin-top: 10px;'>Go to "Available Students" to select and assign students.</p></div>`;
                } else if(filter === 'inactive') {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-user-slash' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No inactive students found.</p><p style='font-size: 0.9rem; margin-top: 10px;'>Students marked as inactive will appear here.</p></div>`;
                } else {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-archive' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No archived students found.</p></div>`;
                }
                // Show empty state on right panel
                const emptyStatePanel = document.getElementById('coun-empty-state');
                const interactionPanel = document.getElementById('coun-interaction');
                if(emptyStatePanel) emptyStatePanel.style.display = 'block';
                if(interactionPanel) interactionPanel.style.display = 'none';
                return;
            }

            filtered.forEach(s => {
                const div = document.createElement('div');
                const isActive = String(currentStudentId) === String(s.id);
                div.className = `student-item ${isActive ? 'active' : ''}`;
                div.setAttribute('data-student-id', s.id);
                div.onclick = (e) => { if(!e.target.closest('button')) selectStudent(s.id); };
                
                // Escape ID for use in onclick handlers
                const safeId = String(s.id).replace(/'/g, "\\'");
                let actions = '';
                if(filter === 'active') {
                    actions = `
                        <div>
                            <button class="coun-action-btn" title="Edit" onclick="event.stopPropagation(); editStudent('${safeId}')"><i class="fas fa-edit"></i></button>
                            <button class="coun-action-btn" title="Mark Inactive" onclick="event.stopPropagation(); toggleStudentActive('${safeId}', false)"><i class="fas fa-user-slash"></i></button>
                            <button class="coun-action-btn" title="Archive" onclick="event.stopPropagation(); archiveStudent('${safeId}')"><i class="fas fa-archive"></i></button>
                            <button class="coun-action-btn delete" title="Delete" onclick="event.stopPropagation(); deleteStudent('${safeId}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                } else if(filter === 'inactive') {
                    actions = `
                        <div>
                            <button class="coun-action-btn" title="Reactivate" onclick="event.stopPropagation(); toggleStudentActive('${safeId}', true)"><i class="fas fa-user-check"></i></button>
                            <button class="coun-action-btn" title="Edit" onclick="event.stopPropagation(); editStudent('${safeId}')"><i class="fas fa-edit"></i></button>
                            <button class="coun-action-btn" title="Archive" onclick="event.stopPropagation(); archiveStudent('${safeId}')"><i class="fas fa-archive"></i></button>
                        </div>
                    `;
                } else {
                    actions = `<div><button class="coun-action-btn" title="Restore" onclick="event.stopPropagation(); archiveStudent('${safeId}', true)"><i class="fas fa-undo"></i></button></div>`;
                }
                
                // Add status badge
                const statusBadge = s.isActive === false ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">Inactive</span>' : 
                                 s.isActive === true ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">Active</span>' : '';
                
                // Add milestone badge
                const milestoneColors = {
                    'Joined': '#17a2b8',
                    'IELTS Completed': '#007bff',
                    'Applied for College': '#6c757d',
                    'Offer Letter Approved': '#28a745',
                    'Offer Letter Denied': '#dc3545',
                    'Visa Applied': '#ffc107',
                    'Visa Approved': '#28a745',
                    'Visa Denied': '#dc3545'
                };
                const milestoneBadge = s.milestone ? `<span style="background: ${milestoneColors[s.milestone] || '#6c757d'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px; font-weight: 500;">${s.milestone}</span>` : '';

                div.innerHTML = `
                    <div>
                        <div style="font-weight:600; font-size:0.95rem; display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
                            ${s.name || 'Unknown Student'}${statusBadge}${milestoneBadge}
                        </div>
                        <div style="font-size:0.8rem; color:#666;">${s.target || 'Not specified'} • ${s.intake || 'Not specified'}</div>
                    </div>
                    ${actions}
                `;
                list.appendChild(div);
            });
            
            // Show empty state if no student is currently selected
            const emptyStatePanel = document.getElementById('coun-empty-state');
            const interactionPanel = document.getElementById('coun-interaction');
            if(!currentStudentId) {
                    if(emptyStatePanel) {
                        emptyStatePanel.style.display = 'block';
                        // Update empty state message based on filter
                        if(filter === 'active') {
                            emptyStatePanel.innerHTML = `
                            <i class="fas fa-comments" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                            <h3>Select a Student</h3>
                            <p>Click on a student from the list to view their profile, documents, and chat.</p>
                        `;
                        }
                    }
                if(interactionPanel) interactionPanel.style.display = 'none';
            }
            
            // Update workspace stats
            updateWorkspaceStats(allStudents, currentCounselorId);
        };
        
        // Update workspace statistics
        function updateWorkspaceStats(allStudents, counselorId) {
            const activeStudents = allStudents.filter(s => 
                s.counselorId === counselorId && s.status !== 'archived' && s.isActive !== false
            );
            const pendingStudents = allStudents.filter(s => 
                s.counselorId === counselorId && s.status === 'Draft' && s.status !== 'archived'
            );
            const completedStudents = allStudents.filter(s => 
                s.counselorId === counselorId && (s.milestone === 'Visa Approved' || s.status === 'archived')
            );
            
            // Update stat cards
            const activeEl = document.getElementById('workspace-stat-active');
            const pendingEl = document.getElementById('workspace-stat-pending');
            const completedEl = document.getElementById('workspace-stat-completed');
            
            if(activeEl) activeEl.textContent = activeStudents.length;
            if(pendingEl) pendingEl.textContent = pendingStudents.length;
            if(completedEl) completedEl.textContent = completedStudents.length;
            
            // Update nav badges
            const navActiveCount = document.getElementById('nav-active-count');
            const navInactiveCount = document.getElementById('nav-inactive-count');
            
            if(navActiveCount) {
                const inactiveCount = allStudents.filter(s => 
                    s.counselorId === counselorId && s.status !== 'archived' && s.isActive === false
                ).length;
                navActiveCount.textContent = activeStudents.length || '';
                if(activeStudents.length === 0) navActiveCount.style.display = 'none';
                else navActiveCount.style.display = 'inline-block';
            }
            
            if(navInactiveCount) {
                const inactiveCount = allStudents.filter(s => 
                    s.counselorId === counselorId && s.status !== 'archived' && s.isActive === false
                ).length;
                navInactiveCount.textContent = inactiveCount || '';
                if(inactiveCount === 0) navInactiveCount.style.display = 'none';
                else navInactiveCount.style.display = 'inline-block';
            }
        }

        // Render all available students with checkboxes for selection
        window.renderAvailableStudents = async function() {
            // Update active menu item
            document.querySelectorAll('.dash-menu-item').forEach(item => {
                if(item.textContent.includes('Available Students')) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            const list = document.getElementById('coun-student-list');
            const header = document.getElementById('coun-list-header');
            const actions = document.getElementById('coun-list-actions');
            
            if(!list) {
                console.error('Counselor student list element not found');
                return;
            }
            
            // Update header and actions
            header.innerText = 'Available Students';
            actions.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="select-all-students" onchange="toggleSelectAllStudents()" style="width: 16px; height: 16px; accent-color: var(--primary);">
                        <span>Select All</span>
                    </label>
                    <button class="btn btn-sm btn-success" onclick="assignSelectedStudents()" id="assign-selected-btn" disabled>
                        <i class="fas fa-user-check"></i> Assign Selected (<span id="selected-count">0</span>)
                    </button>
                </div>
            `;
            
            list.innerHTML = "<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-spinner fa-spin'></i> Loading all students from database...</div>";
            
            let allStudents = [];
            
            // Check if Firebase is initialized
            if(!db) {
                console.error('Firebase database not initialized');
                list.innerHTML = "<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Database not initialized. Please refresh the page.</div>";
                return;
            }
            
            // Load all students from Firebase database
            try {
                console.log('Fetching all students from Firebase...');
                const usersSnapshot = await getDocs(collection(db, "users"));
                console.log(`Found ${usersSnapshot.size} documents in users collection`);
                
                usersSnapshot.forEach((doc) => {
                    try {
                        const userData = doc.data();
                        if(!userData) {
                            console.warn(`Document ${doc.id} has no data`);
                            return;
                        }
                        
                        // Include all students who have created profiles
                        if(userData.fname || userData.email || userData.status) {
                            const studentData = {
                                id: doc.id,
                                name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                email: userData.email || 'noemail@example.com',
                                fname: userData.fname || '',
                                lname: userData.lname || '',
                                target: userData.country || 'Not specified',
                                phone: userData.phone || '',
                                address: userData.address || '',
                                dob: userData.dob || '',
                                gender: userData.gender || '',
                                citizen: userData.citizen || '',
                                state: userData.state || '',
                                intake: userData.intake || '',
                                universities: Array.isArray(userData.universities) ? userData.universities : [],
                                docs: Array.isArray(userData.docs) ? userData.docs : [],
                                counselorId: userData.counselorId || null,
                                status: userData.status === 'Submitted' ? 'active' : (userData.status === 'Draft' ? 'draft' : (userData.status || 'active')),
                                isActive: userData.isActive !== undefined ? userData.isActive : true, // Default to active
                                milestone: userData.milestone || null, // Student milestone
                                updatedAt: userData.updatedAt || null
                            };
                            
                            allStudents.push(studentData);
                        }
                    } catch(docError) {
                        console.error(`Error processing document ${doc.id}:`, docError);
                    }
                });
                
                console.log(`Processed ${allStudents.length} students`);
            } catch(e) {
                console.error("Error loading students from Firebase:", e);
                let errorMessage = "Error loading students. ";
                if(e.code === 'permission-denied') {
                    errorMessage += "Permission denied. Please check Firebase security rules.";
                } else if(e.code === 'unavailable') {
                    errorMessage += "Database unavailable. Please check your internet connection.";
                } else {
                    errorMessage += `Error: ${e.message || 'Unknown error'}. Please try again.`;
                }
                
                list.innerHTML = `<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> ${errorMessage}</div>`;
                return;
            }
            
            // Clear loading message
            list.innerHTML = "";
            
            if (allStudents.length === 0) {
                list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-users' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No students found.</p></div>`;
                return;
            }

            // Render students with checkboxes
            allStudents.forEach(s => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.setAttribute('data-student-id', s.id);
                
                const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
                const isAssigned = s.counselorId && s.counselorId;
                const isAssignedToMe = s.counselorId === currentCounselorId;
                const isAssignedToOther = isAssigned && !isAssignedToMe;
                
                // Disable checkbox if assigned to another counselor
                const checkboxDisabled = isAssignedToOther ? 'disabled' : '';
                const checkboxChecked = isAssignedToMe ? 'checked' : '';
                const itemStyle = isAssignedToOther ? 'opacity: 0.6; background-color: #f5f5f5;' : '';
                
                div.innerHTML = `
                    <div class="student-item-checkbox" style="${itemStyle}">
                        <input type="checkbox" 
                               id="student-checkbox-${s.id}" 
                               data-student-id="${s.id}"
                               data-assigned-to-other="${isAssignedToOther}"
                               onchange="updateSelectedCount()"
                               ${checkboxChecked}
                               ${checkboxDisabled}>
                        <label for="student-checkbox-${s.id}" style="flex: 1; cursor: ${isAssignedToOther ? 'not-allowed' : 'pointer'};">
                            <div class="student-info">
                                <div class="student-name" style="${isAssignedToOther ? 'color: #999;' : ''}">${s.name || 'Unknown Student'}</div>
                                <div class="student-details">
                                    <i class="fas fa-globe" style="margin-right: 5px;"></i>${s.target || 'Not specified'}
                                    ${s.intake ? ` • <i class="fas fa-calendar" style="margin-left: 10px; margin-right: 5px;"></i>${s.intake}` : ''}
                                    ${s.email ? ` • <i class="fas fa-envelope" style="margin-left: 10px; margin-right: 5px;"></i>${s.email}` : ''}
                                    ${isAssignedToMe ? `<span style="color: #28a745; font-size: 0.85rem; margin-left: 10px; font-weight: 600;"><i class="fas fa-check-circle"></i> Assigned to You</span>` : (isAssignedToOther ? `<span style="color: #dc3545; font-size: 0.85rem; margin-left: 10px; font-weight: 600;"><i class="fas fa-lock"></i> Assigned to Another Counselor</span>` : '<span style="color: #6c757d; font-size: 0.85rem; margin-left: 10px;"><i class="fas fa-user-plus"></i> Available</span>')}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Initialize selected count
            updateSelectedCount();
            
            // Show empty state and hide interaction panel
            const emptyState = document.getElementById('coun-empty-state');
            const interactionPanel = document.getElementById('coun-interaction');
            if(emptyState) emptyState.style.display = 'block';
            if(interactionPanel) interactionPanel.style.display = 'none';
            
            // Update workspace stats
            const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
            updateWorkspaceStats(allStudents, currentCounselorId);
        };

        // Toggle select all students
        window.toggleSelectAllStudents = function() {
            const selectAllCheckbox = document.getElementById('select-all-students');
            // Only get checkboxes that are not disabled and not assigned to others
            const checkboxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled])');
            const isChecked = selectAllCheckbox.checked;
            
            checkboxes.forEach(checkbox => {
                // Only check/uncheck if not assigned to another counselor
                if(checkbox.getAttribute('data-assigned-to-other') !== 'true') {
                    checkbox.checked = isChecked;
                }
            });
            
            updateSelectedCount();
        };

        // Update selected count
        window.updateSelectedCount = function() {
            const checkboxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled])');
            const checkedBoxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled]):checked');
            const selectAllCheckbox = document.getElementById('select-all-students');
            const assignBtn = document.getElementById('assign-selected-btn');
            const countSpan = document.getElementById('selected-count');
            
            // Filter out students assigned to others (shouldn't be selectable, but double-check)
            const validCheckedBoxes = Array.from(checkedBoxes).filter(cb => {
                return cb.getAttribute('data-assigned-to-other') !== 'true';
            });
            
            const selectedCount = validCheckedBoxes.length;
            
            if(countSpan) {
                countSpan.textContent = selectedCount;
            }
            
            if(assignBtn) {
                assignBtn.disabled = selectedCount === 0;
            }
            
            // Update select all checkbox state
            if(selectAllCheckbox && checkboxes.length > 0) {
                selectAllCheckbox.checked = selectedCount === checkboxes.length && checkboxes.length > 0;
                selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < checkboxes.length;
            }
        };

        // Assign selected students to counselor
        window.assignSelectedStudents = async function() {
            const checkboxes = document.querySelectorAll('#coun-student-list input[type="checkbox"]:not([disabled]):checked');
            
            if(checkboxes.length === 0) {
                alert('Please select at least one student to assign.');
                return;
            }
            
            const selectedIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-student-id'));
            const selectedStudents = [];
            
            // Get student data for selected IDs
            if(!db) {
                alert('Database not initialized. Please refresh the page.');
                return;
            }
            
            // Confirm assignment
            const confirmMessage = `Are you sure you want to assign ${selectedIds.length} student(s) to you?`;
            if(!confirm(confirmMessage)) {
                return;
            }
            
            // Check for students already assigned to other counselors
            const alreadyAssignedStudents = [];
            for(const id of selectedIds) {
                try {
                    const studentDoc = await getDoc(doc(db, "users", id));
                    if(studentDoc.exists()) {
                        const userData = studentDoc.data();
                        if(userData.counselorId && userData.counselorId !== auth.currentUser.uid) {
                            const studentName = `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student';
                            alreadyAssignedStudents.push(studentName);
                        }
                    }
                } catch(e) {
                    console.error(`Error checking student ${id}:`, e);
                }
            }
            
            // Prevent assignment if students are already assigned to others
            if(alreadyAssignedStudents.length > 0) {
                const studentList = alreadyAssignedStudents.join(', ');
                alert(`Cannot assign the following student(s) as they are already assigned to another counselor:\n\n${studentList}\n\nPlease select only available students.`);
                // Uncheck the selected students that are assigned to others
                selectedIds.forEach(id => {
                    const checkbox = document.querySelector(`#student-checkbox-${id}`);
                    if(checkbox && checkbox.getAttribute('data-assigned-to-other') === 'true') {
                        checkbox.checked = false;
                    }
                });
                updateSelectedCount();
                return;
            }
            
            // Assign students
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for(const id of selectedIds) {
                try {
                    const counselorId = auth.currentUser.uid;
                    
                    // Update student's profile with counselorId
                    await updateDoc(doc(db, "users", id), {
                        counselorId: counselorId,
                        assignedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    
                    successCount++;
                } catch(e) {
                    console.error(`Error assigning student ${id}:`, e);
                    errorCount++;
                    errors.push(e.message);
                }
            }
            
            // Show result
            if(successCount > 0) {
                // Update counselorStudents array with newly assigned students
                for(const id of selectedIds) {
                    try {
                        const studentDoc = await getDoc(doc(db, "users", id));
                        if(studentDoc.exists()) {
                            const userData = studentDoc.data();
                            const updatedStudent = {
                                id: id,
                                name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                email: userData.email || 'noemail@example.com',
                                fname: userData.fname || '',
                                lname: userData.lname || '',
                                target: userData.country || 'Not specified',
                                phone: userData.phone || '',
                                address: userData.address || '',
                                dob: userData.dob || '',
                                gender: userData.gender || '',
                                citizen: userData.citizen || '',
                                state: userData.state || '',
                                intake: userData.intake || '',
                                universities: Array.isArray(userData.universities) ? userData.universities : [],
                                docs: Array.isArray(userData.docs) ? userData.docs : [],
                                counselorId: userData.counselorId || null,
                                status: userData.status === 'Submitted' ? 'active' : (userData.status === 'Draft' ? 'draft' : (userData.status || 'active')),
                                isActive: userData.isActive !== undefined ? userData.isActive : true, // Default to active
                                milestone: userData.milestone || null, // Student milestone
                                updatedAt: userData.updatedAt || null
                            };
                            
                            // Update or add to counselorStudents array
                            const existingIndex = counselorStudents.findIndex(stu => String(stu.id) === String(id));
                            if(existingIndex >= 0) {
                                counselorStudents[existingIndex] = updatedStudent;
                            } else {
                                counselorStudents.push(updatedStudent);
                            }
                        }
                    } catch(e) {
                        console.error(`Error updating student data for ${id}:`, e);
                    }
                }
                
                alert(`Successfully assigned ${successCount} student(s) to you.${errorCount > 0 ? `\n${errorCount} student(s) failed to assign.` : ''}\n\nSwitching to Active Students view...`);
                
                // Switch to Active Students view and refresh
                renderStudentList('active');
                
                // Refresh available students list (to update checkboxes)
                setTimeout(() => {
                    renderAvailableStudents();
                }, 500);
            } else {
                alert(`Failed to assign students. Errors: ${errors.join(', ')}`);
            }
        };

        window.selectStudent = async function(id) {
            currentStudentId = id;
            let s = counselorStudents.find(stu => String(stu.id) === String(id));
            
            // If student not found in loaded list, load from Firebase
            if(!s && db) {
                try {
                    const studentDoc = await getDoc(doc(db, "users", id));
                    if(studentDoc.exists()) {
                        const userData = studentDoc.data();
                        s = {
                            id: id,
                            name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                            email: userData.email || 'N/A',
                            fname: userData.fname || '',
                            lname: userData.lname || '',
                            phone: userData.phone || 'N/A',
                            address: userData.address || 'N/A',
                            dob: userData.dob || 'N/A',
                            gender: userData.gender || 'N/A',
                            citizen: userData.citizen || 'N/A',
                            target: userData.country || 'N/A',
                            state: userData.state || 'N/A',
                            intake: userData.intake || 'N/A',
                            universities: userData.universities || [],
                            docs: userData.docs || [],
                            counselorId: userData.counselorId || null,
                            status: userData.status || 'Draft',
                            milestone: userData.milestone || null,
                            updatedAt: userData.updatedAt || null
                        };
                        // Add to counselorStudents array for future reference
                        const existingIndex = counselorStudents.findIndex(stu => String(stu.id) === String(id));
                        if(existingIndex >= 0) {
                            counselorStudents[existingIndex] = s;
                        } else {
                            counselorStudents.push(s);
                        }
                    }
                } catch(e) {
                    console.error('Error loading student from Firebase:', e);
                }
            }
            
            if(!s) {
                console.error('Student not found:', id);
                alert('Student information not found.');
                return;
            }

            // Highlight selected - update active class
            document.querySelectorAll('.student-item').forEach(el => {
                el.classList.remove('active');
                if(el.getAttribute('data-student-id') == id || el.getAttribute('data-student-id') === id) {
                    el.classList.add('active');
                }
            });

            // Update UI right panel
            document.getElementById('coun-empty-state').style.display = 'none';
            document.getElementById('coun-interaction').style.display = 'block';
            
            // Header Information
            const fullName = s.name || `${s.fname || ''} ${s.lname || ''}`.trim() || 'Unknown Student';
            document.getElementById('coun-header-name').innerHTML = `<i class="fas fa-user-graduate" style="margin-right: 10px;"></i>${fullName}`;
            document.getElementById('coun-header-status').innerHTML = `<i class="fas fa-envelope" style="margin-right: 5px;"></i>${s.email || 'N/A'}`;
            document.getElementById('cp-status-badge').innerText = s.status === 'Submitted' ? 'Submitted' : 'Active';
            document.getElementById('cp-last-updated').innerText = s.updatedAt ? new Date(s.updatedAt).toLocaleDateString() : 'Recently Active';
            document.getElementById('coun-chat-student-name').innerText = fullName;

            // Profile Tab Data - Personal Information
            document.getElementById('cp-fullname').innerText = fullName;
            document.getElementById('cp-phone').innerText = s.phone || 'N/A';
            document.getElementById('cp-addr').innerText = s.address || 'N/A';
            document.getElementById('cp-dob').innerText = s.dob || 'N/A';
            document.getElementById('cp-gender').innerText = s.gender || 'N/A';
            document.getElementById('cp-citizen').innerText = s.citizen || 'N/A';
            
            // Profile Tab Data - Academic Information
            document.getElementById('cp-edu').innerText = "Bachelor's Degree"; // Could be enhanced with actual education data
            document.getElementById('cp-target').innerText = s.target || 'N/A';
            document.getElementById('cp-state').innerText = s.state || 'N/A';
            document.getElementById('cp-intake').innerText = s.intake || 'N/A';
            
            // Universities List
            const unisContainer = document.getElementById('cp-unis');
            if(s.universities && s.universities.length > 0) {
                unisContainer.innerHTML = s.universities.map(uni => 
                    `<span class="uni-tag" style="display: inline-block; margin: 4px 4px 4px 0;">${uni}</span>`
                ).join('');
            } else {
                unisContainer.innerHTML = '<span style="color: #999; font-style: italic;">None selected</span>';
            }
            
            // Application Status
            const statusBadge = document.getElementById('cp-app-status');
            statusBadge.className = s.status === 'Submitted' ? 'status-badge status-submitted' : 'status-badge status-draft';
            statusBadge.innerText = s.status || 'Draft';
            
            // Milestone
            const milestoneSelect = document.getElementById('cp-milestone-select');
            const currentMilestoneDiv = document.getElementById('cp-current-milestone');
            if(milestoneSelect) {
                milestoneSelect.value = s.milestone || '';
            }
            if(currentMilestoneDiv) {
                if(s.milestone) {
                    const milestoneColors = {
                        'Joined': '#17a2b8',
                        'IELTS Completed': '#007bff',
                        'Applied for College': '#6c757d',
                        'Offer Letter Approved': '#28a745',
                        'Offer Letter Denied': '#dc3545',
                        'Visa Applied': '#ffc107',
                        'Visa Approved': '#28a745',
                        'Visa Denied': '#dc3545'
                    };
                    currentMilestoneDiv.innerHTML = `<span style="background: ${milestoneColors[s.milestone] || '#6c757d'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 500;">Current: ${s.milestone}</span>`;
                } else {
                    currentMilestoneDiv.innerHTML = '<span style="color: #999; font-style: italic;">No milestone set</span>';
                }
            }

            // Documents Tab Data
            const docList = document.getElementById('cp-docs-list');
            const docsCount = document.getElementById('cp-docs-count');
            
            if(s.docs && s.docs.length > 0) {
                docsCount.innerText = s.docs.length;
                docsCount.style.display = 'inline-block';
                
                // Group documents by type
                const docsByType = {};
                s.docs.forEach(d => {
                    const docType = d.type || 'Other';
                    if(!docsByType[docType]) {
                        docsByType[docType] = [];
                    }
                    docsByType[docType].push(d);
                });
                
                // Define category order and icons (matching student upload form)
                const categoryOrder = ['Passport', 'Transcript', 'IELTS/PTE', 'Financial', 'SOP', 'Other'];
                const categoryIcons = {
                    'Passport': 'fa-passport',
                    'Transcript': 'fa-graduation-cap',
                    'IELTS/PTE': 'fa-certificate',
                    'Financial': 'fa-dollar-sign',
                    'SOP': 'fa-file-alt',
                    'Other': 'fa-folder'
                };
                const categoryColors = {
                    'Passport': '#007bff',
                    'Transcript': '#28a745',
                    'IELTS/PTE': '#ffc107',
                    'Financial': '#17a2b8',
                    'SOP': '#6f42c1',
                    'Other': '#6c757d'
                };
                
                // Sort categories: known categories first in order, then others
                const sortedCategories = [
                    ...categoryOrder.filter(cat => docsByType[cat]),
                    ...Object.keys(docsByType).filter(cat => !categoryOrder.includes(cat))
                ];
                
                docList.innerHTML = sortedCategories.map(docType => {
                    const typeDocs = docsByType[docType];
                    const icon = categoryIcons[docType] || 'fa-folder';
                    const color = categoryColors[docType] || 'var(--primary)';
                    
                    return `
                        <div style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%); color: white; padding: 15px 20px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                                <i class="fas ${icon}" style="font-size: 1.2rem;"></i>
                                <span style="flex: 1;">${docType}</span>
                                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">${typeDocs.length} ${typeDocs.length === 1 ? 'file' : 'files'}</span>
                            </div>
                            <div style="padding: 0;">
                                ${typeDocs.map((d, index) => {
                                    const docName = d.name || 'file.pdf';
                                    const docSize = d.size ? `(${(d.size / 1024).toFixed(2)} KB)` : '';
                                    const uploadedDate = d.uploadedAt ? new Date(d.uploadedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'recently';
                                    const safeDocName = docName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    const safeDocType = docType.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    
                                    // Determine file icon based on extension
                                    const fileExt = docName.split('.').pop()?.toLowerCase();
                                    let fileIcon = 'fa-file';
                                    let fileIconColor = '#6c757d';
                                    if(fileExt === 'pdf') {
                                        fileIcon = 'fa-file-pdf';
                                        fileIconColor = '#dc3545';
                                    } else if(['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                                        fileIcon = 'fa-file-image';
                                        fileIconColor = '#28a745';
                                    } else if(['doc', 'docx'].includes(fileExt)) {
                                        fileIcon = 'fa-file-word';
                                        fileIconColor = '#007bff';
                                    }
                                    
                                    return `
                                        <div style="padding: 15px 20px; border-bottom: ${index < typeDocs.length - 1 ? '1px solid #f0f0f0' : 'none'}; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; background: white;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                            <div style="display: flex; align-items: center; flex: 1; min-width: 0;">
                                                <i class="fas ${fileIcon}" style="color: ${fileIconColor}; margin-right: 12px; font-size: 1.3rem; flex-shrink: 0;"></i>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 500; color: var(--text-dark); margin-bottom: 4px; word-break: break-word;">${docName}</div>
                                                    <div style="font-size: 0.8rem; color: #999; display: flex; gap: 12px; flex-wrap: wrap;">
                                                        ${docSize ? `<span><i class="fas fa-weight"></i> ${docSize}</span>` : ''}
                                                        <span><i class="fas fa-calendar"></i> ${uploadedDate}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm" style="padding: 8px 16px; font-size: 0.85rem; margin-left: 15px; flex-shrink: 0; background: var(--primary); color: white; border: none;" onclick="downloadCounselorDocument('${safeDocName}', '${safeDocType}', '${d.downloadURL || ''}', '${d.id || ''}')" title="Download ${docName}">
                                                <i class="fas fa-download"></i> Download
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                docsCount.style.display = 'none';
                docList.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px; color: #999;">
                        <i class="fas fa-file-alt" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                        <p style="font-style: italic; font-size: 1.1rem; margin-bottom: 10px;">No documents uploaded by this student yet.</p>
                        <p style="font-size: 0.9rem; color: #bbb;">Documents will appear here once the student uploads them.</p>
                    </div>
                `;
            }

            // Chat Tab - Load chat history
            loadCounselorChat(id);
            
            // Reset to Profile tab
            switchCounselorTab('profile');
        };
        
        // Download document for counselor
        window.downloadCounselorDocument = async function(fileName, docType, downloadURL, fileId) {
            try {
                // If we have a Firebase Storage download URL, use it
                if(downloadURL) {
                    const a = document.createElement('a');
                    a.href = downloadURL;
                    a.download = fileName;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    return;
                }
                
                // If no download URL, try to get it from the student's document data
                if(currentStudentId && db) {
                    try {
                        const studentDoc = await getDoc(doc(db, "users", currentStudentId));
                        if(studentDoc.exists()) {
                            const userData = studentDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                                // Try to find by fileId first, then by name and type
                                let docItem = null;
                                if(fileId) {
                                    docItem = userData.docs.find(d => d.id === fileId);
                                }
                                if(!docItem) {
                                    docItem = userData.docs.find(d => d.name === fileName && d.type === docType);
                                }
                                
                                // Check if it's a chunked file
                                if (docItem.isChunked && docItem.chunkedFileId) {
                                    const loadingMsg = document.createElement('div');
                                    loadingMsg.id = 'dl-msg-counselor';
                                    loadingMsg.style.cssText = "position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:5px; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3);";
                                    loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reassembling large file...';
                                    document.body.appendChild(loadingMsg);
                                    
                                    try {
                                        // Fetch all chunks
                                        let fullBase64 = "";
                                        const count = docItem.chunkCount || 100; // fallback safety
                                        
                                        console.log(`Downloading chunked file: ${fileName}, ${count} chunks`);
                                        
                                        for (let i = 0; i < count; i++) {
                                            // Update loading message
                                            loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading chunk ${i + 1}/${count}...`;
                                            
                                            // Fetch chunk i
                                            const chunkRef = doc(db, `file_data/${docItem.chunkedFileId}/chunks/${i}`);
                                            const snap = await getDoc(chunkRef);
                                            
                                            if (snap.exists()) {
                                                fullBase64 += snap.data().data;
                                            } else {
                                                break; // No more chunks
                                            }
                                        }
                                        
                                        // Trigger Download
                                        const a = document.createElement('a');
                                        a.href = fullBase64;
                                        a.download = fileName;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        
                                        loadingMsg.innerHTML = '<i class="fas fa-check-circle"></i> Download started!';
                                        setTimeout(() => loadingMsg.remove(), 2000);
                                        
                                    } catch (e) {
                                        console.error("Download failed:", e);
                                        loadingMsg.remove();
                                        alert("Failed to download large file: " + e.message);
                                    }
                                    return;
                                    
                                } else if(docItem && docItem.downloadURL) {
                                    // Standard small file (Firebase Storage URL)
                                    const a = document.createElement('a');
                                    a.href = docItem.downloadURL;
                                    a.download = fileName;
                                    a.target = '_blank';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    return;
                                }
                            }
                        }
                    } catch(e) {
                        console.error("Error fetching document from database:", e);
                    }
                }
                
                // Fallback: Show alert if file not found
                alert(`File "${fileName}" is not available for download. The file may not have been uploaded to cloud storage yet.`);
            } catch(error) {
                console.error("Error downloading document:", error);
                alert("Error downloading document. Please try again.");
            }
        };

        window.switchCounselorTab = function(tabName) {
            // Update Tab UI
            document.querySelectorAll('.coun-tab').forEach(t => t.classList.remove('active'));
            const tabs = document.querySelectorAll('.coun-tab');
            tabs.forEach(tab => {
                if(tab.innerHTML.includes(tabName === 'profile' ? 'Profile' : tabName === 'docs' ? 'Documents' : 'Chat')) {
                    tab.classList.add('active');
                }
            });
            
            // Show Content
            document.querySelectorAll('.coun-content').forEach(c => c.style.display = 'none');
            const targetTab = document.getElementById('tab-' + tabName);
            if(targetTab) {
                targetTab.style.display = 'block';
                
                // Load chat when switching to chat tab
                if(tabName === 'chat' && currentStudentId) {
                    loadCounselorChat(currentStudentId);
                }
            }
        };

        // CRUD Actions
        window.addStudent = async function() {
            // Show modal
            const modal = document.getElementById('add-student-modal');
            const listContainer = document.getElementById('available-students-list');
            modal.classList.add('active');
            listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Loading available students from database...</p></div>';
            
            try {
                let availableStudents = [];
                
                // Get all students from Firebase who have created profiles
                if(db) {
                    try {
                        const usersSnapshot = await getDocs(collection(db, "users"));
                        usersSnapshot.forEach((doc) => {
                            const userData = doc.data();
                            // Include students who have at least basic info (name or submitted application)
                            if(userData.fname || userData.status) {
                                // Check if student is already in counselor's list
                                const existingStudent = counselorStudents.find(s => 
                                    String(s.id) === String(doc.id) || 
                                    (s.email && userData.email && s.email === userData.email)
                                );
                                
                                if(!existingStudent) {
                                    availableStudents.push({
                                        id: doc.id,
                                        name: `${userData.fname || ''} ${userData.lname || ''}`.trim() || 'Unknown Student',
                                        email: userData.email || 'noemail@example.com',
                                        fname: userData.fname || '',
                                        lname: userData.lname || '',
                                        target: userData.country || 'Not specified',
                                        phone: userData.phone || '',
                                        address: userData.address || '',
                                        dob: userData.dob || '',
                                        gender: userData.gender || '',
                                        citizen: userData.citizen || '',
                                        state: userData.state || '',
                                        intake: userData.intake || '',
                                        universities: userData.universities || [],
                                        status: userData.status || 'Draft',
                                        docs: userData.docs || [],
                                        counselorId: userData.counselorId || null,
                                        updatedAt: userData.updatedAt || null
                                    });
                                }
                            }
                        });
                    } catch(e) {
                        console.error("Error loading students:", e);
                    }
                }
                
                // Display available students
                if(availableStudents.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 10px;">No available students</p>
                            <p style="font-size: 0.9rem;">All students with profiles have been added to your list.</p>
                        </div>
                    `;
                } else {
                    listContainer.innerHTML = '';
                    // Store available students in modal data attribute for access
                    modal.setAttribute('data-available-students', JSON.stringify(availableStudents));
                    
                    availableStudents.forEach((student, index) => {
                        const studentDiv = document.createElement('div');
                        studentDiv.className = 'modal-student-item';
                        studentDiv.setAttribute('data-student-index', index);
                        
                        const currentCounselorId = auth && auth.currentUser ? auth.currentUser.uid : null;
                        const isAssigned = student.counselorId && student.counselorId;
                        const isAssignedToMe = student.counselorId === currentCounselorId;
                        const isAssignedToOther = isAssigned && !isAssignedToMe;
                        
                        // Only allow click if not assigned to another counselor
                        if(!isAssignedToOther) {
                            studentDiv.onclick = function() {
                                const storedStudents = JSON.parse(modal.getAttribute('data-available-students') || '[]');
                                selectAndAddStudentFromList(index, storedStudents);
                            };
                        } else {
                            studentDiv.style.cursor = 'not-allowed';
                            studentDiv.style.opacity = '0.6';
                        }
                        
                        studentDiv.innerHTML = `
                            <div class="student-info" style="flex: 1; ${isAssignedToOther ? 'opacity: 0.6;' : ''}">
                                <div class="student-name" style="${isAssignedToOther ? 'color: #999;' : ''}">${student.name}</div>
                                <div class="student-details">
                                    <i class="fas fa-globe" style="margin-right: 5px;"></i>${student.target}
                                    ${student.intake ? ` • <i class="fas fa-calendar" style="margin-left: 10px; margin-right: 5px;"></i>${student.intake}` : ''}
                                    ${student.email ? ` • <i class="fas fa-envelope" style="margin-left: 10px; margin-right: 5px;"></i>${student.email}` : ''}
                                    ${isAssignedToMe ? ` • <span style="color: #28a745; font-size: 0.85rem; font-weight: 600;"><i class="fas fa-check-circle" style="margin-left: 10px; margin-right: 5px;"></i>Assigned to You</span>` : (isAssignedToOther ? ` • <span style="color: #dc3545; font-size: 0.85rem; font-weight: 600;"><i class="fas fa-lock" style="margin-left: 10px; margin-right: 5px;"></i>Assigned to Another Counselor</span>` : '<span style="color: #6c757d; font-size: 0.85rem;"><i class="fas fa-user-plus" style="margin-left: 10px; margin-right: 5px;"></i>Available</span>')}
                                </div>
                            </div>
                            <button class="btn btn-sm ${isAssignedToOther ? 'btn-secondary' : (isAssignedToMe ? 'btn-success' : 'btn-success')}" 
                                    style="margin-left: 15px; ${isAssignedToOther ? 'opacity: 0.5; cursor: not-allowed;' : ''}" 
                                    ${isAssignedToOther ? 'disabled' : ''}
                                    onclick="event.stopPropagation(); ${isAssignedToOther ? '' : `(function() { const modal = document.getElementById('add-student-modal'); const students = JSON.parse(modal.getAttribute('data-available-students') || '[]'); selectAndAddStudentFromList(${index}, students); })()`}">
                                <i class="fas ${isAssignedToOther ? 'fa-lock' : (isAssignedToMe ? 'fa-check' : 'fa-plus')}"></i> ${isAssignedToOther ? 'Locked' : (isAssignedToMe ? 'Already Assigned' : 'Assign')}
                            </button>
                        `;
                        listContainer.appendChild(studentDiv);
                    });
                }
            } catch(error) {
                console.error('Error loading available students:', error);
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Error loading students. Please try again.</p>
                    </div>
                `;
            }
        };
        
        window.closeAddStudentModal = function() {
            document.getElementById('add-student-modal').classList.remove('active');
        };
        
        window.selectAndAddStudentFromList = async function(index, availableStudentsList) {
            if(!availableStudentsList || !availableStudentsList[index]) {
                console.error('Student not found in list');
                return;
            }
            
            const student = availableStudentsList[index];
            
            // Check if student already exists
            const exists = counselorStudents.find(s => String(s.id) === String(student.id));
            if(exists) {
                alert('This student is already in your list.');
                closeAddStudentModal();
                return;
            }
            
            // Check if student already has a counselor assigned
            if(student.counselorId && student.counselorId !== auth.currentUser.uid) {
                alert(`${student.name} is already assigned to another counselor and cannot be reassigned. Please contact the administrator if you need to transfer this student.`);
                return;
            }
            
            // Assign counselor to student in Firebase
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const counselorId = auth.currentUser.uid;
                    
                    // Update student's profile with counselorId
                    await updateDoc(doc(db, "users", student.id), {
                        counselorId: counselorId,
                        assignedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    
                    console.log(`Student ${student.id} assigned to counselor ${counselorId}`);
                } catch(e) {
                    console.error("Error assigning student to counselor:", e);
                    alert(`Error assigning student: ${e.message}. Please try again.`);
                    return;
                }
            }
            
            // Add student to counselorStudents array
            const newStudent = {
                ...student,
                counselorId: auth && auth.currentUser ? auth.currentUser.uid : null,
                status: student.status === 'Submitted' ? 'active' : (student.status || 'active')
            };
            counselorStudents.push(newStudent);
            
            // Close modal and refresh list
            closeAddStudentModal();
            renderStudentList('active');
            
            // Select the newly added student
            setTimeout(() => {
                selectStudent(student.id);
            }, 100);
            
            alert(`${student.name} has been assigned to you and added to your student list.`);
        };
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('add-student-modal');
            if(modal) {
                modal.addEventListener('click', function(e) {
                    if(e.target === modal) {
                        closeAddStudentModal();
                    }
                });
            }
        });

        window.editStudent = async function(id) {
            const s = counselorStudents.find(stu => String(stu.id) === String(id));
            if(!s) {
                alert('Student not found');
                return;
            }
            const newName = prompt("Edit Name (First Last):", s.name);
            if(newName && newName.trim()) {
                const nameParts = newName.trim().split(' ');
                const fname = nameParts[0] || '';
                const lname = nameParts.slice(1).join(' ') || '';
                
                // Update in Firebase
                if(db) {
                    try {
                        await updateDoc(doc(db, "users", id), {
                            fname: fname,
                            lname: lname,
                            updatedAt: new Date().toISOString()
                        });
                        
                        // Update local array
                        s.fname = fname;
                        s.lname = lname;
                        s.name = newName.trim();
                        
                renderStudentList('active');
                        if(String(currentStudentId) === String(id)) selectStudent(id); // Refresh view if open
                        alert('Student name updated successfully.');
                    } catch(e) {
                        console.error('Error updating student:', e);
                        alert('Error updating student. Please try again.');
                    }
                } else {
                    // Fallback for demo mode
                    s.name = newName.trim();
                    renderStudentList('active');
                    if(String(currentStudentId) === String(id)) selectStudent(id);
                }
            }
        };

        window.deleteStudent = async function(id) {
            if(confirm("Are you sure you want to delete this student? This will remove them from your view, but their data will remain in the database.")) {
                // Remove from counselorStudents array (not deleting from database)
                counselorStudents = counselorStudents.filter(s => String(s.id) !== String(id));
                renderStudentList('active');
                document.getElementById('coun-interaction').style.display = 'none';
                document.getElementById('coun-empty-state').style.display = 'block';
                currentStudentId = null;
            }
        };

        window.archiveStudent = async function(id, restore = false) {
            const s = counselorStudents.find(stu => String(stu.id) === String(id));
            if(s && db) {
                try {
                    const newStatus = restore ? 'Submitted' : 'archived';
                    // Update status in Firebase
                    await updateDoc(doc(db, "users", id), {
                        status: newStatus,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update local array
                s.status = restore ? 'active' : 'archived';
                renderStudentList(restore ? 'archived' : 'active'); // Refresh current view
                    
                    // If current student was archived, hide the interaction panel
                    if(!restore && String(currentStudentId) === String(id)) {
                        document.getElementById('coun-interaction').style.display = 'none';
                        document.getElementById('coun-empty-state').style.display = 'block';
                        currentStudentId = null;
                    }
                } catch(e) {
                    console.error('Error archiving student:', e);
                    alert('Error updating student status. Please try again.');
                }
            }
        };

        window.toggleStudentActive = async function(id, makeActive = true) {
            const s = counselorStudents.find(stu => String(stu.id) === String(id));
            if(s && db) {
                try {
                    // Update isActive in Firebase
                    await updateDoc(doc(db, "users", id), {
                        isActive: makeActive,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Update local array
                    s.isActive = makeActive;
                    
                    alert(makeActive ? 'Student activated successfully!' : 'Student marked as inactive successfully!');
                    
                    // Refresh the appropriate view
                    const currentFilter = document.querySelector('.dash-menu-item.active')?.textContent || '';
                    if(currentFilter.includes('Active')) {
                        renderStudentList('active');
                    } else if(currentFilter.includes('Inactive')) {
                        renderStudentList('inactive');
                    } else {
                        renderStudentList('active');
                    }
                } catch(e) {
                    console.error('Error toggling student active status:', e);
                    alert('Error updating student status. Please try again.');
                }
            }
        };

        window.updateStudentMilestone = async function() {
            if(!currentStudentId || !db) {
                alert('No student selected or database not available.');
                return;
            }
            
            const milestoneSelect = document.getElementById('cp-milestone-select');
            if(!milestoneSelect) {
                alert('Milestone selector not found.');
                return;
            }
            
            const newMilestone = milestoneSelect.value || null;
            
            try {
                // Update milestone in Firebase
                const updateData = {
                    updatedAt: new Date().toISOString()
                };
                if(newMilestone) {
                    updateData.milestone = newMilestone;
                } else {
                    updateData.milestone = null;
                }
                
                await updateDoc(doc(db, "users", currentStudentId), updateData);
                
                // Update local array
                const s = counselorStudents.find(stu => String(stu.id) === String(currentStudentId));
                if(s) {
                    s.milestone = newMilestone;
                }
                
                // Refresh the display
                selectStudent(currentStudentId);
                renderStudentList('active');
                
                alert(newMilestone ? `Milestone updated to: ${newMilestone}` : 'Milestone removed successfully!');
            } catch(e) {
                console.error('Error updating milestone:', e);
                alert('Error updating milestone. Please try again.');
            }
        };

        // --- SHARED ROUTER ---
        window.router = function(page, role = null) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));

            const navBtn = document.querySelector(`button[onclick*="'${page}'"]`);
            if(navBtn) navBtn.classList.add('active');

            if(page === 'auth') {
                window.currentRole = role;
                document.getElementById('auth-title').innerText = 'Login';
                document.getElementById('page-auth').classList.add('active');
            } else if (page === 'student' || page === 'student-apps') {
                const target = page === 'student' ? 'page-student-dash' : 'page-student-apps';
                document.getElementById(target).classList.add('active');
                document.getElementById('public-nav').style.display = 'none';
                document.getElementById('private-nav').style.display = 'flex';
                
                // Load student chat when on dashboard
                if(page === 'student') {
                    setTimeout(() => {
                        if(typeof loadStudentChat === 'function') {
                            loadStudentChat();
                        }
                    }, 100);
                }
                
                // Load data from Firestore or localStorage
                if(page === 'student-apps') {
                if(isDemoMode) {
                    const saved = localStorage.getItem('demoApp');
                    if(saved) {
                        currentApplication = JSON.parse(saved);
                        selectedUnis = currentApplication.universities || [];
                        }
                    } else if(auth && auth.currentUser) {
                        // Data should already be loaded in auth state handler, but ensure it's loaded
                        getDoc(doc(db, "users", auth.currentUser.uid)).then(docSnap => {
                            if(docSnap.exists()) {
                                currentApplication = docSnap.data();
                                selectedUnis = currentApplication.universities || [];
                                loadFormData();
                            }
                        }).catch(e => console.error('Error loading data:', e));
                    }
                    // Load form data after a small delay to ensure DOM is ready
                    setTimeout(() => loadFormData(), 100);
                }
                updateDashboardUI();
            } else if (page === 'counselor') {
                document.getElementById('page-counselor-dash').classList.add('active');
                document.getElementById('public-nav').style.display = 'none';
                document.getElementById('private-nav').style.display = 'flex';
                // Wait a bit to ensure Firebase is ready, then show available students selection
                setTimeout(() => {
                    if(typeof renderAvailableStudents === 'function') {
                        renderAvailableStudents();
                    } else if(typeof renderStudentList === 'function') {
                        // Fallback if renderAvailableStudents is not available
                        renderStudentList('active');
                    } else {
                        console.error('renderAvailableStudents is not a function');
                    }
                }, 100);
            } else if (page === 'admin') {
                document.getElementById('page-admin-dash').classList.add('active');
                document.getElementById('public-nav').style.display = 'none';
                document.getElementById('private-nav').style.display = 'flex';
                // Show "Back to Counselor Panel" link if user is a counselor
                const backLink = document.getElementById('back-to-counselor-link');
                if(backLink) {
                    backLink.style.display = window.currentRole === 'counselor' ? 'block' : 'none';
                }
                // Wait a bit to ensure Firebase is ready, then show dashboard
                setTimeout(() => {
                    if(typeof showAdminView === 'function') {
                        showAdminView('dashboard');
                    } else if(typeof renderAdminUsers === 'function') {
                        renderAdminUsers('all');
                    }
                }, 100);
            } else {
                document.getElementById('page-' + page).classList.add('active');
                document.getElementById('public-nav').style.display = 'flex';
                document.getElementById('private-nav').style.display = 'none';
            }
            window.scrollTo(0, 0);
        };

        // --- ADMIN FUNCTIONS ---
        window.renderAdminUsers = async function(filter = 'all') {
            // Show users view
            showAdminView('users');
            
            // Update active menu item (exclude back link)
            document.querySelectorAll('.dash-menu-item').forEach(item => {
                // Skip the back to counselor link
                if(item.id === 'back-to-counselor-link') return;
                
                const itemText = item.textContent || '';
                if((filter === 'all' && itemText.includes('All Users')) ||
                   (filter === 'students' && itemText.includes('Students')) ||
                   (filter === 'counselors' && itemText.includes('Counselors')) ||
                   (filter === 'admins' && itemText.includes('Admins'))) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            const list = document.getElementById('admin-users-list');
            const header = document.getElementById('admin-list-header');
            
            if(!list) {
                console.error('Admin users list element not found');
                return;
            }
            
            // Update header
            const headers = {
                'all': 'All Users',
                'students': 'Students',
                'counselors': 'Counselors',
                'admins': 'Administrators'
            };
            if(header) header.innerText = headers[filter] || 'All Users';
            
            list.innerHTML = "<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-spinner fa-spin'></i> Loading users...</div>";
            
            if(!db) {
                list.innerHTML = "<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Database not initialized.</div>";
                return;
            }
            
            try {
                let allUsers = [];
                
                // Get all users from users collection (exclude deleted)
                const usersSnapshot = await getDocs(collection(db, "users"));
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Skip deleted users
                    if(userData.deleted) return;
                    const role = userData.role || 'student';
                    allUsers.push({
                        id: doc.id,
                        email: userData.email || 'N/A',
                        fname: userData.fname || '',
                        lname: userData.lname || '',
                        role: role,
                        milestone: userData.milestone || null,
                        counselorId: userData.counselorId || null,
                        status: userData.status || 'Draft',
                        createdAt: userData.createdAt || null,
                        updatedAt: userData.updatedAt || null
                    });
                });
                
                // Get counselors from counselors collection (for those not in users)
                const counselorsSnapshot = await getDocs(collection(db, "counselors"));
                counselorsSnapshot.forEach((doc) => {
                    const counselorData = doc.data();
                    // Skip deleted counselors
                    if(counselorData.deleted) return;
                    // Check if already in allUsers
                    const exists = allUsers.find(u => u.id === doc.id);
                    if(!exists) {
                        allUsers.push({
                            id: doc.id,
                            email: counselorData.email || 'N/A',
                            fname: '',
                            lname: '',
                            role: 'counselor',
                            counselorId: null,
                            status: null,
                            createdAt: counselorData.createdAt || null,
                            updatedAt: counselorData.updatedAt || null
                        });
                    } else {
                        // Update role if not set
                        const userIndex = allUsers.findIndex(u => u.id === doc.id);
                        if(userIndex >= 0 && allUsers[userIndex].role !== 'counselor') {
                            allUsers[userIndex].role = 'counselor';
                        }
                    }
                });
                
                // Filter users
                let filteredUsers = allUsers;
                if(filter === 'students') {
                    filteredUsers = allUsers.filter(u => u.role === 'student');
                } else if(filter === 'counselors') {
                    filteredUsers = allUsers.filter(u => u.role === 'counselor');
                } else if(filter === 'admins') {
                    filteredUsers = allUsers.filter(u => u.role === 'admin');
                }
                
                list.innerHTML = "";
                
                if(filteredUsers.length === 0) {
                    list.innerHTML = `<div style='padding:20px; color:#999; text-align:center;'><i class='fas fa-users' style='font-size: 2rem; opacity: 0.3; margin-bottom: 10px;'></i><p>No ${filter} users found.</p></div>`;
                    return;
                }
                
                // Render users
                filteredUsers.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'student-item';
                    div.style.padding = '15px';
                    
                    const roleBadge = {
                        'admin': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-user-shield"></i> Admin</span>',
                        'counselor': '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-user-tie"></i> Counselor</span>',
                        'student': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-user-graduate"></i> Student</span>'
                    };
                    
                    const userName = `${u.fname || ''} ${u.lname || ''}`.trim() || u.email || 'Unknown User';
                    
                    // Add milestone badge for students
                    const milestoneColors = {
                        'Joined': '#17a2b8',
                        'IELTS Completed': '#007bff',
                        'Applied for College': '#6c757d',
                        'Offer Letter Approved': '#28a745',
                        'Offer Letter Denied': '#dc3545',
                        'Visa Applied': '#ffc107',
                        'Visa Approved': '#28a745',
                        'Visa Denied': '#dc3545'
                    };
                    const milestoneBadge = (u.role === 'student' && u.milestone) ? 
                        `<span style="background: ${milestoneColors[u.milestone] || '#6c757d'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px; font-weight: 500;">${u.milestone}</span>` : '';
                    
                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <input type="checkbox" data-user-id="${u.id}" onchange="updateBulkActions()" style="width: 18px; height: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
                                    ${userName}${milestoneBadge}
                                </div>
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                                    <i class="fas fa-envelope" style="margin-right: 5px;"></i>${u.email}
                                    ${u.role ? ` • ${roleBadge[u.role] || ''}` : ''}
                                    ${u.status ? ` • <span style="color: #999;">Status: ${u.status}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="coun-action-btn" title="Edit" onclick="editAdminUser('${u.id}')"><i class="fas fa-edit"></i></button>
                            ${u.role !== 'admin' ? `<button class="coun-action-btn delete" title="Delete" onclick="deleteAdminUser('${u.id}', '${u.role}')"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch(e) {
                console.error('Error loading users:', e);
                let errorMsg = e.message;
                if(e.message && e.message.includes('permission') || e.message.includes('Permission')) {
                    errorMsg = 'Permission denied. Please ensure you are logged in as an admin and your admin role is properly set in the database.';
                }
                list.innerHTML = `<div style='padding:20px; color:var(--danger); text-align:center;'><i class='fas fa-exclamation-triangle'></i> Error loading users: ${errorMsg}<br><small style='margin-top:10px; display:block;'>If you are an admin, please check that your user document exists and has role='admin' set.</small></div>`;
            }
        };
        
        window.showCreateUserModal = function() {
            document.getElementById('create-user-modal').classList.add('active');
            // Clear form
            document.getElementById('create-user-email').value = '';
            document.getElementById('create-user-password').value = '';
            document.getElementById('create-user-role').value = 'student';
            document.getElementById('create-user-fname').value = '';
            document.getElementById('create-user-lname').value = '';
        };
        
        window.closeCreateUserModal = function() {
            document.getElementById('create-user-modal').classList.remove('active');
        };
        
        window.createNewUser = async function() {
            const email = document.getElementById('create-user-email').value;
            const password = document.getElementById('create-user-password').value;
            const role = document.getElementById('create-user-role').value;
            const fname = document.getElementById('create-user-fname').value;
            const lname = document.getElementById('create-user-lname').value;
            
            if(!email || !password) {
                alert('Please enter email and password.');
                return;
            }
            if(password.length < 6) {
                alert('Password must be at least 6 characters.');
                return;
            }
            
            try {
                // Create auth user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user document
                const userData = {
                    email: email,
                    fname: fname || '',
                    lname: lname || '',
                    role: role,
                    status: role === 'student' ? 'Draft' : null,
                    counselorId: null, // Explicitly set to null - no auto-assignment
                    milestone: null, // Explicitly set to null - no milestone by default
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await setDoc(doc(db, "users", user.uid), userData);
                
                // If counselor, also create in counselors collection
                if(role === 'counselor') {
                    const counselorName = (fname + ' ' + lname).trim() || email.split('@')[0];
                    await setDoc(doc(db, "counselors", user.uid), {
                        email: email,
                        name: counselorName,
                        studentCount: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                
                alert('User created successfully!');
                closeCreateUserModal();
                const activeItem = document.querySelector('.dash-menu-item.active');
                const activeText = activeItem ? activeItem.textContent : '';
                const filter = activeText.includes('Students') ? 'students' : 
                              activeText.includes('Counselors') ? 'counselors' :
                              activeText.includes('Admins') ? 'admins' : 'all';
                renderAdminUsers(filter);
            } catch(err) {
                console.error('Error creating user:', err);
                alert(`Error creating user: ${err.message}`);
            }
        };
        
        window.editAdminUser = async function(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if(!userDoc.exists()) {
                    alert('User not found.');
                    return;
                }
                
                const userData = userDoc.data();
                
                // Populate edit form
                document.getElementById('edit-user-id').value = userId;
                document.getElementById('edit-user-email').value = userData.email || '';
                document.getElementById('edit-user-role').value = userData.role || 'student';
                document.getElementById('edit-user-fname').value = userData.fname || '';
                document.getElementById('edit-user-lname').value = userData.lname || '';
                
                // Load counselors for assignment (if student)
                if(userData.role === 'student') {
                    document.getElementById('edit-student-counselor').style.display = 'block';
                    const counselorSelect = document.getElementById('edit-user-counselor');
                    counselorSelect.innerHTML = '<option value="">None (Not Assigned)</option>';
                    
                    const counselorsSnapshot = await getDocs(collection(db, "counselors"));
                    counselorsSnapshot.forEach((doc) => {
                        const counselorData = doc.data();
                        if(counselorData.deleted) return; // Skip deleted counselors
                        const selected = userData.counselorId === doc.id ? 'selected' : '';
                        counselorSelect.innerHTML += `<option value="${doc.id}" ${selected}>${counselorData.name || counselorData.email || doc.id}</option>`;
                    });
                    
                    // Explicitly set to empty string if no counselor assigned
                    counselorSelect.value = userData.counselorId || '';
                } else {
                    document.getElementById('edit-student-counselor').style.display = 'none';
                }
                
                document.getElementById('edit-user-modal').classList.add('active');
            } catch(e) {
                console.error('Error loading user:', e);
                alert('Error loading user data.');
            }
        };
        
        window.closeEditUserModal = function() {
            document.getElementById('edit-user-modal').classList.remove('active');
        };
        
        window.saveUserChanges = async function() {
            const userId = document.getElementById('edit-user-id').value;
            const role = document.getElementById('edit-user-role').value;
            const fname = document.getElementById('edit-user-fname').value;
            const lname = document.getElementById('edit-user-lname').value;
            const counselorId = document.getElementById('edit-user-counselor')?.value || null;
            
            if(!userId) {
                alert('User ID missing.');
                return;
            }
            
            try {
                // Get current user data
                const userDoc = await getDoc(doc(db, "users", userId));
                if(!userDoc.exists()) {
                    alert('User not found.');
                    return;
                }
                
                const currentData = userDoc.data();
                const currentRole = currentData.role || 'student';
                
                // Update user document
                const updateData = {
                    fname: fname || '',
                    lname: lname || '',
                    role: role,
                    updatedAt: new Date().toISOString()
                };
                
                // If student, update counselor assignment (only if explicitly set)
                if(role === 'student') {
                    // Only update counselorId if it was explicitly changed
                    const counselorSelect = document.getElementById('edit-user-counselor');
                    if(counselorSelect) {
                        const selectedCounselorId = counselorSelect.value || null;
                        updateData.counselorId = selectedCounselorId;
                        if(selectedCounselorId) {
                            updateData.assignedAt = new Date().toISOString();
                        } else {
                            // If set to "None", remove assignment
                            updateData.counselorId = null;
                            updateData.assignedAt = null;
                        }
                    }
                }
                
                await updateDoc(doc(db, "users", userId), updateData);
                
                // Handle role changes
                if(currentRole !== role) {
                    // If changing from counselor, remove from counselors collection
                    if(currentRole === 'counselor' && role !== 'counselor') {
                        try {
                            await updateDoc(doc(db, "counselors", userId), {
                                deleted: true,
                                updatedAt: new Date().toISOString()
                            });
                        } catch(e) {
                            console.log('Counselor document may not exist');
                        }
                    }
                    
                    // If changing to counselor, add to counselors collection
                    if(role === 'counselor' && currentRole !== 'counselor') {
                        const counselorName = (fname + ' ' + lname).trim() || (currentData.email ? currentData.email.split('@')[0] : '') || 'Counselor';
                        await setDoc(doc(db, "counselors", userId), {
                            email: currentData.email || '',
                            name: counselorName,
                            studentCount: 0,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }
                }
                
                alert('User updated successfully!');
                closeEditUserModal();
                const activeItem = document.querySelector('.dash-menu-item.active');
                const activeText = activeItem ? activeItem.textContent : '';
                const activeFilter = activeText.includes('Students') ? 'students' : 
                                   activeText.includes('Counselors') ? 'counselors' :
                                   activeText.includes('Admins') ? 'admins' : 'all';
                renderAdminUsers(activeFilter);
            } catch(e) {
                console.error('Error updating user:', e);
                alert(`Error updating user: ${e.message}`);
            }
        };
        
        window.deleteAdminUser = async function(userId, role) {
            if(!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Delete from users collection
                await updateDoc(doc(db, "users", userId), {
                    deleted: true,
                    deletedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                // If counselor, also mark in counselors collection
                if(role === 'counselor') {
                    try {
                        await updateDoc(doc(db, "counselors", userId), {
                            deleted: true,
                            deletedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    } catch(e) {
                        console.log('Counselor document may not exist');
                    }
                }
                
                alert('User deleted successfully!');
                const activeItem = document.querySelector('.dash-menu-item.active');
                const activeText = activeItem ? activeItem.textContent : '';
                const activeFilter = activeText.includes('Students') ? 'students' : 
                                   activeText.includes('Counselors') ? 'counselors' :
                                   activeText.includes('Admins') ? 'admins' : 'all';
                renderAdminUsers(activeFilter);
            } catch(e) {
                console.error('Error deleting user:', e);
                alert(`Error deleting user: ${e.message}`);
            }
        };

        // --- NEW ADMIN FEATURES ---
        
        // View switcher
        window.showAdminView = function(view) {
            // Hide all views
            document.getElementById('admin-dashboard-view').style.display = 'none';
            document.getElementById('admin-users-view').style.display = 'none';
            document.getElementById('admin-analytics-view').style.display = 'none';
            document.getElementById('admin-activity-view').style.display = 'none';
            document.getElementById('admin-contacts-view').style.display = 'none';
            
            // Update menu items
            document.querySelectorAll('.dash-menu-item').forEach(item => {
                if(item.id === 'back-to-counselor-link') return;
                item.classList.remove('active');
            });
            
            // Show selected view
            if(view === 'dashboard') {
                document.getElementById('admin-dashboard-view').style.display = 'block';
                document.getElementById('admin-menu-dashboard').classList.add('active');
                loadAdminDashboard();
            } else if(view === 'users') {
                document.getElementById('admin-users-view').style.display = 'block';
                document.getElementById('admin-menu-users').classList.add('active');
                renderAdminUsers('all');
            } else if(view === 'analytics') {
                document.getElementById('admin-analytics-view').style.display = 'block';
                document.getElementById('admin-menu-analytics').classList.add('active');
                loadAdminAnalytics();
            } else if(view === 'activity') {
                document.getElementById('admin-activity-view').style.display = 'block';
                document.getElementById('admin-menu-activity').classList.add('active');
                loadActivityLogs();
            } else if(view === 'contacts') {
                document.getElementById('admin-contacts-view').style.display = 'block';
                document.getElementById('admin-menu-contacts').classList.add('active');
                loadContactMessages();
            }
        };

        // Load dashboard statistics
        window.loadAdminDashboard = async function() {
            if(!db) return;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const counselorsSnapshot = await getDocs(collection(db, "counselors"));
                
                let totalUsers = 0, students = 0, counselors = 0, admins = 0;
                const recentActivity = [];
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    totalUsers++;
                    const role = data.role || 'student';
                    if(role === 'student') students++;
                    else if(role === 'counselor') counselors++;
                    else if(role === 'admin') admins++;
                    
                    if(data.createdAt) {
                        recentActivity.push({
                            type: 'user_created',
                            user: data.email || 'Unknown',
                            role: role,
                            date: data.createdAt,
                            timestamp: new Date(data.createdAt).getTime()
                        });
                    }
                    if(data.updatedAt && data.updatedAt !== data.createdAt) {
                        recentActivity.push({
                            type: 'user_updated',
                            user: data.email || 'Unknown',
                            role: role,
                            date: data.updatedAt,
                            timestamp: new Date(data.updatedAt).getTime()
                        });
                    }
                });
                
                counselorsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    if(!usersSnapshot.docs.find(d => d.id === doc.id)) {
                        counselors++;
                        totalUsers++;
                    }
                });
                
                // Update statistics
                document.getElementById('admin-stat-total').textContent = totalUsers;
                document.getElementById('admin-stat-students').textContent = students;
                document.getElementById('admin-stat-counselors').textContent = counselors;
                document.getElementById('admin-stat-admins').textContent = admins;
                
                // Render pie chart (simple text-based)
                const pieChart = document.getElementById('admin-pie-chart');
                if(pieChart) {
                    const total = students + counselors + admins;
                    if(total > 0) {
                        pieChart.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="background: #28a745; height: ${(students/total)*100}%; min-height: 20px; border-radius: 4px; margin-bottom: 5px;"></div>
                                    <div style="text-align: center; font-size: 0.9rem;">Students: ${Math.round((students/total)*100)}%</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="background: #ffc107; height: ${(counselors/total)*100}%; min-height: 20px; border-radius: 4px; margin-bottom: 5px;"></div>
                                    <div style="text-align: center; font-size: 0.9rem;">Counselors: ${Math.round((counselors/total)*100)}%</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="background: #dc3545; height: ${(admins/total)*100}%; min-height: 20px; border-radius: 4px; margin-bottom: 5px;"></div>
                                    <div style="text-align: center; font-size: 0.9rem;">Admins: ${Math.round((admins/total)*100)}%</div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Render recent activity
                recentActivity.sort((a, b) => b.timestamp - a.timestamp);
                const activityHtml = recentActivity.slice(0, 10).map(activity => {
                    const date = new Date(activity.date);
                    const timeAgo = getTimeAgo(date);
                    const icon = activity.type === 'user_created' ? 'fa-user-plus' : 'fa-user-edit';
                    const color = activity.type === 'user_created' ? '#28a745' : '#007bff';
                    return `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                            <i class="fas ${icon}" style="color: ${color};"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${activity.user}</div>
                                <div style="font-size: 0.85rem; color: #666;">${activity.role} • ${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('admin-recent-activity').innerHTML = activityHtml || '<div style="text-align: center; padding: 20px; color: #999;">No recent activity</div>';
                
            } catch(e) {
                console.error('Error loading dashboard:', e);
            }
        };

        // Helper function for time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if(seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if(minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if(hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if(days < 7) return `${days}d ago`;
            const weeks = Math.floor(days / 7);
            return `${weeks}w ago`;
        }

        // Load analytics
        window.loadAdminAnalytics = async function() {
            if(!db) return;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                let newUsers = 0;
                const statusCounts = { Draft: 0, Submitted: 0, 'In Review': 0, Approved: 0, Rejected: 0 };
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    
                    if(data.createdAt) {
                        const created = new Date(data.createdAt);
                        if(created >= thirtyDaysAgo) newUsers++;
                    }
                    
                    if(data.status) {
                        statusCounts[data.status] = (statusCounts[data.status] || 0) + 1;
                    }
                });
                
                // Render new users chart
                document.getElementById('admin-new-users-chart').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; color: #007bff; font-weight: bold;">${newUsers}</div>
                        <div style="color: #666; margin-top: 10px;">New users in last 30 days</div>
                    </div>
                `;
                
                // Render status chart
                const statusHtml = Object.entries(statusCounts).filter(([status, count]) => count > 0).map(([status, count]) => {
                    const colors = {
                        'Draft': '#6c757d',
                        'Submitted': '#007bff',
                        'In Review': '#ffc107',
                        'Approved': '#28a745',
                        'Rejected': '#dc3545'
                    };
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>${status}</span>
                                <span style="font-weight: 600;">${count}</span>
                            </div>
                            <div style="background: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: ${colors[status] || '#007bff'}; height: 100%; width: ${(count / Math.max(...Object.values(statusCounts))) * 100}%;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('admin-status-chart').innerHTML = statusHtml || '<div style="text-align: center; color: #999;">No status data</div>';
                
                // Detailed stats table
                const statsHtml = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Metric</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">Total Users</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;" id="analytics-total">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">New Users (30 days)</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${newUsers}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">Students</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;" id="analytics-students">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">Counselors</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;" id="analytics-counselors">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px;">Admins</td>
                                <td style="padding: 10px; text-align: right;" id="analytics-admins">-</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                document.getElementById('admin-detailed-stats').innerHTML = statsHtml;
                
                // Update detailed stats
                const total = usersSnapshot.size;
                document.getElementById('analytics-total').textContent = total;
                document.getElementById('analytics-students').textContent = statusCounts.Draft + statusCounts.Submitted + (statusCounts['In Review'] || 0);
                document.getElementById('analytics-counselors').textContent = Object.keys(statusCounts).length;
                document.getElementById('analytics-admins').textContent = '1';
                
            } catch(e) {
                console.error('Error loading analytics:', e);
            }
        };

        // Load activity logs
        window.loadActivityLogs = async function() {
            if(!db) return;
            
            const dateFrom = document.getElementById('activity-date-from').value;
            const dateTo = document.getElementById('activity-date-to').value;
            const filterType = document.getElementById('activity-filter-type').value;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const activities = [];
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.deleted) return;
                    
                    if(data.createdAt) {
                        const date = new Date(data.createdAt);
                        if((!dateFrom || date >= new Date(dateFrom)) && (!dateTo || date <= new Date(dateTo))) {
                            if(filterType === 'all' || filterType === 'user_created') {
                                activities.push({
                                    type: 'user_created',
                                    user: data.email || 'Unknown',
                                    role: data.role || 'student',
                                    date: data.createdAt,
                                    timestamp: date.getTime()
                                });
                            }
                        }
                    }
                    
                    if(data.updatedAt && data.updatedAt !== data.createdAt) {
                        const date = new Date(data.updatedAt);
                        if((!dateFrom || date >= new Date(dateFrom)) && (!dateTo || date <= new Date(dateTo))) {
                            if(filterType === 'all' || filterType === 'user_updated') {
                                activities.push({
                                    type: 'user_updated',
                                    user: data.email || 'Unknown',
                                    role: data.role || 'student',
                                    date: data.updatedAt,
                                    timestamp: date.getTime()
                                });
                            }
                        }
                    }
                });
                
                activities.sort((a, b) => b.timestamp - a.timestamp);
                
                const logsHtml = activities.length > 0 ? activities.map(activity => {
                    const date = new Date(activity.date);
                    const icon = activity.type === 'user_created' ? 'fa-user-plus' : 
                                activity.type === 'user_deleted' ? 'fa-user-times' : 'fa-user-edit';
                    const color = activity.type === 'user_created' ? '#28a745' : 
                                 activity.type === 'user_deleted' ? '#dc3545' : '#007bff';
                    const typeText = activity.type === 'user_created' ? 'User Created' :
                                    activity.type === 'user_deleted' ? 'User Deleted' : 'User Updated';
                    
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
                            <div style="width: 40px; height: 40px; background: ${color}20; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${icon}" style="color: ${color};"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${typeText}</div>
                                <div style="font-size: 0.9rem; color: #666;">${activity.user} (${activity.role})</div>
                                <div style="font-size: 0.85rem; color: #999; margin-top: 5px;">${date.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }).join('') : '<div style="text-align: center; padding: 40px; color: #999;">No activities found</div>';
                
                document.getElementById('admin-activity-logs').innerHTML = logsHtml;
                
            } catch(e) {
                console.error('Error loading activity logs:', e);
                document.getElementById('admin-activity-logs').innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;">Error loading activity logs</div>';
            }
        };

        // --- CONTACT MESSAGES FUNCTIONS ---
        let currentContactId = null;
        let contactMessagesUnsubscribe = null;

        // Handle contact form submission
        window.handleContactSubmit = async function(event) {
            event.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const message = document.getElementById('contact-message').value;
            const statusEl = document.getElementById('contact-form-status');

            if(!name || !email || !message) {
                statusEl.style.display = 'block';
                statusEl.style.color = 'var(--danger)';
                statusEl.textContent = 'Please fill in all fields';
                return;
            }

            const contactData = {
                name: name,
                email: email,
                message: message,
                status: 'new',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                replies: []
            };

            // Try Firebase first, fallback to localStorage if it fails
            if(db && !isDemoMode) {
                try {
                    await addDoc(collection(db, "contactMessages"), contactData);
                    statusEl.style.display = 'block';
                    statusEl.style.color = 'var(--success)';
                    statusEl.textContent = 'Thank you! We will contact you shortly.';
                    document.getElementById('contact-form').reset();
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                    return; // Success, exit function
                } catch(e) {
                    console.error('Firebase error, falling back to localStorage:', e);
                    // Fall through to localStorage fallback
                }
            }

            // Fallback to localStorage (demo mode or if Firebase fails)
            try {
                const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                messages.push({ ...contactData, id: 'demo-' + Date.now() });
                localStorage.setItem('demoContactMessages', JSON.stringify(messages));
                statusEl.style.display = 'block';
                statusEl.style.color = 'var(--success)';
                statusEl.textContent = 'Thank you! Your message has been received.';
                document.getElementById('contact-form').reset();
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            } catch(e) {
                console.error('Error saving to localStorage:', e);
                statusEl.style.display = 'block';
                statusEl.style.color = 'var(--danger)';
                statusEl.textContent = 'Error saving message. Please try again or contact us directly.';
            }
        };

        // Load contact messages
        window.loadContactMessages = async function() {
            const listEl = document.getElementById('contact-messages-list');
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Loading messages...</p></div>';

            try {
                let messages = [];

                if(db && !isDemoMode) {
                    const snapshot = await getDocs(collection(db, "contactMessages"));
                    snapshot.forEach((doc) => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                } else {
                    // Demo mode
                    const demoMessages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    messages = demoMessages;
                }

                // Sort by date (newest first)
                messages.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                if(messages.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px;"></i><p>No messages yet</p></div>';
                    return;
                }

                listEl.innerHTML = messages.map(msg => {
                    const date = new Date(msg.createdAt);
                    const isNew = msg.status === 'new';
                    const unreadCount = (msg.replies || []).filter(r => !r.read).length;
                    return `
                        <div class="student-item ${currentContactId === msg.id ? 'active' : ''}" data-contact-id="${msg.id}" onclick="openContactChat('${msg.id}', this)" style="cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                    <strong style="color: var(--primary);">${msg.name}</strong>
                                    ${isNew ? '<span class="status-badge" style="background: #d1e7dd; color: #0f5132; font-size: 0.75rem;">New</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">${msg.email}</div>
                                <div style="font-size: 0.8rem; color: #999; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px;">
                                    ${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}
                                </div>
                                <div style="font-size: 0.75rem; color: #999; margin-top: 5px;">${date.toLocaleDateString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Set up real-time listener for new messages
                if(db && !isDemoMode && !contactMessagesUnsubscribe) {
                    contactMessagesUnsubscribe = onSnapshot(collection(db, "contactMessages"), (snapshot) => {
                        loadContactMessages();
                    });
                }

            } catch(e) {
                console.error('Error loading contact messages:', e);
                listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i><p>Error loading messages</p></div>';
            }
        };

        // Open contact chat
        window.openContactChat = async function(contactId, clickedElement) {
            currentContactId = contactId;
            
            // Update active state
            document.querySelectorAll('#contact-messages-list .student-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activate the clicked item
            if(clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Fallback: find by data attribute
                const item = document.querySelector(`[data-contact-id="${contactId}"]`);
                if(item) item.classList.add('active');
            }

            try {
                let contactData = null;

                if(db && !isDemoMode) {
                    const docRef = doc(db, "contactMessages", contactId);
                    const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) {
                        contactData = { id: docSnap.id, ...docSnap.data() };
                    }
                } else {
                    // Demo mode
                    const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    contactData = messages.find(m => m.id === contactId);
                }

                if(!contactData) {
                    alert('Contact not found');
                    return;
                }

                // Update chat header
                document.getElementById('contact-chat-name').textContent = contactData.name;
                document.getElementById('contact-chat-email').textContent = contactData.email;
                const statusBadge = document.getElementById('contact-chat-status');
                if(contactData.status === 'new') {
                    statusBadge.textContent = 'New';
                    statusBadge.style.background = '#d1e7dd';
                    statusBadge.style.color = '#0f5132';
                } else if(contactData.status === 'replied') {
                    statusBadge.textContent = 'Replied';
                    statusBadge.style.background = '#cfe2ff';
                    statusBadge.style.color = '#084298';
                } else {
                    statusBadge.textContent = 'Closed';
                    statusBadge.style.background = '#f8d7da';
                    statusBadge.style.color = '#842029';
                }

                // Load messages
                const chatBody = document.getElementById('contact-chat-body');
                const initialMessage = {
                    text: contactData.message,
                    sender: 'contact',
                    timestamp: contactData.createdAt
                };
                const replies = contactData.replies || [];
                const allMessages = [initialMessage, ...replies].sort((a, b) => 
                    new Date(a.timestamp || a.createdAt || 0) - new Date(b.timestamp || b.createdAt || 0)
                );

                chatBody.innerHTML = allMessages.map(msg => {
                    const isAdmin = msg.sender === 'admin';
                    const date = new Date(msg.timestamp || msg.createdAt);
                    return `
                        <div class="message ${isAdmin ? 'msg-out' : 'msg-in'}" style="max-width: 70%;">
                            <div>${msg.text || msg.message}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">
                                ${date.toLocaleString()}
                            </div>
                        </div>
                    `;
                }).join('');

                chatBody.scrollTop = chatBody.scrollHeight;

                // Show chat view
                document.getElementById('contact-chat-empty').style.display = 'none';
                document.getElementById('contact-chat-view').style.display = 'flex';

                // Mark as read if new
                if(contactData.status === 'new' && db && !isDemoMode) {
                    await updateDoc(doc(db, "contactMessages", contactId), {
                        status: 'replied',
                        updatedAt: new Date().toISOString()
                    });
                } else if(contactData.status === 'new' && isDemoMode) {
                    const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    const index = messages.findIndex(m => m.id === contactId);
                    if(index !== -1) {
                        messages[index].status = 'replied';
                        localStorage.setItem('demoContactMessages', JSON.stringify(messages));
                    }
                }

            } catch(e) {
                console.error('Error opening contact chat:', e);
                alert('Error loading contact details');
            }
        };

        // Send reply to contact
        window.sendContactReply = async function() {
            if(!currentContactId) return;

            const input = document.getElementById('contact-chat-input');
            const messageText = input.value.trim();
            if(!messageText) return;

            try {
                const reply = {
                    text: messageText,
                    sender: 'admin',
                    timestamp: new Date().toISOString(),
                    read: false
                };

                if(db && !isDemoMode) {
                    const contactRef = doc(db, "contactMessages", currentContactId);
                    const contactSnap = await getDoc(contactRef);
                    if(!contactSnap.exists()) {
                        alert('Contact not found');
                        return;
                    }

                    const currentReplies = contactSnap.data().replies || [];
                    await updateDoc(contactRef, {
                        replies: [...currentReplies, reply],
                        status: 'replied',
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    // Demo mode
                    const messages = JSON.parse(localStorage.getItem('demoContactMessages') || '[]');
                    const index = messages.findIndex(m => m.id === currentContactId);
                    if(index !== -1) {
                        if(!messages[index].replies) messages[index].replies = [];
                        messages[index].replies.push(reply);
                        messages[index].status = 'replied';
                        localStorage.setItem('demoContactMessages', JSON.stringify(messages));
                    }
                }

                // Add message to UI
                const chatBody = document.getElementById('contact-chat-body');
                const date = new Date();
                chatBody.innerHTML += `
                    <div class="message msg-out" style="max-width: 70%;">
                        <div>${messageText}</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">
                            ${date.toLocaleString()}
                        </div>
                    </div>
                `;
                chatBody.scrollTop = chatBody.scrollHeight;

                input.value = '';
                
                // Reload messages list to update status
                loadContactMessages();

            } catch(e) {
                console.error('Error sending reply:', e);
                alert('Error sending reply. Please try again.');
            }
        };

        // Filter contact messages
        window.filterContactMessages = function(searchTerm) {
            const items = document.querySelectorAll('#contact-messages-list .student-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = !searchTerm || text.includes(searchTerm.toLowerCase()) ? 'flex' : 'none';
            });
        };

        // Filter and search functions
        window.filterAdminUsers = function() {
            const searchTerm = document.getElementById('admin-search-users').value.toLowerCase();
            const roleFilter = document.getElementById('admin-filter-role').value;
            const statusFilter = document.getElementById('admin-filter-status').value;
            
            const items = document.querySelectorAll('#admin-users-list .student-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                const matchesSearch = !searchTerm || text.includes(searchTerm);
                const matchesRole = roleFilter === 'all' || text.includes(roleFilter);
                const matchesStatus = statusFilter === 'all' || text.includes(statusFilter);
                
                item.style.display = (matchesSearch && matchesRole && matchesStatus) ? 'flex' : 'none';
            });
        };

        window.clearAdminFilters = function() {
            document.getElementById('admin-search-users').value = '';
            document.getElementById('admin-filter-role').value = 'all';
            document.getElementById('admin-filter-status').value = 'all';
            filterAdminUsers();
        };

        // Bulk operations
        window.toggleSelectAllUsers = function() {
            const selectAll = document.getElementById('admin-select-all').checked;
            document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]').forEach(cb => {
                cb.checked = selectAll;
            });
            updateBulkActions();
        };

        window.updateBulkActions = function() {
            const selected = document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]:checked').length;
            const bulkActions = document.getElementById('admin-bulk-actions');
            const countSpan = document.getElementById('admin-selected-count');
            
            if(selected > 0) {
                bulkActions.style.display = 'block';
                countSpan.textContent = `${selected} user${selected > 1 ? 's' : ''} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
        };

        window.clearUserSelection = function() {
            document.getElementById('admin-select-all').checked = false;
            document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]').forEach(cb => {
                cb.checked = false;
            });
            updateBulkActions();
        };

        window.bulkDeleteUsers = async function() {
            const selected = Array.from(document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]:checked'))
                .map(cb => cb.getAttribute('data-user-id'));
            
            if(selected.length === 0) {
                alert('No users selected');
                return;
            }
            
            if(!confirm(`Are you sure you want to delete ${selected.length} user(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                for(const userId of selected) {
                    await updateDoc(doc(db, "users", userId), {
                        deleted: true,
                        deletedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                alert(`${selected.length} user(s) deleted successfully!`);
                clearUserSelection();
                renderAdminUsers('all');
            } catch(e) {
                console.error('Error bulk deleting users:', e);
                alert(`Error deleting users: ${e.message}`);
            }
        };

        window.bulkAssignCounselor = async function() {
            const selected = Array.from(document.querySelectorAll('#admin-users-list input[type="checkbox"][data-user-id]:checked'))
                .map(cb => cb.getAttribute('data-user-id'));
            
            if(selected.length === 0) {
                alert('No users selected');
                return;
            }
            
            // Get all counselors
            const counselorsSnapshot = await getDocs(collection(db, "counselors"));
            const counselors = [];
            counselorsSnapshot.forEach(doc => {
                const data = doc.data();
                if(!data.deleted) {
                    counselors.push({ id: doc.id, name: data.name || data.email || 'Unknown' });
                }
            });
            
            if(counselors.length === 0) {
                alert('No counselors available');
                return;
            }
            
            const counselorOptions = counselors.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const counselorId = prompt(`Select counselor ID:\n\n${counselors.map((c, i) => `${i+1}. ${c.name} (${c.id})`).join('\n')}\n\nEnter counselor ID:`, '');
            
            if(!counselorId) return;
            
            try {
                for(const userId of selected) {
                    await updateDoc(doc(db, "users", userId), {
                        counselorId: counselorId,
                        assignedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                alert(`${selected.length} user(s) assigned to counselor successfully!`);
                clearUserSelection();
                renderAdminUsers('all');
            } catch(e) {
                console.error('Error bulk assigning counselor:', e);
                alert(`Error assigning counselor: ${e.message}`);
            }
        };

        // Export data
        window.exportUsersData = async function() {
            if(!db) return;
            
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const data = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if(userData.deleted) return;
                    data.push({
                        id: doc.id,
                        email: userData.email || '',
                        firstName: userData.fname || '',
                        lastName: userData.lname || '',
                        role: userData.role || 'student',
                        status: userData.status || '',
                        createdAt: userData.createdAt || '',
                        updatedAt: userData.updatedAt || ''
                    });
                });
                
                const csv = [
                    ['ID', 'Email', 'First Name', 'Last Name', 'Role', 'Status', 'Created At', 'Updated At'],
                    ...data.map(u => [u.id, u.email, u.firstName, u.lastName, u.role, u.status, u.createdAt, u.updatedAt])
                ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch(e) {
                console.error('Error exporting data:', e);
                alert(`Error exporting data: ${e.message}`);
            }
        };
        
        // Close modals when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modals = ['create-user-modal', 'edit-user-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if(modal) {
                    modal.addEventListener('click', function(e) {
                        if(e.target === modal) {
                            if(modalId === 'create-user-modal') closeCreateUserModal();
                            else if(modalId === 'edit-user-modal') closeEditUserModal();
                        }
                    });
                }
            });
        });

        // --- AUTH & DEMO ---
        window.startDemoMode = function() {
            isDemoMode = true;
            document.getElementById('demo-badge').style.display = 'block';
            const roleText = window.currentRole === 'student' ? 'Demo Student' : 
                           window.currentRole === 'admin' ? 'Demo Admin' : 'Demo Counselor';
            document.getElementById('user-display').innerText = roleText;
            if(window.currentRole === 'student') window.router('student');
            else if(window.currentRole === 'admin') window.router('admin');
            else window.router('counselor');
        };

        console.log('Defining handleLogin function...');
        window.handleLogin = async function() {
            try {
                const e = document.getElementById('auth-email').value;
                const p = document.getElementById('auth-pass').value;
                if(!e || !p) return showAuthError("Enter credentials.");
            if(isDemoMode) return alert("In Demo Mode. Use button below.");
            
            // Hardcoded admin credentials
            const ADMIN_EMAIL = 'admin@gmail.com';
            const ADMIN_PASSWORD = 'admin123';
            
            // Check for hardcoded admin credentials
            if(e === ADMIN_EMAIL && p === ADMIN_PASSWORD) {
                if (!auth || !db) return alert("Firebase Failed.");
                
                try {
                    // Try to sign in with Firebase using admin credentials
                    let userCredential;
                    try {
                        userCredential = await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                    } catch(signInError) {
                        // If user doesn't exist, create the admin account
                        if(signInError.code === 'auth/user-not-found') {
                            userCredential = await createUserWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
                        } else {
                            throw signInError;
                        }
                    }
                    
                    const user = userCredential.user;
                    
                    // Ensure admin user document exists in Firestore
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(!userDoc.exists()) {
                        await setDoc(doc(db, "users", user.uid), {
                            email: ADMIN_EMAIL,
                            role: 'admin',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    } else {
                        // Update role to admin if not already set
                        const userData = userDoc.data();
                        if(userData.role !== 'admin') {
                            await updateDoc(doc(db, "users", user.uid), {
                                role: 'admin',
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }
                    
                    // User will be automatically routed by onAuthStateChanged
                    showAuthError(""); // Clear any errors
                } catch(err) {
                    console.error('Admin login error:', err);
                    showAuthError(err.message || "Failed to authenticate admin.");
                }
                return;
            }
            
            if (!auth) return alert("Firebase Failed.");
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { showAuthError(err.message); }
            } catch(err) {
                console.error('Error in handleLogin:', err);
                alert('An error occurred during login. Please check the console for details.');
            }
        };

        window.toggleSignupMode = function() {
            const toggleBtn = document.getElementById('signup-toggle-btn');
            const submitBtn = document.getElementById('signup-submit-btn');
            
            if(toggleBtn.style.display === 'none') {
                toggleBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            } else {
                toggleBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            }
        };

        window.handleSignup = async function() {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-pass').value;
            
            if(!e || !p) return showAuthError("Enter email and password.");
            if(p.length < 6) return showAuthError("Password must be at least 6 characters.");
            if(isDemoMode) return alert("In Demo Mode. Use button below.");
            if (!auth || !db) return alert("Firebase Failed.");
            
            try {
                // Create user account - default to student
                const userCredential = await createUserWithEmailAndPassword(auth, e, p);
                const user = userCredential.user;
                
                // Create student/user document
                await setDoc(doc(db, "users", user.uid), {
                    email: e,
                    fname: '',
                    lname: '',
                    role: 'student',
                    status: 'Draft',
                    counselorId: null, // Explicitly set to null - no auto-assignment, counselors will choose
                    milestone: null, // Explicitly set to null - no milestone by default
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                console.log('Student account created successfully');
                
                // User will be automatically signed in and routed by onAuthStateChanged
                showAuthError(""); // Clear any errors
                alert('Student account created successfully!');
            } catch(err) {
                console.error('Signup error:', err);
                let errorMsg = err.message;
                if(err.code === 'auth/email-already-in-use') {
                    errorMsg = "This email is already registered. Please sign in instead.";
                } else if(err.code === 'auth/weak-password') {
                    errorMsg = "Password is too weak. Please use a stronger password.";
                } else if(err.code === 'auth/invalid-email') {
                    errorMsg = "Invalid email address.";
                }
                showAuthError(errorMsg);
            }
        };

        window.handleLogout = async function() {
            if(isDemoMode) window.location.reload();
            else { if(auth) await signOut(auth); window.location.reload(); }
        };

        // Store uploaded files
        let uploadedFiles = {};
        let uploadedFilesCounter = 0;
        
        window.handleUpload = async function(docId, docType) {
            const fileInput = document.getElementById('file-' + docId);
            const files = fileInput.files;
            
            if(!files || files.length === 0) {
                alert("Please select file(s) to upload.");
                return;
            }
            
            const list = document.getElementById('stu-file-list');
            if(!list) {
                console.error('File list container not found');
                return;
            }
            
            const noDocsDiv = list.querySelector('.no-docs');
            if(noDocsDiv) {
                noDocsDiv.remove();
            }
            
            // Initialize array for this document type if it doesn't exist
            if(!uploadedFiles[docType]) {
                uploadedFiles[docType] = [];
            }
            
            // Check for duplicate files by name to prevent duplicates
            const existingFileNames = uploadedFiles[docType].map(f => f.name.toLowerCase());
            
            // Helper function to compress images
            const compressImage = (file, maxWidth = 1920, quality = 0.8) => {
                return new Promise((resolve) => {
                    if (!file.type.startsWith('image/')) {
                        resolve(file); // Return original file if not an image
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Resize if too large
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob((blob) => {
                                if (blob && blob.size < file.size) {
                                    resolve(new File([blob], file.name, { type: file.type }));
                                } else {
                                    resolve(file); // Return original if compression didn't help
                                }
                            }, file.type, quality);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };
            
            // Process multiple files
            const uploadTime = new Date().toISOString();
            let newFilesCount = 0;
            const uploadPromises = [];
            const filesToUpload = [];
            
            // Prepare files for upload
            for (const file of Array.from(files)) {
                // Skip if file with same name already exists
                if(existingFileNames.includes(file.name.toLowerCase())) {
                    console.log(`File ${file.name} already exists, skipping duplicate`);
                    continue;
                }
                
                // No size limit - we'll use chunking for large files
                
                const fileId = `file-${uploadedFilesCounter++}`;
                existingFileNames.push(file.name.toLowerCase());
                newFilesCount++;
                filesToUpload.push({ file, fileId });
            }
            
            if(filesToUpload.length === 0) {
                alert("No new files to upload. All selected files may already be uploaded or are too large.");
                return;
            }
            
            // Show uploading indicator with file count
            const uploadingDiv = document.createElement('div');
            uploadingDiv.id = 'uploading-indicator';
            uploadingDiv.style.cssText = 'padding:15px; background:#e3f2fd; border:1px solid #2196f3; margin-top:10px; border-radius:6px; font-size:0.9rem;';
            uploadingDiv.innerHTML = `<div style="text-align:center; margin-bottom:10px;"><i class="fas fa-spinner fa-spin"></i> Uploading ${filesToUpload.length} file(s)...</div>`;
            list.appendChild(uploadingDiv);
            
            // Process each file with individual progress
            for (const { file, fileId } of filesToUpload) {
                // Create individual progress indicator
                const fileProgressDiv = document.createElement('div');
                fileProgressDiv.id = `progress-${fileId}`;
                fileProgressDiv.style.cssText = 'padding:8px; background:#fff; border:1px solid #ddd; margin-top:5px; border-radius:4px; font-size:0.85rem;';
                fileProgressDiv.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <span><i class="fas fa-file" style="margin-right:8px;"></i>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                        <span id="status-${fileId}" style="color:#2196f3;"><i class="fas fa-spinner fa-spin"></i> Uploading...</span>
                    </div>
                    <div style="margin-top:5px; background:#f0f0f0; border-radius:4px; height:4px; overflow:hidden;">
                        <div id="bar-${fileId}" style="background:#2196f3; height:100%; width:0%; transition:width 0.3s;"></div>
                    </div>
                `;
                uploadingDiv.appendChild(fileProgressDiv);
                
                // Upload to Firebase Storage if authenticated
                if(auth && auth.currentUser && !isDemoMode && storage && db) {
                    const uploadPromise = (async () => {
                        try {
                            // Use chunking for ALL files to stay within Firestore 1MB limit
                            // Compress image if it's an image file
                            let processedFile = file;
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            document.getElementById(`bar-${fileId}`).style.width = '5%';
                            processedFile = await compressImage(file);
                            
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            document.getElementById(`bar-${fileId}`).style.width = '10%';
                            
                            // Convert to Base64
                            const base64 = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = (e) => reject(new Error('Failed to read file'));
                                reader.readAsDataURL(processedFile);
                            });
                            
                            console.log(`File "${file.name}": Original size: ${(processedFile.size / 1024).toFixed(2)}KB, Base64 size: ${(base64.length / 1024).toFixed(2)}KB`);
                            
                            document.getElementById(`bar-${fileId}`).style.width = '15%';
                            
                            // Generate unique file ID for chunked storage
                            const chunkedFileId = `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                            
                            // Chunking Logic - Base64 increases size by ~33%, so we use 500KB chunks
                            // This ensures base64 chunks stay well under 1MB Firestore limit
                            // 500KB * 1.33 = ~665KB base64, safely under 1MB limit
                            const CHUNK_SIZE = 500 * 1024; // 500KB base64 string length (safe for 1MB Firestore limit)
                            const totalChunks = Math.ceil(base64.length / CHUNK_SIZE);
                            
                            console.log(`Splitting into ${totalChunks} chunks of max ${(CHUNK_SIZE / 1024).toFixed(2)}KB each`);
                            
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            document.getElementById(`bar-${fileId}`).style.width = '20%';
                            
                            // Save Chunks to 'file_data' collection using batches
                            const BATCH_SIZE = 500; // Firestore batch limit
                            let batch = writeBatch(db);
                            let batchCount = 0;
                            
                            for (let i = 0; i < totalChunks; i++) {
                                const chunkData = base64.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                                
                                // Validate chunk size (should be under 1MB)
                                const chunkSizeKB = chunkData.length / 1024;
                                if (chunkData.length > 1024 * 1024) {
                                    throw new Error(`Chunk ${i + 1} is too large: ${chunkSizeKB.toFixed(2)}KB. Please use a smaller file or contact support.`);
                                }
                                
                                console.log(`Chunk ${i + 1}/${totalChunks}: ${chunkSizeKB.toFixed(2)}KB`);
                                
                                const chunkRef = doc(db, `file_data/${chunkedFileId}/chunks/${i}`);
                                batch.set(chunkRef, { 
                                    data: chunkData,
                                    userId: auth.currentUser.uid, // Store userId for security rule verification
                                    uploadedAt: new Date().toISOString()
                                });
                                batchCount++;
                                
                                // Commit batch when it reaches limit or is the last chunk
                                if (batchCount >= BATCH_SIZE || i === totalChunks - 1) {
                                    if (batchCount > 0) {
                                        try {
                                            console.log(`Committing batch with ${batchCount} chunks (chunk ${i - batchCount + 1} to ${i + 1})...`);
                                            console.log(`Chunk path: file_data/${chunkedFileId}/chunks/${i}`);
                                            console.log(`User ID: ${auth.currentUser.uid}`);
                                            
                                            await batch.commit();
                                            console.log(`✅ Batch committed successfully (chunks ${i - batchCount + 1} to ${i + 1})`);
                                            
                                            // Update progress
                                            const progress = 20 + ((i + 1) / totalChunks) * 70;
                                            document.getElementById(`bar-${fileId}`).style.width = `${Math.min(progress, 90)}%`;
                                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                                        } catch (batchError) {
                                            console.error(`❌ Error committing batch at chunk ${i}:`, batchError);
                                            console.error('Error code:', batchError.code);
                                            console.error('Error message:', batchError.message);
                                            console.error('Full error:', batchError);
                                            
                                            // More detailed error message
                                            let errorMsg = `Failed to upload chunk ${i + 1}/${totalChunks}`;
                                            if (batchError.code === 'permission-denied') {
                                                errorMsg += ': Permission denied. Please check Firestore security rules for file_data collection.';
                                            } else if (batchError.message) {
                                                errorMsg += `: ${batchError.message}`;
                                            }
                                            throw new Error(errorMsg);
                                        }
                                    }
                                    // Create new batch for next iteration
                                    if (i < totalChunks - 1) {
                                        batch = writeBatch(db);
                                        batchCount = 0;
                                    }
                                }
                            }
                            
                            console.log(`✅ All ${totalChunks} chunks uploaded successfully`);
                            
                            document.getElementById(`bar-${fileId}`).style.width = '90%';
                            document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                            
                            // Save METADATA to User Profile (Keep this small!)
                            const fileMetadata = {
                                id: fileId,
                                name: file.name,
                                type: docType,
                                size: processedFile.size,
                                uploadedAt: uploadTime,
                                isChunked: true, // Flag to tell downloader to look in file_data
                                chunkCount: totalChunks,
                                chunkedFileId: chunkedFileId // Store the ID used for chunks
                            };
                            
                            console.log('Saving file metadata:', fileMetadata);
                            
                            // Update local state for UI
                            uploadedFiles[docType].push(fileMetadata);
                            
                            // Save metadata to Firestore User Document
                            try {
                                const userRef = doc(db, "users", auth.currentUser.uid);
                                
                                // Get current user document to merge properly
                                let currentDocs = [];
                                try {
                                    const userDoc = await getDoc(userRef);
                                    if (userDoc.exists()) {
                                        currentDocs = userDoc.data().docs || [];
                                        // Also update currentApplication from database
                                        currentApplication = { ...currentApplication, ...userDoc.data() };
                                    }
                                } catch (readError) {
                                    console.warn('Could not read current user document:', readError);
                                }
                                
                                // Check if file with same ID already exists and replace it, otherwise add new
                                const existingIndex = currentDocs.findIndex(d => d.id === fileId);
                                if (existingIndex >= 0) {
                                    currentDocs[existingIndex] = fileMetadata;
                                    console.log(`Replacing existing document at index ${existingIndex}`);
                                } else {
                                    currentDocs.push(fileMetadata);
                                    console.log('Adding new document to array');
                                }
                                
                                console.log('Updating user document with docs array:', currentDocs.length, 'documents');
                                await setDoc(userRef, { docs: currentDocs }, { merge: true });
                                console.log('✅ Metadata saved to user document');
                                
                                // Update local state
                                currentApplication.docs = currentDocs;
                            } catch (metaError) {
                                console.error('❌ Error saving metadata:', metaError);
                                console.error('Error details:', {
                                    code: metaError.code,
                                    message: metaError.message,
                                    stack: metaError.stack
                                });
                                throw new Error(`Failed to save file metadata: ${metaError.message}`);
                            }
                                
                                document.getElementById(`bar-${fileId}`).style.width = '100%';
                                document.getElementById(`status-${fileId}`).innerHTML = '<i class="fas fa-check-circle" style="color:#28a745;"></i> Complete';
                                fileProgressDiv.style.borderColor = '#28a745';
                            
                            // Remove progress indicator and add to uploaded files list
                            setTimeout(() => {
                                fileProgressDiv.remove();
                                
                                // Display in the uploaded files list
                                const fileDiv = document.createElement('div');
                                fileDiv.id = fileId;
                                fileDiv.style.cssText = 'padding:10px; background:#fff; border:1px solid #eee; margin-top:5px; border-radius:4px; font-size:0.9rem; display:flex; align-items:center; justify-content:space-between;';
                                
                                const safeFileName = file.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    const fileSizeDisplay = processedFile.size > 1024 * 1024 
                                        ? `${(processedFile.size / (1024 * 1024)).toFixed(2)} MB` 
                                        : `${(processedFile.size / 1024).toFixed(2)} KB`;
                                fileDiv.innerHTML = `
                                    <div style="display:flex; align-items:center; flex:1;">
                                        <span class="doc-status-light doc-uploaded"></span>
                                        <strong style="margin-left:10px;">${docType}:</strong>
                                        <a href="#" onclick="downloadStudentDocument('${fileId}', '${docType}', '${safeFileName}'); return false;" style="margin-left:5px; color:var(--primary); text-decoration:none; cursor:pointer; font-weight:500; border-bottom:1px dotted var(--primary);" title="Click to download ${file.name}">
                                            ${file.name}
                                        </a>
                                            <span style="margin-left:10px; color:#999; font-size:0.85rem;">(${fileSizeDisplay})</span>
                                    </div>
                                    <button onclick="removeUploadedFileById('${fileId}', '${docType}')" style="background:none; border:none; color:#dc3545; cursor:pointer; padding:5px; margin-left:10px;" title="Remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                                list.appendChild(fileDiv);
                            }, 500);
                            
                                return { fileId, success: true, isChunked: true };
                        } catch(error) {
                            console.error(`Error uploading ${file.name}:`, error);
                            
                            // Update status to error with detailed message
                            const errorMsg = error.message || 'Unknown error occurred';
                            document.getElementById(`status-${fileId}`).innerHTML = `<i class="fas fa-exclamation-triangle" style="color:#dc3545;"></i> Failed: ${errorMsg.substring(0, 50)}`;
                            fileProgressDiv.style.borderColor = '#dc3545';
                            
                            // Show error alert
                            alert(`Upload failed for "${file.name}": ${errorMsg}\n\nPlease try again or contact support if the problem persists.`);
                            
                            // Remove progress after showing error
                            setTimeout(() => {
                                fileProgressDiv.remove();
                            }, 3000);
                            
                            return { fileId, success: false, error: error.message };
                        }
                    })();
                    
                    uploadPromises.push(uploadPromise);
                } else {
                    // Demo mode or not authenticated - store locally only
                    uploadedFiles[docType].push({
                        id: fileId,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: uploadTime,
                        blob: file
                    });
                    
                    // Display in the uploaded files list
                    const fileDiv = document.createElement('div');
                    fileDiv.id = fileId;
                    fileDiv.style.cssText = 'padding:10px; background:#fff; border:1px solid #eee; margin-top:5px; border-radius:4px; font-size:0.9rem; display:flex; align-items:center; justify-content:space-between;';
                    
                    const safeFileName = file.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    fileDiv.innerHTML = `
                        <div style="display:flex; align-items:center; flex:1;">
                            <span class="doc-status-light doc-uploaded"></span>
                            <strong style="margin-left:10px;">${docType}:</strong>
                            <a href="#" onclick="downloadStudentDocument('${fileId}', '${docType}', '${safeFileName}'); return false;" style="margin-left:5px; color:var(--primary); text-decoration:none; cursor:pointer; font-weight:500; border-bottom:1px dotted var(--primary);" title="Click to download ${file.name}">
                                ${file.name}
                            </a>
                            <span style="margin-left:10px; color:#999; font-size:0.85rem;">(${(file.size / 1024).toFixed(2)} KB)</span>
                        </div>
                        <button onclick="removeUploadedFileById('${fileId}', '${docType}')" style="background:none; border:none; color:#dc3545; cursor:pointer; padding:5px; margin-left:10px;" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    list.appendChild(fileDiv);
                }
            }
            
            // Wait for all uploads to complete
            if(uploadPromises.length > 0) {
                try {
                    await Promise.all(uploadPromises);
                } catch(error) {
                    console.error('Error during file uploads:', error);
                }
            }
            
            // Remove uploading indicator after a short delay (to show completion)
            setTimeout(() => {
                const indicator = document.getElementById('uploading-indicator');
                if(indicator) {
                    indicator.style.opacity = '0';
                    indicator.style.transition = 'opacity 0.3s';
                    setTimeout(() => indicator.remove(), 300);
                }
            }, 1000);
            
            if(newFilesCount === 0) {
                alert("One or more files were already uploaded. Duplicate files were skipped.");
                return;
            }
            
            // Save documents to database immediately after upload
            // Note: This is a backup save - the main save happens in the upload promise
            // We use collectFormData to ensure all files are included
            try {
                const formData = collectFormData();
                if(auth && auth.currentUser && !isDemoMode && db) {
                    try {
                        // Get current docs from database to merge properly
                        const userRef = doc(db, "users", auth.currentUser.uid);
                        let currentDocs = [];
                        try {
                            const userDoc = await getDoc(userRef);
                            if (userDoc.exists()) {
                                currentDocs = userDoc.data().docs || [];
                            }
                        } catch (readError) {
                            console.warn('Could not read user document for final save:', readError);
                        }
                        
                        // Merge: Use formData.docs (which includes all uploadedFiles) as source of truth
                        // But preserve any docs that might have been added elsewhere
                        const mergedDocs = [...formData.docs];
                        console.log(`Final save: ${mergedDocs.length} documents to save`);
                        
                        await setDoc(userRef, { docs: mergedDocs }, { merge: true });
                        console.log('✅ Documents saved to database (final save)');
                        
                        // Update currentApplication
                        currentApplication.docs = mergedDocs;
                    } catch(e) {
                        console.error("❌ Error saving documents to database:", e);
                        console.error("Error details:", {
                            code: e.code,
                            message: e.message
                        });
                    }
                } else if(isDemoMode) {
                    // Update currentApplication with docs
                    currentApplication = { ...currentApplication, docs: formData.docs };
                    localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                    console.log('Documents saved to localStorage (demo mode)');
                }
            } catch(error) {
                console.error('❌ Error saving documents:', error);
            }
            
            // Clear the file input after upload
            fileInput.value = '';
            
            if(newFilesCount > 0) {
                const storageMsg = (auth && auth.currentUser && !isDemoMode && storage) ? ' and saved to cloud storage' : '';
                alert(`Successfully uploaded ${newFilesCount} file(s) for ${docType}${storageMsg}.`);
            }
        };
        
        // Download document function
        window.downloadStudentDocument = async function(fileId, docType, fileName) {
            try {
                // 1. Find metadata
                let fileData = null;
                
                // Search local state first
                if(uploadedFiles[docType]) {
                    fileData = uploadedFiles[docType].find(f => f.id === fileId);
                }
                
                // Fallback to loaded application data - try by ID first, then by name and type
                if (!fileData && currentApplication && currentApplication.docs) {
                    fileData = currentApplication.docs.find(d => d.id === fileId);
                    // If not found by ID, try by name and type (in case ID doesn't match)
                    if (!fileData) {
                        fileData = currentApplication.docs.find(d => d.name === fileName && d.type === docType);
                    }
                }
                
                // If still not found, check database
                if (!fileData && auth && auth.currentUser && !isDemoMode && db) {
                    try {
                        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                                fileData = userData.docs.find(d => d.id === fileId);
                                if(!fileData) {
                                    fileData = userData.docs.find(d => d.name === fileName && d.type === docType);
                                }
                                
                                // Update currentApplication with fresh data from database
                                if(fileData) {
                                    currentApplication = { ...currentApplication, ...userData };
                                }
                            }
                        }
                    } catch(e) {
                        console.error("Error fetching file from database:", e);
                    }
                }
                
                // If fileData exists but is missing critical fields, try to get complete data
                if (fileData && fileData.isChunked && !fileData.chunkedFileId && db && auth && auth.currentUser) {
                    console.log('File data missing chunkedFileId, fetching from database...');
                    try {
                        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                                const completeFileData = userData.docs.find(d => d.id === fileId || (d.name === fileName && d.type === docType));
                                if(completeFileData) {
                                    fileData = completeFileData; // Use complete data
                                    console.log('Found complete file data:', completeFileData);
                                }
                            }
                        }
                    } catch(e) {
                        console.error("Error fetching complete file data:", e);
                    }
                }
                
                if (!fileData) {
                    alert(`File "${fileName}" not found.`);
                    return;
                }
                
                console.log('File data for download:', {
                    id: fileData.id,
                    name: fileData.name,
                    isChunked: fileData.isChunked,
                    chunkedFileId: fileData.chunkedFileId,
                    chunkCount: fileData.chunkCount,
                    downloadURL: fileData.downloadURL,
                    hasBlob: !!fileData.blob
                });
                
                // 2. Check if it's a "Chunked" file (Large file)
                if (fileData.isChunked && fileData.chunkedFileId) {
                    const loadingMsg = document.createElement('div');
                    loadingMsg.id = 'dl-msg';
                    loadingMsg.style.cssText = "position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:5px; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3);";
                    loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reassembling large file...';
                    document.body.appendChild(loadingMsg);
                    
                    try {
                        // Fetch all chunks
                        let fullBase64 = "";
                        const count = fileData.chunkCount || 100; // fallback safety
                        
                        for (let i = 0; i < count; i++) {
                            // Update loading message
                            loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading chunk ${i + 1}/${count}...`;
                            
                            // Fetch chunk i
                            const chunkRef = doc(db, `file_data/${fileData.chunkedFileId}/chunks/${i}`);
                            const snap = await getDoc(chunkRef);
                            
                            if (snap.exists()) {
                                fullBase64 += snap.data().data;
                            } else {
                                break; // No more chunks
                            }
                        }
                        
                        // Trigger Download
                        const a = document.createElement('a');
                        a.href = fullBase64;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        loadingMsg.innerHTML = '<i class="fas fa-check-circle"></i> Download started!';
                        setTimeout(() => loadingMsg.remove(), 2000);
                        
                    } catch (e) {
                        console.error("Download failed:", e);
                        loadingMsg.remove();
                        alert("Failed to download large file: " + e.message);
                    }
                    
                } else if (fileData.downloadURL) {
                    // Standard small file (Firebase Storage URL)
                    const a = document.createElement('a');
                    a.href = fileData.downloadURL;
                    a.download = fileName;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                } else if (fileData.blob instanceof File) {
                    // Local blob (for recently uploaded files not yet in Storage)
                    const url = URL.createObjectURL(fileData.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    
                } else {
                    // Check if file data is stored as data URL in DOM
                    const fileDiv = document.getElementById(fileId);
                    if(fileDiv) {
                        const blobData = fileDiv.getAttribute('data-file-blob');
                        if(blobData) {
                            // Convert data URL to blob and download
                            const response = await fetch(blobData);
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            setTimeout(() => URL.revokeObjectURL(url), 100);
                            return;
                        }
                    }
                    
                    // If we get here, the file metadata exists but content is missing
                    console.error('File content missing for:', fileData);
                    console.error('File data:', {
                        id: fileData.id,
                        name: fileData.name,
                        isChunked: fileData.isChunked,
                        chunkedFileId: fileData.chunkedFileId,
                        downloadURL: fileData.downloadURL,
                        hasBlob: !!fileData.blob
                    });
                    
                    // Try one more time to get from database if it's chunked but chunkedFileId might be missing
                    if (fileData.isChunked && !fileData.chunkedFileId && db && auth && auth.currentUser) {
                        console.log('Attempting to find chunkedFileId in database...');
                        try {
                            const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                            if(userDoc.exists()) {
                                const userData = userDoc.data();
                                if(userData.docs && Array.isArray(userData.docs)) {
                                    const dbFileData = userData.docs.find(d => d.id === fileId || (d.name === fileName && d.type === docType));
                                    if(dbFileData && dbFileData.isChunked && dbFileData.chunkedFileId) {
                                        console.log('Found chunkedFileId in database, retrying download...');
                                        // Retry with the correct chunkedFileId
                                        fileData.chunkedFileId = dbFileData.chunkedFileId;
                                        fileData.chunkCount = dbFileData.chunkCount;
                                        // Recursively call the function with updated data
                                        // But we'll handle it inline to avoid recursion issues
                                        const loadingMsg = document.createElement('div');
                                        loadingMsg.id = 'dl-msg';
                                        loadingMsg.style.cssText = "position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:5px; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.3);";
                                        loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reassembling large file...';
                                        document.body.appendChild(loadingMsg);
                                        
                                        try {
                                            let fullBase64 = "";
                                            const count = dbFileData.chunkCount || 100;
                                            
                                            for (let i = 0; i < count; i++) {
                                                loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading chunk ${i + 1}/${count}...`;
                                                const chunkRef = doc(db, `file_data/${dbFileData.chunkedFileId}/chunks/${i}`);
                                                const snap = await getDoc(chunkRef);
                                                
                                                if (snap.exists()) {
                                                    fullBase64 += snap.data().data;
                                                } else {
                                                    break;
                                                }
                                            }
                                            
                                            const a = document.createElement('a');
                                            a.href = fullBase64;
                                            a.download = fileName;
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            
                                            loadingMsg.innerHTML = '<i class="fas fa-check-circle"></i> Download started!';
                                            setTimeout(() => loadingMsg.remove(), 2000);
                                            return;
                                        } catch (e) {
                                            console.error("Retry download failed:", e);
                                            loadingMsg.remove();
                                            alert("Failed to download file: " + e.message);
                                            return;
                                        }
                                    }
                                }
                            }
                        } catch(e) {
                            console.error("Error retrying download:", e);
                        }
                    }
                    
                    alert(`File "${fileName}" content is missing. The file may need to be re-uploaded.`);
                }
            } catch(error) {
                console.error('Error in downloadStudentDocument:', error);
                alert('Error downloading document. Please try again.');
            }
        };
        
        window.removeUploadedFileById = async function(fileId, docType) {
            // Find the file data to check if it's chunked
            let fileData = null;
            if(uploadedFiles[docType]) {
                fileData = uploadedFiles[docType].find(f => f.id === fileId);
            }
            
            // If not in local state, check currentApplication
            if (!fileData && currentApplication && currentApplication.docs) {
                fileData = currentApplication.docs.find(d => d.id === fileId);
            }
            
            // If still not found and authenticated, check database
            if (!fileData && auth && auth.currentUser && !isDemoMode && db) {
                try {
                        const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            if(userData.docs && Array.isArray(userData.docs)) {
                            fileData = userData.docs.find(d => d.id === fileId);
                        }
                    }
                } catch(e) {
                    console.error("Error fetching file data for removal:", e);
                }
            }
            
            // If it's a chunked file, delete all chunks from Firestore
            if (fileData && fileData.isChunked && fileData.chunkedFileId && db && auth && auth.currentUser && !isDemoMode) {
                try {
                    const chunkCount = fileData.chunkCount || 100;
                    // Delete chunks in batches
                    const BATCH_SIZE = 500;
                    let batch = writeBatch(db);
                    let batchCount = 0;
                    
                    for (let i = 0; i < chunkCount; i++) {
                        const chunkRef = doc(db, `file_data/${fileData.chunkedFileId}/chunks/${i}`);
                        batch.delete(chunkRef);
                        batchCount++;
                        
                        // Commit batch when it reaches limit or is the last chunk
                        if (batchCount >= BATCH_SIZE || i === chunkCount - 1) {
                            await batch.commit();
                            batch = writeBatch(db);
                            batchCount = 0;
                        }
                    }
                    console.log(`Deleted ${chunkCount} chunks for file ${fileId}`);
                    } catch(e) {
                    console.error("Error deleting chunks:", e);
                }
            }
            
            // Remove from data structure
            if(uploadedFiles[docType]) {
                uploadedFiles[docType] = uploadedFiles[docType].filter(f => f.id !== fileId);
                if(uploadedFiles[docType].length === 0) {
                    delete uploadedFiles[docType];
                }
            }
            
            // Remove from DOM
            const fileDiv = document.getElementById(fileId);
            if(fileDiv) {
                fileDiv.remove();
            }
            
            // Save updated documents list to database
            try {
                const formData = collectFormData();
                if(auth && auth.currentUser && !isDemoMode && db) {
                    try {
                        await setDoc(doc(db, "users", auth.currentUser.uid), { docs: formData.docs }, { merge: true });
                        console.log('Documents updated in database after removal');
                    } catch(e) {
                        console.error("Error updating documents in database:", e);
                    }
                } else if(isDemoMode) {
                    currentApplication = { ...currentApplication, docs: formData.docs };
                    localStorage.setItem('demoApp', JSON.stringify(currentApplication));
                }
            } catch(error) {
                console.error('Error saving documents after removal:', error);
            }
            
            // Show "no docs" message if list is empty
            const list = document.getElementById('stu-file-list');
            const fileDivs = Array.from(list.children).filter(child => child.id && child.id.startsWith('file-'));
            if(fileDivs.length === 0) {
                list.innerHTML = '<h4 style="font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">Uploaded Files</h4><div class="no-docs" style="color: #999; font-style: italic; font-size: 0.9rem;">No documents uploaded yet.</div>';
            }
        };

        window.sendMessage = async function(role) {
            const input = document.getElementById(role === 'student' ? 'stu-chat-input' : 'coun-chat-input');
            const box = document.getElementById(role === 'student' ? 'stu-chat-box' : 'coun-chat-box');
            if(!input || !input.value.trim()) return;
            
            const messageText = input.value.trim();
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Create message element
            const div = document.createElement('div');
            div.className = 'message msg-out';
            div.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${role === 'student' ? 'You' : 'You (Counselor)'}</div>
                <div style="margin-bottom: 4px;">${messageText}</div>
                <div style="font-size: 0.75rem; opacity: 0.7; text-align: right;">${timestamp}</div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight; // Auto scroll to bottom
            
            // Save message to Firebase if authenticated
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    let studentId, counselorId;
                    
                    if(role === 'student') {
                        // Student sending message - need to find their counselor
                        studentId = auth.currentUser.uid;
                        // Try to get counselor ID from user's profile
                        try {
                            const userDoc = await getDoc(doc(db, "users", studentId));
                            if(userDoc.exists()) {
                                const userData = userDoc.data();
                                counselorId = userData.counselorId || null;
                                
                                // If student doesn't have a counselor, they can't send messages yet
                                if(!counselorId) {
                                    showInfo("You don't have a counselor assigned yet. A counselor will be assigned to you soon!");
                                    // Remove the message from UI
                                    if(div && div.parentNode) {
                                        div.remove();
                                    }
                                    input.value = messageText; // Restore message text
                                    return;
                                }
                            } else {
                                alert("Your profile is not set up. Please complete your application first.");
                                if(div && div.parentNode) {
                                    div.remove();
                                }
                                input.value = messageText;
                                return;
                            }
                        } catch(e) {
                            console.error("Error getting student counselor:", e);
                            alert("Error loading your profile. Please try again.");
                            if(div && div.parentNode) {
                                div.remove();
                            }
                            input.value = messageText;
                            return;
                        }
                    } else {
                        // Counselor sending message
                        counselorId = auth.currentUser.uid;
                        studentId = currentStudentId || null;
                        
                        if(!studentId) {
                            alert("Please select a student first.");
                            return;
                        }
                    }
                    
                    if(!studentId) {
                        console.error("Cannot send message: studentId is missing");
                        return;
                    }
                    
                    // Ensure counselorId is set for counselor messages
                    if(role === 'counselor' && !counselorId) {
                        counselorId = auth.currentUser.uid;
                    }
                    
                    const messageData = {
                        text: messageText,
                        sender: role === 'student' ? 'student' : 'counselor',
                        senderId: auth.currentUser.uid,
                        studentId: studentId,
                        counselorId: counselorId || null,
                        timestamp: new Date().toISOString(),
                        read: false
                    };
                    
                    // Save to messages collection
                    await addDoc(collection(db, "messages"), messageData);
                    console.log('Message saved successfully');
                } catch(e) {
                    console.error("Error saving message:", e);
                    console.error("Error details:", {
                        code: e.code,
                        message: e.message,
                        studentId: studentId,
                        counselorId: counselorId,
                        role: role
                    });
                    
                    // Show more specific error message
                    let errorMsg = "Failed to send message. ";
                    if(e.code === 'permission-denied') {
                        errorMsg += "Permission denied. Please check that you have the correct permissions.";
                    } else if(e.code === 'unavailable') {
                        errorMsg += "Database unavailable. Please check your internet connection.";
                    } else {
                        errorMsg += `Error: ${e.message || 'Unknown error'}. Please try again.`;
                    }
                    alert(errorMsg);
                    
                    // Remove the message from UI if save failed
                    if(div && div.parentNode) {
                        div.remove();
                    }
                }
            }
            
            input.value = '';
        };
        
        // Store chat listeners to unsubscribe when needed
        let chatUnsubscribers = {};
        
        // Load chat history for counselor
        function loadCounselorChat(studentId) {
            const chatBox = document.getElementById('coun-chat-box');
            if(!chatBox || !studentId) return;
            
            // Unsubscribe from previous chat listener
            if(chatUnsubscribers['counselor']) {
                chatUnsubscribers['counselor']();
                delete chatUnsubscribers['counselor'];
            }
            
            // Clear existing messages
            chatBox.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
            
            // Load messages from Firebase if authenticated
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const counselorId = auth.currentUser.uid;
                    
                    // Query messages between this counselor and student
                    // Use simple query by studentId only (no index required)
                    // Filter by counselorId and sort by timestamp in memory
                    const messagesQuery = query(
                        collection(db, "messages"),
                        where("studentId", "==", studentId)
                    );
                    
                    // Use real-time listener for live updates
                    const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                        chatBox.innerHTML = '';
                        
                        let messages = [];
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            // Filter by counselorId if we used fallback query
                            if(!msg.counselorId || msg.counselorId === counselorId) {
                                messages.push({ id: doc.id, ...msg });
                            }
                        });
                        
                        // Sort by timestamp
                        messages.sort((a, b) => {
                            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                            return timeA - timeB;
                        });
                        
                        if(messages.length === 0) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No previous messages. Start a conversation with the student!
                                </div>
                            `;
                        } else {
                            messages.forEach(msg => {
                                const msgDiv = document.createElement('div');
                                const isCounselor = msg.sender === 'counselor' || msg.senderId === counselorId;
                                msgDiv.className = isCounselor ? 'message msg-out' : 'message msg-in';
                                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                msgDiv.innerHTML = `
                                    <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${isCounselor ? 'You (Counselor)' : 'Student'}</div>
                                    <div style="margin-bottom: 4px;">${msg.text || ''}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.7; ${isCounselor ? 'text-align: right;' : ''}">${time}</div>
                                `;
                                chatBox.appendChild(msgDiv);
                            });
                            chatBox.scrollTop = chatBox.scrollHeight;
                        }
                    }, async (error) => {
                        console.error("Error loading chat:", error);
                        console.error("Error details:", {
                            code: error.code,
                            message: error.message,
                            studentId: studentId,
                            counselorId: counselorId
                        });
                        
                        // If index error, try querying without orderBy
                        if(error.code === 'failed-precondition') {
                            console.log("Index required, retrying without orderBy...");
                            try {
                                const fallbackQuery = query(
                                    collection(db, "messages"),
                                    where("studentId", "==", studentId)
                                );
                                
                                const unsubscribe = onSnapshot(fallbackQuery, (snapshot) => {
                                    chatBox.innerHTML = '';
                                    
                                    let messages = [];
                                    snapshot.forEach(doc => {
                                        const msg = doc.data();
                                        // Filter by counselorId
                                        if(!msg.counselorId || msg.counselorId === counselorId) {
                                            messages.push({ id: doc.id, ...msg });
                                        }
                                    });
                                    
                                    // Sort by timestamp in memory
                                    messages.sort((a, b) => {
                                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                                        return timeA - timeB;
                                    });
                                    
                                    if(messages.length === 0) {
                                        chatBox.innerHTML = `
                                            <div class="message msg-in">
                                                <strong>System:</strong> No previous messages. Start a conversation with the student!
                                            </div>
                                        `;
                                    } else {
                                        messages.forEach(msg => {
                                            const msgDiv = document.createElement('div');
                                            const isCounselor = msg.sender === 'counselor' || msg.senderId === counselorId;
                                            msgDiv.className = isCounselor ? 'message msg-out' : 'message msg-in';
                                            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                            msgDiv.innerHTML = `
                                                <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${isCounselor ? 'You (Counselor)' : 'Student'}</div>
                                                <div style="margin-bottom: 4px;">${msg.text || ''}</div>
                                                <div style="font-size: 0.75rem; opacity: 0.7; ${isCounselor ? 'text-align: right;' : ''}">${time}</div>
                                            `;
                                            chatBox.appendChild(msgDiv);
                                        });
                                        chatBox.scrollTop = chatBox.scrollHeight;
                                    }
                                }, (fallbackError) => {
                                    console.error("Fallback query also failed:", fallbackError);
                                    chatBox.innerHTML = `
                                        <div class="message msg-in">
                                            <strong>System:</strong> Error loading messages. ${fallbackError.message || 'Please try again.'}
                                        </div>
                                    `;
                                });
                                
                                // Store unsubscribe for cleanup
                                if(chatUnsubscribers['counselor']) {
                                    chatUnsubscribers['counselor']();
                                }
                                chatUnsubscribers['counselor'] = unsubscribe;
                                return; // Success, exit error handler
                            } catch(fallbackError) {
                                console.error("Fallback query setup failed:", fallbackError);
                            }
                        }
                        
                        let errorMsg = "Error loading messages. ";
                        if(error.code === 'permission-denied') {
                            errorMsg += "Permission denied. Please check Firestore security rules.";
                        } else if(error.code === 'failed-precondition') {
                            errorMsg += "Database index required. Please create the composite index in Firebase Console.";
                        } else if(error.code === 'unavailable') {
                            errorMsg += "Database unavailable. Please check your internet connection.";
                        } else {
                            errorMsg += `${error.message || 'Unknown error'}. Please try again.`;
                        }
                        
                        chatBox.innerHTML = `
                            <div class="message msg-in">
                                <strong>System:</strong> ${errorMsg}
                            </div>
                        `;
                    });
                    
                    // Store unsubscribe function
                    chatUnsubscribers['counselor'] = unsubscribe;
                } catch(e) {
                    console.error("Error setting up chat:", e);
                    chatBox.innerHTML = `
                        <div class="message msg-in">
                            <strong>System:</strong> Error setting up chat. Please refresh the page.
                        </div>
                    `;
                }
            } else {
                // Demo mode or not authenticated
                chatBox.innerHTML = `
                    <div class="message msg-in">
                        <strong>System:</strong> Start a conversation with the student! Chat messages will be saved when authenticated.
                    </div>
                `;
            }
        }
        
        // Load chat history for student
        function loadStudentChat() {
            const chatBox = document.getElementById('stu-chat-box');
            if(!chatBox || !auth || !auth.currentUser) return;
            
            // Unsubscribe from previous chat listener
            if(chatUnsubscribers['student']) {
                chatUnsubscribers['student']();
                delete chatUnsubscribers['student'];
            }
            
            // Clear existing messages
            chatBox.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
            
            // Load messages from Firebase if authenticated
            if(auth && auth.currentUser && !isDemoMode && db) {
                try {
                    const studentId = auth.currentUser.uid;
                    
                    // Get student's counselor ID
                    getDoc(doc(db, "users", studentId)).then(userDoc => {
                        if(!userDoc.exists()) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No counselor assigned yet. Please contact support.
                                </div>
                            `;
                            return;
                        }
                        
                        const userData = userDoc.data();
                        const counselorId = userData.counselorId;
                        
                        if(!counselorId) {
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> No counselor assigned yet. A counselor will be assigned to you soon!
                                </div>
                            `;
                            return;
                        }
                        
                        // Query messages between this student and their counselor
                        // Use simple query by studentId only (no index required)
                        // Filter by counselorId and sort by timestamp in memory
                        const messagesQuery = query(
                            collection(db, "messages"),
                            where("studentId", "==", studentId)
                        );
                        
                        // Use real-time listener for live updates
                        const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                            chatBox.innerHTML = '';
                            
                            let messages = [];
                            snapshot.forEach(doc => {
                                const msg = doc.data();
                                // Filter by counselorId if we used fallback query
                                if(!msg.counselorId || msg.counselorId === counselorId) {
                                    messages.push({ id: doc.id, ...msg });
                                }
                            });
                            
                            // Sort by timestamp
                            messages.sort((a, b) => {
                                const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                                const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                                return timeA - timeB;
                            });
                            
                            if(messages.length === 0) {
                                chatBox.innerHTML = `
                                    <div class="message msg-in">
                                        <strong>System:</strong> No previous messages. Start a conversation with your counselor!
                                    </div>
                                `;
                            } else {
                                messages.forEach(msg => {
                                    const msgDiv = document.createElement('div');
                                    const isStudent = msg.sender === 'student' || msg.senderId === studentId;
                                    msgDiv.className = isStudent ? 'message msg-out' : 'message msg-in';
                                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                                    msgDiv.innerHTML = `
                                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; opacity: 0.9;">${isStudent ? 'You' : 'Your Counselor'}</div>
                                        <div style="margin-bottom: 4px;">${msg.text || ''}</div>
                                        <div style="font-size: 0.75rem; opacity: 0.7; ${isStudent ? 'text-align: right;' : ''}">${time}</div>
                                    `;
                                    chatBox.appendChild(msgDiv);
                                });
                                chatBox.scrollTop = chatBox.scrollHeight;
                            }
                        }, (error) => {
                            console.error("Error loading chat:", error);
                            console.error("Error details:", {
                                code: error.code,
                                message: error.message,
                                studentId: studentId,
                                counselorId: counselorId
                            });
                            
                            let errorMsg = "Error loading messages. ";
                            if(error.code === 'permission-denied') {
                                errorMsg += "Permission denied. Please check Firestore security rules.";
                            } else if(error.code === 'failed-precondition') {
                                errorMsg += "Database index required. Please create the composite index in Firebase Console.";
                            } else if(error.code === 'unavailable') {
                                errorMsg += "Database unavailable. Please check your internet connection.";
                            } else {
                                errorMsg += `${error.message || 'Unknown error'}. Please try again.`;
                            }
                            
                            chatBox.innerHTML = `
                                <div class="message msg-in">
                                    <strong>System:</strong> ${errorMsg}
                                </div>
                            `;
                        });
                        
                        // Store unsubscribe function
                        chatUnsubscribers['student'] = unsubscribe;
                    }).catch(e => {
                        console.error("Error getting student data:", e);
                        chatBox.innerHTML = `
                            <div class="message msg-in">
                                <strong>System:</strong> Error loading chat. Please try again.
                            </div>
                        `;
                    });
                } catch(e) {
                    console.error("Error setting up chat:", e);
                    chatBox.innerHTML = `
                        <div class="message msg-in">
                            <strong>System:</strong> Error setting up chat. Please refresh the page.
                        </div>
                    `;
                }
            } else {
                // Demo mode or not authenticated
                chatBox.innerHTML = `
                    <div class="message msg-in">
                        <strong>System:</strong> Start a conversation! Chat messages will be saved when authenticated.
                    </div>
                `;
            }
        }

        if(auth) {
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    try {
                        // Check user role from users collection first
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        let userRole = null;
                        
                        if(userDoc.exists()) {
                            const userData = userDoc.data();
                            userRole = userData.role || null;
                        }
                        
                        // If no role in users collection, check counselors collection
                        if(!userRole) {
                            const counDoc = await getDoc(doc(db, "counselors", user.uid));
                            if(counDoc.exists()) {
                                userRole = 'counselor';
                            }
                        }
                        
                        // Route based on role
                        if(userRole === 'admin') {
                            window.currentRole = 'admin';
                            window.router('admin');
                        } else if(userRole === 'counselor') {
                            window.currentRole = 'counselor';
                            window.router('counselor');
                        } else {
                            // Default to student
                            if(userDoc.exists()) {
                                currentApplication = userDoc.data();
                                selectedUnis = currentApplication.universities || [];
                                updateSelectedList();
                                setTimeout(() => loadFormData(), 200);
                            }
                            window.currentRole = 'student';
                            window.router('student');
                        }
                        document.getElementById('user-display').innerText = user.email;
                    } catch (e) { 
                        console.error('Auth state error:', e);
                        window.router('student'); 
                    }
                }
            });
        }
    </script>
</body>
</html>